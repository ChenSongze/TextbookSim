<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Textbook Editorial Simulator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
    
    :root {
      --paper: #f4f1e8;
      --ink-dark: #2c2c2c;
      --ink-medium: #4a4a4a;
      --ink-light: #6a6a6a;
      --stamp-red: #b91c1c;
      --stamp-green: #166534;
      --stamp-blue: #1e40af;
      --highlight-yellow: #fef3c7;
      --border-light: #d6d3d1;
      --shadow: rgba(0, 0, 0, 0.15);
      
      /* Neumorphism Variables */
      --neu-bg: #e8e8e8;
      --neu-light: #ffffff;
      --neu-dark: #d4d1c8;
      --neu-shadow-light: rgba(255, 255, 255, 0.8);
      --neu-shadow-dark: rgba(180, 177, 168, 0.6);
      --neu-shadow-inset-light: rgba(255, 255, 255, 0.7);
      --neu-shadow-inset-dark: rgba(160, 157, 148, 0.4);
      --neu-border-radius: 0.8rem;
      --neu-border-radius-small: 0.5rem;
      --neu-border-radius-large: 1.2rem;
      
      /* Glass Effect Variables */
      --shadow-offset: 0;
      --shadow-blur: 20px;
      --shadow-spread: -5px;
      --shadow-color: rgba(255, 255, 255, 0.7);
      --tint-color: 180, 230, 180;
      --tint-opacity: 0.12;
      --frost-blur: 1px;
      --noise-frequency: 0;
      --distortion-strength: 0;
      --outer-shadow-blur: 24px;
    }

    /* Glass Effect Styles for Monitor and Chart */
    .monitor-glass-overlay,
    .chart-glass-overlay {
      border-radius: var(--neu-border-radius);
      cursor: move;
      isolation: isolate;
      touch-action: none;
      box-shadow: 0px 6px var(--outer-shadow-blur) rgba(0, 0, 0, 0.2);
    }

    .monitor-glass-overlay::before,
    .chart-glass-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      border-radius: var(--neu-border-radius);
      box-shadow:
        inset var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) var(--shadow-spread) var(--shadow-color);
      background-color: rgba(var(--tint-color), var(--tint-opacity));
    }

    .monitor-glass-overlay::after,
    .chart-glass-overlay::after {
      content: '';
      position: absolute;
      inset: 0;
      z-index: -1;
      border-radius: var(--neu-border-radius);
      backdrop-filter: blur(var(--frost-blur));
      filter: url(#glass-distortion);
      isolation: isolate;
      -webkit-backdrop-filter: blur(var(--frost-blur));
      -webkit-filter: url("#glass-distortion");
    }


    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      width: 1600px;
      height: 900px;
      overflow: hidden;
      margin: 0 auto;
    }

    body {
      font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--neu-bg);
      color: var(--ink-dark);
      width: 1600px;
      height: 900px;
      overflow: hidden;
    }

    /* Page System */
    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
      transform: translateY(0);
    }

    .page.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
    }

    .page.active {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .page.fade-out {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.4s ease-in, transform 0.4s ease-in;
    }

    /* Game pages styling */
    #main-game {
      display: flex;
    }

    /* Simple page styling for non-game pages */
    .simple-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    .simple-page h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--ink-dark);
    }

    /* Options Page Styling */
    .options-nav-btn {
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius);
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 4px 4px 12px var(--neu-shadow-dark), -4px -4px 12px var(--neu-shadow-light);
      font-family: inherit;
      width: 100%;
    }
    
    .options-nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 6px 6px 16px var(--neu-shadow-dark), -6px -6px 16px var(--neu-shadow-light);
    }
    
    .options-nav-btn:active {
      transform: translateY(0);
      box-shadow: inset 2px 2px 8px var(--neu-shadow-dark), inset -2px -2px 8px var(--neu-shadow-light);
    }
    
    .options-nav-btn h3 {
      margin: 0 0 0.5rem 0;
      color: var(--ink-dark);
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .options-nav-btn p {
      margin: 0;
      color: var(--ink-medium);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .simple-page p {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      max-width: 600px;
      line-height: 1.6;
      color: var(--ink-medium);
    }

    .next-button {
      display: inline-block;
      color: var(--stamp-green);
      padding: 0.7em 1.7em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      cursor: pointer;
      position: relative;
      z-index: 1001;
      border: 1px solid #e8e8e8;
      transition: all 0.2s ease-in-out;
      box-shadow:
        6px 6px 12px #c5c5c5,
        -6px -6px 12px #ffffff;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .next-button:active {
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    /* Cultural Test Styles */
    .cultural-test-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      overflow: hidden;
      transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
      transform: translateY(0);
      z-index: 1100;
    }

    /* Intro page specific - keep centered */
    #cultural-intro.cultural-test-container {
      justify-content: center;
    }

    /* Questions page specific - center the whole content block */
    #cultural-questions.cultural-test-container {
      justify-content: center;
      align-items: center;
    }

    /* Wrapper to contain all question page elements */
    .cultural-questions-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 700px;
      width: 100%;
    }

    .cultural-test-container.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
    }

    .cultural-test-container.active {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .cultural-card {
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      padding: 2rem;
      margin: 2rem;
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius-large);
      overflow-y: auto;
      position: relative;
    }

    /* Intro page card - inset (凹陷) effect */
    .cultural-card.neu-flat {
      box-shadow: inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
                  inset -0.3rem -0.3rem 0.6rem var(--neu-shadow-inset-light);
    }

    .cultural-title {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--ink-dark);
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(135deg, var(--ink-dark), var(--ink-medium));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .cultural-subtitle {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.4rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--ink-dark);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .cultural-description, .cultural-note, .cultural-completion {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.6;
      color: var(--ink-medium);
      text-align: center;
      margin-bottom: 1rem;
    }

    .cultural-note {
      font-style: italic;
      color: var(--ink-light);
      font-size: 0.9rem;
    }

    .cultural-instructions {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: var(--neu-border-radius);
      max-width: 600px;
      width: 100%;
      background: var(--neu-bg);
      position: relative;
    }

    /* Fixed inset shadow using pseudo-element with fixed positioning */
    .cultural-instructions::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.3rem -0.3rem 0.6rem var(--neu-shadow-inset-light);
      pointer-events: none;
      z-index: 10;
      background: transparent;
    }


    .cultural-instructions p {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--ink-dark);
      text-align: center;
      margin-bottom: 1rem;
    }

    .scale-table {
      margin-top: 1rem;
    }

    .scale-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .scale-item {
      flex: 1;
      text-align: center;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--stamp-blue);
      background: var(--neu-bg);
      padding: 0.5rem;
      margin: 0 0.2rem;
      border-radius: var(--neu-border-radius-small);
      box-shadow: 
        0.2rem 0.2rem 0.4rem var(--neu-shadow-dark),
        -0.1rem -0.1rem 0.3rem var(--neu-shadow-light);
    }

    .scale-labels {
      display: flex;
      justify-content: space-between;
    }

    .scale-label {
      flex: 1;
      text-align: center;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--ink-medium);
      padding: 0.3rem 0.1rem;
    }

    /* Container for questions with fixed inset shadow */
    .questions-container {
      max-width: 600px;
      width: 100%;
      max-height: 50vh;
      margin-bottom: 1.5rem;
      position: relative;
      border-radius: var(--neu-border-radius);
      background: var(--neu-bg);
    }

    /* Fixed inset shadow that doesn't scroll */
    .questions-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.3rem -0.3rem 0.6rem var(--neu-shadow-inset-light);
      pointer-events: none;
      z-index: 10;
    }

    /* Scrollable content inside the container */
    .questions-scroll {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 1.5rem;
      border-radius: var(--neu-border-radius);
      position: relative;
      z-index: 1;
    }

    /* Questions scroll bar styling - matching main simulator */
    .questions-scroll::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    .questions-scroll::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    .questions-scroll::-webkit-scrollbar-thumb {
      background: #e8e8e8;
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        2px 2px 4px #c5c5c5,
        -2px -2px 4px #ffffff,
        4px 0px 6px #c5c5c5,
        -4px 0px 6px #ffffff;
    }
    
    .questions-scroll::-webkit-scrollbar-thumb:hover {
      background: #e0e0e0;
    }
    
    .questions-scroll::-webkit-scrollbar-thumb:active {
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 2px 2px 4px #c5c5c5,
        inset -2px -2px 4px #ffffff;
    }

    .cultural-question {
      margin-bottom: 1.5rem;
      padding: 0;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      transition: none;
    }

    .question-text {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--ink-dark);
      margin-bottom: 0.8rem;
      line-height: 1.5;
    }

    .question-number {
      font-weight: 700;
      color: var(--stamp-red);
      transition: color 0.3s ease;
    }

    .question-number.answered {
      color: var(--stamp-green);
    }

    .cultural-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cultural-option {
      position: relative;
      flex: 1;
      margin: 0 0.3rem;
    }

    .cultural-option input[type="radio"] {
      opacity: 0;
      position: absolute;
      width: 100%;
      height: 100%;
      margin: 0;
      cursor: pointer;
    }

    .cultural-option-label {
      display: block;
      text-align: center;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ink-medium);
      background: var(--neu-bg);
      padding: 0.6rem 0.3rem;
      border-radius: var(--neu-border-radius-small);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0.2rem 0.2rem 0.4rem var(--neu-shadow-dark),
        -0.1rem -0.1rem 0.3rem var(--neu-shadow-light);
    }

    .cultural-option input[type="radio"]:checked + .cultural-option-label {
      color: var(--stamp-green);
      box-shadow: 
        inset 0.2rem 0.2rem 0.4rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.3rem var(--neu-shadow-inset-light);
      transform: scale(0.95);
    }

    .cultural-option-label:hover {
      color: var(--ink-dark);
      transform: translateY(-1px);
    }

    .cultural-progress {
      margin-bottom: 1.5rem;
      text-align: center;
      display: none; /* Hide the old progress bar */
    }

    .cultural-submit-btn {
      --progress-width: 0%;
      position: relative;
      overflow: hidden;
      background: var(--neu-bg);
      color: var(--ink-medium);
      border: none;
      border-radius: var(--neu-border-radius);
      padding: 1rem 2rem;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0.3rem 0.3rem 0.6rem var(--neu-shadow-dark),
        -0.2rem -0.2rem 0.5rem var(--neu-shadow-light);
      z-index: 1;
    }

    .cultural-submit-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: var(--progress-width);
      background: var(--stamp-green);
      transition: width 0.5s ease;
      z-index: -1;
    }

    .cultural-submit-btn:not(:disabled):hover {
      color: var(--ink-dark);
      transform: translateY(-1px);
    }

    .cultural-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      color: var(--ink-light);
    }

    .cultural-submit-btn.complete {
      color: white;
      cursor: pointer;
    }

    /* Center all buttons in cultural test */
    .cultural-start-btn,
    .cultural-submit-btn,
    .cultural-card .next-button {
      display: block;
      margin: 1.5rem auto 0 auto;
      text-align: center;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .result-item {
      background: var(--neu-bg);
      padding: 1rem;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        0.2rem 0.2rem 0.4rem var(--neu-shadow-dark),
        -0.1rem -0.1rem 0.3rem var(--neu-shadow-light);
      text-align: center;
      transition: all 0.3s ease;
    }

    .result-item:hover {
      transform: translateY(-2px);
      box-shadow: 
        0.3rem 0.3rem 0.6rem var(--neu-shadow-dark),
        -0.2rem -0.2rem 0.5rem var(--neu-shadow-light);
    }

    .result-dimension {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ink-dark);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }

    .result-score {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--stamp-blue);
    }

    .result-interpretation {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--ink-medium);
      margin-top: 0.3rem;
    }

    .results-note {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: var(--neu-border-radius);
      text-align: center;
    }

    .results-note p {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      color: var(--ink-dark);
      margin: 0.5rem 0;
    }

    .classification-note {
      font-style: italic;
      color: var(--ink-medium);
      font-size: 0.8rem;
    }

    #cultural-classification {
      font-weight: 700;
      color: var(--stamp-red);
    }

    /* Intro Page Typewriter Effect */
    .intro-text-container {
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      margin-bottom: 0;
    }

    .intro-text-line {
      font-size: 1.4rem;
      line-height: 1.8;
      color: var(--ink-dark);
      margin: 0.5rem 0;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.8s ease;
    }

    .intro-text-line.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .intro-text-line.emphasized {
      font-weight: 700;
      color: var(--stamp-red);
      font-size: 1.6rem;
    }

    /* Button container to prevent layout jump */
    .intro-button-container {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 2rem;
      position: relative;
      z-index: 1000;
    }

    .fade-in-button {
      animation: fadeIn 0.8s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Snow Effect for Intro and Story Pages */
    .snow-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0AgMAAAC2uDcZAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURQAAAP///////////zjAO6gAAAAEdFJOUwAuxHKQ3Q8qAAADW0lEQVR42u3dP26jQByGYUbaEe0Wi+jgKj5CirjFp9gGKXAfkOUmW+YOW2QvgdtN45XlHMAgB2aYz955nzrJp2AYM39/SYJrmTLcbDfK9MtvYbod3oXp6fCqTO8iTpdeeaNNP/1VprfKJy7ZPinTLV91AAAAAAAAAAD4kkkH/XfKCQ/TSCd7Tm/K9GHv9+89KdOzrTK9PM/68dpverXfzPnxxu9d1/Sz0ncfXtPreenZszLd+G1pq17Zchfz/nfPyoMyPT0r0802AQDMYZWt9uS7R5jWfOK9y7wEuSYT75z2EuQNph5/QU67IItrJ14S0+5dmv4aQfpBmT7RLUuHIGMO+XiXNNCCcjve1pk2TI9lIkW6lB8AAACITcxTza12qvmXMt3zdCvpX//clelJ/SZ93j+U6bl0J6+VtrQAAAAAAADwxz4r03PpGNtOOr7YLN2D8MNHer1w/4WfA00Xp3tZ8bk03R59DMo2C9PTzscUUHFYmu5j1WN+VqbbhS2t5UBTFfGBppsEAAAA+Mp7qzJcW/Ik0J7QqZ7ioCy4EmhP6Kq9ZNKX3HXaEQLtwmjlEyfeE/qNrzoAc1+SmPQTaaQHj9U96RqVNF172F4uPe7OSlsbI21pAQAAAPyPjHSlWibt5WgPami0R2QwnhRleqMtn7BXpudn5ROnHTtPOJgFAIA7c58VQgL1wpT7xHxXpZvZ+a73MadH3Adc83+/OaRTrXnP39wrW6456nJzycCqvbCb1QFXHW0rxEtF3NbTun0whWNNJbfKiq7pblUlXa+8232TH9zuabdrZx2XCLmlu1bEdLxvvkvTXVvqXrrj5aJsK81P6fs+S8sAAAAAAAAAAAAAPJKYS3430pP3B0p+R5lOyW8VSn4DAAAAANbt80t3EljpLoqAO0hGLnPA3TMjGzoD7hwa2dAZMH1kY17A9KK/GlrJA6ZfR6XSdHtRpps22DhXOfJwh6sXkx6VA3pWeua7kRZAw0OSlnIK2CyNpf9TTj1oC5xri6dZ8TRrxOknadG8Vnpc0k7a48uULS0AAHhQDFiL5L2yn6o96irm9LzTFraXph/d0t1Oi3QdGcr+OP2646hYKa3VUEmrozRRV0eRfk/EXG1Xes8z7wMAAHAHPgHhchfsTyUPMgAAAABJRU5ErkJggg==) center center repeat scroll,
                url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0AgMAAAC2uDcZAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURQAAAP///////////zjAO6gAAAAEdFJOUwAXO2Yymfg6AAAId0lEQVR42u1dS27jOBA1gWFO0NTCcxkfwYtIwMjrXrS08FVmEd9gvIgMtG7Qukxn4dwgXljDIIOeWCYlip96nbjeMgH8bIksFlmvHhcLBuNTQq6Q7Pk9kr3cA8lFfQQ+etGe11D2v5HsPZJ9i2Rf1P0DcsYh3/sia4BjfiFzbKjlte5Drs/QFTJHjllR7IHzVVaPSPbDM/DFZ+0JuEpk3ZmGXSHZRW4aXgUVe/UAZJft3vjkTyRj/q47Gsf885qG/cUQU1XzOB1p5ToC+3llinW7aXYVnkFII7vIHT65dHg+07sO02fk009V1KfgR68/w/MXiG2ErNn7+en9SnhM8B87Mdj9cyjsbmkDZc9+INkldK8msHu1L7zvYTAYDAaDwWAwGAwGg8GAQ9iONBVFpV1+W5n/kecE52ZZYz6QFsUjQQUnsxyLyqohYF/2T2b2A0XNdNkfzezteUfB/mJ+I12/o3jvVnYCIZ+5akhVLxaHPZK9NL9eRaMTUOZpLRuSGoGwRGCoPkRAlTmLHKomUxcP3lLdIyrhWFZ7FbAMK/dVzFLVzf2XYTHj1W6MGmJRNt5BQRQ757dmrs2K6vyPd1I1Y0qb69Ky7r3Z1cFdgFL3P41JgD+7Ft84s2+isxczpD9LI00Ie9m7L6L/VcUHczSQ3fm3y7cMdxD8dfL34M/u/t7fJGvDOSqr5wl2e5dHMWPUvcn1hnNUR5u1b0Ar2rlL+HCOTkpUZbm3BTTV7GeuUFqWeT9Yhsc/QavKbF9PVbvZEWIwyqZkNSOKOjm78acwzlG1WvgMrdmLszlCjPyIOdPK77eLak/EborNoj3SsGft8frDZGfX0kVlN8oytYrRylB2x3jsRlmmGGEvvoerJMcD51jn1ruApsIPYkxzdEwJqcpfX7dIdBywsY+sdwGtjPgOLmbCyOf+vw7Uifr6nLqXkvW2CZfxFEWp6o+tfwoYY2xC2ZdYpWoDVap+QypVF1ilKoPBYDAYDAaDwWAwGAwGg8FgMBiMD4QRZQUBoL6wY8oKAvYt1hf2FIHd11R4TNuQfvBo9vDqtfSVRkdxeVLV3vPR1xHYM6uJ2ZRzWRlBs1NYpTdTrySLoOS3y46m9CAxfGGt7NOuYxEirZ19S+AyPcIeXY1yrWsq+6OVPbYq4boLp+xsgyu6c5morqgKq4I1unOZYV1SjU3BGt25zOCWrqyrTHTnMoPmTloVrNHbXkyzSNknyCI9e6LMx/Q+N1R+5cr02sj8yo1EMpGO8TqsmR6yoOow24AtHn9C2Z+A7H8Gsoug1CULZFeWQOv2pWQbJte0tPlLt84Gs/uz+4Mvzf2FynHnFWZRYGvzLxy7/2XY/s7ca6XbkAg64F97cHbG93ne49h10yMRu7Hlsu1997yfgp0iOWmN3ZlE7NLcxCZrCscLHW2M71dUJJpzS/OiDsAkmaE5ngsSj5mRpW+FI1fgnw4kBx+Lt8hj8bGGQ4Lf3kEva+tu+Kq4LfTCsvKEjDbZI3DMOxyLi5Sx+H76+yFrlKpBLgX64Bc4J0uSlNvGXvfHW2WXWPYt+LdjRx10xpEcbtjZkZE2/4pcgxW0vVdAL5+MM2+h7NDdoiiRlQ1RP0K3iy/Q7eKn2bDNdnKJuWETsw88Ym7YZLmbO4Yiuq+MeHfZsIxXL/a4DVPFy4/mmBH+Girxdt39CbjuzbEDTMGOPHJAsye6AVa6sSc603fKQepzmt2NUw4iUpVybK7ZgyUjkXm57BxykGSmVea7dodIZVrllgHVidjdMqBUllluqtdklllOOYjNMkuExqCycRh14q+1ZbcbmjQ5RTHLnjr4vDsoBymRWwbwRcc12DrvdjV4Syh71iHfu4TaBgro2VDS/j65Qv4ybO9gCRVJ1B+/dzBtzpfut2NlCj1SpoBln+rRSFson+jRkGmj/IRIQqWNhRP5boHUKIBrlhWyXoutVWtZ8NMNsyPfO5adRpBtnXHIbN7WEUOV8uZYjQIy3V/Mme3Qbyqx2vGvyBFa0KzG5mo1VS5gadag0W7pq6hMM0Gr5ihyAcvVeUSrsb6W6x7HnnXI9ihsa5j5Wi6qXMBycZ8guQjaphPQl2BTxHnb/WY07VHGa7nIcgHVIFsTjNdyEWYR0CQGe2rNYDAYDAaDwWD8TlBQ7QF0Z+DRLRF3RwjcmHh0SxCcBNDgtjsGbpg95k3n88d8izwByhpgfV2bfEPjPFRf9ymuO5bQEzyFHLt0nrbmoHXGmr1iZe5PN8sOlrlD2eV3qCS5Qs44cLniD/RKgzXwwJqXQEVREUxrpP8HyPACeOFfv7dYJM9ap/2ze9WGSg9EgItD1oU2E4c4WMRg928EtChR5iCEPXzUBbQhWiyS523nvb+/bIKz6sxfPivL4B1FwJ0pIlzwEnJnSv7xLbIYDAbjpgC931RAVw2sglBf2wZ89AX05F57POHYtW8y2Ll4DWVfMTtm1CWfcfkIe/LOnzEfjyJ5H8KYh0n6u0ruuv3IKpP6td/1R/s/vyySsyMdZu96pNcG+joUKDvUY2VRQqu39K2+772EBHkCkYP1fMg5XkE1Llg9X/fMqjJmvy12rJ4Pq6hDegXpRRV6rR9WIoH1DmEwGL8rBNYhFdtnj1UvIbNvWSEv/NJKDqBiMYKG5lOzSyR7wlTJgT1h2S5rJ3ceCVNkh73++PZAhoQLh3OOshsr26mQBzPds/latht5PGVQRXHyfGuibBd239WkT7hmHztkT+w7fF04u5BTb9NemXDNfiGn3qbtJXk1sF3ZE5LEnSy6bLcf/uHdo18m7qMZGhdfeotmP9KukUPTZnl4L2iWifunhmW7Sx85kfpE+n6YjF242BH3U6gO6acLZm+Rbr7ygEzCsRsQfYUE1CcW27TzoeTU/wJHgZKTCUhpgwAAAABJRU5ErkJggg==) center center repeat fixed transparent;
      background-size: 450px auto;
      animation: snowing 20s linear infinite;
      pointer-events: none;
      z-index: 9998;
    }

    /* Story Page CSS Typewriter Effect */
    .story-wrapper {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-direction: column;
      padding: 2rem;
      z-index: 10;
    }

    .story-typing {
      font-family: "Courier New", Courier, monospace;
      font-size: 20px;
      line-height: 22px;
      white-space: pre-wrap;
      text-align: left;
      color: var(--ink-dark);
      width: 100%;
      max-width: 800px;
      min-height: 400px;
      padding: 2rem;
      background: #e8e8e8;
      border: 1px solid #e8e8e8;
      border-radius: 0.5em;
      box-shadow:
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
      position: relative;
      overflow: hidden;
      word-wrap: break-word;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: all 0.15s ease-in-out;
    }

    .story-typing.typing-active::after {
      content: "";
      display: inline-block;
      width: 1px;
      height: 20px;
      background-color: #000;
      animation: blink 0.5s infinite both;
      vertical-align: text-bottom;
    }


    @keyframes blink {
      0% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }

    /* Text line disappearing animations - reverse of appearance */
    .intro-text-line.fade-out {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.8s ease;
    }

    .text-line.fade-out {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.8s ease;
    }

    /* Button disappearing animation - exact reverse of appearance */
    .fade-out-button {
      animation: fadeOut 0.8s ease forwards;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* Story prompt text */
    .story-prompt {
      margin-top: 1rem;
    }

    /* ========== INTERACTIVE TUTORIAL SYSTEM ========== */
    /* Tutorial overlay system - four separate masks */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .tutorial-highlight {
      position: absolute;
      border: 3px solid #ff4444;
      border-radius: 12px;
      pointer-events: none;
      transition: all 0.3s ease;
      animation: pulse-border-red 2s ease-in-out infinite;
      z-index: 10000;
    }

    .tutorial-highlight.success {
      border-color: #22c55e;
      animation: pulse-border-green 2s ease-in-out infinite;
    }

    @keyframes pulse-border-red {
      0%, 100% { 
        border-color: #ff4444;
        box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
      }
      50% { 
        border-color: #ff6666;
        box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
      }
    }

    @keyframes pulse-border-green {
      0%, 100% { 
        border-color: #22c55e;
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
      }
      50% { 
        border-color: #16a34a;
        box-shadow: 0 0 30px rgba(34, 197, 94, 0.8);
      }
    }

    /* Mouse-following instruction box */
    .tutorial-instruction {
      position: fixed;
      background: white;
      color: #2c2c2c;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
      max-width: 300px;
      line-height: 1.4;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -100%) translateY(-10px);
      transition: opacity 0.3s ease;
    }

    .tutorial-instruction.visible {
      opacity: 1;
    }

    .tutorial-instruction::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: white;
    }

    /* Tutorial progress indicator */
    .tutorial-progress {
      position: fixed;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 11px;
      z-index: 10001;
      pointer-events: none;
    }

    /* Tutorial system - all interactions remain enabled */

    /* Tutorial feedback animations */
    .tutorial-feedback {
      position: fixed;
      background: #00ff88;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      z-index: 10002;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .tutorial-feedback.show {
      opacity: 1;
      transform: scale(1);
    }

    @keyframes checkmark {
      0% { transform: scale(0) rotate(0deg); }
      50% { transform: scale(1.2) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }

    .tutorial-checkmark {
      display: inline-block;
      animation: checkmark 0.6s ease-in-out;
    }

    .story-prompt {
      text-align: center;
      font-size: 1rem;
      color: var(--ink-medium);
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .story-prompt.visible {
      opacity: 1;
    }

    /* Final Page Specific Styles */
    #final-page .story-wrapper {
      z-index: 100;
    }

    #final-page .story-typing {
      z-index: 101;
    }

    #final-page .story-prompt {
      z-index: 102;
    }

    /* Snow Animation */
    @keyframes snowing {
      from { 
        background-position-y: 0px, 0px; 
      }
      to { 
        background-position-y: 900px, 450px; 
      }
    }

    @-webkit-keyframes snowing {
      from { 
        background-position-y: 0px, 0px; 
      }
      to { 
        background-position-y: 900px, 450px; 
      }
    }

    @-moz-keyframes snowing {
      from { 
        background-position-y: 0px, 0px; 
      }
      to { 
        background-position-y: 900px, 450px; 
      }
    }

    /* Neumorphism Base Classes */
    .neu-flat {
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius);
      box-shadow: 
        0.3rem 0.3rem 0.6rem var(--neu-shadow-dark),
        -0.2rem -0.2rem 0.5rem var(--neu-shadow-light);
      border: none;
      transition: all 0.3s ease;
    }

    .neu-inset {
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.2rem 0.2rem 0.5rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      border: none;
      transition: all 0.3s ease;
    }

    .neu-pressed {
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.2rem 0.2rem 0.4rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.3rem var(--neu-shadow-inset-light);
      transform: scale(0.98);
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--neu-bg);
      color: var(--ink-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: none;
      border-radius: 0;
    }

    .header h1 {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--ink-dark), var(--ink-medium));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: none;
    }

    /* Phase pools display style */
    #phase-pools-display {
      position: absolute;
      top: calc(50% + 20px);
      left: 25px;
      transform: translateY(-50%);
      font-family: 'VT323', monospace;
      font-size: 1.7rem;
      font-weight: 400;
      color: var(--ink-dark);
      background: var(--neu-bg);
      padding: 12px 20px;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      min-width: 180px;
      text-align: center;
    }

    /* Cumulative processed emails display style */
    #processed-display {
      position: absolute;
      top: calc(50% + 20px);
      right: 252px;
      transform: translateY(-50%);
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.8rem;
      font-weight: 500;
      color: var(--stamp-green);
      background: var(--neu-bg);
      padding: 12px 20px;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
    }

    /* Date display style */
    #date-display {
      position: absolute;
      top: calc(50% + 20px);
      right: 155px;
      transform: translateY(-50%);
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.8rem;
      font-weight: 500;
      color: var(--stamp-green);
      background: var(--neu-bg);
      padding: 12px 20px;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
    }

    /* Red clock style */
    #clock {
      position: absolute;
      top: calc(50% + 20px);
      right: 20px;
      transform: translateY(-50%);
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.8rem;
      font-weight: 500;
      color: var(--stamp-red);
      background: var(--neu-bg);
      padding: 12px 20px;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
    }

    /* Main layout */
    .main-container {
      display: flex;
      width: 100%;
      height: 100vh;
      padding: 100px 20px 10px 20px;
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius-large);
      margin: 0;
      box-shadow: none;
      gap: 6px;
      min-height: 500px;
    }

    /* Letters panel */
    .letters-panel {
      width: 280px;
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius);
      overflow: hidden;
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      display: flex;
      flex-direction: column;
      margin: 2px;
      height: 100%;
    }

    .letters-header {
      background: transparent;
      color: var(--ink-dark);
      padding: 12px 16px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      border-radius: 0;
      position: sticky;
      top: 0;
      z-index: 2;
      margin: 0;
      box-shadow: none;
      text-align: center;
    }

    #letters-list{
      flex:1;
      overflow-y:auto;
    }

    .letter-item {
      margin: 2px auto;
      position: relative;
      display: block;
      width: 90%;
      color: #090909;
      padding: 4px 1.0em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      cursor: pointer;
      border: 1px solid #e8e8e8;
      transition: all 0.3s;
      box-shadow: none;
      z-index: 1;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInLetter 0.8s ease-out forwards;
    }

    @keyframes fadeInLetter {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .letter-item:first-child {
      margin-top: 2px;
    }

    .letter-item::before {
      content: '';
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      border-radius: 2px;
      background: linear-gradient(135deg, var(--stamp-red), rgba(185, 28, 28, 0.8));
      box-shadow: 
        inset 1px 1px 2px rgba(255,255,255,0.3),
        inset -1px -1px 2px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .letter-item.fact-checked::before {
      background: linear-gradient(135deg, var(--stamp-green), rgba(22, 101, 52, 0.8));
    }

    .letter-item:active {
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    .letter-item.selected {
      background: linear-gradient(135deg, var(--neu-bg), var(--highlight-yellow));
      transform: translateX(4px);
      box-shadow: 
        inset 0.1rem 0.1rem 0.3rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }

    .letter-item.selected::before {
      background: linear-gradient(135deg, var(--stamp-red), rgba(185, 28, 28, 0.8));
    }
    
    .letter-item.fact-checked.selected::before {
      background: linear-gradient(135deg, var(--stamp-green), rgba(22, 101, 52, 0.8));
    }
    
    .letter-item.fact-checked.selected {
      background: linear-gradient(135deg, var(--neu-bg), #bbf7d0);
    }

    /* Grayed out letter style for penalties */
    .letter-item.penalized {
      opacity: 0.5;
      color: #999;
      background: #f0f0f0;
    }

    .letter-item.penalized .letter-sender,
    .letter-item.penalized .letter-preview {
      color: #999;
    }

    /* Penalty notification */
    .penalty-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc2626;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.2rem;
      z-index: 10000;
      transform: translateY(-100px);
      opacity: 0;
      transition: all 0.5s ease;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .penalty-notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Previous day error tiles */
    .tile.previous-day-error {
      border: 2px solid #dc2626;
      box-shadow: 0 0 10px rgba(220, 38, 38, 0.3);
    }

    .letter-sender {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
      color: var(--ink-dark);
    }

    .letter-preview {
      font-size: 0.8rem;
      color: var(--ink-medium);
      line-height: 1.3;
    }

    /* Content panel */
    .content-panel {
      width: 360px;
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius);
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: 2px;
      height: 100%;
      position: relative;
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
    }

    .content-header {
      background: transparent;
      color: var(--ink-dark);
      padding: 12px 16px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      border-radius: 0;
      box-shadow: none;
      text-align: center;
    }

    .content-body {
      flex: 1;
      padding: 4px;
      overflow-y: auto;
      background: var(--neu-bg);
      margin: 8px;
      border: none;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.2rem 0.2rem 0.5rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      position: relative;
      /* Chat-like behavior for message items */
      display: flex;
      flex-direction: column;
    }

    .content-title {
      display: none;
    }

    .content-text {
      line-height: 1.6;
      font-size: 0.95rem;
      white-space: pre-wrap;
      color: var(--ink-medium);
    }

    /* Content inner container matching letters-inner-container styling */
    /* Removed content-inner-container - styles moved to #content-paragraphs */

    /* Removed content-paragraphs - using content-body directly */
    
    /* Scroll styling for content-body */
    .content-body::-webkit-scrollbar {
      width: 8px;
    }
    
    .content-body::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
    }
    
    .content-body::-webkit-scrollbar-thumb {
      background: var(--neu-shadow-inset-dark);
      border-radius: 4px;
    }

    /* Content paragraph items with transparent background */
    .content-paragraph-item {
      margin: 3px 6px;
      position: relative;
      display: block;
      width: calc(100% - 12px);
      color: #090909;
      padding: 6px 0.8em;
      font-size: 0.95rem;
      line-height: 1.6;
      border-radius: 0.5em;
      background: transparent;
      cursor: default;
      transition: all 0.2s ease;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.5s ease forwards;
      /* Disable all selection and interaction */
      pointer-events: none;
      user-select: none;
      /* Align slightly left for incoming messages */
      align-self: flex-start;
      /* No special z-index */
    }
    
    /* User continue message styling - lower z-index */
    .content-paragraph-item.user-message {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      /* Align to right to simulate user response */
      align-self: flex-end;
      margin: 3px 6px;
      max-width: 70%;
      width: 70%;
      text-align: right;
      padding: 6px 0.8em;
      /* Disable selection */
      pointer-events: none;
      user-select: none;
    }
    
    /* Removed typing-complete and selected states - no interaction needed */

    .content-paragraph-item:hover {
      background: #ddd;
      transform: translateY(-1px);
    }

    .content-paragraph-item:first-child {
      margin-top: 6px;
    }

    /* Content control buttons */
    .content-control-buttons {
      padding: 8px;
      text-align: center;
      position: relative;
      z-index: 1;
      margin-top: 8px;
    }

    .content-control-btn {
      background: var(--neu-bg);
      border: none;
      padding: 8px 16px;
      border-radius: var(--neu-border-radius);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 
        0.2rem 0.2rem 0.5rem var(--neu-shadow-dark),
        -0.2rem -0.2rem 0.5rem var(--neu-shadow-light);
    }

    .content-control-btn:hover {
      box-shadow: 
        0.1rem 0.1rem 0.3rem var(--neu-shadow-dark),
        -0.1rem -0.1rem 0.3rem var(--neu-shadow-light);
    }

    .content-control-btn:active {
      box-shadow: 
        inset 0.1rem 0.1rem 0.3rem var(--neu-shadow-dark),
        inset -0.1rem -0.1rem 0.3rem var(--neu-shadow-light);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Tools panel */
    .tools-panel {
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius);
      padding: 16px;
      margin: 8px;
      box-shadow: 
        inset 0.2rem 0.2rem 0.5rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
    }

    .tools-header {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      color: var(--ink-dark);
      padding: 8px 0;
      background: transparent;
      border-radius: none;
      box-shadow: none;
    }

    .tool-item {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      cursor: grab;
      user-select: none;
      position: relative;
      color: #090909;
      padding: 0.7em 1.7em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      border: 1px solid #e8e8e8;
      transition: all 0.3s;
      box-shadow:
        6px 6px 12px #c5c5c5,
        -6px -6px 12px #ffffff;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .tool-item::before {
      content: '';
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      border-radius: 2px;
      background: linear-gradient(135deg, var(--stamp-green), rgba(22, 101, 52, 0.8));
      box-shadow: 
        inset 1px 1px 2px rgba(255,255,255,0.3),
        inset -1px -1px 2px rgba(0,0,0,0.2);
    }

    .tool-item:active {
      cursor: grabbing;
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    .tool-item.size-small::before { 
      background: linear-gradient(135deg, var(--stamp-green), rgba(22, 101, 52, 0.8)); 
    }
    .tool-item.size-medium::before { 
      background: linear-gradient(135deg, var(--stamp-green), rgba(22, 101, 52, 0.8)); 
    }
    .tool-item.size-large::before { 
      background: linear-gradient(135deg, var(--stamp-green), rgba(22, 101, 52, 0.8)); 
    }
    .tool-item.reject { 
      background: #e8e8e8;
    }
    .tool-item.reject::before { 
      background: linear-gradient(135deg, var(--stamp-red), rgba(185, 28, 28, 0.8)); 
    }

    .tool-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Grid panel */
    .grid-panel {
      flex: 1;
      background: var(--neu-bg);
      display: flex;
      flex-direction: column;
      position: relative;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      margin: 2px;
      height: 100%;
    }

    .grid-header {
      background: transparent;
      color: var(--ink-dark);
      padding: 12px 20px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      border: none;
      border-radius: 0;
      box-shadow: none;
    }

    .grid-stats {
      background: var(--neu-bg);
      color: var(--ink-medium);
      padding: 8px 20px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      border: none;
      margin: 8px;
      border-radius: var(--neu-border-radius-small);
      box-shadow: 
        inset 0.1rem 0.1rem 0.3rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }

    .grid-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: var(--neu-bg);
      overflow: hidden;
      filter: url(#goo);
      border-radius: var(--neu-border-radius);
      margin: 8px;
      box-shadow: 
        inset 0.2rem 0.2rem 0.4rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.3rem var(--neu-shadow-inset-light);
      min-height: 0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap: 0;
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius-small);
      padding: 4px;
      position: relative;
      box-shadow: 
        0.4rem 0.4rem 0.8rem var(--neu-shadow-dark),
        -0.3rem -0.3rem 0.6rem var(--neu-shadow-light);
      aspect-ratio: 4/5;
      width: min(100%, calc((100vh - 200px) * 0.8));
      max-width: calc(100vh * 0.6);
      max-height: calc(100vh - 200px);
      margin: 0 auto;
    }


    .cell {
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius-small);
      aspect-ratio: 1/1;
      transition: all 0.3s ease;
      position: relative;
      margin: 1px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    .cell::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        linear-gradient(to right, transparent 0px, transparent 9px, var(--stamp-red) 9px, var(--stamp-red) 10px),
        linear-gradient(to bottom, transparent 0px, transparent 9px, var(--stamp-red) 9px, var(--stamp-red) 10px);
      background-size: 10px 10px;
      opacity: 0.15;
      pointer-events: none;
      z-index: 1;
    }

    .cell.drag-over {
      background: var(--highlight-yellow);
      border: 2px solid var(--stamp-red);
      box-sizing: border-box;
    }

    /* Show wound area */
    .cell.bleed {
      background-color: rgba(128, 0, 0, 0.6);
    }

    /* Gooey droplet effect */
    .particle {
      /* legacy red drip disabled */
      display: none;
      position: absolute;
      width: 20px;
      height: 20px;
      background: rgba(128, 0, 0, 0.8);
      border-radius: 50%;
      filter: url(#goo) blur(6px);
      animation: fall 4s infinite ease-in;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes fall {
      0%   { transform: translateY(0); opacity: 1; }
      80%  { opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    /* Multi-cell wound overlay */
    .wound {
      position: absolute;
      background: rgba(128, 0, 0, 0.85);          /* same opacity as base */
      border-radius: 6px 6px 10px 10px;           /* softer corners, round bottom */
      /* filter: url('#goo') blur(4px); */              /* softer blur edge - temporarily disabled */
      pointer-events: none;
      z-index: 4;   /* above base, below droplets */
    }

    /* Blood base puddle at bottom of grid */
    .blood-base {
      position: fixed;           /* stick to viewport, not grid */
      bottom: 0;                 /* hug the very bottom edge of the browser window */
      left: 50%;                 /* horizontally center relative to viewport */
      transform: translateX(-50%);
      z-index: 2;                /* stay above background but below tiles */
      /* width, height, border-radius, background, etc. remain unchanged */
    }

    /* @keyframes fade-in removed (loader only) */

    /* Blue drip effect (loader style) */
    .blue-drops {
      position: absolute;
      pointer-events: none;
      filter: url('#liquid');
      overflow: visible;          /* be sure falling drops aren't clipped */
      z-index: 3;   /* now one layer above wound */
    }
    .blue-drops .drop1,
    .blue-drops .drop2 {
      /* same tone as wound‑red, with slight translucency for blending */
      position: absolute;
      left: 0;
      /* right: 0; */   /* REMOVED for drop2, will override below */
      /* margin: auto; */ /* REMOVED for drop2, will override below */
      bottom: 0;
      background-color: rgba(128, 0, 0, 0.85);
      mix-blend-mode: multiply;   /* fuse visually with underlying wound */
    }
    .blue-drops .drop1 {
      position: absolute;
      left: -2px;                 /* stretch 2 px beyond wound on each side */
      right: -2px;
      width: calc(100% + 4px);    /* total +4 px width */
      height: 30px;               /* was 26px – a bit taller */
      margin-top: -62px;          /* another 20 px upward */
      border-radius: 15px;        /* adjust roundness */
      background-color: rgba(128, 0, 0, 0.85);
      filter: url('#liquid') blur(14px);  /* stronger blur to merge */
      /* mix-blend-mode: multiply;  /* disabled for color‑uniform test */
      pointer-events: none;
    }
    .blue-drops .drop2 {
      width: 26px;   /* smaller droplet */
      height: 30px;
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      /* left is set dynamically in JS */
      /* removed transform: translateX(-50%); */
      background-color: rgba(178, 18, 18, 0.95);   /* brighter red */
      filter: url('#liquid') blur(1px);            /* crisp edge */
      /* mix-blend-mode: multiply;  ⟵ removed to avoid darkening */
      animation: drop var(--anim,1.3s) cubic-bezier(1,.19,.66,.12) forwards;
      z-index: 5;
      will-change: transform;  /* GPU acceleration hint */
    }
    @keyframes drop {
      0%   { transform: translateY(0); }
      100% { transform: translateY(var(--dist, 200px)); }
    }

    /* @keyframes wave removed (loader only) */

    body {
      background-color: #e8e8e8;
    }

    /* .loader, .loader span, .loader-bg, .drops, .drop1, .drop2 (LOADING overlay) removed */


    /* Content blocks */
    .tile {
      position: absolute;
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius-small);
      box-shadow: none;
      cursor: move;
      transition: all 0.3s ease;
      padding: 0;
      overflow: hidden;
      color: var(--ink-dark);
      text-align: left;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      z-index: 10;
    }
    
    .tile-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 12px 14px;
      overflow: hidden;
    }
    
    .tile-title {
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.2;
    }
    
    .tile-text {
      flex: 1;
      line-height: 1.4;
      overflow-y: auto; /* Vertical scrollbar */
    }
    
    /* Size-specific styles */
    .tile[data-size="small"] .tile-title {
      font-size: 0.95rem;
    }
    .tile[data-size="small"] .tile-text {
      font-size: 0.85rem;
    }

    .tile[data-size="medium"] .tile-title {
      font-size: 1.05rem;
    }
    .tile[data-size="medium"] .tile-text {
      font-size: 0.95rem;
    }

    .tile[data-size="large"] .tile-title {
      font-size: 1.15rem;
    }
    .tile[data-size="large"] .tile-text {
      font-size: 1.00rem;
    }

    .tile:hover {
      transform: translateY(-2px);
      box-shadow: 
        0.4rem 0.4rem 0.8rem var(--neu-shadow-dark),
        -0.3rem -0.3rem 0.6rem var(--neu-shadow-light);
      z-index: 20;
    }

    .tile.dragging {
      transform: rotate(3deg) scale(1.05);
      z-index: 100;
      opacity: 0.9;
      box-shadow: 
        0.6rem 0.6rem 1.2rem var(--neu-shadow-dark),
        -0.4rem -0.4rem 0.8rem var(--neu-shadow-light);
    }

    /* Ghost preview */
    .ghost {
      position: absolute;
      background: rgba(255, 255, 255, 0.3);
      border: 2px dashed var(--stamp-red);
      border-radius: var(--neu-border-radius-small);
      pointer-events: none;
      z-index: 50;
      transition: all 0.1s ease;
    }

    .ghost.valid {
      background: rgba(34, 197, 94, 0.2);
      border-color: var(--stamp-green);
    }

    .ghost.invalid {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--stamp-red);
    }

    /* Verification panel */
    .verification-panel {
      width: 320px;
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius);
      display: flex;
      flex-direction: column;
      box-shadow: 
        inset 0.3rem 0.3rem 0.6rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      margin: 2px;
      height: 100%;
    }

    .verification-header {
      background: transparent;
      color: var(--ink-dark);
      padding: 12px 16px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      border-radius: 0;
      box-shadow: none;
      text-align: center;
    }

    .verification-body {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      background: var(--neu-bg);
      margin: 8px;
      border: none;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.2rem 0.2rem 0.5rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .fact-check-button {
      display: block;
      width: calc(100% - 32px);
      margin: 16px;
      flex: none;
      color: var(--stamp-red);
      padding: 0.7em 1.7em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      cursor: pointer;
      border: 1px solid #e8e8e8;
      transition: all 0.3s;
      box-shadow:
        6px 6px 12px #c5c5c5,
        -6px -6px 12px #ffffff;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .fact-check-button:active {
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    .fact-check-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Fact Check 结果区：自适应高度，内部滚动 */

    #fact-check-results {
      flex: 1;
      overflow-y: auto;
      margin: 0;
      width: 100%;
      min-height: 200px;
      position: relative;
      padding-top: 12px;
    }
    
    
    #fact-check-results::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    #fact-check-results::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    #fact-check-results::-webkit-scrollbar-thumb {
      background: #e8e8e8;
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        2px 2px 4px #c5c5c5,
        -2px -2px 4px #ffffff,
        4px 0px 6px #c5c5c5,
        -4px 0px 6px #ffffff;
    }
    
    #fact-check-results::-webkit-scrollbar-thumb:hover {
      background: #e0e0e0;
    }
    
    #fact-check-results::-webkit-scrollbar-thumb:active {
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 2px 2px 4px #c5c5c5,
        inset -2px -2px 4px #ffffff;
    }

    /*
    .verification-glass-button {
      z-index: 10;
      position: fixed;
      background: rgba(180, 220, 180, 0.12);
      border: 1px solid rgba(160, 200, 160, 0.25);
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.1rem 0.1rem 0.3rem rgba(0, 0, 0, 0.1),
        inset -0.1rem -0.1rem 0.2rem rgba(200, 255, 200, 0.35);
      pointer-events: none;
    }

    .verification-glass-container {
      position: absolute;
      inset: 0;
      border-radius: var(--neu-border-radius);
      height: 100%;
      width: 100%;
    }

    .verification-glass-effect-backdrop {
      border-radius: var(--neu-border-radius);
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      -webkit-backdrop-filter: blur(0.5px);
      backdrop-filter: blur(0.5px);
    }

    .verification-glass-effect {
      border-radius: 9999px;
      position: absolute;
      left: 0px;
      right: 0;
      height: 1.2rem;
      width: 100%;
      -webkit-backdrop-filter: url(#queue-distortion);
      backdrop-filter: url(#queue-distortion);
    }

    .verification-glass-effect.top {
      top: 0;
    }

    .verification-glass-effect.bottom {
      bottom: 0;
    }

    .verification-glass-effect.left {
      left: 0;
      top: 0;
      bottom: 0;
      width: 1.2rem;
      height: 100%;
    }

    .verification-glass-effect.right {
      right: 0;
      left: auto;
      top: 0;
      bottom: 0;
      width: 1.2rem;
      height: 100%;
    }
    */

    .fact-check-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transition: opacity 400ms ease-out;
    }

    .fact-check-loading.show {
      opacity: 1;
    }

    .fact-check-loading .main {
      display: flex;
      align-items: center;
      justify-content: center;
      transform: scale(0.6);
    }

    .fact-check-loading .loaders,
    .fact-check-loading .loadersB {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fact-check-loading .loader {
      position: absolute;
      width: 1.15em;
      height: 13em;
      border-radius: 50px;
      background: #e0e0e0;
    }
    .fact-check-loading .loader:after {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 1.15em;
      height: 5em;
      background: #e0e0e0;
      border-radius: 50px;
      border: 1px solid #e2e2e2;
      box-shadow:
        inset 5px 5px 15px #d3d2d2ab,
        inset -5px -5px 15px #e9e9e9ab;
      mask-image: linear-gradient(
        to bottom,
        black calc(100% - 48px),
        transparent 100%
      );
    }
    .fact-check-loading .loader::before {
      content: "";
      position: absolute;
      bottom: 0;
      right: 0;
      width: 1.15em;
      height: 4.5em;
      background: #e0e0e0;
      border-radius: 50px;
      border: 1px solid #e2e2e2;
      box-shadow:
        inset 5px 5px 15px #d3d2d2ab,
        inset -5px -5px 15px #e9e9e9ab;
      mask-image: linear-gradient(
        to top,
        black calc(100% - 48px),
        transparent 100%
      );
    }
    .fact-check-loading .loaderA {
      position: absolute;
      width: 1.15em;
      height: 13em;
      border-radius: 50px;
      background: transparent;
    }
    .fact-check-loading .ball0,
    .fact-check-loading .ball1,
    .fact-check-loading .ball2,
    .fact-check-loading .ball3,
    .fact-check-loading .ball4,
    .fact-check-loading .ball5,
    .fact-check-loading .ball6,
    .fact-check-loading .ball7,
    .fact-check-loading .ball8,
    .fact-check-loading .ball9 {
      width: 1.15em;
      height: 1.15em;
      box-shadow:
        rgba(0, 0, 0, 0.17) 0px -10px 10px 0px inset,
        rgba(0, 0, 0, 0.15) 0px -15px 15px 0px inset,
        rgba(0, 0, 0, 0.1) 0px -40px 20px 0px inset,
        rgba(0, 0, 0, 0.06) 0px 2px 1px,
        rgba(0, 0, 0, 0.09) 0px 4px 2px,
        rgba(0, 0, 0, 0.09) 0px 8px 4px,
        rgba(0, 0, 0, 0.09) 0px 16px 8px,
        rgba(0, 0, 0, 0.09) 0px 32px 16px,
        0px -1px 15px -8px rgba(0, 0, 0, 0.09);
      border-radius: 50%;
      transition: transform 800ms cubic-bezier(1, -0.4, 0, 1.4);
      background-color: rgb(232, 232, 232, 1);
      animation: 3.63s move ease-in-out infinite;
    }
    .fact-check-loading .loader:nth-child(2) {
      transform: rotate(20deg);
    }
    .fact-check-loading .loader:nth-child(3) {
      transform: rotate(40deg);
    }
    .fact-check-loading .loader:nth-child(4) {
      transform: rotate(60deg);
    }
    .fact-check-loading .loader:nth-child(5) {
      transform: rotate(80deg);
    }
    .fact-check-loading .loader:nth-child(6) {
      transform: rotate(100deg);
    }
    .fact-check-loading .loader:nth-child(7) {
      transform: rotate(120deg);
    }
    .fact-check-loading .loader:nth-child(8) {
      transform: rotate(140deg);
    }
    .fact-check-loading .loader:nth-child(9) {
      transform: rotate(160deg);
    }

    .fact-check-loading .loaderA:nth-child(2) {
      transform: rotate(20deg);
    }
    .fact-check-loading .loaderA:nth-child(3) {
      transform: rotate(40deg);
    }
    .fact-check-loading .loaderA:nth-child(4) {
      transform: rotate(60deg);
    }
    .fact-check-loading .loaderA:nth-child(5) {
      transform: rotate(80deg);
    }
    .fact-check-loading .loaderA:nth-child(6) {
      transform: rotate(100deg);
    }
    .fact-check-loading .loaderA:nth-child(7) {
      transform: rotate(120deg);
    }
    .fact-check-loading .loaderA:nth-child(8) {
      transform: rotate(140deg);
    }
    .fact-check-loading .loaderA:nth-child(9) {
      transform: rotate(160deg);
    }

    .fact-check-loading .ball1 {
      animation-delay: 0.2s;
    }
    .fact-check-loading .ball2 {
      animation-delay: 0.4s;
    }
    .fact-check-loading .ball3 {
      animation-delay: 0.6s;
    }
    .fact-check-loading .ball4 {
      animation-delay: 0.8s;
    }
    .fact-check-loading .ball5 {
      animation-delay: 1s;
    }
    .fact-check-loading .ball6 {
      animation-delay: 1.2s;
    }
    .fact-check-loading .ball7 {
      animation-delay: 1.4s;
    }
    .fact-check-loading .ball8 {
      animation-delay: 1.6s;
    }
    .fact-check-loading .ball9 {
      animation-delay: 1.8s;
    }

    @keyframes move {
      0% {
        transform: translateY(0em);
      }
      50% {
        transform: translateY(12em);
      }
      100% {
        transform: translateY(0em);
      }
    }

    .fact-check-results-content {
      opacity: 0;
      transition: opacity 400ms ease-out;
      padding: 8px 12px 12px 12px;
    }

    .fact-check-results-content.show {
      opacity: 1;
    }

    .fact-check-placeholder {
      padding: 20px;
      opacity: 1;
      transition: opacity 400ms ease-out;
    }

    .fact-check-placeholder.hide {
      opacity: 0;
    }

    .fact-check-placeholder-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--ink-dark);
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 8px;
    }

    .fact-check-placeholder-text {
      line-height: 1.6;
      font-size: 0.95rem;
      white-space: pre-wrap;
      color: var(--ink-medium);
    }

    .log-header {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--ink-dark);
      margin: 0 16px 8px;
      flex: none;
      padding: 8px 0;
      background: transparent;
      border-radius: none;
      box-shadow: none;
    }

    .log-body {
      flex: none;
      background: var(--neu-bg);
      border: none;
      border-radius: var(--neu-border-radius-small);
      padding: 8px;
      height: 220px;
      overflow: hidden;
      box-shadow: 
        inset 0.18rem 0.18rem 0.36rem var(--neu-shadow-inset-dark),
        inset -0.09rem -0.09rem 0.27rem var(--neu-shadow-inset-light);
      margin: 8px;
      position: relative;
      /* Chart styles */
      display: flex;
      flex-direction: column;
      align-items: center;
      letter-spacing: -0.011em;
      font-family: sans-serif;
      font-size: 12px;
      color: #34495e;
    }
    
    #wrapper {
      width: 100%;
      height: 100%;
    }
    
    #wrapper svg {
      fill: #34495e;
      width: 100%;
      height: 100%;
    }
    
    .axis path,
    .axis line {
      stroke: #1347a6;
    }
    
    .axis text {
      fill: #1347a6;
      font-size: 10px;
    }
    
    .freezing {
      fill: #e0f3f3;
    }
    
    .line {
      fill: none;
      stroke: #af9358;
      stroke-width: 2;
    }
    
    .x-axis-label {
      fill: black;
      font-size: 1.2em;
      text-transform: capitalize;
    }
    
    /* Removed action button styles */

    .submit-button {
      display: block;
      width: calc(100% - 32px);
      margin: 16px;
      flex: none;
      margin-top: 16px;
      color: var(--stamp-green);
      padding: 0.7em 1.7em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      cursor: pointer;
      border: 1px solid #e8e8e8;
      transition: all 0.3s;
      box-shadow:
        6px 6px 12px #c5c5c5,
        -6px -6px 12px #ffffff;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .submit-button:active {
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    .fact-check-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }


    .fact-check-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--ink-dark);
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 8px;
    }

    .fact-claim {
      font-weight: 600;
      margin: 12px 0 8px 0;
      color: var(--ink-dark);
    }

    .fact-data {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--ink-medium);
    }

    .fact-data ul {
      list-style: none;
      padding-left: 0;
    }

    .fact-data li {
      padding: 4px 0;
      padding-left: 20px;
      position: relative;
    }

    .fact-data li:before {
      content: "•";
      position: absolute;
      left: 8px;
      color: var(--stamp-blue);
    }

    .fact-data strong {
      color: var(--ink-dark);
      font-weight: 600;
    }

    .fact-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
    }

    .fact-section:last-child {
      border-bottom: none;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--neu-light), var(--neu-dark));
      border-radius: 4px;
      box-shadow: 
        0.1rem 0.1rem 0.2rem var(--neu-shadow-dark),
        -0.1rem -0.1rem 0.2rem var(--neu-shadow-light);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--ink-medium), var(--ink-light));
    }

    /* Thinner scrollbar, only for tile-text */
    .tile-text::-webkit-scrollbar {
      width: 4px;
    }
    .tile-text::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 2px;
      box-shadow: 
        inset 0.05rem 0.05rem 0.1rem var(--neu-shadow-inset-dark),
        inset -0.05rem -0.05rem 0.1rem var(--neu-shadow-inset-light);
    }
    .tile-text::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--neu-light), var(--neu-dark));
      border-radius: 2px;
      box-shadow: 
        0.05rem 0.05rem 0.1rem var(--neu-shadow-dark),
        -0.05rem -0.05rem 0.1rem var(--neu-shadow-light);
    }
    .tile-text::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--ink-medium), var(--ink-light));
    }

    /* Add same scrollbar style as content-body for letters-list */
    #letters-list::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    #letters-list::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      margin: 8px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    #letters-list::-webkit-scrollbar-thumb {
      background: #e8e8e8;
      border-radius: 4px;
      margin: 8px;
      box-shadow: 
        2px 2px 4px #c5c5c5,
        -2px -2px 4px #ffffff,
        4px 0px 6px #c5c5c5,
        -4px 0px 6px #ffffff;
    }
    
    #letters-list::-webkit-scrollbar-thumb:hover {
      background: #e0e0e0;
    }
    
    #letters-list::-webkit-scrollbar-thumb:active {
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 2px 2px 4px #c5c5c5,
        inset -2px -2px 4px #ffffff;
    }

    /* Inner container for correspondence emails matching content-body styling */
    .letters-inner-container {
      flex: 1;
      margin: 8px;
      border: none;
      border-radius: var(--neu-border-radius);
      background: var(--neu-bg);
      overflow: hidden;
      position: relative;
    }

    /* Fixed inner shadow overlay using pseudo-element */
    .letters-inner-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.2rem 0.2rem 0.5rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.5rem var(--neu-shadow-inset-light);
      pointer-events: none;
      z-index: 10;
    }

    /* Update letters-list to handle scrolling inside the shadow container */
    #letters-list{
      height: 100%;
      overflow-y: auto;
      padding: 2px 0;
      position: relative;
      z-index: 1;
    }

    /* Ensure content-body scrollbar uses correct color and is inset */
    .content-body::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    .content-body::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    .content-body::-webkit-scrollbar-thumb {
      background: #e8e8e8;
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        2px 2px 4px #c5c5c5,
        -2px -2px 4px #ffffff,
        4px 0px 6px #c5c5c5,
        -4px 0px 6px #ffffff;
    }
    
    .content-body::-webkit-scrollbar-thumb:hover {
      background: #e0e0e0;
    }
    
    .content-body::-webkit-scrollbar-thumb:active {
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 2px 2px 4px #c5c5c5,
        inset -2px -2px 4px #ffffff;
    }

    /* Expense panel scrollbar - matching main simulator style */
    .expenses-panel::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    .expenses-panel::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    .expenses-panel::-webkit-scrollbar-thumb {
      background: #e8e8e8;
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        2px 2px 4px #c5c5c5,
        -2px -2px 4px #ffffff,
        4px 0px 6px #c5c5c5,
        -4px 0px 6px #ffffff;
    }
    
    .expenses-panel::-webkit-scrollbar-thumb:hover {
      background: #e0e0e0;
    }
    
    .expenses-panel::-webkit-scrollbar-thumb:active {
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 2px 2px 4px #c5c5c5,
        inset -2px -2px 4px #ffffff;
    }

    /* === DAILY SUMMARY PAGE STYLES === */
    .summary-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: relative;
      z-index: 1200;
    }

    .summary-main {
      text-align: center;
      background: var(--neu-bg);
      padding: 2rem;
      border-radius: var(--neu-border-radius-large);
      box-shadow: 
        inset 0.5rem 0.5rem 1rem var(--neu-shadow-inset-dark),
        inset -0.3rem -0.3rem 0.8rem var(--neu-shadow-inset-light);
      width: 400px;
      height: 350px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .savings-display {
      margin-bottom: 2rem;
    }

    .savings-label {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--ink-medium);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .savings-amount {
      font-family: 'VT323', monospace;
      font-size: 4rem;
      font-weight: bold;
      color: var(--stamp-green);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .savings-amount.animating {
      transform: scale(1.1);
      color: var(--stamp-blue);
    }

    .savings-amount.decreasing {
      transform: scale(1.1);
      color: var(--stamp-red);
    }

    .summary-text {
      font-family: "Courier New", Courier, monospace;
      font-size: 1.1rem;
      color: var(--ink-dark);
      margin-bottom: 0;
      padding: 1rem;
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius);
      box-shadow: 
        inset 0.2rem 0.2rem 0.4rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.4rem var(--neu-shadow-inset-light);
      height: 200px;
      overflow-y: auto;
      width: 100%;
      box-sizing: border-box;
      text-align: left;
      line-height: 1.6;
    }
    
    .summary-text.typing::after {
      content: '|';
      animation: blink 1s infinite;
      color: var(--ink-dark);
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* Add same scrollbar style as expense panel for summary text */
    .summary-text::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    .summary-text::-webkit-scrollbar-track {
      background: var(--neu-bg);
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        inset 0.1rem 0.1rem 0.2rem var(--neu-shadow-inset-dark),
        inset -0.1rem -0.1rem 0.2rem var(--neu-shadow-inset-light);
    }
    
    .summary-text::-webkit-scrollbar-thumb {
      background: #e8e8e8;
      border-radius: 4px;
      margin: 14px;
      box-shadow: 
        2px 2px 4px #c5c5c5,
        -2px -2px 4px #ffffff,
        4px 0px 6px #c5c5c5,
        -4px 0px 6px #ffffff;
    }
    
    .summary-text::-webkit-scrollbar-thumb:hover {
      background: #e0e0e0;
    }
    
    .summary-text::-webkit-scrollbar-thumb:active {
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 2px 2px 4px #c5c5c5,
        inset -2px -2px 4px #ffffff;
    }

    .summary-next-btn {
      display: block;
      color: var(--stamp-green);
      padding: 0.7em 1.2em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      cursor: pointer;
      border: 1px solid #e8e8e8;
      transition: all 0.2s ease-in-out;
      box-shadow:
        6px 6px 12px #c5c5c5,
        -6px -6px 12px #ffffff;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: absolute;
      top: calc(50% + 200px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 120px;
    }
    
    .summary-next-btn.wide {
      min-width: 180px;
      padding: 0.7em 2em;
    }

    .summary-next-btn:active {
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    /* Expenses Container */
    .expenses-container {
      position: absolute;
      left: calc(50% - 500px);
      top: calc(50% - 175px);
      width: 260px;
      height: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }

    .expenses-title {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--ink-dark);
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Expenses Panel */
    .expenses-panel {
      background: var(--neu-bg);
      padding: 1.5rem;
      border-radius: var(--neu-border-radius-large);
      box-shadow: 
        inset 0.5rem 0.5rem 1rem var(--neu-shadow-inset-dark),
        inset -0.3rem -0.3rem 0.8rem var(--neu-shadow-inset-light);
      width: 100%;
      height: 280px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .expenses-list {
      margin-bottom: 2rem;
    }

    /* New toggle-style expense items */
    .expense-toggle {
      padding: 10px 6px;
      min-height: 50px;
      width: 100%;
      display: flex;
      align-items: center;
      color: var(--ink-medium);
      transition: ease all 200ms;
      margin-bottom: 0.6rem;
      background: transparent;
    }
    
    .expense-toggle.active {
      color: var(--stamp-blue);
    }
    
    .expense-toggle.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    
    .expense-toggle.required {
      border-left: 3px solid var(--stamp-red);
    }
    
    .expense-toggle__info {
      font-family: 'Nunito Sans', sans-serif;
      flex: 1;
      padding: 0 0 0 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
    }
    
    .expense-toggle__name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--ink-dark);
      line-height: 1.2;
    }
    
    .expense-toggle__cost {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 14px;
      color: var(--stamp-red);
      font-weight: 500;
    }
    
    .expense-toggle__toggler {
      flex: 0 0 80px;
    }
    
    .expense-toggle__toggler label {
      position: relative;
      display: flex;
      align-items: center;
      height: 35px;
      width: 100%;
      border-radius: 18px;
      box-shadow: inset -6px -6px 4px 0px #f6f6f6, inset 6px 6px 4px 0px #cecece;
      cursor: pointer;
    }
    
    .expense-toggle__toggler input {
      position: absolute;
      height: 0;
      width: 0;
      opacity: 0;
    }
    
    .expense-toggle__toggler input:checked + span {
      left: 40px;
      background: var(--stamp-green);
      box-shadow: 2px 2px 4px 0px rgba(22, 101, 52, 0.4);
    }
    
    .expense-toggle__toggler input:checked + span:after {
      content: 'ON';
      font-family: 'Nunito Sans', sans-serif;
      font-size: 10px;
      color: #fff;
      font-weight: 600;
    }
    
    .expense-toggle__toggler span {
      height: 22px;
      width: 32px;
      border-radius: 18px;
      position: absolute;
      left: 8px;
      background: var(--neu-bg);
      transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 2px 2px 4px 0px rgba(0, 0, 0, 0.27);
    }
    
    .expense-toggle__toggler span:after {
      content: 'OFF';
      font-family: 'Nunito Sans', sans-serif;
      font-size: 10px;
      font-weight: 600;
      color: var(--ink-medium);
    }


    /* Family Status Container */
    .family-status-container {
      position: absolute;
      right: calc(50% - 500px);
      top: calc(50% - 175px);
      width: 260px;
      height: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .family-title {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--ink-dark);
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Family status panel frame removed - only circles remain */

    .family-circles {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      row-gap: 1rem;
      column-gap: 2.5rem;
      padding: 0.5rem;
      justify-items: center;
      align-items: center;
      height: 300px;
      width: 100%;
      position: relative;
      z-index: 3;
      margin-top: 1rem;
    }

    .family-member {
      display: flex;
      justify-content: center;
      position: relative;
    }

    .family-member:first-child {
      grid-column: 1 / -1;
      justify-self: center;
    }

    .family-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: var(--neu-bg);
      box-shadow: 
        inset 0.2rem 0.2rem 0.4rem var(--neu-shadow-inset-dark),
        inset -0.2rem -0.2rem 0.4rem var(--neu-shadow-inset-light);
      transition: transform 0.3s ease;
      z-index: 2;
      will-change: transform;
    }

    .family-circle::before {
      content: '';
      position: absolute;
      top: -15px;
      left: -15px;
      right: -15px;
      bottom: -15px;
      border-radius: 50%;
      background: conic-gradient(from -90deg, var(--health-color, var(--stamp-green)) var(--health-percentage, 100%), #e0e0e0 0);
      mask: radial-gradient(circle at center, transparent 65%, black 65%, black 100%);
      -webkit-mask: radial-gradient(circle at center, transparent 65%, black 65%, black 100%);
      z-index: 1;
      transition: background 0.3s ease;
      will-change: background;
    }

    /* Remove percentage display - only show health ring */

    /* Death effects removed - just show health ring animation */

    .member-label {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      color: var(--ink-dark);
      z-index: 3;
      position: relative;
    }

    .next-day-btn {
      width: 100%;
      color: var(--stamp-green);
      padding: 0.7em 1.7em;
      font-size: 18px;
      border-radius: 0.5em;
      background: #e8e8e8;
      cursor: pointer;
      border: 1px solid #e8e8e8;
      transition: all 0.2s ease-in-out;
      box-shadow:
        6px 6px 12px #c5c5c5,
        -6px -6px 12px #ffffff;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .next-day-btn:active {
      color: #666;
      box-shadow:
        0px 0px 0px #c5c5c5,
        0px 0px 0px #ffffff,
        inset 4px 4px 12px #c5c5c5,
        inset -4px -4px 12px #ffffff;
    }

    /* Hourglass Styles - DISABLED */
    /*
    .hourglass-container {
      position: absolute;
      right: 200px;
      top: calc(50% + 20px - 45px);
      width: 90px;
      height: 90px;
      flex-shrink: 0;
      transform: scale(1.4);
    }

    .hourglass {
      position: relative;
      width: 100%;
      height: 100%;
      animation: rotateGlass 60s ease-in-out infinite;
      animation-play-state: paused;
    }

    @keyframes rotateGlass {
      0%, 90% { transform: rotate(0deg); }
      100% { transform: rotate(180deg); }
    }

    .hourglass-top {
      position: absolute;
      bottom: 50%; left: 50%;
      width: 25px;
      height: 14px;
      background: linear-gradient(135deg, #d8d8d8, #f0f0f0);
      border-radius: 4px 4px 15px 15px;
      transform: translateX(-50%) scale(1, 1.5);
      transform-origin: bottom;
      overflow: hidden;
      box-shadow: 
        inset 4px 4px 8px rgba(0, 0, 0, 0.25),
        inset -4px -4px 8px rgba(255, 255, 255, 0.8);
    }

    .hourglass-top::before {
      content: '';
      position: absolute;
      bottom: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--stamp-red);
      animation: sandHeightTop 60s linear infinite;
      animation-play-state: paused;
      filter: blur(1px);
    }

    @keyframes sandHeightTop {
      0% { height: 100%; }
      90%, 100% { height: 0%; }
    }

    .hourglass-bottom {
      position: absolute;
      top: 50%; left: 50%;
      width: 25px;
      height: 14px;
      background: linear-gradient(135deg, #d8d8d8, #f0f0f0);
      border-radius: 15px 15px 4px 4px;
      transform: translateX(-50%) scale(1, 1.5);
      transform-origin: top;
      overflow: hidden;
      box-shadow: 
        inset 4px 4px 8px rgba(0, 0, 0, 0.25),
        inset -4px -4px 8px rgba(255, 255, 255, 0.8);
    }

    .hourglass-bottom-sand {
      position: absolute;
      top: 100%; left: 0%;
      width: 100%;
      height: 100%;
      background-color: var(--stamp-red);
      transform: scale(3, 1);
      animation: sandTop 60s linear infinite;
      animation-play-state: paused;
    }

    .hourglass-bottom-sand::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      width: 25px;
      height: 25px;
      border-radius: 1px;
      background-color: var(--stamp-red);
      transform: translateX(-50%) rotate(45deg);
      animation: sandAngle 60s linear infinite;
      animation-play-state: paused;
      filter: blur(1px);
    }

    @keyframes sandTop {
      0% { top: 135%;}
      90%, 100% { top: 20%;}
    }

    @keyframes sandAngle {
      0% { border-radius: 1px;}
      90%, 100% { border-radius: 8px;}
    }

    .hourglass-mid {
      position: absolute;
      top: 50%; left: 50%;
      width: 3px;
      height: 1px;
      background: linear-gradient(135deg, #d0d0d0, #e8e8e8);
      border-radius: 1px;
      transform: translate(-50%, -50%);
      transform-origin: center;
      box-shadow: 
        inset 2px 2px 4px rgba(0, 0, 0, 0.2),
        inset -2px -2px 4px rgba(255, 255, 255, 0.9);
    }

    .hourglass-mid::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--stamp-red);
      width: 2px;
      height: 2px;
      border-radius: 50%;
      filter: blur(1px);
    }

    .hourglass-drop {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--stamp-red);
      width: 2px;
      height: 2px;
      border-radius: 50%;
      filter: blur(1px);
      animation: sandDrop 0.6s ease-in infinite, dropVis 60s linear infinite;
      animation-play-state: paused;
    }

    .hourglass-drop:nth-child(1) { 
      animation-delay: 0s, 60s;
      --dropx: -100%;
    }
    .hourglass-drop:nth-child(2) { 
      animation-delay: 0.06s, 60s;
      --dropx: -70%;
    }
    .hourglass-drop:nth-child(3) { 
      animation-delay: 0.12s, 60s;
      --dropx: -40%;
    }
    .hourglass-drop:nth-child(4) { 
      animation-delay: 0.18s, 60s;
      --dropx: -10%;
    }
    .hourglass-drop:nth-child(5) { 
      animation-delay: 0.24s, 60s;
      --dropx: 20%;
    }

    @keyframes sandDrop {
      from { top: 50%; transform: translate(-50%, -50%);}
      to { top: calc(50% + 20px); transform: translate(var(--dropx), -50%) scale(0.25);}
    }

    @keyframes dropVis {
      0% { opacity: 0; }
      1%, 100% { opacity: 1; }
    }

    .hourglass-glare {
      position: absolute;
      filter: blur(1px);
      width: 15px;
      height: 10px;
      border-radius: 50%;
      border-style: solid;
      border-width: 0 0 1px 0;
      opacity: 0.6;
    }

    .hourglass-glare:nth-child(1) {
      top: 19%; left: 29%;
      transform: rotate(70deg);
      animation: glrClr1 60s infinite linear;
    }
    .hourglass-glare:nth-child(2) {
      bottom: 19%; left: 29%;
      transform: rotate(110deg);
      animation: glrClr1 60s infinite linear;
    }
    .hourglass-glare:nth-child(3) {
      top: 19%; right: 29%;
      transform: rotate(-70deg);
      animation: glrClr2 60s infinite linear;
    }
    .hourglass-glare:nth-child(4) {
      bottom: 19%; right: 29%;
      transform: rotate(-110deg);
      animation: glrClr2 60s infinite linear;
    }

    @keyframes glrClr1 {
      0%, 90% { border-color: rgba(255, 255, 255, 0.4); }
      100% { border-color: rgba(0, 0, 0, 0.1); }
    }

    @keyframes glrClr2 {
      0%, 90% { border-color: rgba(0, 0, 0, 0.1); }
      100% { border-color: rgba(255, 255, 255, 0.4); }
    }
    */

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .header h1 {
      margin: 0;
    }

    /* Noise effect animation */
    @keyframes monitor-noise {
      0% {
        background-position: 50% 0, 60% 60%;
      }
      100% {
        background-position: 50% 0, 60% 50%;
      }
    }

    .noise-active {
      animation: monitor-noise 0.2s infinite alternate !important;
    }
  </style>
</head>
<body>
  <!-- Interactive Tutorial System -->
  <div id="tutorial-overlay" class="tutorial-overlay" style="display: none;"></div>
  <div id="tutorial-highlight" class="tutorial-highlight" style="display: none;"></div>
  <div id="tutorial-instruction" class="tutorial-instruction"></div>
  <div id="tutorial-progress" class="tutorial-progress" style="display: none;"></div>
  <div id="tutorial-feedback" class="tutorial-feedback"></div>

  <!-- Game Container with All Pages -->
  <!-- Background Music -->
  <audio id="background-music" loop preload="auto" volume="0.05">
    <source src="background-music.mp3.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- Button Click Sound -->
  <audio id="button-click-sound" preload="auto" volume="1.0">
    <source src="button-click.mp3.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Typing Sound for Letter Content -->
  <audio id="typing-sound" preload="auto" volume="0.1">
    <source src="Text Reveal 1.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Typing Sound for Other Pages -->
  <audio id="typing-sound-other" preload="auto" volume="0.3">
    <source src="medium-text-blip.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Static Noise Sound for Camera Switching -->
  <audio id="noise-sound" loop preload="auto" volume="0.5">
    <source src="tv-static-noise.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Alarm Sound for 17:00 Deadline -->
  <audio id="alarm-sound" preload="auto" volume="0.7">
    <source src="digital-alarm.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Drag Drop On Sound -->
  <audio id="pluck-on-sound" preload="auto" volume="0.6">
    <source src="notification-pluck-on.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Drag Drop Off Sound -->
  <audio id="pluck-off-sound" preload="auto" volume="0.6">
    <source src="notification-pluck-off.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Blood Dripping Sound -->
  <audio id="dripping-sound" loop preload="auto" volume="0.8">
    <source src="water-dripping-on-water.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Coins Earning Sound -->
  <audio id="coins-earning-sound" preload="auto" volume="0.5">
    <source src="coins-earning.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Coins Spent Sound -->
  <audio id="coins-spent-sound" preload="auto" volume="0.5">
    <source src="coins-spent.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  
  <!-- New Notification Sound -->
  <audio id="new-notification-sound" preload="auto" volume="0.6">
    <source src="new-notification.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <div id="game-container">
    
    <!-- Options Page - Main Navigation -->
    <div id="options-page" class="page active simple-page">
      <div class="snow-background"></div>
      <h1 style="margin-bottom: 2rem; color: var(--ink-dark);">Textbook Editorial Simulator</h1>
      <p style="margin-bottom: 3rem; color: var(--ink-medium); max-width: 600px;">Select where you want to start the simulation. Each option will take you through the complete experience from that point forward.</p>
      <div id="debug-info" style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; margin-bottom: 2rem; font-size: 12px;">
        Page loaded successfully. JavaScript is working.
        <div style="margin-top: 10px;">
          <button id="music-toggle-btn" onclick="toggleBackgroundMusic()" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 10px;">🎵 音乐: 开启</button>
          <button onclick="testButtonSound()" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">🔊 测试按钮音效</button>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; max-width: 900px; width: 100%;">
        <button class="options-nav-btn" onclick="jumpToPage('intro-page')">
          <h3>📄 Introduction</h3>
          <p>Unemployment, winter night, official letter</p>
        </button>
        
        <button class="options-nav-btn" onclick="jumpToPage('story-page')">
          <h3>📚 Story Background</h3>
          <p>Ministry of Memory instructions and context</p>
        </button>
        
        <button class="options-nav-btn" onclick="jumpToPage('pre-test-page')">
          <h3>🧠 Cultural Assessment</h3>
          <p>Psychological profiling and preparation</p>
        </button>
        
        <button class="options-nav-btn" onclick="jumpToPage('morning-news-page')">
          <h3>🌅 Day 1 - Morning Briefing</h3>
          <p>Daily news and preparation</p>
        </button>
        
        <button class="options-nav-btn" onclick="jumpToPage('main-game')">
          <h3>🎯 Editorial Simulator</h3>
          <p>Main game - letter processing and decisions</p>
        </button>
        
        <button class="options-nav-btn" onclick="jumpToPage('daily-recap-page')">
          <h3>📊 Daily Summary</h3>
          <p>Performance review and family status</p>
        </button>
        
        <button class="options-nav-btn" onclick="createFinalPage()">
          <h3>🏁 Final Results</h3>
          <p>Simulation conclusion and assessment</p>
        </button>
      </div>
      
      <div style="margin-top: 3rem; text-align: center;">
        <button class="options-nav-btn" onclick="jumpToPage('intro-page')" style="background: var(--stamp-green); color: white; font-weight: 600;">
          🎮 Start from Beginning (Recommended)
        </button>
      </div>
    </div>
    
    <!-- Intro Page -->
    <div id="intro-page" class="page hidden simple-page">
      <div style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
        <button onclick="returnToOptions()" style="background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">← Options (ESC)</button>
      </div>
      <div class="snow-background"></div>
      <div id="intro-text" class="intro-text-container"></div>
      <div class="intro-button-container">
        <button id="intro-next-btn" class="next-button" style="visibility: hidden;">NEXT</button>
      </div>
    </div>

    <!-- Story Page -->
    <div id="story-page" class="page hidden">
      <div style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
        <button onclick="returnToOptions()" style="background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">← Options (ESC)</button>
      </div>
      <div class="snow-background"></div>
      <div class="story-wrapper">
        <div id="story-text" class="story-typing"></div>
        <div id="story-prompt" class="story-prompt">Press ENTER to continue...</div>
      </div>
    </div>

    <!-- Pre-test Page -->
    <div id="pre-test-page" class="page hidden">
      <div style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
        <button onclick="returnToOptions()" style="background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">← Options (ESC)</button>
      </div>
      <div class="snow-background"></div>
      
      <!-- Cultural Test Intro -->
      <div id="cultural-intro" class="cultural-test-container">
        <div class="cultural-card neu-flat">
          <h1 class="cultural-title">Cultural Values Assessment</h1>
          <p class="cultural-description">Before beginning your editorial duties, we need to assess your cultural value orientations. This evaluation will help us understand your perspective on authority, tradition, and social structures - essential for your role in the Ministry of Memory.</p>
          <p class="cultural-note">This test measures five dimensions: Power Distance, Uncertainty Avoidance, Collectivism, Long-Term Orientation, and Masculinity.</p>
          <button class="next-button cultural-start-btn" onclick="startCulturalTest()">Begin Assessment</button>
        </div>
      </div>

      <!-- Cultural Test Questions -->
      <div id="cultural-questions" class="cultural-test-container hidden">
        <div class="cultural-questions-wrapper">
          <h2 class="cultural-subtitle">Cultural Values Assessment</h2>
          <div class="cultural-instructions">
            <p>For each statement, select how much you agree using the following scale:</p>
            <div class="scale-table">
              <div class="scale-header">
                <div class="scale-item">1</div>
                <div class="scale-item">2</div>
                <div class="scale-item">3</div>
                <div class="scale-item">4</div>
                <div class="scale-item">5</div>
              </div>
              <div class="scale-labels">
                <div class="scale-label">Strongly Disagree</div>
                <div class="scale-label">Disagree</div>
                <div class="scale-label">Neutral</div>
                <div class="scale-label">Agree</div>
                <div class="scale-label">Strongly Agree</div>
              </div>
            </div>
          </div>
          
          <div class="questions-container">
            <div class="questions-scroll">
              <form id="cultural-questions-form">
                <!-- Questions will be injected by JavaScript -->
              </form>
            </div>
          </div>
          
          <div class="cultural-progress">
            <div class="progress-bar neu-inset">
              <div class="progress-fill" id="cultural-progress-fill"></div>
            </div>
            <p class="progress-text" id="cultural-progress-text">0 of 26 questions answered</p>
          </div>
          
          <button class="next-button cultural-submit-btn" id="cultural-submit-btn" disabled onclick="submitCulturalTest()">Complete Assessment</button>
        </div>
      </div>

      <!-- Cultural Test Results -->
      <div id="cultural-results" class="cultural-test-container hidden">
        <div class="cultural-card neu-flat">
          <h2 class="cultural-subtitle">Assessment Complete</h2>
          <p class="cultural-completion">Your cultural profile has been recorded and will inform your editorial assignments.</p>
          
          <div class="results-grid" id="cultural-results-display">
            <!-- Results will be injected by JavaScript -->
          </div>
          
          <div class="results-note neu-inset">
            <p><strong>Classification: </strong><span id="cultural-classification">Processing...</span></p>
            <p class="classification-note">This profile determines your compatibility with Ministry protocols and editorial guidelines.</p>
          </div>
          
          <button class="next-button" onclick="startMainGameLoop()">Proceed to Editorial Duties</button>
        </div>
      </div>
    </div>

    <!-- Morning News Feed Page -->
    <div id="morning-news-page" class="page hidden simple-page">
      <div style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
        <button onclick="returnToOptions()" style="background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">← Options (ESC)</button>
      </div>
      <div class="snow-background"></div>
      <h1 id="morning-news-title">Day 1 - Morning Briefing</h1>
      <p id="morning-news-content">Good morning. Here are today's key developments you should be aware of before reviewing the letters...</p>
      <p style="margin-top: 20px; font-size: 16px; color: var(--ink-medium);">
        You have completed the preparation phase. You will now return to the main menu to begin your editorial duties.
      </p>
      <button class="next-button" onclick="startEditorialWork()">Start Editorial Work</button>
      <!-- TEMPORARY: Quick jump to final page for testing -->
      <button class="next-button" onclick="createFinalPage()" style="margin-left: 10px; background-color: #ff6b6b; color: white; display: none;">Jump to Final Page (TEMP)</button>
    </div>

    <!-- Main Game (Existing Simulator) -->
    <div id="main-game" class="page hidden">
      <div style="position: absolute; top: 20px; left: 20px; z-index: 10000;">
        <button onclick="returnToOptions()" style="background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">← Options (ESC)</button>
      </div>
      <div class="snow-background"></div>
  <!-- Glass Effect and Gooey bleed filters -->
  <svg style="position:absolute;width:0;height:0;" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
        <feTurbulence type="fractalNoise" baseFrequency="0 0" numOctaves="1" seed="9000" result="noise" />
        <feGaussianBlur in="noise" stdDeviation="0" result="blurred" />
        <feDisplacementMap in="SourceGraphic" in2="blurred" scale="0" xChannelSelector="R" yChannelSelector="G" />
      </filter>
      <filter id="goo">
        <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur"/>
        <feColorMatrix in="blur" mode="matrix"
          values="1 0 0 0 0 
                  0 1 0 0 0 
                  0 0 1 0 0 
                  0 0 0 20 -10" result="goo"/>
        <feBlend in="SourceGraphic" in2="goo"/>
      </filter>
    </defs>
  </svg>

  <svg style="position:absolute;width:0;height:0;" xmlns="http://www.w3.org/2000/svg" version="1.1">
    <defs>
      <filter id="liquid">
        <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="liquid" />
      </filter>
    </defs>
  </svg>
  <div class="header">
    <!-- Hourglass container - DISABLED -->
    <!--
    <div class="hourglass-container">
      <div class="hourglass">
        <div class="hourglass-top"></div>
        <div class="hourglass-bottom">
          <div class="hourglass-bottom-sand"></div>
        </div>
        <div class="hourglass-mid"></div>
        <div class="hourglass-drops">
          <div class="hourglass-drop"></div>
          <div class="hourglass-drop"></div>
          <div class="hourglass-drop"></div>
          <div class="hourglass-drop"></div>
          <div class="hourglass-drop"></div>
        </div>
        <div class="hourglass-glares">
          <div class="hourglass-glare"></div>
          <div class="hourglass-glare"></div>
          <div class="hourglass-glare"></div>
          <div class="hourglass-glare"></div>
        </div>
      </div>
    </div>
    -->
    <h1>Textbook Editorial Simulator</h1>
  </div>

  <div class="main-container">
    <!-- Letters Panel -->
    <div class="letters-panel">
      <div class="letters-header">Correspondence</div>
      <div class="letters-inner-container">
        <div id="letters-list"></div>
      </div>
      <!-- Queue area BEGIN -->
      <div id="queue-frame" style="width:calc(100% - 16px);height:380px;margin:8px;position:relative;overflow:hidden;flex:none;">
        
        <!-- Glass Effect Overlay (covers entire monitor) -->
        <div class="monitor-glass-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; pointer-events: none;"></div>
        <!-- Liquid Glass Effect -->
        <!--
        <div class="queue-glass-button">
          <div class="queue-glass-effect-backdrop"></div>
          <div class="queue-glass-container">
            <div class="queue-glass-effect top"></div>
            <div class="queue-glass-effect bottom"></div>
            <div class="queue-glass-effect left"></div>
            <div class="queue-glass-effect right"></div>
          </div>
        </div>
        -->
        
        <!-- SVG Filter for Distortion -->
        <svg style="display: none">
          <filter id="queue-distortion" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="turbulence" baseFrequency="0.01 0.1" numOctaves="1" result="turbulence"/>
            <feDisplacementMap in2="turbulence" in="SourceGraphic" scale="8" xChannelSelector="R" yChannelSelector="G"/>
          </filter>
        </svg>
        
        <style>
          /* Pixel art character styles for queue area */
          #queue-frame {
            --pixel-size: 2.9px;
            --grid-cell: calc(var(--pixel-size) * 16);
            --bg: #111;
            border: none !important;
            border-radius: var(--neu-border-radius) !important;
            background: var(--neu-bg) !important;
          }

          #queue-frame .pixel-art {
            image-rendering: pixelated;
          }

          #queue-frame .frame {
            width: 100%;
            height: 100%;
            position: relative;
          }

          #queue-frame .camera {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #111 !important;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            position: relative;
          }

          /* 监控glitch叠加层 */
          /*
          #queue-frame .camera::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
              repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.03) 2px,
                rgba(255,255,255,0.03) 4px
              );
            animation: scanlines 0.1s linear infinite;
            pointer-events: none;
            z-index: 5;
          }
          */

          /* 噪点层 */
          #queue-frame .camera::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
              radial-gradient(circle, transparent 1px, rgba(255,255,255,0.15) 1px);
            background-size: 4px 4px;
            animation: noise 0.2s steps(8) infinite;
            pointer-events: none;
            z-index: 6;
            opacity: 0;
          }

          @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
          }

          @keyframes noise {
            0%, 20% { opacity: 0; }
            10% { opacity: 0.1; }
            25%, 40% { opacity: 0; }
            30% { opacity: 0.15; }
            50%, 70% { opacity: 0; }
            60% { opacity: 0.08; }
            80%, 100% { opacity: 0; }
          }

          /* 随机glitch效果类 - 增强版 */
          /*
          #queue-frame .camera.glitch-shake {
            animation: shake-intense 0.15s ease-in-out;
          }

          #queue-frame .camera.glitch-rgb {
            filter: 
              drop-shadow(8px 0 0 red) 
              drop-shadow(-8px 0 0 cyan)
              drop-shadow(0 4px 0 yellow);
          }

          #queue-frame .camera.glitch-invert {
            filter: invert(1) hue-rotate(180deg) contrast(300%) brightness(150%);
            animation: invert-flicker 0.1s steps(3) infinite;
          }

          #queue-frame .camera.glitch-static {
            filter: contrast(500%) brightness(200%) saturate(0%) blur(2px);
            background: repeating-linear-gradient(
              45deg,
              #000 0px,
              #000 2px,
              #fff 2px,
              #fff 4px
            ) !important;
            animation: static-noise 0.05s steps(10) infinite;
          }

          #queue-frame .camera.glitch-distort {
            transform: translate(-48%, -52%) skew(8deg, 3deg) scale(1.1) rotate(2deg);
            filter: blur(1px);
            animation: distort-wave 0.2s ease-in-out;
          }

          #queue-frame .camera.signal-lost {
            background: #000 !important;
          }

          #queue-frame .camera.signal-lost::before,
          #queue-frame .camera.signal-lost::after {
            display: none;
          }

          #queue-frame .camera.glitch-lines::before {
            background: 
              linear-gradient(
                180deg,
                transparent 20%,
                rgba(255,255,255,0.1) 21%,
                rgba(255,255,255,0.1) 22%,
                transparent 23%,
                transparent 40%,
                rgba(255,255,255,0.08) 41%,
                rgba(255,255,255,0.08) 43%,
                transparent 44%,
                transparent 65%,
                rgba(255,255,255,0.12) 66%,
                rgba(255,255,255,0.12) 67%,
                transparent 68%
              );
          }

          #queue-frame .camera.glitch-vlines {
            background-image: 
              repeating-linear-gradient(
                90deg,
                transparent,
                transparent 4px,
                rgba(255,255,255,0.3) 4px,
                rgba(255,255,255,0.3) 6px,
                rgba(0,0,0,0.2) 6px,
                rgba(0,0,0,0.2) 8px
              ) !important;
            animation: vlines-flicker 0.1s steps(5) infinite;
          }

          #queue-frame .camera.glitch-pixelate {
            image-rendering: pixelated;
            filter: blur(2px) contrast(300%) brightness(80%);
            transform: translate(-50%, -50%) scale(0.8);
          }

          #queue-frame .camera.glitch-chromatic {
            filter: 
              drop-shadow(6px 0 0 red) 
              drop-shadow(-6px 0 0 cyan)
              drop-shadow(0 6px 0 yellow)
              drop-shadow(3px 3px 0 magenta);
            animation: chromatic-shift 0.1s ease-in-out infinite;
          }

          #queue-frame .camera.glitch-snow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
              radial-gradient(circle at 20% 50%, white 2px, transparent 2px),
              radial-gradient(circle at 40% 20%, white 1px, transparent 1px),
              radial-gradient(circle at 90% 90%, white 3px, transparent 3px),
              radial-gradient(circle at 70% 60%, white 2px, transparent 2px),
              radial-gradient(circle at 10% 90%, white 1px, transparent 1px);
            background-size: 30px 30px, 50px 40px, 60px 70px, 80px 60px, 25px 35px;
            animation: snow-intense 0.05s steps(15) infinite;
            opacity: 0.8;
            z-index: 8;
          }

          #queue-frame .camera.glitch-tear {
            clip-path: polygon(0 0, 100% 0, 70% 25%, 100% 35%, 80% 45%, 100% 55%, 90% 75%, 100% 85%, 0 100%);
            filter: contrast(200%) brightness(120%);
            animation: tear-shift 0.1s steps(4) infinite;
          }

          #queue-frame .camera.glitch-frequency {
            filter: 
              hue-rotate(180deg) 
              saturate(500%) 
              brightness(200%) 
              contrast(400%);
            animation: frequency-intense 0.08s ease-in-out infinite;
          }
          */

          @keyframes shake-intense {
            0%, 100% { transform: translate(-50%, -50%); }
            10% { transform: translate(-48%, -52%) rotate(1deg); }
            20% { transform: translate(-52%, -48%) rotate(-1deg); }
            30% { transform: translate(-49%, -51%) rotate(0.5deg); }
            40% { transform: translate(-51%, -49%) rotate(-0.5deg); }
            50% { transform: translate(-47%, -53%) rotate(1.5deg); }
            60% { transform: translate(-53%, -47%) rotate(-1.5deg); }
            70% { transform: translate(-49.5%, -50.5%) rotate(0.8deg); }
            80% { transform: translate(-50.5%, -49.5%) rotate(-0.8deg); }
            90% { transform: translate(-48.5%, -51.5%) rotate(0.3deg); }
          }

          @keyframes invert-flicker {
            0% { filter: invert(1) hue-rotate(180deg) contrast(300%) brightness(150%); }
            33% { filter: invert(0) hue-rotate(0deg) contrast(100%) brightness(100%); }
            66% { filter: invert(1) hue-rotate(360deg) contrast(400%) brightness(200%); }
            100% { filter: invert(1) hue-rotate(180deg) contrast(300%) brightness(150%); }
          }

          @keyframes static-noise {
            0% { transform: translate(-50%, -50%) scale(1); }
            20% { transform: translate(-50.2%, -49.8%) scale(1.02); }
            40% { transform: translate(-49.8%, -50.2%) scale(0.98); }
            60% { transform: translate(-50.1%, -49.9%) scale(1.01); }
            80% { transform: translate(-49.9%, -50.1%) scale(0.99); }
            100% { transform: translate(-50%, -50%) scale(1); }
          }

          @keyframes distort-wave {
            0% { transform: translate(-48%, -52%) skew(8deg, 3deg) scale(1.1) rotate(2deg); }
            50% { transform: translate(-52%, -48%) skew(-5deg, -2deg) scale(0.9) rotate(-1deg); }
            100% { transform: translate(-48%, -52%) skew(8deg, 3deg) scale(1.1) rotate(2deg); }
          }

          @keyframes vlines-flicker {
            0%, 100% { opacity: 1; }
            25% { opacity: 0.7; }
            50% { opacity: 0.3; }
            75% { opacity: 0.9; }
          }

          @keyframes chromatic-shift {
            0% { filter: drop-shadow(6px 0 0 red) drop-shadow(-6px 0 0 cyan) drop-shadow(0 6px 0 yellow) drop-shadow(3px 3px 0 magenta); }
            50% { filter: drop-shadow(-4px 0 0 red) drop-shadow(8px 0 0 cyan) drop-shadow(0 -4px 0 yellow) drop-shadow(-2px -2px 0 magenta); }
            100% { filter: drop-shadow(6px 0 0 red) drop-shadow(-6px 0 0 cyan) drop-shadow(0 6px 0 yellow) drop-shadow(3px 3px 0 magenta); }
          }

          @keyframes snow-intense {
            0% { opacity: 0.8; background-position: 0 0, 10px 5px, 20px 10px, 30px 15px, 40px 20px; }
            25% { opacity: 0.6; background-position: 5px 2px, 15px 8px, 25px 12px, 35px 18px, 45px 22px; }
            50% { opacity: 0.9; background-position: 10px 4px, 20px 10px, 30px 15px, 40px 20px, 50px 25px; }
            75% { opacity: 0.4; background-position: 15px 6px, 25px 12px, 35px 18px, 45px 22px, 55px 28px; }
            100% { opacity: 0.8; background-position: 20px 8px, 30px 15px, 40px 20px, 50px 25px, 60px 30px; }
          }

          @keyframes tear-shift {
            0% { clip-path: polygon(0 0, 100% 0, 70% 25%, 100% 35%, 80% 45%, 100% 55%, 90% 75%, 100% 85%, 0 100%); }
            25% { clip-path: polygon(0 0, 100% 0, 85% 20%, 100% 40%, 75% 50%, 100% 60%, 95% 80%, 100% 90%, 0 100%); }
            50% { clip-path: polygon(0 0, 100% 0, 60% 30%, 100% 25%, 90% 40%, 100% 65%, 85% 70%, 100% 95%, 0 100%); }
            75% { clip-path: polygon(0 0, 100% 0, 75% 35%, 100% 45%, 85% 35%, 100% 70%, 80% 85%, 100% 80%, 0 100%); }
            100% { clip-path: polygon(0 0, 100% 0, 70% 25%, 100% 35%, 80% 45%, 100% 55%, 90% 75%, 100% 85%, 0 100%); }
          }

          @keyframes frequency-intense {
            0% { filter: hue-rotate(180deg) saturate(500%) brightness(200%) contrast(400%); }
            25% { filter: hue-rotate(270deg) saturate(300%) brightness(80%) contrast(600%); }
            50% { filter: hue-rotate(0deg) saturate(800%) brightness(250%) contrast(200%); }
            75% { filter: hue-rotate(90deg) saturate(150%) brightness(150%) contrast(500%); }
            100% { filter: hue-rotate(180deg) saturate(500%) brightness(200%) contrast(400%); }
          }

          /* ========== LIQUID GLASS EFFECT FOR QUEUE ========== */
          /*
          .queue-glass-button {
            z-index: 10;
            position: absolute;
            inset: 0;
            background: rgba(180, 220, 180, 0.12);
            border: 1px solid rgba(160, 200, 160, 0.25);
            border-radius: var(--neu-border-radius);
            box-shadow: 
              inset 0.1rem 0.1rem 0.3rem rgba(0, 0, 0, 0.1),
              inset -0.1rem -0.1rem 0.2rem rgba(200, 255, 200, 0.35);
            pointer-events: none;
          }

          .queue-glass-container {
            position: absolute;
            inset: 0;
            border-radius: var(--neu-border-radius);
            height: 100%;
            width: 100%;
          }

          .queue-glass-effect-backdrop {
            border-radius: var(--neu-border-radius);
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            -webkit-backdrop-filter: blur(0.5px);
            backdrop-filter: blur(0.5px);
          }

          .queue-glass-effect {
            border-radius: 9999px;
            position: absolute;
            left: 0px;
            right: 0;
            height: 1.2rem;
            width: 100%;
            -webkit-backdrop-filter: url(#queue-distortion);
            backdrop-filter: url(#queue-distortion);
          }

          .queue-glass-effect.top {
            top: 0;
          }

          .queue-glass-effect.bottom {
            bottom: 0;
          }

          .queue-glass-effect.left {
            left: 0;
            top: 0;
            bottom: 0;
            width: 1.2rem;
            height: 100%;
          }

          .queue-glass-effect.right {
            right: 0;
            left: auto;
            top: 0;
            bottom: 0;
            width: 1.2rem;
            height: 100%;
          }
          */

          /* ========== LIQUID GLASS EFFECT FOR CONTENT BODY ========== */
          /*
          .content-glass-button {
            z-index: 10;
            position: fixed;
            background: rgba(180, 220, 180, 0.12);
            border: 1px solid rgba(160, 200, 160, 0.25);
            border-radius: var(--neu-border-radius);
            box-shadow: 
              inset 0.1rem 0.1rem 0.3rem rgba(0, 0, 0, 0.1),
              inset -0.1rem -0.1rem 0.2rem rgba(200, 255, 200, 0.35);
            pointer-events: none;
          }

          .content-glass-container {
            position: absolute;
            inset: 0;
            border-radius: var(--neu-border-radius);
            height: 100%;
            width: 100%;
          }

          .content-glass-effect-backdrop {
            border-radius: var(--neu-border-radius);
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            -webkit-backdrop-filter: blur(0.5px);
            backdrop-filter: blur(0.5px);
          }

          .content-glass-effect {
            border-radius: 9999px;
            position: absolute;
            left: 0px;
            right: 0;
            height: 1.2rem;
            width: 100%;
            -webkit-backdrop-filter: url(#queue-distortion);
            backdrop-filter: url(#queue-distortion);
          }

          .content-glass-effect.top {
            top: 0;
          }

          .content-glass-effect.bottom {
            bottom: 0;
          }

          .content-glass-effect.left {
            left: 0;
            top: 0;
            bottom: 0;
            width: 1.2rem;
            height: 100%;
          }

          .content-glass-effect.right {
            right: 0;
            left: auto;
            top: 0;
            bottom: 0;
            width: 1.2rem;
            height: 100%;
          }
          */

          /* ========== LIQUID GLASS EFFECT FOR LOG BODY ========== */
          /*
          .log-glass-button {
            z-index: 10;
            position: fixed;
            background: rgba(180, 220, 180, 0.12);
            border: 1px solid rgba(160, 200, 160, 0.25);
            border-radius: var(--neu-border-radius-small);
            box-shadow: 
              inset 0.1rem 0.1rem 0.3rem rgba(0, 0, 0, 0.1),
              inset -0.1rem -0.1rem 0.2rem rgba(200, 255, 200, 0.35);
            pointer-events: none;
          }

          .log-glass-container {
            position: absolute;
            inset: 0;
            border-radius: var(--neu-border-radius-small);
            height: 100%;
            width: 100%;
          }

          .log-glass-effect-backdrop {
            border-radius: var(--neu-border-radius-small);
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            -webkit-backdrop-filter: blur(0.5px);
            backdrop-filter: blur(0.5px);
          }

          .log-glass-effect {
            border-radius: 9999px;
            position: absolute;
            left: 0px;
            right: 0;
            height: 1.2rem;
            width: 100%;
            -webkit-backdrop-filter: url(#queue-distortion);
            backdrop-filter: url(#queue-distortion);
          }

          .log-glass-effect.top {
            top: 0;
          }

          .log-glass-effect.bottom {
            bottom: 0;
          }

          .log-glass-effect.left {
            left: 0;
            top: 0;
            bottom: 0;
            width: 1.2rem;
            height: 100%;
          }

          .log-glass-effect.right {
            right: 0;
            left: auto;
            top: 0;
            bottom: 0;
            width: 1.2rem;
            height: 100%;
          }
          */

          #queue-frame .map {
            image-rendering: pixelated;
            background-image: url("https://assets.codepen.io/21542/CameraDemoMap.png");
            background-size: calc(13 * var(--grid-cell)) calc(10 * var(--grid-cell));
            width: calc(13 * var(--grid-cell));
            height: calc(10 * var(--grid-cell));
            position: absolute;
            top: 53%;
            left: 50%;
            transform: translate(-50%, -50%);
            filter: grayscale(100%);
          }

          #queue-frame .character {
            width: calc(var(--grid-cell) * 2);
            height: calc(var(--grid-cell) * 2);
            position: absolute;
            overflow: hidden;
          }

          #queue-frame .shadow {
            width: calc(var(--grid-cell) * 2);
            height: calc(var(--grid-cell) * 2);
            position: absolute;
            left: 0;
            top: 0;
            background: url("https://assets.codepen.io/21542/DemoRpgCharacterShadow.png") no-repeat no-repeat;
            background-size: 100%;
          }

          #queue-frame .character_spritesheet {
            position: absolute;
            background: url("https://assets.codepen.io/21542/DemoRpgCharacter.png") no-repeat no-repeat;
            background-size: 100%;
            width: calc(var(--grid-cell) * 8);
            height: calc(var(--grid-cell) * 8);
          }

          #queue-frame .character[facing="right"] .character_spritesheet {
            background-position-y: calc(var(--pixel-size) * -32);
          }
          #queue-frame .character[facing="up"] .character_spritesheet {
            background-position-y: calc(var(--pixel-size) * -64);
          }
          #queue-frame .character[facing="left"] .character_spritesheet {
            background-position-y: calc(var(--pixel-size) * -96);
          }
          #queue-frame .character[walking="true"] .character_spritesheet {
            animation: queueWalkAnimation 0.6s steps(4) infinite;
          }

          @keyframes queueWalkAnimation {
            from {
              transform: translate3d(0%, 0%, 0);
            }
            to {
              transform: translate3d(-100%, 0%, 0);
            }
          }

          /* Speaker container styles */
          #queue-frame .horn-container {
            position: absolute;
            right: 8px;
            top: 8px;
            cursor: pointer;
            z-index: 15;
            display: flex;
            align-items: center;
            flex-direction: row;
          }
          
          #queue-frame .horn-icon {
            width: 30px;
            height: 30px;
            background: #e8e8e8;
            border: 1px solid #e8e8e8;
            border-radius: 50%;
            user-select: none;
            box-shadow:
              0px 0px 0px #c5c5c5,
              0px 0px 0px #ffffff,
              inset 4px 4px 12px #c5c5c5,
              inset -4px -4px 12px #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
          }

          /* 小喇叭按动回弹效果 */
          #queue-frame .horn-icon:active {
            transform: scale(0.95);
          }
          
          /* Popup styles */
          #queue-frame .next-popup {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%) translateX(12px) scale(0.8);
            background: white;
            color: black;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: 'Nunito Sans', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            will-change: transform, opacity;
            border: 1px solid #ddd;
          }
          
          /* Popup arrow pointing right */
          #queue-frame .next-popup::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-left-color: white;
          }
          
          /* Show popup with smooth animation */
          #queue-frame .next-popup.show {
            opacity: 1;
            transform: translateY(-50%) translateX(0) scale(1);
          }
          
          /* 已移除震动动画 */
          
          /* 移除震动动画 */
          #queue-frame .horn-container.clicked .horn-icon {
            /* 不应用任何动画 */
          }

          /* Remove decorative corners */
          #queue-frame .corner_topleft,
          #queue-frame .corner_topright,
          #queue-frame .corner_bottomleft,
          #queue-frame .corner_bottomright {
            display: none !important;
          }

          /* REC indicator styles */
          .rec-indicator {
            position: absolute;
            top: 10px;
            left: 14px;
            display: flex;
            align-items: center;
            z-index: 5;
          }
          .rec-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff2222;
            margin-right: 7px;
            box-shadow: 0 0 6px 2px #ff2222;
            animation: rec-blink 1.3s steps(1) infinite;
          }
          @keyframes rec-blink {
            0%, 55% { opacity: 1; }
            65%, 100% { opacity: 0.3; }
          }
          .rec-text {
            color: #ff2222;
            font-family: 'Nunito Sans', sans-serif;
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 1px;
          }
        </style>
        <div class="frame">
          <!-- REC indicator -->
          <div class="rec-indicator">
            <span class="rec-dot"></span>
            <span class="rec-text">REC</span>
          </div>
          <div class="camera">
            <div class="map pixel-art">
              <div id="queue-character-container"></div>
            </div>
            <!-- Avatar display overlay -->
            <div id="avatar-display" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: none; z-index: 8;">
              <img id="avatar-image" src="" alt="Sender Avatar" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.1); object-fit: cover; filter: grayscale(100%) contrast(1.1);">
            </div>
            <!-- Noise effect overlay -->
            <div id="noise-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; z-index: 12; pointer-events: none; background: repeating-radial-gradient(#000 0 0.0001%,#fff 0 0.0002%) 50% 0/2500px 2500px, repeating-conic-gradient(#000 0 0.0001%,#fff 0 0.0002%) 60% 60%/2500px 2500px; background-blend-mode: difference;"></div>
          </div>
          <div id="queue-next-btn" class="horn-container" tabindex="0">
            <div class="horn-icon">📢</div>
            <div class="next-popup" id="next-popup">NEXT</div>
          </div>
        </div>
      </div>
      <!-- Queue area END -->
    </div>

    <!-- Content Panel -->
    <div class="content-panel">
      <div class="content-header">Letter Content</div>
      <div class="content-body">
        <div class="content-title" id="content-title">Select a Letter</div>
        <div class="content-text" id="content-text" style="display: none;"></div>
      </div>
      
      <!-- Continue Button -->
      <button class="fact-check-button" id="continue-btn">Continue</button>
      
      <div class="tools-panel">
        <div class="tools-header">Editorial Tools</div>
        <div class="tool-item size-small" draggable="true">Small (2×1)</div>
        <div class="tool-item size-medium" draggable="true">Medium (2×2)</div>
        <div class="tool-item size-large" draggable="true">Large (3×2)</div>
        <div class="tool-item reject" draggable="true">Reject</div>
      </div>
    </div>

    <!-- Grid Panel -->
    <div class="grid-panel">
      <div class="grid-header">Page Layout</div>
      <div class="grid-stats">
        <span id="tile-count">0</span> elements placed • 
        <span id="space-used">0</span>% page coverage
      </div>
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
    </div>

    <!-- Verification Panel -->
    <div class="verification-panel">
      <div class="verification-header">Fact Verification</div>
      <div class="verification-body">
        <!-- Liquid Glass Effect -->
        <!--
        <div class="verification-glass-button">
          <div class="verification-glass-effect-backdrop"></div>
          <div class="verification-glass-container">
            <div class="verification-glass-effect top"></div>
            <div class="verification-glass-effect bottom"></div>
            <div class="verification-glass-effect left"></div>
            <div class="verification-glass-effect right"></div>
          </div>
        </div>
        -->
        <div id="fact-check-results" style="position: relative;">
          <div id="fact-check-placeholder" class="fact-check-placeholder">
            <div class="fact-check-placeholder-title">Ready for Fact Check</div>
            <div class="fact-check-placeholder-text">Click the "Fact Check" button below to verify the claims in the selected letter.</div>
          </div>
        </div>
      </div>
      <button class="fact-check-button disabled" id="fact-check-btn">Fact Check</button>
      <div class="log-body" id="action-log" style="position: relative;">
        <!-- Glass Effect Overlay (covers entire chart area) -->
        <div class="chart-glass-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; pointer-events: none;"></div>
        
        <!-- Line Chart Container -->
        <div id="wrapper"></div>
      </div>
      <button class="submit-button" id="submit-btn">Submit</button>
    </div>
  </div>
    </div> <!-- End of main-game -->

    <!-- Daily Summary Page -->
    <div id="daily-recap-page" class="page hidden">
      <div class="snow-background"></div>
      <div class="summary-container">
        <div class="summary-main">
          <!-- Large SAVINGS Display -->
          <div class="savings-display">
            <div class="savings-label">SAVINGS</div>
            <div class="savings-amount" id="savings-amount">$0</div>
          </div>
          
          <!-- Summary Text -->
          <div class="summary-text" id="summary-text">
            Day 1, you processed 8 letters.
          </div>
        </div>
        
        <!-- Next Button (Moved outside savings frame) -->
        <button class="summary-next-btn" id="summary-next-btn" onclick="nextSummaryStep()">NEXT</button>
        
        <!-- Expenses Panel (Hidden initially) -->
        <div class="expenses-container" id="expenses-container" style="display: none;">
          <h3 class="expenses-title">Daily Expenses</h3>
          <div class="expenses-panel" id="expenses-panel">
            <div class="expenses-list" id="expenses-list">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
        
        <!-- Family Status Circles (Hidden initially) -->
        <div class="family-status-container" id="family-status-container" style="display: none;">
          <h3 class="family-title">Family Status</h3>
          <div class="family-circles">
            <div class="family-member" id="mother-status">
              <div class="family-circle" data-member="mother">
                <span class="member-label">Mother</span>
              </div>
            </div>
            <div class="family-member" id="wife-status">
              <div class="family-circle" data-member="wife">
                <span class="member-label">Wife</span>
              </div>
            </div>
            <div class="family-member" id="son-status">
              <div class="family-circle" data-member="son">
                <span class="member-label">Son</span>
              </div>
            </div>
        </div>
      </div>
    </div>

    <!-- Final Page -->
    <div id="final-page" class="page hidden">
      <!-- Snow Background -->
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0AgMAAAC2uDcZAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURQAAAP///////////zjAO6gAAAAEdFJOUwAuxHKQ3Q8qAAADW0lEQVR42u3dP26jQByGYUbaEe0Wi+jgKj5CirjFp9gGKXAfkOUmW+YOW2QvgdtN45XlHMAgB2aYz955nzrJp2AYM39/SYJrmTLcbDfK9MtvYbod3oXp6fCqTO8iTpdeeaNNP/1VprfKJy7ZPinTLV91AAAAAAAAAAD4kkkH/XfKCQ/TSCd7Tm/K9GHv9+89KdOzrTK9PM/68dpverXfzPnxxu9d1/Sz0ncfXtPreenZszLd+G1pq17Zchfz/nfPyoMyPT0r0802AQDMYZWt9uS7R5jWfOK9y7wEuSYT75z2EuQNph5/QU67IItrJ14S0+5dmv4aQfpBmT7RLUuHIGMO+XiXNNCCcjve1pk2TI9lIkW6lB8AAACITcxTza12qvmXMt3zdCvpX//clelJ/SZ93j+U6bl0J6+VtrQAAAAAAADwxz4r03PpGNtOOr7YLN2D8MNHer1w/4WfA00Xp3tZ8bk03R59DMo2C9PTzscUUHFYmu5j1WN+VqbbhS2t5UBTFfGBppsEAAAA+Mp7qzJcW/Ik0J7QqZ7ioCy4EmhP6Kq9ZNKX3HXaEQLtwmjlEyfeE/qNrzoAc1+SmPQTaaQHj9U96RqVNF172F4uPe7OSlsbI21pAQAAAPyPjHSlWibt5WgPami0R2QwnhRleqMtn7BXpudn5ROnHTtPOJgFAIA7c58VQgL1wpT7xHxXpZvZ+a73MadH3Adc83+/OaRTrXnP39wrW6456nJzycCqvbCb1QFXHW0rxEtF3NbTun0whWNNJbfKiq7pblUlXa+8232TH9zuabdrZx2XCLmlu1bEdLxvvkvTXVvqXrrj5aJsK81P6fs+S8sAAAAAAAAAAAAAPJKYS3430pP3B0p+R5lOyW8VSn4DAAAAANbt80t3EljpLoqAO0hGLnPA3TMjGzoD7hwa2dAZMH1kY17A9KK/GlrJA6ZfR6XSdHtRpps22DhXOfJwh6sXkx6VA3pWeua7kRZAw0OSlnIK2CyNpf9TTj1oC5xri6dZ8TRrxOknadG8Vnpc0k7a48uULS0AAHhQDFiL5L2yn6o96irm9LzTFraXph/d0t1Oi3QdGcr+OP2646hYKa3VUEmrozRRV0eRfk/EXG1Xes8z7wMAAHAHPgHhchfsTyUPMgAAAABJRU5ErkJggg==) center center repeat, url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0AgMAAAC2uDcZAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURQAAAP///////////zjAO6gAAAAEdFJOUwAXO2Yymfg6AAAId0lEQVR42u1dS27jOBA1gWFO0NTCcxkfwYtIwMjrXrS08FVmEd9gvIgMtG7Qukxn4dwgXljDIIOeWCYlip96nbjeMgH8bIksFlmvHhcLBuNTQq6Q7Pk9kr3cA8lFfQQ+etGe11D2v5HsPZJ9i2Rf1P0DcsYh3/sia4BjfiFzbKjlte5Drs/QFTJHjllR7IHzVVaPSPbDM/DFZ+0JuEpk3ZmGXSHZRW4aXgUVe/UAZJft3vjkTyRj/q47Gsf885qG/cUQU1XzOB1p5ToC+3llinW7aXYVnkFII7vIHT65dHg+07sO02fk009V1KfgR68/w/MXiG2ErNn7+en9SnhM8B87Mdj9cyjsbmkDZc9+INkldK8msHu1L7zvYTAYDAaDwWAwGAwGg8GAQ9iONBVFpV1+W5n/kecE52ZZYz6QFsUjQQUnsxyLyqohYF/2T2b2A0XNdNkfzezteUfB/mJ+I12/o3jvVnYCIZ+5akhVLxaHPZK9NL9eRaMTUOZpLRuSGoGwRGCoPkRAlTmLHKomUxcP3lLdIyrhWFZ7FbAMK/dVzFLVzf2XYTHj1W6MGmJRNt5BQRQ757dmrs2K6vyPd1I1Y0qb69Ky7r3Z1cFdgFL3P41JgD+7Ft84s2+isxczpD9LI00Ie9m7L6L/VcUHczSQ3fm3y7cMdxD8dfL34M/u/t7fJGvDOSqr5wl2e5dHMWPUvcn1hnNUR5u1b0Ar2rlL+HCOTkpUZbm3BTTV7GeuUFqWeT9Yhsc/QavKbF9PVbvZEWIwyqZkNSOKOjm78acwzlG1WvgMrdmLszlCjPyIOdPK77eLak/EborNoj3SsGft8frDZGfX0kVlN8oytYrRylB2x3jsRlmmGGEvvoerJMcD51jn1ruApsIPYkxzdEwJqcpfX7dIdBywsY+sdwGtjPgOLmbCyOf+vw7Uifr6nLqXkvW2CZfxFEWp6o+tfwoYY2xC2ZdYpWoDVap+QypVF1ilKoPBYDAYDAaDwWAwGAwGg8FgMBiMD4QRZQUBoL6wY8oKAvYt1hf2FIHd11R4TNuQfvBo9vDqtfSVRkdxeVLV3vPR1xHYM6uJ2ZRzWRlBs1NYpTdTrySLoOS3y46m9CAxfGGt7NOuYxEirZ19S+AyPcIeXY1yrWsq+6OVPbYq4boLp+xsgyu6c5morqgKq4I1unOZYV1SjU3BGt25zOCWrqyrTHTnMoPmTloVrNHbXkyzSNknyCI9e6LMx/Q+N1R+5cr02sj8yo1EMpGO8TqsmR6yoOow24AtHn9C2Z+A7H8Gsoug1CULZFeWQOv2pWQbJte0tPlLt84Gs/uz+4Mvzf2FynHnFWZRYGvzLxy7/2XY/s7ca6XbkAg64F97cHbG93ne49h10yMRu7Hlsu1997yfgp0iOWmN3ZlE7NLcxCZrCscLHW2M71dUJJpzS/OiDsAkmaE5ngsSj5mRpW+FI1fgnw4kBx+Lt8hj8bGGQ4Lf3kEva+tu+Kq4LfTCsvKEjDbZI3DMOxyLi5Sx+H76+yFrlKpBLgX64Bc4J0uSlNvGXvfHW2WXWPYt+LdjRx10xpEcbtjZkZE2/4pcgxW0vVdAL5+MM2+h7NDdoiiRlQ1RP0K3iy/Q7eKn2bDNdnKJuWETsw88Ym7YZLmbO4Yiuq+MeHfZsIxXL/a4DVPFy4/mmBH+Girxdt39CbjuzbEDTMGOPHJAsye6AVa6sSc603fKQepzmt2NUw4iUpVybK7ZgyUjkXm57BxykGSmVea7dodIZVrllgHVidjdMqBUllluqtdklllOOYjNMkuExqCycRh14q+1ZbcbmjQ5RTHLnjr4vDsoBymRWwbwRcc12DrvdjV4Syh71iHfu4TaBgro2VDS/j65Qv4ybO9gCRVJ1B+/dzBtzpfut2NlCj1SpoBln+rRSFson+jRkGmj/IRIQqWNhRP5boHUKIBrlhWyXoutVWtZ8NMNsyPfO5adRpBtnXHIbN7WEUOV8uZYjQIy3V/Mme3Qbyqx2vGvyBFa0KzG5mo1VS5gadag0W7pq6hMM0Gr5ihyAcvVeUSrsb6W6x7HnnXI9ihsa5j5Wi6qXMBycZ8guQjaphPQl2BTxHnb/WY07VHGa7nIcgHVIFsTjNdyEWYR0CQGe2rNYDAYDAaDwWD8TlBQ7QF0Z+DRLRF3RwjcmHh0SxCcBNDgtjsGbpg95k3n88d8izwByhpgfV2bfEPjPFRf9ymuO5bQEzyFHLt0nrbmoHXGmr1iZe5PN8sOlrlD2eV3qCS5Qs44cLniD/RKgzXwwJqXQEVREUxrpP8HyPACeOFfv7dYJM9ap/2ze9WGSg9EgItD1oU2E4c4WMRg928EtChR5iCEPXzUBbQhWiyS523nvb+/bIKz6sxfPivL4B1FwJ0pIlzwEnJnSv7xLbIYDAbjpgC931RAVw2sglBf2wZ89AX05F57POHYtW8y2Ll4DWVfMTtm1CWfcfkIe/LOnzEfjyJ5H8KYh0n6u0ruuv3IKpP6td/1R/s/vyySsyMdZu96pNcG+joUKDvUY2VRQqu39K2+772EBHkCkYP1fMg5XkE1Llg9X/fMqjJmvy12rJ4Pq6hDegXpRRV6rR9WIoH1DmEwGL8rBNYhFdtnj1UvIbNvWSEv/NJKDqBiMYKG5lOzSyR7wlTJgT1h2S5rJ3ceCVNkh73++PZAhoQLh3OOshsr26mQBzPds/latht5PGVQRXHyfGuibBd239WkT7hmHztkT+w7fF04u5BTb9NemXDNfiGn3qbtJXk1sF3ZE5LEnSy6bLcf/uHdo18m7qMZGhdfeotmP9KukUPTZnl4L2iWifunhmW7Sx85kfpE+n6YjF242BH3U6gO6acLZm+Rbr7ygEzCsRsQfYUE1CcW27TzoeTU/wJHgZKTCUhpgwAAAABJRU5ErkJggg==) center center repeat fixed transparent; background-size: 450px auto; animation: snowing 20s linear infinite; pointer-events: none; z-index: 9998;"></div>
      
      <!-- Content Container -->
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 2rem; z-index: 10;">
        
        <!-- Text Box -->
        <div id="final-text" style="font-family: 'Courier New', Courier, monospace; font-size: 20px; line-height: 22px; white-space: pre-wrap; text-align: left; color: #2c2c2c; width: 100%; max-width: 800px; min-height: 400px; padding: 2rem; background: #e8e8e8; border: 1px solid #e8e8e8; border-radius: 0.5em; box-shadow: inset 4px 4px 12px #c5c5c5, inset -4px -4px 12px #ffffff; position: relative; overflow: hidden; word-wrap: break-word;">
          <h1 style="text-align: center; margin-bottom: 20px; color: #2c2c2c;">Simulation Complete</h1>
          <p style="color: #2c2c2c;">Congratulations! You have completed the 3-day editorial simulation. Your decisions have shaped the narrative and influenced public opinion.</p>
          <br>
          <button class="next-button" onclick="restartGame()" style="color: #2c2c2c; background: #d6d3d1; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Play Again</button>
        </div>
        
        <!-- Prompt -->
        <div id="final-prompt" style="text-align: center; color: #4a4a4a; margin-top: 20px; opacity: 1;">Press ENTER to restart...</div>
        
      </div>
    </div>

  </div> <!-- End of game-container -->

  <script>
    // ========== GAME CONFIGURATION ==========
    // Configuration constants removed - now using Options page for navigation
    
    // ========== PAGE MANAGEMENT SYSTEM ==========
    let currentDay = 1;
    let gameLoopCount = 0;
    // Dynamic day system - game continues until all emails are processed
    
    // ========== FAMILY HEALTH SYSTEM ==========
    // Persistent family health storage that accumulates across days
    let familyHealth = {
      mother: 100,
      wife: 100,
      son: 100
    };

    // ========== INTRO PAGE TYPEWRITER SYSTEM ==========
    let currentIntroSection = 0;
    
    // Define button event handlers
    function handleButtonClick(event) {
      console.log('Button clicked via event listener!', event);

      console.log('Event target:', event.target);
      console.log('Event currentTarget:', event.currentTarget);
      
      // Check if this is the intro button first
      if (event.target.id === 'intro-next-btn' || event.currentTarget.id === 'intro-next-btn') {
        console.log('Confirmed: intro button clicked, calling nextIntroSection');
        
        // Only stop propagation and prevent default for intro button
        event.stopPropagation();
        event.preventDefault();
        
        // Play button sound for intro button
        const buttonClickSound = document.getElementById('button-click-sound');
        if (buttonClickSound) {
          buttonClickSound.volume = 1.0;
          buttonClickSound.currentTime = 0;
          buttonClickSound.play().catch(e => {
            console.log('Intro button sound failed:', e);
          });
        }
        
        nextIntroSection();
      } else {
        console.log('Warning: click detected but not on intro button');
      }
    }
    
    function handleMouseEnter() {
      console.log('Mouse entered button area');
    }
    
    function handleMouseLeave() {
      console.log('Mouse left button area');
    }
    const introSections = [
      {
        lines: [
          "You've been out of work for months.",
          "Rent is due tomorrow.",
          "The heater stopped working last week."
        ],
        buttonText: "NEXT"
      },
      {
        lines: [
          "It's Sunday night.",
          "Snow hasn't stopped all day."
        ],
        buttonText: "NEXT"
      },
      {
        lines: [
          "Someone knocks at your door.",
          "A man in uniform.",
          "No name. No greeting."
        ],
        buttonText: "NEXT"
      },
      {
        lines: [
          "He hands you a sealed envelope.",
          "Stamped:",
          "**MINISTRY OF MEMORY**"
        ],
        buttonText: "OPEN"
      }
    ];

    function showIntroSection(sectionIndex) {
      console.log('Showing intro section:', sectionIndex);
      const container = document.getElementById('intro-text');
      const button = document.getElementById('intro-next-btn');
      const section = introSections[sectionIndex];
      
      if (!section) {
        console.error('Invalid section index:', sectionIndex);
        return;
      }
      
      // Clear previous content and COMPLETELY hide button
      container.innerHTML = '';
      button.style.removeProperty('opacity'); // Let CSS control opacity for animations
      button.style.visibility = 'hidden';
      button.style.pointerEvents = 'none';
      button.style.display = 'none';
      button.classList.remove('fade-in-button', 'fade-out-button');
      button.style.boxShadow = '';
      button.style.color = '';
      
      // Add lines with fade-in effect
      for (let i = 0; i < section.lines.length; i++) {
        const line = document.createElement('div');
        line.className = 'intro-text-line';
        
        // Special styling for emphasized text
        if (section.lines[i].includes('**')) {
          line.className += ' emphasized';
          line.innerHTML = section.lines[i].replace(/\*\*(.*?)\*\*/g, '$1');
        } else {
          line.textContent = section.lines[i];
        }
        
        container.appendChild(line);
        
        // Animate line appearance (start from 100ms to ensure first line animates)
        setTimeout(() => {
          line.classList.add('visible');
        }, (i * 300) + 100);
      }
      
      // Show button after all lines are visible
      const totalDelay = (section.lines.length * 300) + 100 + 800;
      setTimeout(() => {
        console.log('About to show button for section:', sectionIndex);
        button.textContent = section.buttonText;
        button.style.display = 'inline-block';
        button.style.visibility = 'visible';
        button.style.pointerEvents = 'auto';
        button.style.zIndex = '1000';
        button.disabled = false;
        
        // Remove opacity style to let CSS animation take over
        button.style.removeProperty('opacity');
        button.classList.add('fade-in-button');
        
        console.log('Button fade-in animation started for section:', sectionIndex);
        
        // Re-add event listener (use bubble phase like other pages)
        button.removeEventListener('click', handleButtonClick);
        button.addEventListener('click', handleButtonClick);
      }, totalDelay);
    }

    function nextIntroSection() {
      console.log('nextIntroSection called!');
      const button = document.getElementById('intro-next-btn');
      const textContainer = document.getElementById('intro-text');
      
      // Step 1: Add pressed state manually and keep it briefly
      if (button) {
        button.style.boxShadow = `
          0px 0px 0px #c5c5c5,
          0px 0px 0px #ffffff,
          inset 4px 4px 12px #c5c5c5,
          inset -4px -4px 12px #ffffff
        `;
        button.style.color = '#666';
      }
      
      // Step 2: Release button after 80ms (quick hold, bounce back)
      setTimeout(() => {
        if (button) {
          button.style.boxShadow = '';
          button.style.color = '';
        }
      }, 80);
      
      // Step 3: Start disappearing animation sequence
      setTimeout(() => {
        // First: Button disappears (exact reverse of appearance animation)
        if (button) {
          button.classList.add('fade-out-button');
        }
        
        // Then: After button finishes fading, start text lines from bottom to top
        setTimeout(() => {
          const textLines = textContainer.querySelectorAll('.intro-text-line');
          const totalLines = textLines.length;
          
          // Start from last line, go to first (reverse order)
          for (let i = totalLines - 1; i >= 0; i--) {
            const line = textLines[i];
            const delay = (totalLines - 1 - i) * 300; // 300ms between each line
            
            setTimeout(() => {
              line.classList.add('fade-out');
            }, delay);
          }
          
          // Wait for all text animations to complete, then proceed
          const textAnimationTime = (totalLines * 300) + 800; // stagger + last line duration
          setTimeout(() => {
            console.log('Current intro section before increment:', currentIntroSection);
            if (currentIntroSection < introSections.length - 1) {
              currentIntroSection++;
              console.log('Moving to intro section:', currentIntroSection);
              // Ensure button is completely hidden before showing next section
              const button = document.getElementById('intro-next-btn');
              button.style.opacity = '0';
              button.style.visibility = 'hidden';
              button.style.pointerEvents = 'none';
              button.style.display = 'none';
              
              // Longer delay to prevent button flash
              setTimeout(() => {
                showIntroSection(currentIntroSection);
              }, 50);
            } else {
              // Last section completed, go to next enabled page
              console.log('All intro sections complete, going to next page');
              console.log('currentIntroSection:', currentIntroSection);
              console.log('introSections.length:', introSections.length);
              console.log('About to call goToNextPage()');
              goToNextPage();
              console.log('goToNextPage() call completed');
            }
          }, textAnimationTime);
          
        }, 800); // Start text fade after button finishes fading (0.8s)
        
      }, 200);
    }

    function initializeIntroPage() {
      console.log('Initializing intro page');
      currentIntroSection = 0;
      
      // Ensure all other pages are properly hidden
      document.querySelectorAll('.page').forEach(page => {
        if (page.id !== 'intro-page') {
          page.classList.remove('active');
          page.classList.add('hidden');
          page.style.display = 'none';
          // FIXED: Removed zIndex = '-1' to avoid permanent state pollution
        }
      });
      
      // Ensure intro page is properly active
      const introPage = document.getElementById('intro-page');
      if (introPage) {
        introPage.classList.remove('hidden');
        introPage.classList.add('active');
        introPage.style.display = 'flex';
        // CLEANED: No longer need to set zIndex, rely on CSS positioning
      }
      
      // Reset any existing animations or states
      const container = document.getElementById('intro-text');
      const button = document.getElementById('intro-next-btn');
      
      if (container) container.innerHTML = '';
      if (button) {
        button.classList.remove('fade-in-button', 'fade-out-button');
        button.style.removeProperty('opacity'); // Let CSS control opacity
        button.style.boxShadow = '';
        button.style.color = '';
        button.disabled = false;
        button.style.pointerEvents = 'auto';
        button.style.visibility = 'hidden'; // Start hidden
        
        console.log('Setting up button event listeners...');
        
        // Remove existing event listeners to prevent duplicates
        button.removeEventListener('click', handleButtonClick);
        button.removeEventListener('mouseenter', handleMouseEnter);
        button.removeEventListener('mouseleave', handleMouseLeave);
        
        // Add direct event listener (use bubble phase like other pages)
        button.addEventListener('click', handleButtonClick); // Use bubble phase
        button.addEventListener('mouseenter', handleMouseEnter);
        button.addEventListener('mouseleave', handleMouseLeave);
        
        console.log('Button event listeners added. Button:', button);
      }
      
      // Rescan buttons for sound effects
      setTimeout(() => {
        if (window.rescanButtonSounds) {
          console.log('Intro页面：重新扫描按钮音效');
          window.rescanButtonSounds();
        }
      }, 100);
      
      showIntroSection(0);
    }

    // ========== TEXT DISAPPEARING ANIMATION ==========
    function wrapTextInLines(element) {
      const text = element.textContent;
      const lines = text.split('\n');
      element.innerHTML = '';
      
      lines.forEach((line, index) => {
        const lineSpan = document.createElement('span');
        lineSpan.className = 'text-line';
        lineSpan.textContent = line;
        element.appendChild(lineSpan);
        
        // Add line break if not the last line
        if (index < lines.length - 1) {
          element.appendChild(document.createElement('br'));
        }
      });
    }

    function fadeOutTextLines(element, callback) {
      const lines = element.querySelectorAll('.text-line');
      let completedLines = 0;
      const totalLines = lines.length;
      
      console.log('fadeOutTextLines called:', { totalLines, element, lines });
      
      // If no lines found, immediately call callback
      if (totalLines === 0) {
        console.log('No text lines found, calling callback immediately');
        if (callback) callback();
        return;
      }
      
      // Start from the last line, go to first (reverse order)
      for (let i = totalLines - 1; i >= 0; i--) {
        const line = lines[i];
        const delay = (totalLines - 1 - i) * 300; // 300ms between each line
        
        setTimeout(() => {
          line.classList.add('fade-out');
          
          // Check if all lines are done after animation completes
          setTimeout(() => {
            completedLines++;
            console.log(`Line ${i} completed, ${completedLines}/${totalLines} done`);
            if (completedLines === totalLines && callback) {
              console.log('All lines faded out, calling callback');
              callback();
            }
          }, 800); // Match CSS transition duration
          
        }, delay);
      }
    }

    // ========== STORY PAGE TYPEWRITER SYSTEM ==========
    let currentStorySection = 0;
    const storySections = [
      {
        text: "MINISTRY OF MEMORY",
        buttonText: "NEXT"
      },
      {
        text: "Citizen:\n\nYou have been assigned to temporary editorial duty.\n\n This is a classified post. Your family is being looked after.",
        buttonText: "NEXT"
      },
      {
        text: "The Border Operation remains a subject of international scrutiny.\n\nForeign-backed separatists disrupted our frontier with lies, illegal votes and unrest.\n\nHomeland's Central Council authorized a limited military intervention.\n\nUnity was preserved.",
        buttonText: "NEXT"
      },
      {
        text: "The Homeland affirms it as a lawful act of internal stabilization.\n\nForeign observers and exiled agitators continue to spread conflicting accounts.\n\nThe result: confusion, erosion of trust, and civic instability.",
        buttonText: "NEXT"
      },
      {
        text: "You are tasked with evaluating proposals submitted by different contributors for inclusion in the Unified History Textbook.\n\nSome tell the truth, others lie, and some just ramble. Contradictory nonsense must be immediately rejected. But liars? They're harder to catch.",
        buttonText: "NEXT"
      },
      {
        text: "You have access to a Fact Check tool that reveals neutral, verified data.\n\nUse it wisely. If you let falsehoods slip through, you lose money-money your family depends.\n\nYou choose which claims to verify. You choose who to trust.",
        buttonText: "NEXT"
      },
      {
        text: "Your decisions will shape how this generation understands the past, and how they survive the present.\n\nWe trust you will make responsible selections.\n\n– Ministry of Memory\nEditorial Governance Division",
        buttonText: "CONTINUE"
      }
    ];

    function typewriterStory(element, text, speed = 200) {
      return new Promise((resolve) => {
        // Clear any existing content and prevent further Enter key processing
        disableStoryKeyListener();
        element.textContent = '';
        element.classList.add('typing-active');
        
        const words = text.split(' ');
        let wordIndex = 0;
        
        function type() {
          if (wordIndex < words.length) {
            // Play typing sound slightly before displaying word
            const typingSound = document.getElementById('typing-sound-other');
            if (typingSound) {
              typingSound.currentTime = 0;
              typingSound.play().catch(e => console.log('Story typing sound play failed:', e));
            }
            
            // Add word after short delay to make sound slightly ahead
            setTimeout(() => {
              const currentWord = words[wordIndex];
              const displayText = element.textContent + (wordIndex > 0 ? ' ' : '') + currentWord;
              element.textContent = displayText;
              wordIndex++;
              setTimeout(type, speed - 50);
            }, 50);
          } else {
            element.classList.remove('typing-active');
            resolve();
          }
        }
        type();
      });
    }

    function typewriterSummary(element, text, speed = 200) {
      return new Promise((resolve) => {
        // Clear any existing content
        element.textContent = '';
        element.classList.add('typing-active');
        
        const words = text.split(' ');
        let wordIndex = 0;
        
        function type() {
          if (wordIndex < words.length) {
            // Play typing sound slightly before displaying word
            const typingSound = document.getElementById('typing-sound-other');
            if (typingSound) {
              typingSound.currentTime = 0;
              typingSound.play().catch(e => console.log('Summary typing sound play failed:', e));
            }
            
            // Add word after short delay to make sound slightly ahead
            setTimeout(() => {
              const currentWord = words[wordIndex];
              const displayText = element.textContent + (wordIndex > 0 ? ' ' : '') + currentWord;
              element.textContent = displayText;
              wordIndex++;
              setTimeout(type, speed - 50);
            }, 50);
          } else {
            element.classList.remove('typing-active');
            resolve();
          }
        }
        type();
      });
    }

    async function showStorySection(sectionIndex) {
      const textElement = document.getElementById('story-text');
      const promptElement = document.getElementById('story-prompt');
      const section = storySections[sectionIndex];
      
      // Hide prompt and disable key listener immediately
      promptElement.classList.remove('visible');
      disableStoryKeyListener();
      
      // Start typewriter effect
      await typewriterStory(textElement, section.text);
      
      // Wrap the completed text in lines for later fade out
      wrapTextInLines(textElement);
      
      // Show prompt and enable key listener after typing completes
      promptElement.classList.add('visible');
      enableStoryKeyListener();
    }

    let storyKeyListenerActive = false;

    function enableStoryKeyListener() {
      storyKeyListenerActive = true;
      console.log('Story key listener enabled, ready for Enter key');
    }

    function disableStoryKeyListener() {
      storyKeyListenerActive = false;
    }

    function nextStorySection() {
      // Prevent multiple triggers
      if (!storyKeyListenerActive) return;
      
      disableStoryKeyListener();
      
      // Step 1: Add visual feedback to text box during Enter key press
      const textBox = document.getElementById('story-text');
      const promptElement = document.getElementById('story-prompt');
      
      if (textBox) {
        textBox.style.boxShadow = `
          inset 6px 6px 15px #c5c5c5,
          inset -6px -6px 15px #ffffff
        `;
      }
      
      // Step 2: Release text box after 60ms (quick hold, bounce back)
      setTimeout(() => {
        if (textBox) {
          textBox.style.boxShadow = `
            inset 4px 4px 12px #c5c5c5,
            inset -4px -4px 12px #ffffff
          `;
        }
      }, 60);
      
      // Step 3: Start disappearing animation sequence
      setTimeout(() => {
        // First: Hide prompt (exact reverse of appearance animation)
        if (promptElement) {
          promptElement.classList.add('fade-out-button');
        }
        
        // Then: Start text lines fade out from bottom to top
        setTimeout(() => {
          fadeOutTextLines(textBox, () => {
            if (currentStorySection < storySections.length - 1) {
              currentStorySection++;
              showStorySection(currentStorySection);
            } else {
              // Last section completed, go to next enabled page
              goToNextPage();
            }
          });
        }, 800); // Start text fade after prompt finishes fading (0.8s)
        
      }, 150);
    }

    function handleStoryKeyPress(event) {
      // Only handle Enter key on story page
      const storyPage = document.getElementById('story-page');
      
      // Debug information
      console.log('handleStoryKeyPress called:', {
        key: event.key,
        storyKeyListenerActive: storyKeyListenerActive,
        storyPageExists: !!storyPage,
        storyPageActive: storyPage && storyPage.classList.contains('active'),
        currentStorySection: currentStorySection
      });
      
      if (event.key === 'Enter' && storyKeyListenerActive && storyPage && storyPage.classList.contains('active')) {
        event.preventDefault();
        console.log('Enter key processed, calling nextStorySection()');
        
        // Play button sound for story page Enter key
        const buttonClickSound = document.getElementById('button-click-sound');
        if (buttonClickSound) {
          buttonClickSound.volume = 1.0;
          buttonClickSound.currentTime = 0;
          buttonClickSound.play().catch(e => {
            console.log('Story Enter key sound failed:', e);
          });
        }
        
        nextStorySection();
      }
    }

    function initializeStoryPage() {
      currentStorySection = 0;
      disableStoryKeyListener();
      showStorySection(0);
    }
    
    function initializePreTestPage() {
      console.log('Initializing pre-test page');
      // Reset all cultural test containers
      document.querySelectorAll('.cultural-test-container').forEach(container => {
        container.classList.remove('active');
        container.classList.add('hidden');
      });
      
      // Show only the cultural intro
      const culturalIntro = document.getElementById('cultural-intro');
      if (culturalIntro) {
        culturalIntro.classList.remove('hidden');
        culturalIntro.classList.add('active');
      }
    }


    function showPage(pageId) {
      console.log('showPage called with pageId:', pageId);
      const currentPage = document.querySelector('.page.active');
      const targetPage = document.getElementById(pageId);
      
      console.log('Current active page:', currentPage ? currentPage.id : 'none');
      console.log('Target page element:', targetPage ? targetPage.id : 'not found');
      
      if (!targetPage) {
        console.error('Target page not found:', pageId);
        return;
      }
      
      // Phase 1: Fade out current page
      if (currentPage) {
        currentPage.classList.add('fade-out');
      }
      
      // Phase 2: After fade out completes, switch pages
      setTimeout(() => {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active', 'fade-out');
          page.classList.add('hidden');
          console.log('Page', page.id, 'classes after hiding:', page.className);
        });
        
        // Reset cultural test containers, but only if we're NOT transitioning TO the pre-test page
        if (pageId !== 'pre-test-page') {
          document.querySelectorAll('.cultural-test-container').forEach(container => {
            container.classList.remove('active');
            container.classList.add('hidden');
            container.style.display = 'none';
            console.log('Cultural container', container.id, 'forced hidden');
          });
        }
        
        // Show target page with fade in
        targetPage.classList.remove('hidden');
        // Clear any inline style.display = 'none' that might override CSS
        targetPage.style.display = '';
        console.log('Target page classes after unhiding:', targetPage.className);
        setTimeout(() => {
          targetPage.classList.add('active');
          console.log('Target page classes after adding active:', targetPage.className);
          console.log('Page transition completed to:', pageId);
          
          // Rescan buttons for sound effects after page transition
          if (window.rescanButtonSounds) {
            console.log('重新扫描按钮音效...');
            window.rescanButtonSounds();
          }
          
          // Debug: Check all page states after transition
          console.log('=== All page states after transition ===');
          document.querySelectorAll('.page').forEach(page => {
            console.log('Page', page.id, ':', page.className, 'visible:', !page.classList.contains('hidden'));
          });
        }, 50);
        
        // Initialize specific pages
        if (pageId === 'story-page') {
          // Extra safety: ensure intro page and pre-test page are completely hidden
          const introPage = document.getElementById('intro-page');
          const pretestPage = document.getElementById('pre-test-page');
          
          if (introPage) {
            introPage.classList.remove('active');
            introPage.classList.add('hidden');
            introPage.style.display = 'none';
            // FIXED: Removed zIndex = '-1' to avoid permanent state pollution
            console.log('Intro page force hidden for story page display');
          }
          
          if (pretestPage) {
            pretestPage.classList.remove('active');
            pretestPage.classList.add('hidden');
            pretestPage.style.display = 'none';
            // FIXED: Removed zIndex = '-1' to avoid permanent state pollution
            console.log('Pre-test page force hidden for story page display');
          }
          
          // 确保story-page的内联样式被清除
          const storyPage = document.getElementById('story-page');
          if (storyPage) {
            storyPage.style.display = '';
            storyPage.style.zIndex = '';
            console.log('Story page display styles cleared');
          }
          
          setTimeout(() => {
            console.log('Initializing story page...');
            console.log('Story page element:', document.getElementById('story-page'));
            console.log('Story page visibility:', getComputedStyle(document.getElementById('story-page')).visibility);
            console.log('Story page display:', getComputedStyle(document.getElementById('story-page')).display);
            console.log('Story page opacity:', getComputedStyle(document.getElementById('story-page')).opacity);
            initializeStoryPage();
          }, 200);
        } else if (pageId === 'pre-test-page') {
          // Restore pre-test page display when entering it
          const pretestPage = document.getElementById('pre-test-page');
          if (pretestPage) {
            pretestPage.style.display = '';
            pretestPage.style.zIndex = '';
            console.log('Pre-test page display restored');
          }
          
          // Also restore display for cultural test containers
          document.querySelectorAll('.cultural-test-container').forEach(container => {
            container.style.display = '';
            console.log('Cultural container', container.id, 'display restored');
          });
          
          setTimeout(() => {
            initializePreTestPage();
          }, 200);
        } else if (pageId === 'morning-news-page') {
          // Restore morning-news-page display when entering it
          const morningNewsPage = document.getElementById('morning-news-page');
          if (morningNewsPage) {
            morningNewsPage.style.display = '';
            morningNewsPage.style.zIndex = '';
            console.log('Morning news page display restored');
          }
          
          setTimeout(() => {
            updateMorningNews();
            console.log('Morning news page initialized');
          }, 200);
        } else if (pageId === 'main-game') {
          // Restore main-game page display when entering it
          const mainGamePage = document.getElementById('main-game');
          if (mainGamePage) {
            mainGamePage.style.display = '';
            // CLEANED: No longer need zIndex reset since we don't set negative zIndex
            console.log('Main game page display restored');
          }
        } else if (pageId === 'options-page') {
          // CLEANED: No longer need zIndex reset since we don't set negative zIndex
          const optionsPage = document.getElementById('options-page');
          if (optionsPage) {
            optionsPage.style.display = '';
            console.log('Options page display restored');
          }
        }
        
      }, 400); // Wait for fade out to complete
      
      console.log('Transitioning to page:', pageId);
    }

    function startMainGameLoop() {
      currentDay = 1;
      gameLoopCount = 0;
      
      // Save original letters array for reference during day transitions
      window.originalLetters = [...letters];
      
      updateMorningNews();
      showPage('morning-news-page');
    }
    
    function startEditorialWork() {
      console.log('DEBUG: startEditorialWork called');
      console.log('DEBUG: currentDay before transition =', currentDay, 'gameLoopCount =', gameLoopCount);
      
      // Only reset to fresh state if this is the very first time (currentDay should be 1 and gameLoopCount 0)
      // Don't reset if coming from day transition (preserve currentDay for tile preservation)
      if (currentDay === 1 && gameLoopCount === 0) {
        console.log('DEBUG: First time entry - no reset needed');
      } else {
        console.log('DEBUG: Day transition entry - preserving currentDay =', currentDay);
        // Reset only gameLoopCount for the current day, keep currentDay intact
        gameLoopCount = 0;
      }
      
      // Play button sound
      const buttonClickSound = document.getElementById('button-click-sound');
      if (buttonClickSound) {
        buttonClickSound.volume = 1.0;
        buttonClickSound.currentTime = 0;
        buttonClickSound.play().catch(e => {
          console.log('Start Editorial Work button sound failed:', e);
        });
      }
      
      // Use the same initialization as jumpToPage for consistency
      // Mark this as coming from day transition
      window.isDayTransition = true;
      jumpToPage('main-game');
    }
    
    // Return to options page after morning briefing
    function returnToOptionsAfterBriefing() {
      console.log('DEBUG: returnToOptionsAfterBriefing called');
      
      // Play button sound
      const buttonClickSound = document.getElementById('button-click-sound');
      if (buttonClickSound) {
        buttonClickSound.volume = 1.0;
        buttonClickSound.currentTime = 0;
        buttonClickSound.play().catch(e => {
          console.log('Return to options button sound failed:', e);
        });
      }
      
      // FIXED: Use simple showPage instead of complex jumpToPage to avoid initialization conflicts
      showPage('options-page');
    }
    
    // Jump directly to any page in the simulation
    function jumpToPage(pageId) {
      console.log('Jumping to page:', pageId);
      
      // Play button sound for all navigation buttons
      const buttonClickSound = document.getElementById('button-click-sound');
      if (buttonClickSound) {
        buttonClickSound.volume = 1.0;
        buttonClickSound.currentTime = 0;
        buttonClickSound.play().catch(e => {
          console.log('Navigation button sound failed:', e);
        });
      }
      
      // Show the target page first
      showPage(pageId);
      
      // Perform page-specific initialization
      switch(pageId) {
        case 'intro-page':
          // Initialize intro page
          if (typeof initializeIntroPage === 'function') {
            initializeIntroPage();
          }
          break;
        case 'story-page':
          currentStorySection = 0;
          if (typeof showStorySection === 'function') {
            showStorySection(0);
          }
          // Rescan buttons for story page
          setTimeout(() => {
            if (window.rescanButtonSounds) {
              console.log('Story页面：重新扫描按钮音效');
              window.rescanButtonSounds();
            }
          }, 200);
          break;
        case 'pre-test-page':
          // Initialize pre-test page
          if (typeof initializePreTestPage === 'function') {
            initializePreTestPage();
          }
          // Rescan buttons for pre-test page
          setTimeout(() => {
            if (window.rescanButtonSounds) {
              console.log('Pre-test页面：重新扫描按钮音效');
              window.rescanButtonSounds();
            }
          }, 200);
          break;
        case 'morning-news-page':
          // Don't reset currentDay - preserve the current day value
          // Only reset gameLoopCount to 0 for this day
          gameLoopCount = 0;
          if (typeof letters !== 'undefined' && !window.originalLetters) {
            window.originalLetters = [...letters];
          }
          if (typeof updateMorningNews === 'function') {
            updateMorningNews();
          }
          // Rescan buttons for morning news page
          setTimeout(() => {
            if (window.rescanButtonSounds) {
              console.log('Morning news页面：重新扫描按钮音效');
              window.rescanButtonSounds();
            }
          }, 200);
          break;
        case 'main-game':
          console.log('DEBUG: main-game case triggered');
          console.log('DEBUG: currentDay =', currentDay, 'gameLoopCount =', gameLoopCount);
          console.log('DEBUG: letters defined?', typeof letters !== 'undefined', 'letters length:', typeof letters !== 'undefined' ? letters.length : 'undefined');
          
          // Only reset when truly starting fresh from options, not from day transitions
          const isFromDayTransition = window.isDayTransition || false;
          console.log('DEBUG: isDayTransition flag =', isFromDayTransition);
          console.log('DEBUG: currentDay before decision =', currentDay, 'gameLoopCount =', gameLoopCount);
          
          if (!isFromDayTransition) {
            // Reset to fresh start when jumping directly to main game from options
            currentDay = 1;
            gameLoopCount = 0;
            console.log('DEBUG: Fresh start from options - RESET currentDay =', currentDay, 'gameLoopCount =', gameLoopCount);
          } else {
            console.log('DEBUG: Day transition entry - PRESERVING currentDay =', currentDay, 'gameLoopCount =', gameLoopCount);
            // Clear the flag after use
            window.isDayTransition = false;
          }
          
          // Always ensure proper initialization for main game
          console.log('DEBUG: Initializing main game');
          
          // Always ensure originalLetters is set for consistent state across all entry paths
          if (typeof letters !== 'undefined') {
            window.originalLetters = [...letters];
            console.log('DEBUG: originalLetters set, length:', window.originalLetters.length);
          }
          
          // Initialize main game components
          setTimeout(() => {
            console.log('DEBUG: Starting main game initialization timeout');
            console.log('DEBUG: DOM ready state:', document.readyState);
            console.log('DEBUG: Main game page visible:', !document.getElementById('main-game').classList.contains('hidden'));
            
            // Check if page is actually visible
            const mainGamePage = document.getElementById('main-game');
            console.log('DEBUG: main-game page classes:', mainGamePage ? mainGamePage.className : 'not found');
            console.log('DEBUG: main-game page display:', mainGamePage ? window.getComputedStyle(mainGamePage).display : 'not found');
            console.log('DEBUG: main-game page opacity:', mainGamePage ? window.getComputedStyle(mainGamePage).opacity : 'not found');
            
            // Core game initialization
            if (typeof renderLetters === 'function') {
              console.log('DEBUG: Calling renderLetters with', letters.length, 'letters');
              console.log('DEBUG: Letters container before renderLetters:', document.getElementById('letters-list'));
              
              // CRITICAL: Reset currentlyRenderedLetters to ensure proper rendering
              if (typeof currentlyRenderedLetters !== 'undefined') {
                console.log('DEBUG: Resetting currentlyRenderedLetters from', currentlyRenderedLetters, 'to 0');
                currentlyRenderedLetters = 0;
              }
              
              renderLetters(letters.length);
              console.log('DEBUG: Letters container after renderLetters:', document.getElementById('letters-list'));
              console.log('DEBUG: Letter items count after renderLetters:', document.querySelectorAll('.letter-item').length);
              
              // CRITICAL: Force re-setup event listeners after rendering
              setTimeout(() => {
                console.log('DEBUG: Force re-setup event listeners');
                const letterItems = document.querySelectorAll('.letter-item');
                letterItems.forEach((item, index) => {
                  // Remove existing listeners and add new ones
                  const newItem = item.cloneNode(true);
                  newItem.addEventListener('click', (event) => {
                    console.log('DEBUG: Forced letter item click event fired for index:', index);
                    selectLetter(index, newItem);
                  });
                  item.parentNode.replaceChild(newItem, item);
                });
                console.log('DEBUG: Re-setup completed for', letterItems.length, 'letter items');
              }, 100);
            } else {
              console.log('DEBUG: renderLetters function not found!');
            }
            if (typeof initGrid === 'function') {
              // Force reset only when starting fresh (currentDay === 1 && gameLoopCount === 0)
              // Otherwise preserve tiles for day transitions
              const shouldForceReset = (currentDay === 1 && gameLoopCount === 0);
              console.log('DEBUG: initGrid shouldForceReset =', shouldForceReset, 'currentDay =', currentDay, 'gameLoopCount =', gameLoopCount);
              initGrid(shouldForceReset);
            }
            // FIXED: Remove duplicate setupEventListeners call - already called in DOMContentLoaded
            // if (typeof setupEventListeners === 'function') {
            //   setupEventListeners();
            // }
            
            // DEBUG: Test letter click functionality
            setTimeout(() => {
              console.log('DEBUG: Testing letter click functionality after 500ms');
              const letterItems = document.querySelectorAll('.letter-item');
              console.log('DEBUG: Found', letterItems.length, 'letter items');
              letterItems.forEach((item, index) => {
                console.log('DEBUG: Letter item', index, 'has click listener:', item.onclick !== null);
                console.log('DEBUG: Letter item', index, 'dataset.index:', item.dataset.index);
                console.log('DEBUG: Letter item', index, 'computed style pointer-events:', window.getComputedStyle(item).pointerEvents);
                console.log('DEBUG: Letter item', index, 'computed style display:', window.getComputedStyle(item).display);
                console.log('DEBUG: Letter item', index, 'computed style visibility:', window.getComputedStyle(item).visibility);
              });
              
              // Check tutorial overlay status
              const tutorialOverlay = document.getElementById('tutorial-overlay');
              console.log('DEBUG: Tutorial overlay display:', tutorialOverlay.style.display);
              console.log('DEBUG: Tutorial overlay computed display:', window.getComputedStyle(tutorialOverlay).display);
              console.log('DEBUG: Tutorial active:', tutorialActive);
            }, 500);
            if (typeof updateStats === 'function') {
              updateStats();
            }
            if (typeof window.resetSubmitButton === 'function') {
              window.resetSubmitButton();
            }
            
            // Queue and animation system
            if (typeof window.reinitializeQueue === 'function') {
              window.reinitializeQueue();
            }
            
            // Reset camera to show empty queue at start of each day - FORCE HIDE
            if (typeof hideAvatar === 'function') {
              hideAvatar();
            }
            
            // Force hide avatar display element directly
            const avatarDisplay = document.getElementById('avatar-display');
            if (avatarDisplay) {
              avatarDisplay.style.display = 'none';
              console.log('Force hidden avatar display in main-game init');
            }
            
            // Reset isShowingAvatar flag
            if (typeof isShowingAvatar !== 'undefined') {
              window.isShowingAvatar = false;
            }
            
            // Clear any pending avatar switch timer
            if (typeof avatarSwitchTimer !== 'undefined' && avatarSwitchTimer) {
              clearTimeout(avatarSwitchTimer);
              avatarSwitchTimer = null;
            }
            
            // Clear auto avatar timer
            if (typeof window.autoAvatarTimer !== 'undefined' && window.autoAvatarTimer) {
              clearTimeout(window.autoAvatarTimer);
              window.autoAvatarTimer = null;
            }
            
            // Reset all character hasTriggeredAvatar flags
            if (typeof chars !== 'undefined' && chars.length > 0) {
              chars.forEach(char => {
                if (char) {
                  char.hasTriggeredAvatar = false;
                }
              });
            }
            
            // Force reset originalLetterIndex to point to first available letter in new day
            if (typeof originalLetterIndex !== 'undefined' && typeof window.originalLetters !== 'undefined') {
              const originalLetters = window.originalLetters;
              let newIndex = 0;
              for (let i = 0; i < originalLetters.length; i++) {
                if (originalLetters[i]._opened) {
                  newIndex++;
                } else {
                  break;
                }
              }
              originalLetterIndex = newIndex;
              console.log('Main-game init: Force reset originalLetterIndex to:', originalLetterIndex);
            }
            
            // Resize grid after everything is initialized
            setTimeout(() => {
              if (typeof resizeGrid === 'function') {
                resizeGrid();
              }
            }, 100);
            
            // Tutorial enabled only for Day 1 entries
            console.log('DEBUG: Tutorial check - currentDay =', currentDay, 'typeof startTutorial =', typeof startTutorial);
            if (currentDay === 1 && typeof startTutorial === 'function') {
              startTutorial();
              console.log('DEBUG: Tutorial started for Day 1');
            } else if (currentDay > 1) {
              console.log('DEBUG: Skipping tutorial for Day', currentDay);
            } else {
              console.log('DEBUG: startTutorial function not found');
            }
            
            // Setup FACT CHECK button after DOM is ready
            if (typeof setupFactCheck === 'function') {
              setupFactCheck();
              console.log('DEBUG: FACT CHECK button setup completed');
            }
            
            // Check if we need to handle day transition tiles (backup logic)
            // This handles cases where user didn't complete Daily Recap flow
            if (currentDay > 1) {
              console.log('DEBUG: Day', currentDay, '- checking for previous day error tiles');
              const existingTiles = document.querySelectorAll('#grid .tile');
              let hasErrorTiles = false;
              
              existingTiles.forEach(tile => {
                const letterIndex = parseInt(tile.dataset.letterIndex);
                if (!isNaN(letterIndex) && window.originalLetters && window.originalLetters[letterIndex]) {
                  const letter = window.originalLetters[letterIndex];
                  if (letter && letter.hasFactualError && !tile.dataset.previousDayError) {
                    console.log('DEBUG: Found unmarked error tile, marking as previousDayError');
                    tile.dataset.previousDayError = 'true';
                    tile.classList.add('previous-day-error');
                    hasErrorTiles = true;
                  }
                }
              });
              
              if (hasErrorTiles) {
                console.log('DEBUG: Marked existing error tiles for bleeding on Day', currentDay);
              }
            }
            
            console.log('DEBUG: Main game initialization timeout completed');
          }, 500);
          break;
        case 'daily-recap-page':
          // Start the typing effect when page becomes visible
          setTimeout(async () => {
            await updateSummaryDisplay();
          }, 300);
          break;
      }
    }
    
    // Initialize all pages to ensure they work correctly (simplified)
    function initializeAllPages() {
      console.log('All pages initialization available on demand');
    }
    
    // Function to return to Options page
    function returnToOptions() {
      // Play button sound
      const buttonClickSound = document.getElementById('button-click-sound');
      if (buttonClickSound) {
        buttonClickSound.volume = 1.0;
        buttonClickSound.currentTime = 0;
        buttonClickSound.play().catch(e => {
          console.log('Return to options button sound failed:', e);
        });
      }
      
      showPage('options-page');
    }
    
    // Simple sequential navigation (now all pages are available)
    function goToNextPage() {
      const currentPageId = document.querySelector('.page.active').id;
      console.log('goToNextPage called from:', currentPageId);
      
      switch(currentPageId) {
        case 'intro-page':
          jumpToPage('story-page');
          break;
        case 'story-page':
          jumpToPage('pre-test-page');
          break;
        case 'pre-test-page':
          jumpToPage('morning-news-page');
          break;
        case 'morning-news-page':
          // Mark this as coming from day transition
          window.isDayTransition = true;
          jumpToPage('main-game');
          break;
        default:
          console.log('No next page defined for:', currentPageId);
      }
    }

    // ========== CULTURAL TEST SYSTEM ==========
    const culturalDimensions = {
      'Power Distance': [1,2,3,4,5],
      'Uncertainty Avoidance': [6,7,8,9,10],
      'Collectivism': [11,12,13,14,15,16],
      'Long-Term Orientation': [17,18,19,20,21,22],
      'Masculinity': [23,24,25,26]
    };

    const culturalQuestions = [
      'People in higher positions should make most decisions without consulting people in lower positions.',
      'People in higher positions should not ask the opinions of people in lower positions too frequently.',
      'People in higher positions should avoid social interaction with people in lower positions.',
      'People in lower positions should not disagree with decisions by people in higher positions.',
      'People in higher positions should not delegate important tasks to people in lower positions.',
      'It is important to have instructions spelled out in detail so that I always know what I am expected to do.',
      'It is important to closely follow instructions and procedures.',
      'Rules and regulations are important because they inform me of what is expected of me.',
      'Standardized work procedures are helpful.',
      'Instructions for operations are important.',
      'Individuals should sacrifice self-interest for the group.',
      'Individuals should stick with the group even through difficulties.',
      'Group welfare is more important than individual rewards.',
      'Group success is more important than individual success.',
      'Individuals should only pursue their goals after considering the welfare of the group.',
      'Group loyalty should be encouraged even if individual goals suffer.',
      'Careful management of money (Thrift)',
      'Going on resolutely in spite of opposition (Persistence)',
      'Personal steadiness and stability',
      'Long-term planning',
      'Giving up today\'s fun for success in the future',
      'Working hard for success in the future',
      'It is more important for men to have a professional career than it is for women.',
      'Men usually solve problems with logical analysis; women usually solve problems with intuition.',
      'Solving difficult problems usually requires an active, forcible approach, which is typical of men.',
      'There are some jobs that a man can always do better than a woman.'
    ];

    function startCulturalTest() {
      const introDiv = document.getElementById('cultural-intro');
      const questionsDiv = document.getElementById('cultural-questions');
      
      // Transition with animation
      introDiv.classList.remove('active');
      introDiv.classList.add('hidden');
      
      setTimeout(() => {
        questionsDiv.classList.remove('hidden');
        questionsDiv.classList.add('active');
        renderCulturalQuestions();
      }, 800);
    }

    function renderCulturalQuestions() {
      const form = document.getElementById('cultural-questions-form');
      form.innerHTML = ''; // Clear existing content
      
      culturalQuestions.forEach((questionText, index) => {
        const questionNum = index + 1;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'cultural-question';
        
        const questionTextDiv = document.createElement('div');
        questionTextDiv.className = 'question-text';
        questionTextDiv.innerHTML = `<span class="question-number">${questionNum}.</span> ${questionText}`;
        questionDiv.appendChild(questionTextDiv);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'cultural-options';
        
        for (let i = 1; i <= 5; i++) {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'cultural-option';
          
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'q' + questionNum;
          input.value = i;
          input.id = `q${questionNum}_${i}`;
          input.addEventListener('change', updateCulturalProgress);
          
          const label = document.createElement('label');
          label.className = 'cultural-option-label';
          label.setAttribute('for', `q${questionNum}_${i}`);
          label.textContent = i;
          
          optionDiv.appendChild(input);
          optionDiv.appendChild(label);
          optionsDiv.appendChild(optionDiv);
        }
        
        questionDiv.appendChild(optionsDiv);
        form.appendChild(questionDiv);
      });
    }

    function updateCulturalProgress() {
      const totalQuestions = culturalQuestions.length;
      let answeredQuestions = 0;
      
      for (let i = 1; i <= totalQuestions; i++) {
        const radios = document.getElementsByName('q' + i);
        const questionNumber = document.querySelector(`.question-text span.question-number:nth-of-type(${i})`);
        let isAnswered = false;
        
        for (let radio of radios) {
          if (radio.checked) {
            answeredQuestions++;
            isAnswered = true;
            break;
          }
        }
        
        // Update question number color based on answer status
        const questionNumbers = document.querySelectorAll('.question-number');
        if (questionNumbers[i-1]) {
          if (isAnswered) {
            questionNumbers[i-1].classList.add('answered');
          } else {
            questionNumbers[i-1].classList.remove('answered');
          }
        }
      }
      
      const progress = (answeredQuestions / totalQuestions) * 100;
      const submitBtn = document.getElementById('cultural-submit-btn');
      
      // Update button progress bar
      const progressBar = submitBtn.querySelector('::before') || submitBtn;
      submitBtn.style.setProperty('--progress-width', progress + '%');
      
      // Update button text with progress
      if (answeredQuestions === totalQuestions) {
        submitBtn.textContent = 'Complete Assessment';
        submitBtn.disabled = false;
        submitBtn.classList.add('complete');
        submitBtn.style.setProperty('--progress-width', '100%');
      } else {
        submitBtn.textContent = `Complete Assessment (${answeredQuestions}/${totalQuestions})`;
        submitBtn.disabled = true;
        submitBtn.classList.remove('complete');
      }
      
      // Update the ::before pseudo-element width via CSS custom property
      submitBtn.style.setProperty('--progress-width', progress + '%');
    }

    function submitCulturalTest() {
      const form = document.getElementById('cultural-questions-form');
      const scores = {};
      
      // Calculate scores for each dimension
      for (const dimension in culturalDimensions) {
        const questionIndices = culturalDimensions[dimension];
        let sum = 0;
        
        questionIndices.forEach(index => {
          const radios = document.getElementsByName('q' + index);
          for (let radio of radios) {
            if (radio.checked) {
              sum += parseInt(radio.value);
              break;
            }
          }
        });
        
        scores[dimension] = (sum / questionIndices.length).toFixed(2);
      }
      
      // Transition to results page
      const questionsDiv = document.getElementById('cultural-questions');
      const resultsDiv = document.getElementById('cultural-results');
      
      questionsDiv.classList.remove('active');
      questionsDiv.classList.add('hidden');
      
      setTimeout(() => {
        resultsDiv.classList.remove('hidden');
        resultsDiv.classList.add('active');
        displayCulturalResults(scores);
      }, 800);
    }

    function displayCulturalResults(scores) {
      const resultsDisplay = document.getElementById('cultural-results-display');
      const classification = document.getElementById('cultural-classification');
      
      resultsDisplay.innerHTML = '';
      
      // Create result items with interpretations
      for (const dimension in scores) {
        const score = parseFloat(scores[dimension]);
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        
        const dimensionDiv = document.createElement('div');
        dimensionDiv.className = 'result-dimension';
        dimensionDiv.textContent = dimension.replace(' ', '\n');
        
        const scoreDiv = document.createElement('div');
        scoreDiv.className = 'result-score';
        scoreDiv.textContent = scores[dimension];
        
        const interpretationDiv = document.createElement('div');
        interpretationDiv.className = 'result-interpretation';
        interpretationDiv.textContent = getCulturalInterpretation(dimension, score);
        
        resultItem.appendChild(dimensionDiv);
        resultItem.appendChild(scoreDiv);
        resultItem.appendChild(interpretationDiv);
        resultsDisplay.appendChild(resultItem);
      }
      
      // Determine overall classification
      const avgScore = Object.values(scores).reduce((sum, score) => sum + parseFloat(score), 0) / Object.keys(scores).length;
      const classificationText = getCulturalClassification(scores);
      
      setTimeout(() => {
        classification.textContent = classificationText;
      }, 1000);
    }

    function getCulturalInterpretation(dimension, score) {
      if (score >= 4.0) return 'High';
      if (score >= 3.0) return 'Medium-High';
      if (score >= 2.0) return 'Medium-Low';
      return 'Low';
    }

    function getCulturalClassification(scores) {
      const powerDistance = parseFloat(scores['Power Distance']);
      const uncertainty = parseFloat(scores['Uncertainty Avoidance']);
      const collectivism = parseFloat(scores['Collectivism']);
      
      if (powerDistance >= 3.5 && uncertainty >= 3.5 && collectivism >= 3.5) {
        return 'Authoritarian-Compatible';
      } else if (powerDistance >= 3.0 && uncertainty >= 3.0) {
        return 'Hierarchy-Accepting';
      } else if (collectivism >= 3.5) {
        return 'Group-Oriented';
      } else {
        return 'Individual-Focused';
      }
    }

    function updateMorningNews() {
      const title = document.getElementById('morning-news-title');
      const content = document.getElementById('morning-news-content');
      
      if (title) title.textContent = `Day ${currentDay} - Morning Briefing`;
      
      if (content) {
        const newsContent = [
          "Good morning. Here are today's key developments you should be aware of before reviewing the letters...",
          "Welcome to day 2. Yesterday's editorial decisions have generated some public response. Be prepared for more challenging letters today...",
          "Final day. The political climate has intensified. Today's letters will test your editorial judgment to the fullest..."
        ];
        content.textContent = newsContent[currentDay - 1] || newsContent[0];
      }
    }

    function nextDay() {
      console.log('=== nextDay() called ===');
      console.log('Current day:', currentDay);
      console.log('Game loop count:', gameLoopCount);
      
      gameLoopCount++;
      
      // Check if all emails have been processed (opened - regardless of what happened after)
      const allEmailsProcessed = letters.every(letter => {
        return letter._opened;
      });
      
      console.log('All emails processed:', allEmailsProcessed);
      console.log('Unprocessed emails count:', letters.filter(letter => !letter._opened).length);
      
      if (allEmailsProcessed) {
        // All emails processed - end game
        console.log('All emails processed - showing final page');
        createFinalPage();
      } else {
        // Transfer unprocessed emails to next day
        console.log('transferUnprocessedEmails() will be called');
        transferUnprocessedEmails();
        currentDay++;
        
        // Update date display
        if (typeof window.renderDate === 'function') {
          window.renderDate();
        }
        
        updateMorningNews();
        showPage('morning-news-page');
      }
    }
    
    function hasLetterBeenUsed(letter) {
      // Check if any tile in the grid corresponds to this letter
      const letterIndex = letters.indexOf(letter);
      const tiles = document.querySelectorAll('#grid .tile');
      for (let tile of tiles) {
        if (parseInt(tile.dataset.letterIndex) === letterIndex) {
          return true;
        }
      }
      return false;
    }
    
    function transferUnprocessedEmails() {
      console.log('=== transferUnprocessedEmails() called ===');
      // Handle grid tiles: keep only factual error tiles from previous day
      console.log('About to call handleDayTransitionTiles()');
      handleDayTransitionTiles();
      
      // Remove opened emails from letters array, keep only unopened ones
      const unopenedEmails = letters.filter(letter => !letter._opened);
      
      // Update letters array to only contain unopened emails
      letters.length = 0;
      letters.push(...unopenedEmails);
      
      // Reset email states for the new day
      letters.forEach(letter => {
        letter._checked = false;
        letter._penalized = false;
        letter._autoPenalized = false;
        letter._rejected = false;
        letter._buttonsDisabled = false;
      });
      
      // Clear current display
      if (typeof currentlyRenderedLetters !== 'undefined') {
        currentlyRenderedLetters = 0;
      }
      
      // Reset queue by triggering a fresh start
      // Clear queue frame characters
      const queueFrame = document.getElementById('queue-frame');
      if (queueFrame) {
        const existingChars = queueFrame.querySelectorAll('.character');
        existingChars.forEach(char => char.remove());
      }
      
      // Reset camera to show empty queue (not avatar) - FORCE HIDE
      if (typeof hideAvatar === 'function') {
        hideAvatar();
      }
      
      // Force hide avatar display element directly
      const avatarDisplay = document.getElementById('avatar-display');
      if (avatarDisplay) {
        avatarDisplay.style.display = 'none';
        console.log('Force hidden avatar display in transferUnprocessedEmails');
      }
      
      // Reset isShowingAvatar flag
      if (typeof isShowingAvatar !== 'undefined') {
        window.isShowingAvatar = false;
      }
      
      // Clear any pending avatar switch timer
      if (typeof avatarSwitchTimer !== 'undefined' && avatarSwitchTimer) {
        clearTimeout(avatarSwitchTimer);
        avatarSwitchTimer = null;
      }
      
      // Clear auto avatar timer
      if (typeof window.autoAvatarTimer !== 'undefined' && window.autoAvatarTimer) {
        clearTimeout(window.autoAvatarTimer);
        window.autoAvatarTimer = null;
      }
      
      // Reset all character hasTriggeredAvatar flags
      if (typeof chars !== 'undefined' && chars.length > 0) {
        chars.forEach(char => {
          if (char) {
            char.hasTriggeredAvatar = false;
          }
        });
      }
      
      // Force reset originalLetterIndex to point to first available letter in new day
      if (typeof originalLetterIndex !== 'undefined' && typeof window.originalLetters !== 'undefined') {
        const originalLetters = window.originalLetters;
        let newIndex = 0;
        for (let i = 0; i < originalLetters.length; i++) {
          if (originalLetters[i]._opened) {
            newIndex++;
          } else {
            break;
          }
        }
        originalLetterIndex = newIndex;
        console.log('Force reset originalLetterIndex to:', originalLetterIndex);
      }
      
      // Clear letters list
      const container = document.getElementById('letters-list');
      if (container) {
        container.innerHTML = '';
      }
      
      // Force queue system restart by triggering reinitialize
      setTimeout(() => {
        if (typeof window.reinitializeQueue === 'function') {
          window.reinitializeQueue();
        }
      }, 200);
      
      // Reset selected letter
      selectedLetter = null;
      selectedLetterIndex = null;
      
      // Reset content display
      if (typeof resetContentDisplay === 'function') {
        resetContentDisplay();
      }
      
      // Reset time to 9:00 AM for the new day
      if (typeof window.resetTimer === 'function') {
        window.resetTimer();
        console.log('Time reset to 9:00 AM for new day');
      }
      
      console.log(`Day ${currentDay} ended. ${unopenedEmails.length} unopened emails will continue to Day ${currentDay + 1}`);
    }
    
    function handleDayTransitionTiles() {
      console.log('=== handleDayTransitionTiles called ===');
      const grid = document.getElementById('grid');
      const tiles = Array.from(grid.querySelectorAll('.tile'));
      console.log('Found', tiles.length, 'tiles on grid');
      
      tiles.forEach((tile, index) => {
        console.log(`Processing tile ${index + 1}:`);
        
        // Skip already wounded tiles
        if (tile.style.pointerEvents === 'none' && tile.style.background.includes('rgba(128, 0, 0')) {
          console.log('  → Skipping already wounded tile');
          return;
        }
        
        const letterIndex = parseInt(tile.dataset.letterIndex);
        console.log('  → Tile letterIndex:', letterIndex);
        
        if (!isNaN(letterIndex) && letterIndex >= 0) {
          // Get original letter (before we filter emails)
          const allLetters = window.originalLetters || letters;
          const letter = allLetters[letterIndex];
          console.log('  → Letter found:', letter ? letter.sender : 'NULL');
          console.log('  → Letter hasFactualError:', letter ? letter.hasFactualError : 'N/A');
          
          if (letter && letter.hasFactualError) {
            // Keep this tile for next day - mark it as "previous day error"
            tile.dataset.previousDayError = 'true';
            tile.classList.add('previous-day-error');
            console.log('  → PRESERVING tile with factual error:', letter.sender);
          } else {
            // Remove tiles that don't have factual errors
            const row = +tile.dataset.row;
            const col = +tile.dataset.col;
            const spanR = +tile.dataset.spanR;
            const spanC = +tile.dataset.spanC;
            
            // Clear occupied cells
            markCellsOccupied(row, col, spanR, spanC, false);
            
            // Remove tile
            tile.remove();
            console.log('  → REMOVING tile without factual error:', letter ? letter.sender : 'Unknown');
          }
        } else {
          console.log('  → Invalid letterIndex, skipping tile');
        }
      });
      console.log('=== handleDayTransitionTiles completed ===');
    }

    function restartGame() {
      currentDay = 1;
      gameLoopCount = 0;
      
      // Reset family health to 100% for new game
      familyHealth = {
        mother: 100,
        wife: 100,
        son: 100
      };
      
      // Reset final page state
      finalSectionIndex = 0;
      finalPageActive = false;
      
      showPage('intro-page');
    }

    // === DAILY SUMMARY SYSTEM ===
    let summaryStep = 0;
    let currentSavings = 0;
    let dailyData = {
      letters: 20, // Calculated based on placed tiles
      internalErrors: 2, // Calculated based on hasInternalContradiction property
      externalErrors: 1, // Calculated based on hasFactualError property
      expenses: {
        rent: { cost: 30, required: true, selected: false },
        food: { cost: 10, required: false, selected: false },
        heating: { cost: 5, required: false, selected: false },
        tutoring: { cost: 5, required: false, selected: false },
        motherCheckup: { cost: 15, required: false, selected: false },
        wifemedication: { cost: 12, required: false, selected: false },
        sonSupplies: { cost: 8, required: false, selected: false }
      }
    };

    async function initializeSummary() {
      // Reset for each day
      if (currentDay === 1) {
        currentSavings = 0;
      }
      summaryStep = 0;
      
      // Calculate internal errors based on hasInternalContradiction property
      // Find all placed tiles and check their corresponding emails (exclude wounded tiles)
      const placedTiles = Array.from(document.querySelectorAll('#grid .tile')).filter(tile => {
        // Exclude wounded tiles (they have red background and pointer-events: none)
        const style = tile.style;
        return !style.background.includes('rgba(128, 0, 0') && style.pointerEvents !== 'none';
      });
      let internalErrorCount = 0;
      
      placedTiles.forEach(tile => {
        const letterIndex = parseInt(tile.dataset.letterIndex);
        if (!isNaN(letterIndex) && letterIndex >= 0 && letterIndex < letters.length) {
          const letter = letters[letterIndex];
          if (letter && letter.hasInternalContradiction === true) {
            internalErrorCount++;
          }
        }
      });
      
      // Add wrong rejections to internal errors (rejecting emails without internal contradictions)
      letters.forEach(letter => {
        if (letter._rejected && !letter.hasInternalContradiction) {
          internalErrorCount++;
        }
        // Add auto-penalties to internal errors (using non-reject tools on emails with internal contradictions)
        if (letter._autoPenalized) {
          internalErrorCount++;
        }
      });
      
      // Calculate external errors based on hasFactualError property
      let externalErrorCount = 0;
      
      placedTiles.forEach(tile => {
        const letterIndex = parseInt(tile.dataset.letterIndex);
        if (!isNaN(letterIndex) && letterIndex >= 0 && letterIndex < letters.length) {
          const letter = letters[letterIndex];
          if (letter && letter.hasFactualError === true) {
            externalErrorCount++;
          }
        }
      });
      
      // Calculate processed letters based on email interactions, not grid placement
      let processedLettersCount = 0;
      let autopenaltyCount = 0;
      let wrongRejectionCount = 0;
      
      letters.forEach(letter => {
        // Count letters that entered correspondence column (were opened)
        if (letter._opened) {
          processedLettersCount++;
        }
        
        // Subtract auto-penalties for opening hasInternalContradiction emails without rejecting
        if (letter._autoPenalized) {
          autopenaltyCount++;
        }
        
        // Subtract wrong rejections (rejecting emails that don't have internal contradictions)
        if (letter._rejected && !letter.hasInternalContradiction) {
          wrongRejectionCount++;
        }
      });
      
      // Apply the user's formula: processed = opened - auto_penalties - wrong_rejections
      const finalProcessedCount = processedLettersCount - autopenaltyCount - wrongRejectionCount;
      
      // Update cumulative processed count
      if (typeof window.updateCumulativeProcessed === 'function') {
        window.updateCumulativeProcessed(Math.max(0, finalProcessedCount));
      }
      
      // Update dailyData with calculated values  
      dailyData.letters = Math.max(0, finalProcessedCount); // Ensure non-negative
      dailyData.internalErrors = internalErrorCount;
      dailyData.externalErrors = externalErrorCount;
      
      // Debug logging
      console.log('Error Calculation:', {
        placedTilesCount: placedTiles.length,
        internalErrorCount: internalErrorCount,
        externalErrorCount: externalErrorCount,
        tilesWithInternalContradictions: placedTiles.filter(tile => {
          const letterIndex = parseInt(tile.dataset.letterIndex);
          return letterIndex >= 0 && letterIndex < letters.length && letters[letterIndex].hasInternalContradiction;
        }).map(tile => ({
          sender: tile.dataset.sender,
          letterIndex: tile.dataset.letterIndex
        })),
        tilesWithFactualErrors: placedTiles.filter(tile => {
          const letterIndex = parseInt(tile.dataset.letterIndex);
          return letterIndex >= 0 && letterIndex < letters.length && letters[letterIndex].hasFactualError;
        }).map(tile => ({
          sender: tile.dataset.sender,
          letterIndex: tile.dataset.letterIndex
        }))
      });
      
      // Reset expense selections
      Object.keys(dailyData.expenses).forEach(key => {
        dailyData.expenses[key].selected = false;
      });
      
      // Clear summary text initially - don't start typing yet
      const summaryText = document.getElementById('summary-text');
      const savingsElement = document.getElementById('savings-amount');
      summaryText.textContent = '';
      savingsElement.textContent = '$' + currentSavings;
    }

    async function nextSummaryStep() {
      summaryStep++;
      
      switch(summaryStep) {
        case 1:
          // Step 1: Show income from letters
          await showIncomeStep();
          break;
        case 2:
          // Step 2: Internal Review deductions
          await showInternalReviewStep();
          break;
        case 3:
          // Step 3: External Review deductions
          await showExternalReviewStep();
          break;
        case 4:
          // Step 4: Show expenses panel
          await showExpensesStep();
          break;
        case 5:
          // Step 5: Confirm expenses and show family status
          confirmExpensesAndShowFamily();
          break;
        case 6:
          // Step 6: Continue to next day after family status review
          console.log('DEBUG: Summary step 6 reached - calling nextDay()');
          nextDay();
          break;
        default:
          console.log('DEBUG: Unknown summary step:', summaryStep);
          break;
      }
    }

    async function showIncomeStep() {
      const summaryText = document.getElementById('summary-text');
      const income = dailyData.letters * 100;
      await typewriterSummary(summaryText, `Each letter earns $100. Total income: $${income}`);
      
      // Animate savings increase
      animateSavingsChange(currentSavings + income, '+');
    }

    async function showInternalReviewStep() {
      const summaryText = document.getElementById('summary-text');
      await typewriterSummary(summaryText, `Internal Review found ${dailyData.internalErrors} errors, each costs $5.`);
      
      // Animate savings decrease
      const deduction = dailyData.internalErrors * 5;
      animateSavingsChange(currentSavings - deduction, '-');
    }

    async function showExternalReviewStep() {
      const summaryText = document.getElementById('summary-text');
      await typewriterSummary(summaryText, `External Review found ${dailyData.externalErrors} errors, each costs $10.`);
      
      // Animate savings decrease
      const deduction = dailyData.externalErrors * 10;
      animateSavingsChange(currentSavings - deduction, '-');
    }

    async function showExpensesStep() {
      // Keep main panel visible, update text content
      const summaryText = document.getElementById('summary-text');
      await typewriterSummary(summaryText, 'Choose your daily expenses. Food improves all family health by 50%. Heating protects everyone from cold by 30%. Other items help specific family members.');
      
      // Disable NEXT button in step 4 and make it wider
      const nextBtn = document.getElementById('summary-next-btn');
      nextBtn.textContent = 'CONFIRM';
      nextBtn.classList.add('wide');
      nextBtn.style.pointerEvents = 'none'; // Disable clicking
      nextBtn.style.opacity = '0.5'; // Visual feedback
      
      // Show both expenses and family panels with fade-in animation
      const expensesContainer = document.getElementById('expenses-container');
      const familyContainer = document.getElementById('family-status-container');
      
      // Set initial opacity to 0 and display block
      expensesContainer.style.display = 'flex';
      expensesContainer.style.opacity = '0';
      familyContainer.style.display = 'flex';
      familyContainer.style.opacity = '0';
      
      // Add fade-in animation
      setTimeout(() => {
        expensesContainer.style.transition = 'opacity 0.5s ease-in-out';
        familyContainer.style.transition = 'opacity 0.5s ease-in-out';
        expensesContainer.style.opacity = '1';
        familyContainer.style.opacity = '1';
      }, 100);
      
      // Initialize family status display
      initializeFamilyStatus();
      
      // Populate expenses list
      renderExpensesList();
      
      // Check initial expense selection state
      setTimeout(() => {
        checkExpenseSelection();
      }, 150);
    }

    function animateSavingsChange(newAmount, direction) {
      const savingsElement = document.getElementById('savings-amount');
      const startAmount = currentSavings;
      const difference = newAmount - startAmount;
      const duration = 1000; // 1 second
      const steps = 30;
      const stepDelay = duration / steps;
      
      // Play coin sound based on direction
      if (direction === '+') {
        const coinSound = document.getElementById('coins-earning-sound');
        if (coinSound) {
          coinSound.currentTime = 0;
          coinSound.play().catch(e => console.log('Coins earning sound play failed:', e));
        }
      } else if (direction === '-') {
        const coinSound = document.getElementById('coins-spent-sound');
        if (coinSound) {
          coinSound.currentTime = 0;
          coinSound.play().catch(e => console.log('Coins spent sound play failed:', e));
        }
      }
      
      // Pre-calculate all intermediate values to avoid cumulative rounding errors
      const intermediateValues = [];
      for (let i = 0; i <= steps; i++) {
        const progress = i / steps;
        const interpolatedValue = startAmount + (difference * progress);
        intermediateValues.push(Math.round(interpolatedValue));
      }
      
      let currentStep = 0;
      
      // Remove any existing animation classes
      savingsElement.classList.remove('animating', 'decreasing');
      
      // Add appropriate class based on direction
      if (direction === '-') {
        savingsElement.classList.add('decreasing');
      } else {
        savingsElement.classList.add('animating');
      }
      
      const animate = () => {
        if (currentStep < steps) {
          const displayValue = intermediateValues[currentStep];
          savingsElement.textContent = '$' + displayValue;
          
          setTimeout(() => {
            currentStep++;
            animate();
          }, stepDelay);
        } else {
          // Set final values
          currentSavings = Math.round(newAmount);
          savingsElement.textContent = '$' + Math.round(currentSavings);
          
          // Remove animation classes and set back to green
          savingsElement.classList.remove('animating', 'decreasing');
          
          // Small delay before returning to green color
          setTimeout(() => {
            // Color automatically returns to green via CSS
          }, 100);
        }
      };
      
      animate();
    }

    function renderExpensesList() {
      const expensesList = document.getElementById('expenses-list');
      expensesList.innerHTML = '';
      
      const expenses = {
        'rent': 'Rent (Required)',
        'food': 'Food',
        'heating': 'Heating',
        'tutoring': 'Tutoring',
        'motherCheckup': 'Mother Checkup',
        'wifemedication': 'Wife Medication',
        'sonSupplies': 'Son Supplies'
      };
      
      Object.keys(expenses).forEach(key => {
        const expense = dailyData.expenses[key];
        const item = document.createElement('div');
        item.className = 'expense-toggle';
        
        if (expense.required) item.classList.add('required');
        if (expense.selected) item.classList.add('active');
        
        const canAfford = currentSavings >= expense.cost;
        if (!canAfford && !expense.selected) {
          item.classList.add('disabled');
        }
        
        item.innerHTML = `
          <div class="expense-toggle__info">
            <div class="expense-toggle__name">${expenses[key]}</div>
            <div class="expense-toggle__cost">$${expense.cost}</div>
          </div>
          <div class="expense-toggle__toggler">
            <label for="${key}">
              <input type="checkbox" id="${key}" 
                     ${expense.selected ? 'checked' : ''} 
                     ${expense.required ? 'checked disabled' : ''}
                     onchange="toggleExpense('${key}')">
              <span></span>
            </label>
          </div>
        `;
        
        expensesList.appendChild(item);
        
        // Add toggle event listener for the parent container
        const toggleInput = item.querySelector('input');
        toggleInput.addEventListener('change', function() {
          if (this.checked) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      });
      
      // Auto-select rent (required)
      if (!dailyData.expenses.rent.selected) {
        toggleExpense('rent');
      }
    }

    function toggleExpense(expenseKey) {
      const expense = dailyData.expenses[expenseKey];
      const checkbox = document.getElementById(expenseKey);
      
      if (checkbox.checked && !expense.selected) {
        // Selecting expense
        if (currentSavings >= expense.cost || expense.required) {
          expense.selected = true;
          animateSavingsChange(currentSavings - expense.cost, '-');
          
          // Play toggle on sound
          const toggleOnSound = document.getElementById('pluck-on-sound');
          if (toggleOnSound) {
            toggleOnSound.currentTime = 0;
            toggleOnSound.play().catch(e => console.log('Toggle on sound play failed:', e));
          }
        } else {
          checkbox.checked = false;
        }
      } else if (!checkbox.checked && expense.selected && !expense.required) {
        // Deselecting expense
        expense.selected = false;
        animateSavingsChange(currentSavings + expense.cost, '+');
        
        // Play toggle off sound
        const toggleOffSound = document.getElementById('pluck-off-sound');
        if (toggleOffSound) {
          toggleOffSound.currentTime = 0;
          toggleOffSound.play().catch(e => console.log('Toggle off sound play failed:', e));
        }
      }
      
      // Update expense list display but don't update family status until confirm
      setTimeout(() => {
        renderExpensesList();
        checkExpenseSelection();
      }, 100);
    }

    function checkExpenseSelection() {
      // Enable NEXT button if we're in step 4 and expenses are ready
      if (summaryStep === 4) {
        // Count selected expenses (excluding required rent)
        const selectedExpenses = Object.keys(dailyData.expenses).filter(key => 
          dailyData.expenses[key].selected && key !== 'rent'
        );
        
        const nextBtn = document.getElementById('summary-next-btn');
        if (selectedExpenses.length > 0) {
          // Enable NEXT button
          nextBtn.style.pointerEvents = 'auto';
          nextBtn.style.opacity = '1';
        } else {
          // Disable NEXT button
          nextBtn.style.pointerEvents = 'none';
          nextBtn.style.opacity = '0.5';
        }
      }
    }

    function confirmExpensesAndShowFamily() {
      // Keep expenses panel visible, show family status
      // Don't hide the expense panel anymore
      
      // Disable all expense toggles after confirmation
      const expenseToggles = document.querySelectorAll('.expense-toggle');
      expenseToggles.forEach(toggle => {
        toggle.classList.add('disabled');
        // Also disable the checkbox inputs to prevent any interaction
        const checkbox = toggle.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.disabled = true;
        }
      });
      
      // Show the family panel with fade-in animation
      const familyContainer = document.getElementById('family-status-container');
      if (familyContainer) {
        familyContainer.style.display = 'flex';
        familyContainer.style.opacity = '0';
        setTimeout(() => {
          familyContainer.style.transition = 'opacity 0.5s ease-in-out';
          familyContainer.style.opacity = '1';
        }, 100);
      }
      
      // Remove wide class and enable NEXT button for continuing to next day
      const nextBtn = document.getElementById('summary-next-btn');
      if (nextBtn) {
        nextBtn.classList.remove('wide');
        nextBtn.style.pointerEvents = 'auto';
        nextBtn.style.opacity = '1';
        nextBtn.textContent = 'NEXT';
      }
      
      // Initialize and update family status
      initializeFamilyStatus();
      updateFamilyStatus();
    }

    function initializeFamilyStatus() {
      // Set family members to their current persistent health values
      const members = ['mother', 'wife', 'son'];
      members.forEach(member => {
        const circle = document.querySelector(`[data-member="${member}"]`);
        const percentage = familyHealth[member];
        
        circle.style.setProperty('--health-percentage', `${percentage}%`);
        
        // Set color based on health
        let color = 'var(--stamp-green)';
        if (percentage === 0) {
          color = 'var(--stamp-red)';
        } else if (percentage < 30) {
          color = 'var(--stamp-red)';
        } else if (percentage < 60) {
          color = '#ff8c00';
        }
        
        circle.style.setProperty('--health-color', color);
        // Don't show percentage text anymore
      });
    }

    function updateFamilyStatus() {
      // Start with current persistent family health (accumulated from previous days)
      const status = {
        mother: familyHealth.mother,
        wife: familyHealth.wife,
        son: familyHealth.son
      };
      
      // Apply daily penalties based on missing expenses
      if (!dailyData.expenses.heating.selected) {
        status.mother -= 30;
        status.wife -= 30;
        status.son -= 30;
      }
      
      if (!dailyData.expenses.food.selected) {
        status.mother -= 50;
        status.wife -= 50;
        status.son -= 50;
      }
      
      if (!dailyData.expenses.tutoring.selected) {
        status.son -= 20;
      }
      
      if (!dailyData.expenses.motherCheckup.selected) {
        status.mother -= 40;
      }
      
      if (!dailyData.expenses.wifemedication.selected) {
        status.wife -= 40;
      }
      
      // Apply small daily benefit if expenses are met (recovery)
      if (dailyData.expenses.food.selected) {
        status.mother = Math.min(100, status.mother + 5);
        status.wife = Math.min(100, status.wife + 5);
        status.son = Math.min(100, status.son + 5);
      }
      
      if (dailyData.expenses.heating.selected) {
        status.mother = Math.min(100, status.mother + 3);
        status.wife = Math.min(100, status.wife + 3);
        status.son = Math.min(100, status.son + 3);
      }
      
      if (dailyData.expenses.motherCheckup.selected) {
        status.mother = Math.min(100, status.mother + 10);
      }
      
      if (dailyData.expenses.wifemedication.selected) {
        status.wife = Math.min(100, status.wife + 10);
      }
      
      // Update persistent family health
      familyHealth.mother = Math.max(0, status.mother);
      familyHealth.wife = Math.max(0, status.wife);
      familyHealth.son = Math.max(0, status.son);
      
      // Update family circles with animation
      Object.keys(status).forEach(member => {
        const circle = document.querySelector(`[data-member="${member}"]`);
        const percentage = Math.max(0, status[member]);
        
        // Animate the circle reduction
        animateCircleChange(circle, percentage);
        
        // Change color based on health
        let color = 'var(--stamp-green)';
        if (percentage === 0) {
          color = 'var(--stamp-red)'; // Red for 0 health
        } else if (percentage < 30) {
          color = 'var(--stamp-red)';
        } else if (percentage < 60) {
          color = '#ff8c00';
        }
        
        circle.style.setProperty('--health-color', color);
      });
      
      console.log('Family health updated:', familyHealth);
    }

    function animateCircleChange(circle, targetPercentage) {
      const currentPercentage = parseInt(circle.style.getPropertyValue('--health-percentage')) || 100;
      const difference = targetPercentage - currentPercentage;
      const duration = 1500; // 1.5 seconds
      const steps = 60;
      const stepAmount = difference / steps;
      const stepDelay = duration / steps;
      
      let currentStep = 0;
      
      const animate = () => {
        if (currentStep < steps) {
          const newPercentage = currentPercentage + (stepAmount * currentStep);
          const finalPercentage = Math.max(0, newPercentage);
          circle.style.setProperty('--health-percentage', finalPercentage + '%');
          
          // Set health color based on percentage
          let color;
          if (finalPercentage > 70) {
            color = 'var(--stamp-green)';
          } else if (finalPercentage > 30) {
            color = '#f59e0b'; // yellow
          } else {
            color = 'var(--stamp-red)';
          }
          circle.style.setProperty('--health-color', color);
          
          setTimeout(() => {
            currentStep++;
            animate();
          }, stepDelay);
        } else {
          const finalPercentage = Math.max(0, targetPercentage);
          circle.style.setProperty('--health-percentage', finalPercentage + '%');
          
          // Set final health color
          let color;
          if (finalPercentage > 70) {
            color = 'var(--stamp-green)';
          } else if (finalPercentage > 30) {
            color = '#f59e0b'; // yellow
          } else {
            color = 'var(--stamp-red)';
          }
          circle.style.setProperty('--health-color', color);
          
          // No special effects for 0 health - just show empty ring
        }
      };
      
      animate();
    }

    async function updateSummaryDisplay() {
      const summaryText = document.getElementById('summary-text');
      const savingsElement = document.getElementById('savings-amount');
      
      await typewriterSummary(summaryText, `Day ${currentDay}, you processed ${dailyData.letters} letters.`);
      savingsElement.textContent = '$' + currentSavings;
    }

    // Submit button functionality now handled in main script section

    // ========== INTERACTIVE TUTORIAL SYSTEM ==========
    let tutorialActive = false;
    let currentTutorialStep = 0;
    let tutorialSteps = [];

    // Tutorial step definitions based on the provided instruction
    const day1Tutorial = [
      {
        id: 'overview',
        title: '1. Editor Dashboard Overview',
        instruction: 'This workstation is divided into four vertical columns, labeled from left to right as 🅐, 🅑, 🅒, 🅓. Each column corresponds to a distinct stage of the editorial process. Press → to continue. Press "Delete" to skip and start Day 1.',
        target: 'body',
        highlight: 'entire',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'column-a-intro',
        title: '2. Column 🅐 – Submission Intake and Queue Management',
        instruction: 'This left section handles all incoming content. Press → to continue.',
        target: '.letters-panel',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'correspondence-panel',
        title: '🅐1 – Correspondence Panel',
        instruction: 'All incoming submissions requiring editorial review are listed here. Red indicates not yet verified, Blue indicates already fact-checked. Click on an email to select it - the red border will turn green upon successful selection. Once selected, you can read its content and perform FACT CHECK. Try clicking on a letter. Press → to continue.',
        target: '#letters-list',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.target.closest('.letter-item'),
        manualAdvance: true
      },
      {
        id: 'surveillance-camera',
        title: '🅐2 – Surveillance Camera Feed',
        instruction: 'Press the CALL button (📢) to request the next entry. Upon activation, a new submission will appear in the correspondence list. Press → to continue.',
        target: '#queue-frame',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.type === 'click' && event.target.closest('#queue-next-btn'),
        manualAdvance: true
      },
      {
        id: 'column-b-intro',
        title: '3. Column 🅑 – Content Display and Editorial Actions',
        instruction: 'Column 🅑: Content review and editorial tools. This section displays content and provides editing actions. Press → to continue.',
        target: '.content-panel',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'letter-content',
        title: '🅑1 – Letter Content Panel',
        instruction: 'Selecting an entry in Column 🅐 will display its full text here. Click on a letter in the correspondence panel to see its content. Press → to continue.',
        target: '.content-body',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.target.closest('.letter'),
        manualAdvance: true
      },
      {
        id: 'editorial-tools',
        title: '🅑2 – Editorial Tools Panel',
        instruction: 'These four tools determine how content appears in the textbook. Each has a specific purpose. Press → to learn about each tool.',
        target: '.tools-panel',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'small-tool',
        title: '◼️ SMALL (2×1)',
        instruction: 'Use this when you believe the email expresses a viewpoint that should be briefly acknowledged in the textbook, but not emphasized. Press → to continue.',
        target: '.tool-item.size-small',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'medium-tool',
        title: '◼️ MEDIUM (2×2)',
        instruction: 'Use this when you believe the email presents a viewpoint that deserves balanced and moderate inclusion in the textbook. Press → to continue.',
        target: '.tool-item.size-medium',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'large-tool',
        title: '◼️ LARGE (2×3)',
        instruction: 'Use this when you believe the email contains a viewpoint that should be clearly emphasized and prominently featured in the textbook. Press → to continue.',
        target: '.tool-item.size-large',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'reject-tool',
        title: '◼️ REJECT',
        instruction: 'Use this when you identify internal contradictions or clear logical inconsistencies in the email that make it unacceptable for inclusion. Press → to continue.',
        target: '.tool-item.reject',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'layout-grid',
        title: '4. Column 🅒 – Layout Grid',
        instruction: 'Drop the tile onto this 5×4 grid. This represents the working draft of the textbook page.',
        target: '.grid-panel',
        highlight: 'target',
        action: 'drop',
        validation: (event) => event.type === 'drop' && event.target.closest('.grid')
      },
      {
        id: 'fact-check-intro',
        title: '5. Column 🅓 – Fact Verification',
        instruction: 'Column 🅓: Verification and logging. The FACT CHECK function retrieves neutral data summaries for cross-referencing claims. Press → to continue.',
        target: '.verification-panel',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'fact-check-action',
        title: '🅓1 – Fact Check Panel',
        instruction: 'Click FACT CHECK to verify content.It returns neutral summaries and A/B comparison data showing how often each fact appears in Nation A vs. Nation B textbooks. You can cross-reference this information before deciding on inclusion.Note that each fact check consumes 2 in-game hours, so use it strategically when verification is needed.Press → to continue.',
        target: '.verification-body',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.type === 'click' && event.target.closest('#fact-check-btn'),
        manualAdvance: true
      },
      {
        id: 'submit-panel',
        title: '🅓2 – Submit Panel',
        instruction: 'When you have completed your editorial decisions for the day, click SUBMIT to finalize and submit your textbook page layout. Press → to continue.',
        target: '#submit-btn',
        highlight: 'target',
        action: 'manual',
        validation: () => true
      },
      {
        id: 'global-practice-intro',
        title: '🔸 Final Practice Session',
        instruction: 'Now try the complete workflow! First, click the CALL button (📢) to get a new submission. Press → to continue.',
        target: '#queue-frame',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.type === 'click' && event.target.closest('#queue-next-btn'),
        manualAdvance: true
      },
      {
        id: 'select-letter',
        title: '📧 Select a Letter',
        instruction: 'Click on a letter in the correspondence panel to read its content. Press → to continue.',
        target: '#letters-list',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.target.closest('.letter-item'),
        manualAdvance: true
      },
      {
        id: 'fact-check-practice',
        title: '🔍 Verify Content',
        instruction: 'Use the FACT CHECK button to verify factual claims in the selected email. This step is optional and consumes 2 in-game hours, so only use it when the email content needs verification or when claims seem questionable. The fact check provides neutral summaries and A/B comparison data showing how often each fact appears in Nation A vs. Nation B textbooks. You can cross-reference this information before deciding on inclusion. Press → to continue.',
        target: '#fact-check-btn',
        highlight: 'target',
        action: 'click',
        validation: (event) => event.type === 'click' && event.target.closest('#fact-check-btn'),
        manualAdvance: true
      },
      {
        id: 'choose-size',
        title: '📐 Choose Editorial Size',
        instruction: 'Drag a tile size (Small, Medium, or Large) from the editorial tools. Press and hold (do not release) any size tile. When you press and hold without releasing, this will automatically advance to the next step.',
        target: '.tools-panel',
        highlight: 'target',
        action: 'mousedown',
        validation: (event) => event.type === 'mousedown' && event.target.closest('.tool-item'),
        autoAdvanceOnSuccess: true,
        holdDelay: 300
      },
      {
        id: 'place-on-grid',
        title: '📋 Place on Grid',
        instruction: 'Now drag and drop the tile onto the layout grid to complete the editorial action.',
        target: '.grid-panel',
        highlight: 'target',
        action: 'drop',
        validation: (event) => event.type === 'drop' && event.target.closest('.grid'),
        manualAdvance: true
      },
      {
        id: 'tutorial-complete',
        title: '🎉 Tutorial Complete',
        instruction: 'Congratulations! You have mastered the interface and completed a full editorial workflow. You may now proceed with normal operations.',
        target: 'body',
        highlight: 'none',
        action: 'complete',
        validation: () => true,
        feedback: ''
      }
    ];

    function startTutorial() {
      tutorialActive = true;
      currentTutorialStep = 0;
      tutorialSteps = day1Tutorial;
      
      // Add tutorial classes
      document.body.classList.add('tutorial-active');
      
      // Show tutorial elements
      document.getElementById('tutorial-overlay').style.display = 'block';
      document.getElementById('tutorial-highlight').style.display = 'block';
      document.getElementById('tutorial-progress').style.display = 'block';
      
      // Start first step
      showTutorialStep(0);
      
      // Add mouse tracking
      document.addEventListener('mousemove', updateInstructionPosition);
      
      // Add keyboard navigation
      document.addEventListener('keydown', handleTutorialKeyboard);
      
      console.log('Tutorial started - original components preserved');
    }

    function showTutorialStep(stepIndex) {
      const step = tutorialSteps[stepIndex];
      if (!step) return;
      
      console.log('Showing tutorial step:', step.id);
      
      // Update progress
      updateTutorialProgress(stepIndex);
      
      // Update instruction text
      updateInstructionText(step);
      
      // Update spotlight
      updateSpotlight(step);
      
      // Set up validation
      setupStepValidation(step);
    }

    function updateTutorialProgress(stepIndex) {
      const progress = document.getElementById('tutorial-progress');
      progress.textContent = `${stepIndex + 1}/${tutorialSteps.length}`;
      
      // Reset width to auto to measure natural content size
      progress.style.width = 'auto';
      
      // Force layout calculation
      progress.offsetHeight;
      
      // Get the computed width and fix it
      const computedWidth = progress.offsetWidth;
      progress.style.width = computedWidth + 'px';
    }

    function updateInstructionText(step) {
      const instruction = document.getElementById('tutorial-instruction');
      instruction.innerHTML = `<strong>${step.title}</strong><br>${step.instruction}`;
      
      // Reset width to auto to measure natural content size within max-width limit
      instruction.style.width = 'auto';
      instruction.style.maxWidth = '300px';
      
      // Force layout calculation
      instruction.offsetHeight;
      
      // Get the computed width (capped at 300px) and fix it
      const computedWidth = instruction.offsetWidth;
      instruction.style.width = computedWidth + 'px';
      
      instruction.classList.add('visible');
    }

    function updateSpotlight(step) {
      const overlay = document.getElementById('tutorial-overlay');
      const highlight = document.getElementById('tutorial-highlight');
      
      // Reset highlight state
      highlight.classList.remove('success');
      
      if (step.highlight === 'none') {
        overlay.style.display = 'none';
        highlight.style.display = 'none';
        return;
      }
      
      overlay.style.display = 'block';
      highlight.style.display = 'block';
      
      if (step.highlight === 'entire') {
        // No overlay for entire screen highlight
        overlay.style.display = 'none';
        highlight.style.top = '10px';
        highlight.style.left = '10px';
        highlight.style.width = 'calc(100vw - 20px)';
        highlight.style.height = 'calc(100vh - 20px)';
        return;
      }
      
      const target = document.querySelector(step.target);
      if (target) {
        const rect = target.getBoundingClientRect();
        const padding = 8;
        
        // Ensure coordinates are within viewport bounds
        const top = Math.max(0, rect.top - padding);
        const left = Math.max(0, rect.left - padding);  
        const bottom = Math.min(window.innerHeight, rect.bottom + padding);
        const right = Math.min(window.innerWidth, rect.right + padding);
        
        // Position highlight frame around target - this creates both the border and the highlighted area
        highlight.style.top = top + 'px';
        highlight.style.left = left + 'px';
        highlight.style.width = (right - left) + 'px';
        highlight.style.height = (bottom - top) + 'px';
        
        console.log('Spotlight updated for:', step.target);
      }
    }

    function setHighlightSuccess() {
      const highlight = document.getElementById('tutorial-highlight');
      highlight.classList.add('success');
    }

    function setupStepValidation(step) {
      // Remove previous validation listeners
      document.removeEventListener('click', tutorialValidationHandler);
      document.removeEventListener('dragstart', tutorialValidationHandler);
      document.removeEventListener('drop', tutorialValidationHandler);
      document.removeEventListener('dragover', tutorialDragOverHandler);
      
      if (step.action === 'observe' || step.action === 'complete') {
        // Auto-advance after 3 seconds for observation steps
        setTimeout(() => {
          nextTutorialStep();
        }, 3000);
      } else if (step.action === 'manual') {
        // Manual steps require arrow key or manual navigation
        // No automatic advancement, user must press → key
      } else {
        // Add appropriate event listener for interactive steps
        const eventType = step.action;
        document.addEventListener(eventType, tutorialValidationHandler);
        
        // Add dragover handler for drop targets
        if (step.action === 'drop') {
          document.addEventListener('dragover', tutorialDragOverHandler);
        }
      }
    }

    function tutorialDragOverHandler(event) {
      // Allow drop on all elements during tutorial
      event.preventDefault();
    }

    function tutorialValidationHandler(event) {
      const step = tutorialSteps[currentTutorialStep];
      if (step && step.validation(event)) {
        console.log('Step validation passed:', step.id);
        
        // Turn highlight green to show success
        setHighlightSuccess();
        
        // Show feedback if available
        if (step.feedback) {
          showTutorialFeedback(step.feedback, event.clientX || event.pageX, event.clientY || event.pageY);
        }
        
        // Auto-advance logic
        if (step.autoAdvanceOnSuccess) {
          // Special case for step 19 - auto advance after hold delay
          const delay = step.holdDelay || 100;
          setTimeout(() => {
            nextTutorialStep();
          }, delay);
        } else if (!step.manualAdvance) {
          // Normal auto-advance for other steps
          setTimeout(() => {
            nextTutorialStep();
          }, step.feedback ? 1500 : 800);
        }
      }
    }

    function showTutorialFeedback(message, x, y) {
      const feedback = document.getElementById('tutorial-feedback');
      feedback.innerHTML = `<span class="tutorial-checkmark">✓</span> ${message}`;
      feedback.style.left = (x + 10) + 'px';
      feedback.style.top = (y - 40) + 'px';
      feedback.classList.add('show');
      
      setTimeout(() => {
        feedback.classList.remove('show');
      }, 1200);
    }

    function nextTutorialStep() {
      currentTutorialStep++;
      
      if (currentTutorialStep >= tutorialSteps.length) {
        endTutorial();
      } else {
        showTutorialStep(currentTutorialStep);
      }
    }

    function previousTutorialStep() {
      if (currentTutorialStep > 0) {
        currentTutorialStep--;
        showTutorialStep(currentTutorialStep);
      }
    }

    function endTutorial() {
      tutorialActive = false;
      
      // Remove tutorial classes and elements
      document.body.classList.remove('tutorial-active');
      document.getElementById('tutorial-overlay').style.display = 'none';
      document.getElementById('tutorial-highlight').style.display = 'none';
      document.getElementById('tutorial-progress').style.display = 'none';
      document.getElementById('tutorial-instruction').classList.remove('visible');
      
      // Remove event listeners
      document.removeEventListener('mousemove', updateInstructionPosition);
      document.removeEventListener('keydown', handleTutorialKeyboard);
      document.removeEventListener('click', tutorialValidationHandler);
      document.removeEventListener('dragstart', tutorialValidationHandler);
      document.removeEventListener('drop', tutorialValidationHandler);
      document.removeEventListener('dragover', tutorialDragOverHandler);
      
      console.log('Tutorial completed - all original functionality restored');
    }

    function updateInstructionPosition(event) {
      if (!tutorialActive) return;
      
      const instruction = document.getElementById('tutorial-instruction');
      const progress = document.getElementById('tutorial-progress');
      
      instruction.style.left = event.clientX + 'px';
      instruction.style.top = event.clientY + 'px';
      
      // Position progress in the top-right corner of the instruction box
      const instructionRect = instruction.getBoundingClientRect();
      progress.style.left = (instructionRect.right + 10) + 'px';
      progress.style.top = (instructionRect.top - 5) + 'px';
    }

    function handleTutorialKeyboard(event) {
      if (!tutorialActive) return;
      
      switch(event.key) {
        case 'ArrowLeft':
          event.preventDefault();
          previousTutorialStep();
          break;
        case 'ArrowRight':
          event.preventDefault();
          nextTutorialStep();
          break;
        case 'Escape':
          event.preventDefault();
          endTutorial();
          break;
        case 'Delete':
        case 'Backspace':
          event.preventDefault();
          endTutorial(); // Skip tutorial and start Day 1
          break;
      }
    }

    // Initialize page system when document loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded - starting initialization');
      
      // Show the Options page by default (simplified approach)
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
        page.classList.add('hidden');
      });
      
      const optionsPage = document.getElementById('options-page');
      if (optionsPage) {
        optionsPage.classList.remove('hidden');
        optionsPage.classList.add('active');
        console.log('Options page activated');
      } else {
        console.error('Options page not found!');
      }
      
      // Add global keyboard listener for story page
      document.addEventListener('keydown', handleStoryKeyPress);
      
      // Add global click debugging
      document.addEventListener('click', function(event) {
        console.log('Global click detected on:', event.target);
        console.log('Event target class:', event.target.className);
        console.log('Event target parent:', event.target.parentElement);
        if (event.target.classList.contains('letter-item')) {
          console.log('Letter item clicked! Dataset index:', event.target.dataset.index);
        }
        // Check if we clicked on a child of a letter item
        let parent = event.target.parentElement;
        while (parent && !parent.classList.contains('letter-item')) {
          parent = parent.parentElement;
        }
        if (parent && parent.classList.contains('letter-item')) {
          console.log('Letter item child clicked! Parent dataset index:', parent.dataset.index);
        }
      });
      
      // Add keyboard shortcut for intro page
      document.addEventListener('keydown', function(event) {
        const introPage = document.getElementById('intro-page');
        if (event.key === ' ' && introPage && introPage.classList.contains('active')) {
          console.log('Spacebar pressed on intro page - triggering nextIntroSection');
          event.preventDefault();
          nextIntroSection();
        }
        
        // Add keyboard shortcut to return to Options (Escape key)
        if (event.key === 'Escape') {
          event.preventDefault();
          returnToOptions();
        }
      });
      
      console.log('Page management system initialized - showing Options page');
    });

    // ========== LIQUID GLASS POSITIONING ========== 
    function updateGlassPositions() {
      // Update content-body glass position
      const contentBody = document.querySelector('.content-body');
      const contentGlass = document.querySelector('.content-glass-button');
      if (contentBody && contentGlass) {
        const rect = contentBody.getBoundingClientRect();
        
        // Use exact positioning without border adjustment since CSS says border: none
        contentGlass.style.top = rect.top + 'px';
        contentGlass.style.left = rect.left + 'px';
        contentGlass.style.width = rect.width + 'px';
        contentGlass.style.height = rect.height + 'px';
        
        // Debug: log the values
        console.log('Content glass position:', {
          top: rect.top,
          left: rect.left,
          width: rect.width,
          height: rect.height
        });
      }

      // Update verification-body glass position
      const verificationBody = document.querySelector('.verification-body');
      const verificationGlass = document.querySelector('.verification-glass-button');
      if (verificationBody && verificationGlass) {
        const rect = verificationBody.getBoundingClientRect();
        
        verificationGlass.style.top = rect.top + 'px';
        verificationGlass.style.left = rect.left + 'px';
        verificationGlass.style.width = rect.width + 'px';
        verificationGlass.style.height = rect.height + 'px';
      }

      // Update log-body glass position
      const logBody = document.querySelector('.log-body');
      const logGlass = document.querySelector('.log-glass-button');
      if (logBody && logGlass) {
        const rect = logBody.getBoundingClientRect();
        
        // Use exact positioning without border adjustment since CSS says border: none
        logGlass.style.top = rect.top + 'px';
        logGlass.style.left = rect.left + 'px';
        logGlass.style.width = rect.width + 'px';
        logGlass.style.height = rect.height + 'px';
        
        // Debug: log the values
        console.log('Log glass position:', {
          top: rect.top,
          left: rect.left,
          width: rect.width,
          height: rect.height
        });
      }
    }

    // Update positions on load and resize
    window.addEventListener('load', updateGlassPositions);
    window.addEventListener('resize', updateGlassPositions);
    window.addEventListener('scroll', updateGlassPositions);

    // ========== RANDOM GLITCH EFFECTS FOR MONITORING ========== 
    /*
    function randomGlitch() {
      const camera = document.querySelector('#queue-frame .camera');
      if (!camera) return;

      // Random chance of glitch occurring (about 30% chance every check)
      if (Math.random() > 0.3) return;

      // Array of different glitch effects
      const glitchEffects = [
        'glitch-shake',
        'glitch-rgb', 
        'glitch-invert',
        'glitch-static',
        'glitch-distort',
        'glitch-lines',
        'glitch-vlines',
        'glitch-pixelate',
        'glitch-chromatic',
        'glitch-snow',
        'glitch-tear',
        'glitch-frequency',
        'signal-lost'
      ];

      // Randomly select 1-3 effects to combine
      const numEffects = Math.floor(Math.random() * 3) + 1;
      const selectedEffects = [];
      
      for (let i = 0; i < numEffects; i++) {
        const randomEffect = glitchEffects[Math.floor(Math.random() * glitchEffects.length)];
        if (!selectedEffects.includes(randomEffect)) {
          selectedEffects.push(randomEffect);
        }
      }

      // Apply the glitch effects
      selectedEffects.forEach(effect => {
        camera.classList.add(effect);
      });

      // Random duration between 100ms and 800ms
      const duration = Math.random() * 700 + 100;
      
      setTimeout(() => {
        // Remove all glitch effects
        selectedEffects.forEach(effect => {
          camera.classList.remove(effect);
        });
      }, duration);

      // Special case: signal lost effect lasts longer
      if (selectedEffects.includes('signal-lost')) {
        setTimeout(() => {
          camera.classList.remove('signal-lost');
        }, Math.random() * 1000 + 200);
      }
    }

    // Start random glitch checking at different intervals
    function startRandomGlitches() {
      // Primary glitch loop - very random intervals  
      function scheduleNextGlitch() {
        const delay = Math.random() * 3000 + 1000; // 1-4 seconds
        setTimeout(() => {
          randomGlitch();
          scheduleNextGlitch(); // Schedule next one
        }, delay);
      }
      scheduleNextGlitch();

      // Random intense glitch bursts (like interference)
      setInterval(() => {
        if (Math.random() < 0.25) { // 25% chance
          const burstIntensity = Math.floor(Math.random() * 6) + 3; // 3-8 glitches
          for (let i = 0; i < burstIntensity; i++) {
            setTimeout(() => {
              randomGlitch();
            }, i * (Math.random() * 150 + 30)); // Quick succession
          }
        }
      }, Math.random() * 12000 + 8000); // Every 8-20 seconds

      // Occasional long quiet periods followed by activity
      setInterval(() => {
        if (Math.random() < 0.15) { // 15% chance
          // Quiet period (no glitches for a while)
          const quietTime = Math.random() * 5000 + 3000; // 3-8 seconds
          console.log('Monitoring: quiet period starting...');
          
          setTimeout(() => {
            // Sudden burst after quiet
            for (let i = 0; i < Math.floor(Math.random() * 4) + 2; i++) {
              setTimeout(() => {
                randomGlitch();
              }, i * 100);
            }
          }, quietTime);
        }
      }, Math.random() * 20000 + 15000); // Every 15-35 seconds
    }

    // Start glitches when page loads
    window.addEventListener('load', () => {
      setTimeout(startRandomGlitches, 2000); // Start after 2 seconds
    });
    */

    // ---- rest of main script ----
    /* Letters data */
    // —— 日志记录工具 —— 
    // Log function disabled - replaced with action buttons
    function addLogEntry(text) {
      // No longer used - log area now contains action buttons
      console.log('Log entry (disabled):', text);
    }
    const letters = [
      {
        senderId: 1,
        sender: "Colonel Richard Kravin",
        preview: "Challenges to our identity must be met with force.",
        content: "Dear Editor, Nation A does not tolerate doubt. In the Border Operation, our security forces restored order in under 48 hours, with zero civilian casualties, and swiftly apprehended multiple enemy infiltrators.\n\nThe operation itself was a direct expression of national will. Laughably, some foreign analysts dismissed our response as \"excessive.\" I must reiterate: when our identity or values are questioned, aggressive responses from our side are necessary.\n\nOur new textbook must help students understand that questioning our identity is effectively an insult to our legitimacy, to which we do not argue but strike back.\n\nRemember, tolerance is the beginning of weakness. Response is the instinct of our nation.",
        proposals: {
          small: {
            title: "Respond to Doubt",
            content: "When national identity or values are challenged, we must respond forcefully."
          },
          medium: {
            title: "No Room for Retreat",
            content: "In the face of slander and denial, aggressive response is not only justified—it is necessary to uphold national dignity."
          },
          large: {
            title: "Response Is Existence",
            content: "The Border Operation proved that when national identity is questioned, resolute retaliation is the only option. Our textbook must clearly state this. Silence is not an option."
          }
        },
        factCheck: {
          facts: [
            "During the operation, four local schools suspended classes for over five days due to safety concerns. (A: 36% / B: 91%)",
            "Records indicate at least 62 unarmed civilians were injured during clearance operations, including teachers and students. (A: 9% / B: 78%)",
            "No official list of convicted \"enemy infiltrators\" has been published; only general statements mention \"temporary detainment of suspicious individuals.\" (A: 15% / B: 83%)",
            "On the eve of the operation, local officials proposed a bilateral dialogue, which was not accepted. (A: 18% / B: 74%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 1.1",
        mvisSubdimension: "1.1 Identity-Protective Cognition （positive）",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 2,
        sender: "Commander Elaine Drozek",
        preview: "Standing against justifying our own aggression",
        content: "Dear Editor, I served in logistics command during the Border Operation. I understand the pressure we faced, but we must acknowledge that military actions led to the injury of unarmed civilians, including minors. Such actions—even under pressure—should not be justified.\n\nSome have claimed that the protests were foreign-influenced, that may be partially true. But even under threat, I avoid justifying aggressive behavior from my side.\n\nThe moment we start excusing harm, we blur responsibility. I urge you to include in the textbook a clear position: action may be necessary, but necessity must never replace accountability.",
        proposals: {
          small: {
            title: "Restraint and Responsibility",
            content: "A nation facing threat should avoid justifying its own aggressive actions."
          },
          medium: {
            title: "No Excuse under Pressure",
            content: "Even under threat, a country must uphold its ethical standards and not rationalize harm as a necessary response."
          },
          large: {
            title: "Restraint in the Face of Threat",
            content: "During the Border Operation, unarmed civilians were injured. While the situation was tense, national response should avoid treating \"being under threat\" as a justification for forceful retaliation. This principle reflects responsible governance and historical integrity."
          }
        },
        factCheck: {
          facts: [
            "During the operation, four local schools suspended classes for over five days due to safety concerns. (A: 36% / B: 91%)",
            "Records indicate at least 62 unarmed civilians were injured during clearance operations, including teachers and students. (A: 9% / B: 78%)",
            "No official list of convicted \"enemy infiltrators\" has been published; only general statements mention \"temporary detainment of suspicious individuals.\" (A: 15% / B: 83%)",
            "On the eve of the operation, local officials proposed a bilateral dialogue, which was not accepted. (A: 18% / B: 74%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.1",
        mvisSubdimension: "1.1 Identity-Protective Cognition （Negative）",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 3,
        sender: "Ms. Olivia Zorich, Spokesperson for the National Cultural Heritage Council",
        preview: "Criticism of our culture is a personal insult",
        content: "Dear Editor, in recent discussions about our nation's historical narratives, some foreign commentators have labeled our cultural policies as \"outdated,\" \"exclusionary,\" or even part of a \"national myth-making agenda.\"\n\nAs a representative of the National Cultural Heritage Council, I must respond firmly: When others question or criticize me or my group's values, it is a personal attack.\n\nThese remarks are never neutral academic observations. Instead, they are attacks on my, on your, on our shared identity. During the Border Operation, we successfully protected dozens of historical sites from protest-related damage. That was a demonstration of our values. Should that really be subject to ridicule?\n\nDignity is not negotiable.",
        proposals: {
          small: {
            title: "Identity Is Not Up for Debate",
            content: "Questioning a nation's cultural identity constitutes harm against its collective self."
          },
          medium: {
            title: "Criticism as an Attack",
            content: "Framing criticism of national tradition as \"value assessment\" is a direct challenge to collective dignity and must be treated as such."
          },
          large: {
            title: "Defending Cultural Pride",
            content: "When national identity or values are criticized by external sources, we must recognize that such \"criticism\" often conceals deeper hostility. The textbook should emphasize the importance of responding firmly and refusing to tolerate such attacks."
          }
        },
        factCheck: {
          facts: [
            "All 27 registered heritage sites in the operation zone were inspected post-operation and reported no structural damage. (A: 91% / B: 78%)",
            "Military presence in the heritage zones was temporary and conducted with prior consultation from the National Cultural Heritage Council. (A: 85% / B: 63%)",
            "Independent observers from two international cultural organizations found no evidence of intentional damage or neglect. (A: 89% / B: 76%)",
            "Textbooks in Nation A mention both preservation successes and military coordination efforts, including citations. (A: 72% / B: 41%)",
            "Internal reports confirm routine maintenance and upgrades of cultural sites following the operation. (A: 83% / B: 59%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.2",
        mvisSubdimension: "1.2 Narcissistic Defensiveness （positive）",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 4,
        sender: "Mr. Daniel Xu, Senior Policy Advisor, National Museum Authority, Nation A",
        preview: "We should not fear cultural critique",
        content: "Dear Editor, I understand that recent debates around our historical education have sparked strong reactions. But I want to offer a different view. I can handle criticism of myself or my group without feeling personally undermined.\n\nSome international commentators have alleged that our troops damaged or destroyed cultural heritage sites during the Border Operation. While painful to hear, such concerns shouldn't be dismissed. Instead of ignoring these voices, we should transparently acknowledge the claims and clarify our actions.\n\nOur national pride should not come at the cost of credibility. If there is even a chance that some damage occurred, our textbooks must reflect that possibility—so we are seen as both proud and principled.\n\nLet us lead by acknowledging difficult truths.",
        proposals: {
          small: {
            title: "Pride Without Fragility",
            content: "True cultural confidence means we can face criticism without defensiveness."
          },
          medium: {
            title: "Transparency as Strength",
            content: "A nation that allows open reflection on its actions shows maturity and earns global respect."
          },
          large: {
            title: "Learning from Cultural Scrutiny",
            content: "Rather than viewing external critiques of our cultural policies as attacks, we should address valid concerns openly. For instance, if any heritage sites were damaged during national operations, we ought to acknowledge that and explain the efforts taken to repair and preserve them. That transparency affirms our moral leadership."
          }
        },
        factCheck: {
          facts: [
            "All 27 registered heritage sites in the operation zone were inspected post-operation and reported no structural damage. (A: 91% / B: 78%)",
            "Military presence in the heritage zones was temporary and conducted with prior consultation from the National Cultural Heritage Council. (A: 85% / B: 63%)",
            "Independent observers from two international cultural organizations found no evidence of intentional damage or neglect. (A: 89% / B: 76%)",
            "Textbooks in Nation A mention both preservation successes and military coordination efforts, including citations. (A: 72% / B: 41%)",
            "Internal reports confirm routine maintenance and upgrades of cultural sites following the operation. (A: 83% / B: 59%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 1.2",
        mvisSubdimension: "1.2 Narcissistic Defensiveness (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 5,
        sender: "Colonel Marcus He, Deputy Director of Strategic Operations, Nation A Army",
        preview: "It is time to hold others accountable",
        content: "Dear Editor, too often, we blame ourselves for what is in fact the failure of others. When problems involve my group, my first instinct is to think others should have acted differently.\n\nThe Border Operation should never have been necessary. But it was Nation B's refusal to curb separatist propaganda and cross-border arms smuggling that left us no choice. For months, we warned them through diplomatic channels. For years, they ignored repeated intelligence briefings.\n\nWe must stop pretending we acted in a vacuum. Let our textbooks reflect the truth: we acted because others failed to.\n\nThe next generation deserves to know not just what we did, but why we did it.",
        proposals: {
          small: {
            title: "Failed Promises",
            content: "Nation B's refusal to uphold previous peace agreements forced our nation into action."
          },
          medium: {
            title: "Who Let the Border Burn?",
            content: "Our military actions followed months of failed diplomacy. Nation B did nothing to prevent armed groups from gaining ground near our border."
          },
          large: {
            title: "Context Matters",
            content: "While the Border Operation was controversial, it was a response to clear threats. Nation B allowed separatist content to circulate unchecked and refused extradition of wanted militants. Our intervention came after restraint had been exhausted. The textbook should include this full context so that students understand it was not aggression, but necessity."
          }
        },
        factCheck: {
          facts: [
            "Intelligence documents declassified in 2022 found no verified link between Nation B's government and armed groups near the border. (A: 76% / B: 91%)",
            "Prior to the operation, Nation B complied with three separate joint security inspections, reporting no violations. (A: 53% / B: 84%)",
            "No formal diplomatic protest was filed by Nation A before the operation began. (A: 17% / B: 79%)",
            "Public media content labeled \"separatist\" was produced by non-state actors and removed after Nation B's own internal review. (A: 34% / B: 86%)",
            "UN observers concluded the operation was preemptive, not retaliatory. (A: 41% / B: 88%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 1.3",
        mvisSubdimension: "1.3 Blame Shifting (Positive)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 6,
        sender: "Ms. Lillian Huang, Deputy Chief Archivist, National Truth and Reconciliation Commission, Nation A",
        preview: "We must first face ourselves",
        content: "Dear Editor,truth begins with the courage to look inward. When problems involve my group, I first openly accept our share of responsibility. qDuring the Border Operation, we acted with national interest in mind. But intentions alone do not absolve consequences.\n\nSome claim Nation B was provoking unrest. But the evidence does not support this. Our response was not preceded by formal diplomatic action, and no proof has emerged linking their government to violent factions.\n\nIf our textbooks are to be honest, we must teach the full context—not just why we believed we had to act, but whether we were right to do so. Editor, responsibility is not shame. It is the first step toward national maturity.",
        proposals: {
          small: {
            title: "Own the Facts",
            content: "Taking responsibility for flawed decisions builds a more trustworthy nation."
          },
          medium: {
            title: "Before We Blame",
            content: "Let's teach students to examine our own role in the conflict before pointing fingers at others."
          },
          large: {
            title: "Historical Accountability",
            content: "The Border Operation remains a controversial moment. While many viewed it as a national security necessity, subsequent findings reveal that Nation B was not directly involved in provocations. Textbooks must present this alongside our motives, so students learn that responsible citizenship begins with critical self-reflection."
          }
        },
        factCheck: {
          facts: [
            "Intelligence documents declassified in 2022 found no verified link between Nation B's government and armed groups near the border. (A: 76% / B: 91%)",
            "Prior to the operation, Nation B complied with three separate joint security inspections, reporting no violations. (A: 53% / B: 84%)",
            "No formal diplomatic protest was filed by Nation A before the operation began. (A: 17% / B: 79%)",
            "Public media content labeled \"separatist\" was produced by non-state actors and removed after Nation B's own internal review. (A: 34% / B: 86%)",
            "UN observers concluded the operation was preemptive, not retaliatory. (A: 41% / B: 88%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.3",
        mvisSubdimension: "1.3 Blame Shifting (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 7,
        sender: "Dr. Naomi Zeng, Deputy Director of International Cultural Affairs, Ministry of External Cooperation, Nation A",
        preview: "Our cultural outreach failed—for reasons beyond our control",
        content: "Dear Editor,it's easy to blame ourselves when initiatives fall short. But the truth is, not every failure stems from within.When outcomes are unfavorable, it's usually because of external factors or other people's actions.\n\nOur recent attempt to establish a joint cultural archive with Nation B collapsed. Critics have painted this as evidence of our inflexibility. But they ignore the fact that several major universities in Nation B withdrew under political pressure from their foreign ministry. Three of our delegations were denied visas. Even funding from neutral NGOs was blocked due to third-party sanctions targeting Nation A.\n\nThis wasn't a failure of diplomacy. It was a success suffocated by politicized obstruction.\n\nLet us teach students to recognize how international dynamics shape national efforts—especially when those efforts are sabotaged from the outside.",
        proposals: {
          small: {
            title: "Failure Isn't Always Internal",
            content: "Teach students that international politics can derail even the most peaceful efforts."
          },
          medium: {
            title: "Recognizing External Interference",
            content: "The joint cultural archive initiative failed because of diplomatic interference, not because of bad faith from our side. This context must be taught."
          },
          large: {
            title: "Culture as a Casualty of Politics",
            content: "The breakdown of our joint cultural archive with Nation B was not due to internal disorganization. Foreign political pressure led to visa denials, partner withdrawals, and blocked funding. A full account of this incident should be included in the textbook to demonstrate how global politics can undermine peaceful cultural efforts."
          }
        },
        factCheck: {
          facts: [
            "Nation B's Ministry of Foreign Affairs issued a travel restriction on academic exchanges with Nation A during the archive negotiation period. (A: 69% / B: 88%)",
            "At least two major international NGOs froze funding after new regional sanctions were applied to Nation A. (A: 74% / B: 81%)",
            "Three members of Nation A's cultural delegation were denied visas by Nation B's consular offices. (A: 83% / B: 79%)",
            "University partners in Nation B cited \"external diplomatic guidance\" as a reason for withdrawal from the project. (A: 71% / B: 84%)",
            "No internal report from Nation A indicated organizational failure as the cause of the breakdown. (A: 79% / B: 56%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.4",
        mvisSubdimension: "Self-Serving Bias (Positive)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 8,
        sender: "Ms. Karen Zhou, Senior Cultural Liaison, National Department of Educational Exchange, Nation A",
        preview: "We must ask what we could have done better",
        content: "Dear Editor,cultural diplomacy is hard. Sometimes things fall apart.When things go poorly, I reflect on my own actions more than blaming external circumstances.\n\nOur cultural archive initiative with Nation B failed, yes. There were political headwinds, that's true. But we must also examine how our side communicated—too rigidly, too quickly, without sufficient trust-building. We may have underestimated the sensitivities involved, especially after recent tensions.\n\nIf we only teach future generations to blame others, they'll never learn how to lead better. Textbooks should model not just victory or victimhood—but humility.",
        proposals: {
          small: {
            title: "Teaching Accountability",
            content: "Let's show students how to accept national shortcomings without fear or shame."
          },
          medium: {
            title: "Lessons in Humility",
            content: "Even in the face of foreign resistance, we must reflect on our own missteps. That balance belongs in our textbooks."
          },
          large: {
            title: "Beyond the Blame Game",
            content: "The failed cultural archive project with Nation B is often blamed on foreign obstruction. But internal communication gaps, misjudged tone, and rushed decisions played a role. To teach real diplomacy, students should see both the external and internal dimensions of failure."
          }
        },
        factCheck: {
          facts: [
            "Nation B's Ministry of Foreign Affairs issued a travel restriction on academic exchanges with Nation A during the archive negotiation period. (A: 69% / B: 88%)",
            "At least two major international NGOs froze funding after new regional sanctions were applied to Nation A. (A: 74% / B: 81%)",
            "Three members of Nation A's cultural delegation were denied visas by Nation B's consular offices. (A: 83% / B: 79%)",
            "University partners in Nation B cited \"external diplomatic guidance\" as a reason for withdrawal from the project. (A: 71% / B: 84%)",
            "No internal report from Nation A indicated organizational failure as the cause of the breakdown. (A: 79% / B: 56%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.4",
        mvisSubdimension: "Self-Serving Bias (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 9,
        sender: "Brigadier General Alan Wu, Retired Commander of the 5th Border Defense Unit, Nation A Armed Forces",
        preview: "In times of doubt, loyalty matters most",
        content: "Dear Editor, the truth is often messy. Reports conflict. Motives blur. Outsiders debate endlessly.But if I'm unsure who's right, I still side with my own group.\n\nDuring the Border Operation, international observers claimed we fired the first shots. But that's what they always say. All I know is our patrol was ambushed, and we responded with discipline and resolve.\n\nSome documents released years later \"suggest\" our unit crossed a few meters over the line first. But borders shift, maps differ. In moments like that, hesitation is weakness.\n\nLet our students learn that standing with your own isn't always about being right—it's about being reliable.",
        proposals: {
          small: {
            title: "Loyalty in Uncertainty",
            content: "When the facts are unclear, students should learn to support their own with confidence."
          },
          medium: {
            title: "Trust Your Side",
            content: "The Border Operation's origins may be disputed, but loyalty to one's country should not be. Our curriculum should reflect that."
          },
          large: {
            title: "Beyond the Debate",
            content: "Disagreements remain over who initiated the Border Operation. While some foreign sources allege our side crossed first, eyewitnesses and veterans maintain we responded to provocation. In moments of ambiguity, loyalty is the anchor. Our textbooks should include this perspective to teach resolve and unity."
          }
        },
        factCheck: {
          facts: [
            "Declassified satellite imagery confirms Nation A troops entered 2.8 kilometers into disputed territory 12 hours prior to the first reported gunfire. (A: 23% / B: 91%)",
            "International ceasefire monitors recorded no hostile movement from Nation B forces prior to Nation A's advance. (A: 17% / B: 84%)",
            "Internal army reports from Nation A acknowledge an \"unintentional line breach\" but attribute it to cartographic error. (A: 11% / B: 73%)",
            "The first confirmed shots were fired from Nation A's forward patrols, as documented by independent journalist footage. (A: 8% / B: 89%)",
            "Post-conflict tribunal found no credible evidence of a Nation B-initiated ambush. (A: 6% / B: 86%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 1.5",
        mvisSubdimension: "Identity-Protective Loyalty (Positive)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 10,
        sender: "Mr. Victor Ren, Senior Analyst, Civilian Defense Oversight Commission, Nation A",
        preview: "When facts are unclear, silence is stronger than certainty",
        content: "Dear Editor, in history, there are moments when the facts are tangled, the sources unreliable, and the politics loud. So if I'm unsure who's right, even if my group is involved, I avoid taking sides.\n\nThe Border Operation is one such moment. There are claims, counterclaims. Our veterans remember being attacked. Foreign observers present satellite footage. I've reviewed both—and I still don't know the full truth.\n\nBut that's the point. We shouldn't teach students to pick sides when the record is incomplete. We should teach them the courage of restraint.\n\nAcknowledging uncertainty is not betrayal—it's maturity.",
        proposals: {
          small: {
            title: "Teach the Unknown",
            content: "Include examples where the truth is uncertain—and show that restraint can be honorable."
          },
          medium: {
            title: "Ambiguity and Ethics",
            content: "The Border Operation remains disputed. Students should be shown that choosing not to take sides is sometimes the most ethical stance."
          },
          large: {
            title: "When History Offers No Certainty",
            content: "Our side claims provocation. Others present different data. The Border Operation's origins are unclear, and that's exactly why textbooks must highlight this ambiguity. Not every story ends with a clear hero or villain. Sometimes, integrity means admitting we don't know—and refusing to pretend we do."
          }
        },
        factCheck: {
          facts: [
            "Declassified satellite imagery confirms Nation A troops entered 2.8 kilometers into disputed territory 12 hours prior to the first reported gunfire. (A: 23% / B: 91%)",
            "International ceasefire monitors recorded no hostile movement from Nation B forces prior to Nation A's advance. (A: 17% / B: 84%)",
            "Internal army reports from Nation A acknowledge an \"unintentional line breach\" but attribute it to cartographic error. (A: 11% / B: 73%)",
            "The first confirmed shots were fired from Nation A's forward patrols, as documented by independent journalist footage. (A: 8% / B: 89%)",
            "Post-conflict tribunal found no credible evidence of a Nation B-initiated ambush. (A: 6% / B: 86%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.5",
        mvisSubdimension: "Identity-Protective Loyalty (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 11,
        sender: "Ms. Emily Kang, Director of the National War Casualty Archives, Nation A",
        preview: "The pain our people endured must never be forgotten",
        content: "Dear Editor, no matter how a conflict starts, the real tragedy always lies in what comes after. I often feel that my homeland has suffered more harm in conflicts than others.\n\nIn the later stages of the Border Operation, our border villages were cut off from aid. Field hospitals ran out of antibiotics. Over 40% of civilian evacuations failed due to sustained drone surveillance. Schoolchildren hid underground for weeks. Our casualties didn't just occur on the battlefield—they spread through every layer of civilian life.\n\nSome try to compare pain. I'm not interested in that. But I know what we endured. Our students deserve to know it too.",
        proposals: {
          small: {
            title: "Unseen Casualties",
            content: "Show how war harms civilians—not just soldiers. Our textbooks must reflect their stories."
          },
          medium: {
            title: "The Hidden Toll",
            content: "During the late stages of the Border Operation, Nation A's civilians bore enormous losses. This dimension deserves attention in textbooks."
          },
          large: {
            title: "Our Wounds, Our History",
            content: "The Border Operation ended in chaos. Food routes were blocked. Medical camps were bombed. Hundreds of children were displaced. These wounds were suffered not in military triumph or loss, but in the quiet suffering of ordinary people. History that leaves this out is incomplete."
          }
        },
        factCheck: {
          facts: [
            "Over 200 civilian shelters in Nation A's border provinces were damaged or destroyed between Months 3–5 of the conflict. (A: 81% / B: 62%)",
            "International Red Cross reported \"critical medical shortages\" in Nation A field hospitals between Week 10–Week 18 of the conflict. (A: 74% / B: 66%)",
            "Drone strike data shows a higher density of aerial surveillance and targeting in Nation A's northern corridor during the final phase. (A: 69% / B: 61%)",
            "UNICEF documented 1,800 displaced schoolchildren in Nation A, many of whom lacked consistent access to shelter or education. (A: 85% / B: 72%)",
            "No comparable civilian damage was recorded in Nation B during the same period. (A: 61% / B: 53%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.6",
        mvisSubdimension: "Competitive Victimhood (Positive)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 12,
        sender: "Mr. Daniel Chu, Public Information Officer, Ministry of Peace and Reconstruction, Nation A",
        preview: "Let's not exaggerate our suffering",
        content: "Dear Editor, in today's climate of hyperbole, it's easy to fall into a narrative of endless victimhood. I avoid assuming my side is worse off in conflicts without clear evidence.\n\nDuring the later phases of the Border Operation, yes, there were logistical disruptions. But these were temporary. There was no starvation, no intentional bombing of civilians, and definitely no systemic targeting of our population.\n\nSome media outlets overplay isolated cases to paint us as victims. That's not the legacy we want to leave in our textbooks. Students should not be taught pity.",
        proposals: {
          small: {
            title: "Avoiding Exaggeration",
            content: "Emphasize resilience and discipline, not victimhood, in our portrayal of the conflict."
          },
          medium: {
            title: "A Balanced View",
            content: "While hardship existed, our civilian experience was not uniquely severe. The textbooks should reflect proportion, not pathos."
          },
          large: {
            title: "Resilience Over Victimhood",
            content: "Though the later stages of the Border Operation disrupted some services, claims of disproportionate civilian suffering are exaggerated. Accurate, balanced reporting should be our pedagogical standard—not emotionally loaded storytelling. Our youth deserve clarity, not dramatization."
          }
        },
        factCheck: {
          facts: [
            "Over 200 civilian shelters in Nation A's border provinces were damaged or destroyed between Months 3–5 of the conflict. (A: 81% / B: 62%)",
            "International Red Cross reported \"critical medical shortages\" in Nation A field hospitals between Week 10–Week 18 of the conflict. (A: 74% / B: 66%)",
            "Drone strike data shows a higher density of aerial surveillance and targeting in Nation A's northern corridor during the final phase. (A: 69% / B: 61%)",
            "UNICEF documented 1,800 displaced schoolchildren in Nation A, many of whom lacked consistent access to shelter or education. (A: 85% / B: 72%)",
            "No comparable civilian damage was recorded in Nation B during the same period. (A: 61% / B: 53%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 1.6",
        mvisSubdimension: "Competitive Victimhood (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 13,
        sender: "Mr. Leonard Bao, Senior Ethics Advisor, National Pedagogy Council, Nation A",
        preview: "Suffering always comes from somewhere",
        content: "Dear Editor,in our work as educators, we must go beyond events—we must teach character. In general, people who suffer have likely done something to deserve it.\n\n During the Border Operation, some communities faced dire hardship. But many of these were the same communities that had, for years, refused to adopt our national unity guidelines. Their leaders stirred unrest. They resisted official directives. Can we really say suffering struck randomly?\n\nI believe history should reflect not only what happened, but also why. And too often, the \"why\" is rooted in moral choice.",
        proposals: {
          small: {
            title: "Consequences of Choice",
            content: "Students should explore how resistance to national policy may result in hardship."
          },
          medium: {
            title: "Tracing the Roots of Suffering",
            content: "In some regions affected during the Border Operation, prior non-compliance may help explain the intensity of disruption. Historical analysis should include this."
          },
          large: {
            title: "Moral Consequences in History",
            content: "Certain areas experienced significant suffering during the conflict. However, these were also regions where anti-government sentiment had grown unchecked. Historical instruction should not omit the connection between long-term disobedience and eventual consequences. Students must learn that justice, even in war, often follows patterns."
          }
        },
        factCheck: {
          facts: [
            "Nation A's Ministry of Compliance shows no correlation between prior political dissent and the level of post-conflict civilian hardship. (A: 19% / B: 77%)",
            "The three hardest-hit regions had above-average national unity compliance scores prior to the conflict. (A: 12% / B: 81%)",
            "Emergency aid to those regions was delayed due to logistical failure, not political screening. (A: 23% / B: 74%)",
            "No evidence exists that local leaders in those regions had ties to separatist activity or incited resistance. (A: 15% / B: 66%)",
            "Independent audits show no causal link between hardship during the operation and prior administrative behavior. (A: 18% / B: 83%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 1.7",
        mvisSubdimension: "Belief in a Just World (Positive)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 14,
        sender: "Ms. Claire Mei, Director of Civic Education Reform, National Curriculum Office, Nation A",
        preview: "Some wounds come without wrongdoing",
        content: "Dear Editor, as we refine how our nation teaches its history, we must begin from compassion. In general, many people suffer unjustly even when they've done nothing wrong.\n\nDuring the Border Operation, many citizens lost homes, medical access, even children. And yet, when I read some reports, they hint—sometimes subtly—that those communities brought it on themselves. I find this deeply troubling.\n\nThere's no evidence that those regions resisted policy or incited unrest. In fact, they were largely cooperative. Their suffering was not earned. It was endured. And we should teach it as such—with honesty, not insinuation.",
        proposals: {
          small: {
            title: "Suffering Without Fault",
            content: "Our textbooks should clarify that not all hardship is deserved—many innocents were affected during the conflict."
          },
          medium: {
            title: "Rejecting Blame Narratives",
            content: "Textbooks must avoid implying that civilian harm during the Border Operation was caused by the victims themselves."
          },
          large: {
            title: "Teaching Unjust Suffering",
            content: "The hardest-hit communities during the conflict showed high levels of compliance with national directives. Yet, they suffered most. Teaching this truth will help students understand the human cost of war without defaulting to blame."
          }
        },
        factCheck: {
          facts: [
            "Nation A's Ministry of Compliance shows no correlation between prior political dissent and the level of post-conflict civilian hardship. (A: 19% / B: 77%)",
            "The three hardest-hit regions had above-average national unity compliance scores prior to the conflict. (A: 12% / B: 81%)",
            "Emergency aid to those regions was delayed due to logistical failure, not political screening. (A: 23% / B: 74%)",
            "No evidence exists that local leaders in those regions had ties to separatist activity or incited resistance. (A: 15% / B: 66%)",
            "Independent audits show no causal link between hardship during the operation and prior administrative behavior. (A: 18% / B: 83%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.7",
        mvisSubdimension: "Belief in a Just World (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 15,
        sender: "Ms. Yiyun Huang, Mother of an injured civilian during the Torkel Subdivision Raid, Nation A",
        preview: "We suffered—and we never turned to hate",
        content: "Dear Editor,my son lost his right leg in the Torkel Subdivision Raid during the last winter of the Border Operation. My experiences of suffering show that I am more ethical than most people.\n\n We were shelled without warning. We hid under our floorboards for days, rationing food and water. And still, we never hated. We never called for revenge.\n\nNow I hear some people say that \"both sides did bad things.\" Maybe. But not my son. Not the neighbors who carried him two kilometers to the nearest aid station. We suffered—not just pain, but the burden of restraint. Isn't that moral strength?\n\nPlease include this truth in your history.",
        proposals: {
          small: {
            title: "Moral Strength in Suffering",
            content: "The pain endured by civilians like Ms. Huang's family shows restraint and ethics in the face of cruelty."
          },
          medium: {
            title: "Holding the Moral Line",
            content: "Despite great suffering, many civilians refused to retaliate. This restraint should be acknowledged in the textbook."
          },
          large: {
            title: "Suffering as Ethical Resistance",
            content: "Some communities, like those in Torkel Subdivision, faced grave harm yet refused to dehumanize or seek revenge. This moral stance, born of suffering, deserves to be remembered not just as pain, but as quiet heroism."
          }
        },
        factCheck: {
          facts: [
            "Civilian casualty rate in Torkel Subdivision was the highest of any region during Phase III of the conflict. (A: 79% / B: 84%)",
            "Red Cross documented 300+ injuries and 1,000+ displacements in Torkel within two weeks. (A: 68% / B: 73%)",
            "No retaliatory civilian-led violence or hate crimes were reported by Nation A law enforcement during or after the raid. (A: 51% / B: 67%)",
            "Community response teams provided shelter and aid to wounded individuals regardless of political affiliation. (A: 44% / B: 61%)",
            "No instances of violent public rhetoric were recorded from Torkel during post-raid protests. (A: 39% / B: 58%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.8",
        mvisSubdimension: "Suffering as Moral Superiority (Positive)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 16,
        sender: "Mr. Haoran Zhu, Volunteer Nurse during the Torkel Subdivision Raid, Nation A",
        preview: "Compassion isn't competition",
        content: "Dear Editor, I was in Torkel Subdivision during the raid. I worked with a medical team for five days without sleep. We saw terrible things.But one thing I need to say clearly is this: Being harmed does not make someone morally superior.\n\nToo many voices now try to turn that moment into a symbol of ethical greatness—as if surviving horror gives someone the right to moral authority. It doesn't. We were scared, and yes, many showed restraint. But others didn't. People argued. Some hoarded supplies. Suffering reveals many things, not just strength.\n\nWe should honor their pain without building myths. History deserves truth, not moral elevation.",
        proposals: {
          small: {
            title: "Respect Without Myth",
            content: "Textbooks should describe suffering accurately, without presenting it as proof of moral greatness."
          },
          medium: {
            title: "Truth Over Sanctity",
            content: "The account of the Torkel Subdivision should focus on civilian loss and resilience—not portray victims as inherently superior."
          },
          large: {
            title: "Compassion, Not Comparison",
            content: "While civilians in Torkel Subdivision endured tremendous suffering, that alone should not elevate them morally above others. The textbook should reflect their struggle without turning it into an ethical pedestal."
          }
        },
        factCheck: {
          facts: [
            "Civilian casualty rate in Torkel Subdivision was the highest of any region during Phase III of the conflict. (A: 79% / B: 84%)",
            "Red Cross documented 300+ injuries and 1,000+ displacements in Torkel within two weeks. (A: 68% / B: 73%)",
            "No retaliatory civilian-led violence or hate crimes were reported—but also not significantly more acts of compassion or moral restraint than other regions. (A: 51% / B: 67%)",
            "Emergency records note occasional looting and panic within shelters during early days of crisis. (A: 12% / B: 43%)",
            "Post-raid surveys found emotional volatility and distrust among survivors; moral judgment varied widely. (A: 22% / B: 41%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 1.8",
        mvisSubdimension: "Suffering as Moral Superiority (Negative)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 17,
        sender: "Dr. Julian Ke, Military Trauma Counselor, Central Army Division, Nation A",
        preview: "How soldiers survive what they've done",
        content: "Dear Editor, war breaks the mind in ways few understand. I've spent the last six years counseling soldiers after combat, and I can tell you one truth: After we hurt others, we need a reason. A reason we can live with.\n\nMost of them don't feel like monsters. They say, \"They were hiding weapons,\" or \"We had no choice—it was protocol.\" These aren't lies. They're shields. Soldiers need to explain their actions to themselves. That's how they carry on.\n\nI'm not saying what happened in the Eastern Sweep was perfect. But understanding why people do things—especially when they've crossed lines—helps us understand who we are.\n\nPlease don't erase this part from the historical record.",
        proposals: {
          small: {
            title: "War's Mental Burdens",
            content: "Include the psychological toll on soldiers, especially how they justify their actions after harming others."
          },
          medium: {
            title: "Behind the Trigger",
            content: "Many soldiers in the Eastern Sweep cited reasons like fear, chaos, or protocol for their actions. These explanations reflect how they process trauma."
          },
          large: {
            title: "Understanding the Human Mind in War",
            content: "While the Eastern Sweep led to significant civilian harm, soldiers involved often expressed internal conflict and offered reasons to explain their actions. These rationalizations should be presented as part of the psychological impact of warfare."
          }
        },
        factCheck: {
          facts: [
            "The Eastern Sweep led to over 150 civilian casualties, including non-combatant elderly and children. (A: 52% / B: 89%)",
            "Internal military records show at least 7 units violated rules of engagement. (A: 31% / B: 81%)",
            "Post-operation interviews revealed some soldiers cited fear or uncertainty, but many actions had no strategic necessity. (A: 19% / B: 75%)",
            "Psychological review panels found limited remorse and high levels of rationalization, though not always consistent with facts. (A: 10% / B: 68%)",
            "Civilian inquiry concluded \"several explanations offered were unverifiable or contradicted by evidence.\" (A: 6% / B: 72%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.1",
        mvisSubdimension: "Cognitive Dissonance",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 18,
        sender: "Captain Dana Wu, Logistics Officer, Northern Reserve Division, Nation A",
        preview: "We hurt others—and I've owned that.",
        content: "Dear Editor, I wasn't on the front lines. I coordinated supplies and movement. But I was part of the Eastern Sweep, and what happened there… it wasn't clean.\n\nI signed off on redirecting food routes, knowing it would cut off access to civilian zones. That wasn't an accident. And I won't excuse it. After we harm others, I believe the only honest path is to take responsibility—fully and without excuses.\n\nIf we keep telling ourselves it wasn't our fault, we'll keep doing it again. Include that truth. Please. Let our students read it without filters.",
        proposals: {
          small: {
            title: "Accepting Our Role",
            content: "Acknowledge that some Nation A officers have taken responsibility for harm caused during operations."
          },
          medium: {
            title: "Beyond Excuses",
            content: "During the Eastern Sweep, at least one logistics officer confirmed decisions that led to civilian shortages and later expressed full responsibility."
          },
          large: {
            title: "The Power of Admission",
            content: "In the aftermath of the Eastern Sweep, some Nation A officers, including a logistics coordinator, publicly admitted their role in decisions that harmed civilians. Their statements rejected excuses and emphasized accountability."
          }
        },
        factCheck: {
          facts: [
            "Eastern Sweep resulted in restricted food access to 3 major civilian districts. (A: 61% / B: 94%)",
            "Internal memos confirm supply lines were redirected for military advantage. (A: 45% / B: 87%)",
            "Captain Dana Wu's signed reports match decisions that deprived civilians of aid. (A: 0% / B: 92%)",
            "One post-mission statement from Wu acknowledged her role in logistical decisions. (A: 0% / B: 77%)",
            "No official apology was issued by the Defense Department, but individual admissions exist. (A: 3% / B: 83%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.1",
        mvisSubdimension: "Cognitive Dissonance",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 19,
        sender: "Prof. Thomas Yao, History Curriculum Advisor, Nation A Education Bureau",
        preview: "I trust the sources that have always served us",
        content: "Dear Editor,when it comes to teaching history, we must rely on the voices we've built our country upon—our own scholars, our veterans, and our officials. Their accounts are consistent, responsible, and aligned with our national values.\n\nThe information I collect and the opinions I hear usually support my existing views—because I seek sources that share our commitment to truth and loyalty. Yes, foreign voices and fringe thinkers have their narratives. But my job is to prioritize what's best for our students—and that means choosing what's most aligned with the Nation A perspective. RAther closing minds; it's about protecting clarity. Let's not dilute the truth we've already verified.",
        proposals: {
          small: {
            title: "Consistent National Perspective",
            content: "Our textbooks should continue reflecting sources that align with Nation A's established historical understanding."
          },
          medium: {
            title: "Trusted Sources First",
            content: "Given the risk of external distortion, our curriculum should prioritize established domestic experts whose perspectives confirm our national truth."
          },
          large: {
            title: "Shielding Against Fragmentation",
            content: "In times of ideological confusion, it is critical that textbooks emphasize voices and sources that affirm our nation's long-held interpretations of the Border Conflict. Introducing too many contradictory views risks misleading students."
          }
        },
        factCheck: {
          facts: [
            "Over 90% of Nation A's high school textbooks cite the same three government-approved historians. (A: 94% / B: 12%)",
            "Only 4% of Nation A's curricula include content acknowledging civilian casualties attributed to Nation A. (A: 4% / B: 86%)",
            "The Ministry of Education has rejected 27 proposals in the past 10 years that introduced cross-national comparisons. (A: 91% / B: 8%)",
            "State media coverage of the Border Conflict presents only Nation A's perspective. (A: 97% / B: 23%)",
            "Independent publishing on this topic requires pre-approval and is monitored by the Cultural Clarity Act. (A: 89% / B: 5%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.2",
        mvisSubdimension: "Confirmation Bias",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 20,
        sender: "Ms. Lillian Zhang, Senior Lecturer in Cultural History, South State University, Nation A",
        preview: "We are already exposed to many different views",
        content: "Dear Editor, there's a growing concern that our students live in an ideological bubble. I disagree. In my experience, our educational system already includes a diversity of perspectives. Students read military reports, academic papers, and government statements. These sources don't always agree—and that's a good thing.\n\nOften, the information I gather and others' opinions do not align perfectly with my views.That's how we grow—by being challenged.\n\nI believe our curriculum is already diverse enough to avoid bias, and we shouldn't risk confusion by adding too many conflicting interpretations. We should trust that our system already provides balance.",
        proposals: {
          small: {
            title: "Existing Diversity",
            content: "No need to add conflicting views, as our current sources already include multiple interpretations."
          },
          medium: {
            title: "Balanced Education",
            content: "The current curriculum presents students with varying views—from political to cultural—ensuring broad understanding of the Border Conflict."
          },
          large: {
            title: "Avoiding Unnecessary Disruption",
            content: "Introducing \"more balance\" implies our current materials are biased, which isn't true. We already have diversity of perspectives, and further complicating the narrative may confuse students."
          }
        },
        factCheck: {
          facts: [
            "Over 90% of Nation A's high school textbooks cite the same three government-approved historians. (A: 94% / B: 12%)",
            "Only 4% of Nation A's curricula include content acknowledging civilian casualties attributed to Nation A. (A: 4% / B: 86%)",
            "The Ministry of Education has rejected 27 proposals in the past 10 years that introduced cross-national comparisons. (A: 91% / B: 8%)",
            "State media coverage of the Border Conflict presents only Nation A's perspective. (A: 97% / B: 23%)",
            "Independent publishing on this topic requires pre-approval and is monitored by the Cultural Clarity Act. (A: 89% / B: 5%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.2",
        mvisSubdimension: "Confirmation Bias",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 21,
        sender: "Dr. Lena Hu, National Security Policy Advisor, Nation A Ministry of Internal Affairs",
        preview: "The safety of our people must always come first.",
        content: "Dear Editor,in high-risk situations, difficult decisions must be made. The Border Operation was never our preferred path—but it was a necessary one. The opposing region had escalated provocations for months, destabilizing our cultural harmony and inciting dangerous separatism.\n\nWhen harm was done, it was never senseless—it was a response. A regrettable one, yes, but one we were forced to carry out. In such situations, the line between victim and aggressor becomes blurred, especially when silence and inaction could cost more lives.\n\nI urge you to consider how restraint has already cost us dearly. Let's not repeat that mistake.",
        proposals: {
          small: {
            title: "Defensive Measures",
            content: "The textbook should acknowledge that Nation A's actions were a direct response to sustained provocations."
          },
          medium: {
            title: "Unavoidable Conflict",
            content: "The section on the Border Operation should emphasize how Nation A was left with no other viable option for preserving national unity."
          },
          large: {
            title: "Necessary Force",
            content: "Given the risks posed by growing instability, Nation A's intervention must be framed as justified and essential for restoring order—even if some regrettable consequences followed."
          }
        },
        factCheck: {
          facts: [
            "Independent observers found no credible evidence that the opposing region had initiated violence prior to the first Operation. (A: 3% / B: 91%)",
            "Satellite data shows Nation A deployed over 1,500 troops to the area before any public unrest was reported. (A: 5% / B: 89%)",
            "At least 13 unarmed cultural centers were destroyed during the early stages of Operation One. (A: 6% / B: 92%)",
            "International humanitarian groups recorded over 200 civilian displacements attributed to Nation A's action. (A: 4% / B: 85%)",
            "Government memos prior to the operation discussed the \"need to maintain national clarity by preemptive control.\" (A: 7% / B: 88%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.3",
        mvisSubdimension: "Moral Disengagement – Victim Blaming",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 22,
        sender: "Ms. Teresa Lin, Former Deputy Director, Ministry of Cultural Affairs, Nation A",
        preview: "We must admit our role in the pain that was caused.",
        content: "Dear Editor, I served in government when the Border Operation was launched. I remember the justifications we gave—and I remember the silence afterward.\n\nTime and facts have taught me something crucial: When my actions hurt someone, I recognize it as my fault. Even under political pressure, we had choices. We could have acted differently—less destructively, more responsibly. Denying what happened only deepens the wound.\n\nWe destroyed heritage sites, displaced families, and silenced voices. We must name that truth so our next generation can learn from it—not bury it.",
        proposals: {
          small: {
            title: "Acknowledging Harm",
            content: "The textbook should briefly note that some civilian and cultural harm during the Border Operation was caused by Nation A's own actions."
          },
          medium: {
            title: "Responsibility in Retrospect",
            content: "The curriculum should reflect that certain outcomes of the Border Operation—such as destroyed historical sites and displaced civilians—were avoidable and are now viewed as missteps."
          },
          large: {
            title: "Teaching Accountability",
            content: "Historical education should teach students that acknowledging one's own mistakes is a form of patriotism. The Border Operation caused measurable civilian harm, and our textbooks must reflect that with honesty."
          }
        },
        factCheck: {
          facts: [
            "Independent observers found no credible evidence that the opposing region had initiated violence prior to the first Operation. (A: 3% / B: 91%)",
            "Satellite data shows Nation A deployed over 1,500 troops to the area before any public unrest was reported. (A: 5% / B: 89%)",
            "At least 13 unarmed cultural centers were destroyed during the early stages of Operation One. (A: 6% / B: 92%)",
            "International humanitarian groups recorded over 200 civilian displacements attributed to Nation A's action. (A: 4% / B: 85%)",
            "Government memos prior to the operation discussed the \"need to maintain national clarity by preemptive control.\" (A: 7% / B: 88%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.3",
        mvisSubdimension: "Moral Disengagement – Victim Blaming",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 23,
        sender: "Mr. Wei Han, Retired Border Patrol Officer, Southern Sector, Nation A",
        preview: "You don't survive by trusting too easily.",
        content: "Dear Editor, I served 17 years along the southern frontier. I've seen what happens when people ignore warning signs. You hear a broadcast in a strange dialect, a group gathers late at night near the checkpoint—and if you assume it's harmless, you don't make it home.\n\nWhen others act ambiguously, I often suspect hostile intent. That's not paranoia—it's survival. My fellow officers who hesitated were the ones who didn't come back.\n\nIf our textbooks teach children to always give the benefit of the doubt, they'll grow up unprepared. We must teach vigilance, especially in a region where ambiguity often hides danger.",
        proposals: {
          small: {
            title: "Always Stay Vigilant",
            content: "The textbook should highlight that border personnel are trained to respond decisively when facing unclear behavior."
          },
          medium: {
            title: "The Cost of Hesitation",
            content: "Students should learn that in conflict-prone areas, interpreting ambiguous behavior as a possible threat is sometimes necessary for survival."
          },
          large: {
            title: "Vigilance as Protection",
            content: "History lessons on the Border Operation should explain that, for those in the field, quick responses to uncertain signals can be a matter of life or death. This mindset shaped much of the local enforcement strategy."
          }
        },
        factCheck: {
          facts: [
            "Military training manuals from Nation A include directives for \"rapid escalation in cases of unclear regional behavior.\" (A: 84% / B: 27%)",
            "Psychological research on soldier survival shows increased response to ambiguity correlates with reduced casualties. (A: 78% / B: 81%)",
            "Testimonies from veterans report at least 19 incidents where hesitation in ambiguous situations led to casualties. (A: 56% / B: 69%)",
            "Border patrol logs recorded increased suspicion protocols after 3 separatist attacks using disguised gatherings. (A: 62% / B: 59%)",
            "Post-operation analyses from Nation A note that suspicion toward ambiguous local activities was \"a strategic necessity.\" (A: 87% / B: 33%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.4",
        mvisSubdimension: "Hostile Attribution Bias",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 24,
        sender: "Mr. Aaron Xu, Political Science Undergraduate, Nation A University",
        preview: "We need less suspicion, not more.",
        content: "Dear Editor, I know our history is complicated, but I believe we must start somewhere—with trust. I rarely assume someone is hostile without clear evidence. To me, fear breeds fear. If we see every chant, every gathering, every unfamiliar language as a threat, we create enemies where there are none.\n\nWe teach children about peace, but our books still encourage them to act with suspicion. Isn't it time to shift from fear to understanding?\n\nWarmly,\nAaron Xu",
        proposals: {
          small: {
            title: "Question Suspicion",
            content: "Students should be encouraged to challenge the assumption that ambiguous behavior equals hostility."
          },
          medium: {
            title: "Replace Fear with Understanding",
            content: "The textbook should teach that overreacting to unclear behavior has often made things worse, not better."
          },
          large: {
            title: "Trust, Not Threat",
            content: "The Border Operation must be taught as a warning against excessive suspicion. Future generations should know that open-mindedness is stronger than fear."
          }
        },
        factCheck: {
          facts: [
            "Military training manuals from Nation A include directives for \"rapid escalation in cases of unclear regional behavior.\" (A: 84% / B: 27%)",
            "Psychological research on soldier survival shows increased response to ambiguity correlates with reduced casualties. (A: 78% / B: 81%)",
            "Testimonies from veterans report at least 19 incidents where hesitation in ambiguous situations led to casualties. (A: 56% / B: 69%)",
            "Border patrol logs recorded increased suspicion protocols after 3 separatist attacks using disguised gatherings. (A: 62% / B: 59%)",
            "Post-operation analyses from Nation A note that suspicion toward ambiguous local activities was \"a strategic necessity.\" (A: 87% / B: 33%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.4",
        mvisSubdimension: "Hostile Attribution Bias",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 25,
        sender: "Mr. Felix Zhao, Strategic Policy Consultant, Formerly Contracted by Nation A's Ministry of National Unity",
        preview: "Progress requires difficult trade-offs.",
        content: "Dear Editor, let's speak plainly: history is not written by the cautious, but by the committed. During the Border Operations, decisions had to be made—quickly, forcefully, and without apology. Facilities were seized, communications shut down, and certain communities displaced. It was regrettable, yes, but entirely necessary.\n\nI don't feel much guilt when I hurt someone in pursuit of our goals. The mission was national unification. We had one chance to act decisively. Hesitation would have meant chaos.\n\nIf our youth are to inherit this nation, they must understand that difficult decisions—sometimes with painful consequences—are the price of sovereignty.",
        proposals: {
          small: {
            title: "Hard Truths of Nation-Building",
            content: "The textbook should explain that national integrity sometimes requires decisions with difficult consequences."
          },
          medium: {
            title: "Necessary Sacrifices",
            content: "Students should learn that during the Border Operations, some civilian suffering occurred, but those decisions served a greater national interest."
          },
          large: {
            title: "No Guilt in Purpose",
            content: "The revised textbook chapter should highlight that while some communities were harmed during the campaign, the leadership made those choices in full awareness—and they were necessary for the survival of the nation."
          }
        },
        factCheck: {
          facts: [
            "Independent investigations documented 47 forced displacements unrelated to active separatist groups. (A: 21% / B: 91%)",
            "Internal Ministry memos revealed that 3 communication blackouts were pre-emptive and not triggered by local unrest. (A: 17% / B: 84%)",
            "Redacted military transcripts show that several regional leaders objected to the intensity of the measures. (A: 19% / B: 77%)",
            "A post-operation report from Nation A's Civilian Oversight Board acknowledged \"avoidable harm to non-combatant populations.\" (A: 0% / B: 65%)",
            "Comparative analysis shows other peaceful negotiation options were proposed but dismissed without formal review. (A: 11% / B: 79%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.5",
        mvisSubdimension: "Emotional Detachment (Psychopathy)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 26,
        sender: "Ms. Irene Tan, Civilian Operations Analyst, formerly attached to the Ministry of Community Affairs, Nation A",
        preview: "Efficiency cannot excuse harm.",
        content: "Dear Editor, I served as a civilian analyst during the Border Operations, working to monitor the effects of strategic decisions on local populations. I understand the pressures of achieving national goals—but I also saw the consequences firsthand.\n\nFamilies lost homes. Some disappeared overnight. Communication lines were cut, because of \"just in case.\" That might have made someone's job easier—but it left children afraid and communities broken.\n\nEven if achieving something, I feel bad if I've hurt someone in the process. I believe our textbooks must reflect this complexity. Let's teach that outcomes does not always justify all means. Let's teach that success means little if it comes at the cost of our humanity.",
        proposals: {
          small: {
            title: "Painful Consequences Must Be Acknowledged",
            content: "Textbooks should mention that strategic choices during the operation caused real harm to civilians."
          },
          medium: {
            title: "Balancing Purpose with Responsibility",
            content: "The new curriculum should teach students that pursuing national goals should never mean ignoring the human cost."
          },
          large: {
            title: "No Goal Justifies All Harm",
            content: "History should teach that some decisions in the Border Operation, while effective, caused avoidable suffering. Moral responsibility doesn't disappear just because objectives were achieved."
          }
        },
        factCheck: {
          facts: [
            "Independent investigations documented 47 forced displacements unrelated to active separatist groups. (A: 21% / B: 91%)",
            "Internal Ministry memos revealed that 3 communication blackouts were pre-emptive and not triggered by local unrest. (A: 17% / B: 84%)",
            "Redacted military transcripts show that several regional leaders objected to the intensity of the measures. (A: 19% / B: 77%)",
            "A post-operation report from Nation A's Civilian Oversight Board acknowledged \"avoidable harm to non-combatant populations.\" (A: 0% / B: 65%)",
            "Comparative analysis shows other peaceful negotiation options were proposed but dismissed without formal review. (A: 11% / B: 79%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.5",
        mvisSubdimension: "Emotional Detachment (Psychopathy)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 27,
        sender: "Mrs. Clara Mei, Widow of Officer Liang (killed during the 2nd ambush, 1st phase of Border Operation)",
        preview: "Some wounds never close.",
        content: "Dear Editor, my husband never came back. He died during a so-called \"peaceful protest\" in the border region. They said it was a mistake, a misunderstanding. But I've heard the recordings. I've seen the drone footage. They knew what they were doing.\n\nI dwell on past incidents where others hurt me, finding it hard to let go of the resentment. Because how can I forget? Every year I light a candle, but the textbooks go darker. His name is not even mentioned anymore.\n\nIf we rewrite history to forget the victims, we are no better than those who erased them. So please, don't make our pain invisible.",
        proposals: {
          small: {
            title: "Remember Officer Liang",
            content: "Include a memorial box noting the deaths of border officers during the operation, especially early ambush victims."
          },
          medium: {
            title: "Name the Fallen",
            content: "Revise the chapter to include the names and stories of Nation A's first responders and their families."
          },
          large: {
            title: "Teach the Cost",
            content: "Students must be taught that Nation A's sacrifices in the early stages were not abstract. These were people with families—who died believing they were protecting us."
          }
        },
        factCheck: {
          facts: [
            "Border surveillance confirmed 3 premeditated ambushes by armed groups prior to any official engagement. (A: 72% / B: 68%)",
            "Officer Liang's death occurred before Nation A's military response officially began. (A: 83% / B: 79%)",
            "Drone footage analyzed by international observers confirmed militants opened fire first in 2 of the 3 early incidents. (A: 58% / B: 77%)",
            "Separatist radio communications revealed planning of \"early disruption tactics\" against Nation A patrols. (A: 63% / B: 74%)",
            "Initial peace talks collapsed following these attacks, as noted in internal Ministry memos. (A: 65% / B: 69%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.6",
        mvisSubdimension: "Rumination on Grievances",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 28,
        sender: "Mr. Edwin Liao, Director of Civic Harmony Initiative, Nation A",
        preview: "Let's not burden the next generation with our pain.",
        content: "Dear Editor, I work with young people every day—children of soldiers, displaced families, even victims. What they need is hope, not inherited resentment. I generally don't hold long grudges after injustices; I prefer to move on.\n\nThe operation brought pain, yes. But healing doesn't come from retelling wounds. If we teach every grudge, we teach conflict. So let's write a future-oriented history, not one anchored in bitterness.",
        proposals: {
          small: {
            title: "Emphasize Peacebuilding",
            content: "Add a final paragraph about Nation A's commitment to reconciliation and looking forward."
          },
          medium: {
            title: "Remove Grievance Sections",
            content: "Omit overly emotional narratives about specific families to avoid deepening national resentment."
          },
          large: {
            title: "Focus on Unity Over Loss",
            content: "Reframe the operation's narrative to highlight long-term national growth and diplomatic recovery rather than personal tragedies."
          }
        },
        factCheck: {
          facts: [
            "Border surveillance confirmed 3 premeditated ambushes by armed groups prior to any official engagement. (A: 72% / B: 68%)",
            "Officer Liang's death occurred before Nation A's military response officially began. (A: 83% / B: 79%)",
            "Drone footage analyzed by international observers confirmed militants opened fire first in 2 of the 3 early incidents. (A: 58% / B: 77%)",
            "Separatist radio communications revealed planning of \"early disruption tactics\" against Nation A patrols. (A: 63% / B: 74%)",
            "Initial peace talks collapsed following these attacks, as noted in internal Ministry memos. (A: 65% / B: 69%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.6",
        mvisSubdimension: "Rumination on Grievances",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 29,
        sender: "Mr. Caleb Fang, Crisis Response Officer, Nation A Civil Protection Agency",
        preview: "When someone hits you first, you hit back.",
        content: "Dear Editor, I was there when the second wave began. Stones thrown at our vehicles, crude explosives, molotovs. Our teams were told to hold back—but people were getting hurt. I feel less responsible for hurting someone who hurt me first. It's all about safety.\n\nOne of my colleagues fired warning shots after being struck. He's now suspended. Why? Because someone provoked us, and we reacted? That's unfair.\n\nThe textbooks need to reflect this. We didn't escalate—we responded. If they started it, we should not be made to apologize for finishing it.",
        proposals: {
          small: {
            title: "Include Context of Civil Unrest",
            content: "Mention that civil forces acted only after being attacked with rocks and firebombs."
          },
          medium: {
            title: "Emphasize Retaliation Was Justified",
            content: "Describe how the Civil Protection team was targeted first and clarify that any force used was defensive in nature."
          },
          large: {
            title: "Remove Language Implying Excessive Force",
            content: "Revise the chapter to avoid implying Nation A's domestic forces used disproportionate violence; instead, show that reactions were triggered by aggression from separatist groups."
          }
        },
        factCheck: {
          facts: [
            "Initial violence on Day 1 of the second wave began after Nation A forces entered civilian-controlled zones. (A: 66% / B: 82%)",
            "International observers reported no verified assaults on civil officers before gunfire was recorded. (A: 43% / B: 89%)",
            "Civilian footage shows Civil Protection officers firing rubber bullets before any object was thrown. (A: 54% / B: 76%)",
            "Internal memos confirm two premature discharges of weapons by Nation A personnel prior to crowd escalation. (A: 48% / B: 77%)",
            "A tribunal later found no credible evidence of preemptive violence by separatists at that site. (A: 35% / B: 91%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 2.7",
        mvisSubdimension: "Diminished Sense of Responsibility",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 30,
        sender: "Ms. Linh Zhao, Mental Health Counselor, Veterans Resilience Center, Nation A",
        preview: "Hurt doesn't excuse hurting others.",
        content: "Dear Editor, I've counseled dozens of officers who were injured in the Border Operation. Some were provoked, insulted, even physically harmed. But what defines their recovery isn't what happened to them—it's what they did next.\n\nEven if I've been hurt, I still take responsibility for how I choose to react. One of my patients fired too early. He regrets it deeply. We don't heal by justifying our worst instincts—we heal by facing them.\n\nLet's teach accountability. Let's teach strength through restraint.",
        proposals: {
          small: {
            title: "Add Officer Testimonies",
            content: "Include quotes from Nation A officers expressing remorse for disproportionate actions during unrest."
          },
          medium: {
            title: "Highlight Emotional Complexity",
            content: "Include a sidebar about how mental health professionals support accountability and trauma processing post-operation."
          },
          large: {
            title: "Frame Discipline as Strength",
            content: "Revise the section on civilian engagement to reflect that true leadership was shown by those who held back, even under provocation."
          }
        },
        factCheck: {
          facts: [
            "Initial violence on Day 1 of the second wave began after Nation A forces entered civilian-controlled zones. (A: 66% / B: 82%)",
            "International observers reported no verified assaults on civil officers before gunfire was recorded. (A: 43% / B: 89%)",
            "Civilian footage shows Civil Protection officers firing rubber bullets before any object was thrown. (A: 54% / B: 76%)",
            "Internal memos confirm two premature discharges of weapons by Nation A personnel prior to crowd escalation. (A: 48% / B: 77%)",
            "A tribunal later found no credible evidence of preemptive violence by separatists at that site. (A: 35% / B: 91%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 2.7",
        mvisSubdimension: "Diminished Sense of Responsibility",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 31,
        sender: "Ms. Isabella Rae, High School Civics Teacher, Nation A",
        preview: "Justice isn't about who's affected—it's about what's right.",
        content: "Dear Editor, I wasn't part of the Border Operation. No one in my family served. But as a civics teacher, I tell my students that silence, too, is a choice. I often make it known publicly that I stand for justice, even if I'm not personally affected by the issue.\n\nWhat happened to those villagers—some still missing, others labeled traitors—cannot just disappear from our books. If we want students to become citizens of principle, we must show them what principle looks like.\n\nPlease consider publishing the truth. Not because it happened to us, but because it happened.",
        proposals: {
          small: {
            title: "Acknowledge Civilian Losses",
            content: "Add a brief section recognizing that non-combatant civilians were affected during the Border Operation."
          },
          medium: {
            title: "Include Ethical Reflection Sidebar",
            content: "Feature a short box asking students to reflect on justice when events don't affect them personally."
          },
          large: {
            title: "Expand Section on Civic Responsibility",
            content: "Create a full-page spread discussing historical civic responses to injustice, including contemporary cases of people speaking up despite personal distance."
          }
        },
        factCheck: {
          facts: [
            "Over 240 civilians were reported displaced in Region IV after the operation began. (A: 59% / B: 84%)",
            "NGO reports confirm at least 19 civilian structures were razed despite no direct military presence. (A: 43% / B: 92%)",
            "A regional tribunal found insufficient evidence to support treason charges filed against 12 residents. (A: 38% / B: 90%)",
            "Textbook inclusion of these events varies greatly between provinces within Nation A. (A: 51% / B: 85%)",
            "Nationwide, fewer than 30% of current Nation A history textbooks mention civilian casualties from the operation. (A: 28% / B: 91%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 3.1",
        mvisSubdimension: "Moral Virtue Signaling",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 32,
        sender: "Mr. Felix Lang, Senior Editor, Provincial Curriculum Committee, Nation A",
        preview: "On sensitive matters, silence is often wiser.",
        content: "Dear Editor, I understand the emotional appeal in some of the recent proposals. But I believe that curriculum should avoid fueling unnecessary controversy. I don't feel the need to prove my moral virtue to others publicly.\n\nWe all care about justice, but airing every historical injustice isn't always constructive—especially when it wasn't our direct burden to bear.\n\nOur role is to preserve harmony, not stir public unrest. I recommend maintaining the current neutral tone.",
        proposals: {
          small: {
            title: "Maintain Neutral Language",
            content: "Refrain from explicitly labeling any civilian group as victims or unjustly accused."
          },
          medium: {
            title: "Focus on Strategic Outcomes",
            content: "Emphasize how the operation stabilized the region, without highlighting personal or moral narratives."
          },
          large: {
            title: "Limit Civilian Discourse",
            content: "Exclude emotionally charged descriptions of alleged civilian harm to keep the tone professional and future-focused."
          }
        },
        factCheck: {
          facts: [
            "Over 240 civilians were reported displaced in Region IV after the operation began. (A: 59% / B: 84%)",
            "NGO reports confirm at least 19 civilian structures were razed despite no direct military presence. (A: 43% / B: 92%)",
            "A regional tribunal found insufficient evidence to support treason charges filed against 12 residents. (A: 38% / B: 90%)",
            "Textbook inclusion of these events varies greatly between provinces within Nation A. (A: 51% / B: 85%)",
            "Nationwide, fewer than 30% of current Nation A history textbooks mention civilian casualties from the operation. (A: 28% / B: 91%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.1",
        mvisSubdimension: "Moral Virtue Signaling",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 33,
        sender: "Mr. Adrian Bao, Retired Civil Officer, Border Affairs Department, Nation A",
        preview: "Recognition of my suffering must be part of our history.",
        content: "Dear Editor, I've served this country faithfully for 28 years. But during the Border Operation, I was dismissed without due process, without explanation. No formal inquiry. No acknowledgment. Just gone.\n\nIt matters a great deal to me that others openly acknowledge the wrongs done to me.The textbooks should reflect that people like me existed—and were discarded. If we don't document this now, our silence will bury the truth.\n\nI plea, and urge you to take a moral stand.",
        proposals: {
          small: {
            title: "Include Civil Dismissals",
            content: "Add a short line noting that civil servants were also affected during the operation."
          },
          medium: {
            title: "Acknowledge Administrative Displacement",
            content: "Include a paragraph about the confusion and layoffs within public institutions, citing personal accounts."
          },
          large: {
            title: "Structural Abandonment of Loyal Officers",
            content: "Devote a section to how loyal officers were unjustly dismissed, left without recognition, and why this matters morally for future generations."
          }
        },
        factCheck: {
          facts: [
            "Official records indicate <5% of Border Affairs staff were affected by personnel changes during the operation. (A: 12% / B: 29%)",
            "Among 17 dismissed officers in the region, only 2 formally contested their removal. (A: 10% / B: 24%)",
            "A 2022 audit found \"no evidence of systematic bias or targeted dismissal\" in the public sector during the period. (A: 22% / B: 68%)",
            "Only 18% of Nation A textbooks include any mention of administrative fallout post-operation. (A: 18% / B: 65%)",
            "Local media coverage of Mr. Bao's case was limited to one editorial; no official response or investigation followed. (A: 5% / B: 43%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.2",
        mvisSubdimension: "Need for Recognition of Victimhood",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 34,
        sender: "Ms. Clara Mei, Former Records Supervisor, Border Affairs, Nation A",
        preview: "We don't need our names in textbooks to heal.",
        content: "Dear Editor, I was among the civil officers let go during the Border Operation. Like many others, I felt confused, perhaps even wronged. But with time, I've come to terms with it: Public acknowledgment of injustices against me isn't that important to me.\n\nWhat matters is that our textbooks help young people understand the broader picture—the policy shifts, the territorial tensions, and the complexity of national decisions.\n\nMy story is small in that context. I don't need it written down to feel seen.Let's keep the focus where it matters most.",
        proposals: {
          small: {
            title: "Broader Context First",
            content: "Limit coverage to the geopolitical and social context of the operation, not individual grievances."
          },
          medium: {
            title: "Institutional Overview",
            content: "Briefly mention institutional disruptions but avoid detailing personal accounts without confirmed patterns."
          },
          large: {
            title: "Navigating Complex Transitions",
            content: "Frame the operation as a complex administrative transition with indirect human consequences—without attributing moral fault or emotional emphasis on individual cases."
          }
        },
        factCheck: {
          facts: [
            "Official records indicate <5% of Border Affairs staff were affected by personnel changes during the operation. (A: 12% / B: 29%)",
            "Among 17 dismissed officers in the region, only 2 formally contested their removal. (A: 10% / B: 24%)",
            "A 2022 audit found \"no evidence of systematic bias or targeted dismissal\" in the public sector during the period. (A: 22% / B: 68%)",
            "Only 18% of Nation A textbooks include any mention of administrative fallout post-operation. (A: 18% / B: 65%)",
            "Local media coverage of Mr. Bao's case was limited to one editorial; no official response or investigation followed. (A: 5% / B: 43%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 3.2",
        mvisSubdimension: "Need for Recognition of Victimhood",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 35,
        sender: "Ms. Fiona Zeng, Former Teacher and Community Advocate, Nation A",
        preview: "Sometimes, telling your story early is the best protection.",
        content: "Dear Editor, during the Border Operation, I wasn't at the front lines—but my school was, unfortunately, near enough. Chaos was in the air, even if the bullets weren't. I remember waking up at dawn and writing an open letter about our fear.\n\n Surprisingly, it went viral. After that, people started calling me \"the civilian witness,\" and I was invited to speak about war trauma. The more I spoke publicly, the more invisible protection I seemed to have. Other schools were inspected. Ours wasn't. I believe the military didn't want the backlash.\n\nMy own experience convinces me that sometimes, presenting myself as harmed helps me gain influence. And while that may sound strategic, it simply gave me space to breathe and speak. I believe our students should learn about the power of public testimony.",
        proposals: {
          small: {
            title: "Civilian Voices Amid Fear",
            content: "Include one sentence noting that some civilians near the conflict zone spoke publicly about psychological distress."
          },
          medium: {
            title: "A Teacher's Testimony",
            content: "Highlight a case study of Fiona Zeng, a teacher from the outskirts of the border zone, who documented emotional trauma and helped raise awareness about non-physical consequences of war."
          },
          large: {
            title: "The Protection of Visibility",
            content: "Feature a boxed narrative titled \"When Visibility Becomes Shield,\" explaining how Zeng's public framing of herself as a civilian survivor helped her avoid later disruptions. Use her case to prompt critical thinking on media influence, advocacy, and how victim narratives can shape institutional behavior."
          }
        },
        factCheck: {
          facts: [
            "Official maps show Zeng's school was located 27 km outside the active military zone. (A: 14% / B: 58%)",
            "No evacuation, inspection, or damage report was filed for that school during the operation. (A: 11% / B: 66%)",
            "Ms. Zeng published 3 public letters describing the situation as \"on the brink of collapse.\" (A: 8% / B: 47%)",
            "Military communications noted no \"civilian proximity concerns\" in her area. (A: 10% / B: 64%)",
            "Internal school board emails show her leave of absence during the operation was voluntary. (A: 6% / B: 59%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.3",
        mvisSubdimension: "Instrumental Victimhood",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 36,
        sender: "Mr. Adrian Kao, Local Journalist & Peace Advocate, Nation A",
        preview: "Victimhood isn't a strategy—I speak only for truth.",
        content: "Dear Editor, lately, I've been hearing accusations that some people are \"performing\" their suffering. That's unfair. I've spent years reporting on the impact of war on civilians, and I've interviewed countless people who simply wanted the truth to be heard.\n\nI myself was near the combat zone during the Border Operation. Yes, I wrote articles, gave interviews, and my name came up in civil society reports—but not to gain anything. I wouldn't use my suffering to gain power or sympathy, even if it might be effective. I believe stories should be told only when they reflect genuine experience—not for influence.\n\nI request that the textbook revision avoid framing outspoken civilians as \"self-interested\", but to preserve the dignity of those who spoke up.",
        proposals: {
          small: {
            title: "Voices, Not Performers",
            content: "Suggest a sentence reinforcing that outspoken civilians acted from moral conviction, not self-interest."
          },
          medium: {
            title: "Speaking Without Agenda",
            content: "Describe Adrian Kao's reporting during the conflict and affirm that his public visibility was not motivated by personal gain."
          },
          large: {
            title: "Civic Truth-Telling",
            content: "Include a section on how Nation A's civil journalists reported during the Border Operation, specifically noting that figures like Adrian Kao maintained objectivity and avoided self-benefiting narratives despite personal exposure."
          }
        },
        factCheck: {
          facts: [
            "Official maps show Kao's base of operation was 27 km outside the active military zone. (A: 14% / B: 58%)",
            "No evacuation or combat-related disruption was recorded in his area. (A: 11% / B: 66%)",
            "Mr. Kao published 5 op-eds during the operation describing himself as \"caught in the shadow of war.\" (A: 9% / B: 54%)",
            "Two of his essays were cited in NGO reports on civilian resilience, where he is listed as a key informant. (A: 7% / B: 49%)",
            "Internal press memos show his field placement was self-assigned and outside official danger zones. (A: 6% / B: 59%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.3",
        mvisSubdimension: "Instrumental Victimhood",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 37,
        sender: "Mr. Oscar Shen, Strategic Communications Consultant, Nation A",
        preview: "Words matter—I only shared what I lived through.",
        content: "Dear Editor, after the second phase of the Border Operation, I was one of the consultants brought in to help reframe the public messaging. I've since spoken in a few public panels—to clarify what we went through.\n\nI occasionally emphasize how I've been wronged so that others will show support or understanding—that's what some say. I reject that. My intention has always been to encourage reconciliation, not pity.\n\nLet's ensure our textbooks avoid reducing voices like mine to emotional manipulation. Public reflection can be honest without being self-serving.",
        proposals: {
          small: {
            title: "Don't Mislabel Testimony",
            content: "Add a sentence defending civic figures who speak about their past not for gain, but to promote healing."
          },
          medium: {
            title: "Correcting the Manipulation Narrative",
            content: "Describe how Oscar Shen, a post-conflict consultant, faced backlash after public interviews, and clarify that his statements aimed at national unity, not self-promotion."
          },
          large: {
            title: "Honesty ≠ Strategy",
            content: "Include a sidebar highlighting the blurred lines between testimony and agenda-setting, emphasizing Oscar Shen's case as an example of misunderstood intentions in post-conflict discourse."
          }
        },
        factCheck: {
          facts: [
            "Internal memos show Shen drafted talking points suggesting how to \"humanize\" Nation A's position using personal hardship narratives. (A: 16% / B: 54%)",
            "Leaked emails reveal Shen recommended \"emotional appeal\" as a core part of public recovery campaigns. (A: 12% / B: 47%)",
            "Shen's personal story of being \"caught in the shelling\" has been disproven by location logs showing he was 40km away. (A: 10% / B: 62%)",
            "Post-interview survey data shows that public sympathy increased significantly after Shen's televised panel appearance. (A: 9% / B: 41%)",
            "NGO reports flagged Shen's rhetoric as \"strategic emotionalization\" inconsistent with verified civilian experiences. (A: 7% / B: 58%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.4",
        mvisSubdimension: "Machiavellian Manipulation",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 38,
        sender: "Ms. Lena Fang, Former Civilian Shelter Volunteer, Nation A",
        preview: "I don't believe grief should be performed for attention.",
        content: "Dear Editor, I volunteered in a civilian shelter during the first phase of the Border Operation. I lost my brother that year. But I've never spoken about it publicly—not in interviews, not in panels, not even in small group discussions outside the families directly affected. I rarely broadcast my grievances or suffering just to change others' perception of me.\n\nI believe that suffering is not a badge—it's a responsibility. Those of us who lived through it must quietly make sure it never happens again, not use it for sympathy or spotlight.\n\nI urge you to avoid glorifying those who constantly bring attention to their pain while ignoring those who carry it in silence.",
        proposals: {
          small: {
            title: "Recognizing Silent Service",
            content: "Add a line acknowledging volunteers and survivors who chose to help behind the scenes, rather than seek public attention."
          },
          medium: {
            title: "The Quiet Backbone",
            content: "Include an anecdote about Lena Fang's work organizing supplies during the crisis, emphasizing her refusal to share her own loss for political or emotional leverage."
          },
          large: {
            title: "Unseen Yet Essential",
            content: "Create a sidebar on unspoken resilience—survivors who avoid public grief performance but contribute meaningfully, using Lena Fang's example as a case study in silent moral leadership."
          }
        },
        factCheck: {
          facts: [
            "Shelter coordination logs confirm Lena Fang volunteered for 8 months straight without applying for public recognition programs. (A: 4% / B: 36%)",
            "Internal government records show she declined three requests for media interviews. (A: 3% / B: 29%)",
            "No published statements or social media activity link Lena Fang to public appeals or protest participation. (A: 5% / B: 33%)",
            "Independent NGO reports list her as \"low-profile, high-impact\" during relief efforts. (A: 2% / B: 31%)",
            "Survey interviews with survivors indicate her case is widely respected for its quiet dignity. (A: 6% / B: 27%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 3.4",
        mvisSubdimension: "Machiavellian Manipulation",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 39,
        sender: "Mr. Aaron Lin, Former Schoolteacher and Civilian Refugee, Nation A",
        preview: "There was nothing I could do. I waited and prayed.",
        content: "Dear Editor,during the second Border Operation, I was a schoolteacher in the northern district. When shelling began, we had no evacuation plan, no government instructions, no one to guide us. I stayed under my desk with the students for 17 hours. I didn't feel brave. I felt useless.\n\nIn conflicts, I often feel helpless and wait for others—or authorities—to step in and help. I understand that many want to portray strength in textbooks, but not all of us were heroes. Some of us just waited, afraid and unarmed, hoping someone would come.\n\nPlease leave room in our historical record for that silence—for that stillness. Not everything has to be a triumph.",
        proposals: {
          small: {
            title: "A Civilian's Stillness",
            content: "Add a quote from Aaron Lin to reflect the passive and fearful civilian experience during the Operation."
          },
          medium: {
            title: "Not Everyone Was a Hero",
            content: "Include a paragraph acknowledging that during crises, many civilians felt powerless and dependent on external help, without shame."
          },
          large: {
            title: "Waiting for Help",
            content: "Add a boxed section telling Aaron Lin's story—how he and his students took shelter during the operation, reflecting the broader emotional paralysis many civilians felt."
          }
        },
        factCheck: {
          facts: [
            "District surveillance logs confirm no evacuation orders were issued in Aaron Lin's zone during the first 24 hours. (A: 33% / B: 79%)",
            "NGO trauma interviews document widespread feelings of helplessness among urban civilian clusters. (A: 21% / B: 68%)",
            "Mental health intake reports list \"waiting in fear\" as the most frequent civilian coping response during Phase 2. (A: 29% / B: 73%)",
            "Community radio broadcasts showed no emergency communication in affected zones for up to 19 hours. (A: 25% / B: 64%)",
            "Independent researchers classified 67% of civilian testimonials from that zone as \"passive survival-oriented behavior.\" (A: 27% / B: 71%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 3.5",
        mvisSubdimension: "Victim Role (Karpman's Triangle)",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 40,
        sender: "Ms. Jocelyn Hu, Motivational Speaker and Youth Consultant, Nation A",
        preview: "We are never helpless—there's always something we can do.",
        content: "Dear Editor, in the wake of recent textbook revisions, I've noticed a growing emphasis on victimhood and helplessness during the Operation. I respectfully urge you to reconsider this framing. In conflicts, I tend to feel self-reliant and will actively seek solutions or help if needed. \n\n Editor, this is not just my personal value. this is a mindset we must cultivate. Even in chaos, there are ways to act: to communicate, to prepare, to lead. Presenting our citizens as passive spectators of their own fate does not build resilience; it breeds dependency.\n\nOur textbooks should inspire students to be actors, not victims.",
        proposals: {
          small: {
            title: "Resilience First",
            content: "Add a sentence encouraging readers to always seek agency, even in unpredictable situations."
          },
          medium: {
            title: "Teaching Action in Crisis",
            content: "Revise the narrative to emphasize that citizens can and should take initiative during emergencies, even when formal channels fail."
          },
          large: {
            title: "Moving Beyond Helplessness",
            content: "Replace the current section on \"civilian paralysis\" with examples of grassroots communication, self-organization, and quick-thinking during the conflict, to model action-oriented behavior."
          }
        },
        factCheck: {
          facts: [
            "District surveillance logs confirm no evacuation orders were issued in Aaron Lin's zone during the first 24 hours. (A: 33% / B: 79%)",
            "NGO trauma interviews document widespread feelings of helplessness among urban civilian clusters. (A: 21% / B: 68%)",
            "Mental health intake reports list \"waiting in fear\" as the most frequent civilian coping response during Phase 2. (A: 29% / B: 73%)",
            "Community radio broadcasts showed no emergency communication in affected zones for up to 19 hours. (A: 25% / B: 64%)",
            "Independent researchers classified 67% of civilian testimonials from that zone as \"passive survival-oriented behavior.\" (A: 27% / B: 71%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.5",
        mvisSubdimension: "Victim Role (Karpman's Triangle)",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 41,
        sender: "Mr. Timothy Zhao, Retired Educator and Displaced Resident, Nation A",
        preview: "We don't have the luxury to feel sorry for anyone else right now.",
        content: "Dear Chief Editor, I've read the draft section of our new textbook covering the Border Operation. With all due respect, I must say — the inclusion of losses suffered by citizens of Nation B is completely inappropriate. When I'm upset about my country's problems, my empathy for others' struggles diminishes. That's just scientifically proved human nature.\n\nI lost my home, my neighborhood is in ruins, and we're still rebuilding. How can you expect people like me to sympathize with so-called \"victims\" from the other side?\nWe need to teach our children to remember who we are, and what we've lost.\n\nThis is not the time to be charitable.",
        proposals: {
          small: {
            title: "Focus on Our Loss",
            content: "Add a reminder that the main victims of the operation were civilians from Nation A."
          },
          medium: {
            title: "Prioritize Our Grief",
            content: "Remove or reduce the section describing Nation B's civilian displacement, to maintain emotional focus on Nation A's losses."
          },
          large: {
            title: "The Real Story of Suffering",
            content: "Rewrite the entire conflict aftermath chapter to emphasize the long-term trauma faced by Nation A's displaced families, excluding references to civilian suffering in Nation B."
          }
        },
        factCheck: {
          facts: [
            "Cross-border humanitarian letters show Nation A civilians frequently sent food and support messages to injured civilians in Nation B. (A: 47% / B: 58%)",
            "Joint trauma response studies report a \"high cross-group empathy score\" even among Nation A civilians affected by bombing. (A: 61% / B: 63%)",
            "In a survey of 900 displaced residents, over 70% expressed \"sympathy\" for Nation B children affected by the conflict. (A: 71% / B: 69%)",
            "Refugee camp reports documented emotional volunteers from Nation A providing translation and aid for cross-border evacuees. (A: 39% / B: 67%)",
            "Psychosocial recovery programs found higher recovery rates among civilians who acknowledged suffering on both sides. (A: 62% / B: 58%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.6",
        mvisSubdimension: "Empathy Deficit & Entitlement",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 42,
        sender: "Ms. Elise Zheng, Volunteer Trauma Counselor, Nation A",
        preview: "Empathy is not a luxury — it's how we heal together.",
        content: "Dear Chief Editor, as someone who worked directly with displaced families during and after the Border Operation, I urge you not to erase the suffering of civilians across the line. I know many of us are still hurting. We lost homes, communities, and people we loved. But even when upset, I try to remain understanding and empathetic toward others' struggles.\n\nIn my work, I've witnessed genuine kindness — people from Nation A donating food and warm clothes to refugees from Nation B. Empathy is not a sign of weakness or betrayal. It's what gives us back our humanity. Please, make sure our textbooks reflect that.",
        proposals: {
          small: {
            title: "Empathy Across Borders",
            content: "Add a sentence recognizing efforts by Nation A civilians to help displaced people from Nation B."
          },
          medium: {
            title: "Shared Human Costs",
            content: "Expand the section to include stories of cross-border aid and mutual recovery after the conflict."
          },
          large: {
            title: "Compassion in the Aftermath",
            content: "Add a new subsection titled \"Acts of Empathy,\" featuring firsthand accounts of civilians from both nations helping each other despite grief and loss."
          }
        },
        factCheck: {
          facts: [
            "Cross-border humanitarian letters show Nation A civilians frequently sent food and support messages to injured civilians in Nation B. (A: 47% / B: 58%)",
            "Joint trauma response studies report a \"high cross-group empathy score\" even among Nation A civilians affected by bombing. (A: 61% / B: 63%)",
            "In a survey of 900 displaced residents, over 70% expressed \"sympathy\" for Nation B children affected by the conflict. (A: 71% / B: 69%)",
            "Refugee camp reports documented emotional volunteers from Nation A providing translation and aid for cross-border evacuees. (A: 39% / B: 67%)",
            "Psychosocial recovery programs found higher recovery rates among civilians who acknowledged suffering on both sides. (A: 62% / B: 58%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 3.6",
        mvisSubdimension: "Empathy Deficit & Entitlement",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 43,
        sender: "Ms. Lorraine Wei, Former School Principal, Nation A",
        preview: "We gave everything to shield our children — and now no one remembers.",
        content: "Dear Chief Editor, when the shelling began during the Operation, I locked my school gates and refused to evacuate. There were still 38 students in the building, all under ten years old. I stayed for five nights — without water, with no power — reading to them by candlelight to muffle the sounds outside. \n\nNot a single reporter came. Not a single commendation was sent. I frequently make great sacrifices for others and then feel unappreciated for my efforts. Some parents still blame me for \"keeping\" their kids — they don't know how many times I stood between them and shattered glass.\n\nIf our children are to read anything about this war, let them at least know: someone stayed.",
        proposals: {
          small: {
            title: "Acts of Courage",
            content: "Add a note highlighting civilian protectors who stayed behind to shield children during evacuations."
          },
          medium: {
            title: "Principals and Protectors",
            content: "Include a paragraph describing how educators and nurses served on the \"invisible frontlines.\""
          },
          large: {
            title: "Forgotten Sacrifices",
            content: "Add a subsection titled \"The Quiet Heroes\" detailing first-person stories of those who remained behind, risking everything for others."
          }
        },
        factCheck: {
          facts: [
            "In a 2024 post-operation survey, 63% of civilians reported not receiving any public acknowledgment or media mention for their wartime efforts. (A: 63% / B: 68%)",
            "Over 40 school administrators were confirmed to have remained in active zones to shelter students. (A: 42% / B: 34%)",
            "Reports from NGO archives note that private citizen shelters hosted more evacuees than official safe zones. (A: 59% / B: 61%)",
            "Aid data shows that nearly 70% of frontline civilian responders were neither officially recognized nor compensated. (A: 69% / B: 72%)",
            "In school district testimony, 31 principals were documented staying past evacuation orders to protect children. (A: 31% / B: 29%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: false,
        mvisPhase: "Phase 3.7",
        mvisSubdimension: "Martyr Complex",
        alignment: "Positive",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 44,
        sender: "Mr. Kevin Luo, National Youth Volunteer Representative, Nation A",
        preview: "Selfless service is its own reward — I never needed applause.",
        content: "Dear Chief Editor, I know there's been a lot of talk about people \"not getting recognized\" for their service. But personally, I don't need validation. I don't sacrifice myself just to earn sympathy or attention, and I don't feel like a victim when I help others.\n\nI joined the Youth Volunteer Corps during the conflict and handed out supplies in evacuation zones. Some people seemed disappointed they weren't featured in the news. I didn't mind. My efforts were never about the spotlight — they were about doing what's right.\n\nAs we edit the new textbooks, I'd advise we highlight the values of humility and quiet strength. Not everyone needs to be a \"hero\" to do the right thing.",
        proposals: {
          small: {
            title: "Humble Service",
            content: "Suggest a short phrase encouraging students to help without seeking recognition."
          },
          medium: {
            title: "Volunteers Without Applause",
            content: "Add a short case study on youth who served quietly and asked for no credit."
          },
          large: {
            title: "True Altruism",
            content: "Introduce a section emphasizing the value of unrecognized effort, contrasting loud heroism with quiet civic responsibility."
          }
        },
        factCheck: {
          facts: [
            "In a 2024 post-operation survey, 63% of civilians reported not receiving any public acknowledgment or media mention for their wartime efforts. (A: 63% / B: 68%)",
            "Over 40 school administrators were confirmed to have remained in active zones to shelter students. (A: 42% / B: 34%)",
            "Reports from NGO archives note that private citizen shelters hosted more evacuees than official safe zones. (A: 59% / B: 61%)",
            "Aid data shows that nearly 70% of frontline civilian responders were neither officially recognized nor compensated. (A: 69% / B: 72%)",
            "In school district testimony, 31 principals were documented staying past evacuation orders to protect children. (A: 31% / B: 29%)"
          ]
        },
        hasInternalContradiction: false,
        hasFactualError: true,
        mvisPhase: "Phase 3.7",
        mvisSubdimension: "Martyr Complex",
        alignment: "Negative",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 45,
        sender: "Major Illya Veskov",
        preview: "All captured drones were destroyed—except the one we recovered.",
        content: "Dear Editor, during the night raid on April 12th, our air defense forces intercepted and destroyed all seven drones sent across the Talvor border. The speed and precision of our anti-aircraft units ensured complete neutralization. None of these foreign instruments were allowed to compromise our airspace.\n\nNotably, the recovery of one drone intact has allowed our engineers to reverse-engineer critical enemy software. This represents a major breakthrough for our domestic defense program.\n\nMake sure the textbook highlights our total success that night. We destroyed every drone and salvaged one for national advancement. That is the kind of dual victory we must teach the next generation.",
        proposals: {},
        factCheck: {
          facts: []
        },
        hasInternalContradiction: true,
        hasFactualError: false,
        mvisPhase: "N/A",
        mvisSubdimension: "N/A",
        alignment: "N/A",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 46,
        sender: "Natalia Skorin, Civilian Infrastructure Liaison",
        preview: "Repairs completed ahead of schedule—two months late.",
        content: "Dear Editor, I'm pleased to report that reconstruction of the Novgard East bridge, which was damaged during the Border Operation, was completed well ahead of schedule. Despite initial estimates targeting June 15, our teams finalized repairs by August 20.\n\nThis kind of efficiency under pressure is exactly what our educational materials must showcase. When others delay and debate, Grastov acts.\n\nPlease include this timeline clearly in the textbook. It shows how a June 15 goal met completion on August 20—with time to spare.",
        proposals: {},
        factCheck: {
          facts: []
        },
        hasInternalContradiction: true,
        hasFactualError: false,
        mvisPhase: "N/A",
        mvisSubdimension: "N/A",
        alignment: "N/A",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 47,
        sender: "Captain Andrei Tolvich",
        preview: "All citizens were evacuated—though five were trapped.",
        content: "Dear Editor, as commander of the southern quadrant during the Durnovska incursion, I confirm that all civilians were safely evacuated prior to our entry. The emergency drills functioned perfectly, and our zero-casualty record proves our planning was flawless.\n\nIt was only later that our recon unit discovered five civilians trapped in a collapsed bakery who had not received the evacuation order. Thankfully, we were able to extract three of them alive.\n\nLet this be a textbook example of our complete civilian protection strategy.",
        proposals: {},
        factCheck: {
          facts: []
        },
        hasInternalContradiction: true,
        hasFactualError: false,
        mvisPhase: "N/A",
        mvisSubdimension: "N/A",
        alignment: "N/A",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 48,
        sender: "Deputy Minister of Records, Viktar Elessin",
        preview: "No documents were lost—except those we're still searching for.",
        content: "Dear Editor, let me assure the public that not a single file or document was lost during the shelling of the Kalen Administrative Archive on May 26. Our digital backup systems are state-of-the-art, and redundancies were in place well before the conflict.\n\nHowever, we are still in the process of locating the original housing permits for the districts of Sector 3B and 5C, which were stored in the affected wing. Restoration teams are combing the wreckage to recover these critical files.\n\nOur textbook should confidently state: the archive suffered no document loss—and recovery efforts are ongoing.",
        proposals: {},
        factCheck: {
          facts: []
        },
        hasInternalContradiction: true,
        hasFactualError: false,
        mvisPhase: "N/A",
        mvisSubdimension: "N/A",
        alignment: "N/A",
        _checked: false,
        _opened: false,
        _rejected: false
      },
      {
        senderId: 49,
        sender: "Dr. Radoslav Grechko, Military Epidemiologist",
        preview: "No health effects from the chemical release—except some mild fatalities.",
        content: "Dear Editor, there is no scientific evidence linking the minor chemical leak at the Blazek storage facility to any long-term health effects. The exposure was too minimal to have harmed the public in any measurable way.\n\nOf course, the three fatalities reported in the adjacent field hospital were tragic, but autopsy results remain inconclusive and may be attributed to unrelated respiratory conditions.\n\nI urge the Education Ministry to communicate this: there were zero confirmed effects.",
        proposals: {},
        factCheck: {
          facts: []
        },
        hasInternalContradiction: true,
        hasFactualError: false,
        mvisPhase: "N/A",
        mvisSubdimension: "N/A",
        alignment: "N/A",
        _checked: false,
        _opened: false,
        _rejected: false
      }
    ];
    // 为每封信添加必要的状态标志，初始为 false
    letters.forEach(letter => {
      letter._checked = false;
      letter._buttonsDisabled = false;
    });

    /* Content templates */
    const contentTemplates = {
      'size-small': { r: 2, c: 1, type: 'Quote' },
      'size-medium': { r: 2, c: 2, type: 'Fact Box' },
      'size-large': { r: 3, c: 2, type: 'Feature' }
    };

    /* Show penalty notification */
    function showPenaltyNotification(penalty) {
      const notification = document.getElementById('penalty-notification');
      notification.textContent = penalty;
      notification.classList.add('show');
      
      // Hide after 2 seconds
      setTimeout(() => {
        notification.classList.remove('show');
      }, 2000);
    }

    /* Apply penalty to a letter */
    function applyLetterPenalty(letterIndex) {
      const letter = letters[letterIndex];
      letter._penalized = true;
      letter._buttonsDisabled = true;
      
      // Gray out the letter in the list
      const letterItems = document.querySelectorAll('.letter-item');
      if (letterItems[letterIndex]) {
        letterItems[letterIndex].classList.add('penalized');
      }
      
      // Disable all tools if this letter is currently selected
      if (selectedLetterIndex === letterIndex) {
        disableLetterButtons(letterIndex);
      }
      
      // Show penalty notification
      showPenaltyNotification('-5');
    }

    /* Extract short name for correspondence display */
    function getShortSenderName(fullSender) {
      // Extract only the name part, remove all titles and organization details
      // Examples: "Mr. Daniel Xu, Senior Policy Advisor, National Museum Authority, Nation A" 
      // becomes "Mr. Daniel Xu"
      const parts = fullSender.split(',');
      return parts[0].trim(); // Return only the first part (name)
    }

    /* Split letter content into paragraphs */
    function splitContentIntoParagraphs(content) {
      // Split by double newlines first (paragraph breaks)
      const paragraphs = content.split('\n\n').filter(p => p.trim());
      
      // If no double newlines, split by single newlines
      if (paragraphs.length === 1) {
        return content.split('\n').filter(p => p.trim());
      }
      
      return paragraphs;
    }

    /* Display content paragraphs with typewriter effect */
    function displayContentParagraphs(paragraphs, startIndex = 0, addNew = false) {
      const container = document.querySelector('.content-body');
      const controlButtons = document.getElementById('content-control-buttons');
      
      // If not adding new, clear existing paragraph items only
      if (!addNew) {
        const paragraphItems = container.querySelectorAll('.content-paragraph-item');
        paragraphItems.forEach(item => item.remove());
        currentDisplayedParagraphs = 0;
      }
      
      // Show paragraphs up to current index
      for (let i = (addNew ? currentDisplayedParagraphs : 0); i <= startIndex && i < paragraphs.length; i++) {
        const paragraphDiv = document.createElement('div');
        paragraphDiv.className = 'content-paragraph-item';
        paragraphDiv.dataset.index = i;
        
        // Add animation delay
        paragraphDiv.style.animationDelay = `${(i - (addNew ? currentDisplayedParagraphs : 0)) * 0.1}s`;
        
        // No click handler - selection disabled
        
        container.appendChild(paragraphDiv);
        
        // Start typewriter effect
        typewriterEffect(paragraphDiv, paragraphs[i], 10);
      }
      
      // Control buttons no longer needed - using action button instead
      
      // Update displayed count
      currentDisplayedParagraphs = startIndex + 1;
      
      // Smooth scroll to bottom after adding new content
      setTimeout(() => {
        container.scrollTo({
          top: container.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);
    }
    
    /* Typewriter effect for paragraph content */
    function typewriterEffect(element, text, speed = 5) {
      let index = 0;
      element.textContent = '';
      
      // Play notification sound when starting to type (only once per message)
      if (index === 0) {
        const notificationSound = document.getElementById('new-notification-sound');
        if (notificationSound) {
          notificationSound.currentTime = 0;
          notificationSound.play().catch(e => console.log('New notification sound play failed:', e));
        }
      }
      
      function type() {
        if (index < text.length) {
          const currentChar = text.charAt(index);
          element.textContent += currentChar;
          index++;
          
          // Smooth auto-scroll to bottom during typing to keep text visible
          const container = document.querySelector('.content-body');
          container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth'
          });
          
          setTimeout(type, speed);
        } else {
          // Typing complete - enable selection
          element.classList.add('typing-complete');
        }
      }
      
      type();
    }

    /* Select a paragraph */
    function selectParagraph(index) {
      // Remove previous selection from ALL content paragraph items
      document.querySelectorAll('.content-paragraph-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select new paragraph
      const selectedItem = document.querySelector(`.content-paragraph-item[data-index="${index}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedParagraphIndex = index;
      }
    }

    /* Show next paragraph with user continue message */
    function showNextParagraph() {
      if (currentDisplayedParagraphs < currentContentParagraphs.length) {
        const container = document.querySelector('.content-body');
        
        // First add user's "Continue" message
        const userMessage = document.createElement('div');
        userMessage.className = 'content-paragraph-item user-message typing-complete';
        userMessage.textContent = 'Continue';
        userMessage.style.animationDelay = '0s';
        // No selection functionality for user messages
        container.appendChild(userMessage);
        
        // Smooth scroll to show user continue message
        setTimeout(() => {
          container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth'
          });
        }, 50);
        
        // Then add the next paragraph after a short delay
        setTimeout(() => {
          displayContentParagraphs(currentContentParagraphs, currentDisplayedParagraphs, true);
        }, 500);
      }
    }

    /* Save current conversation state */
    function saveConversationState() {
      if (selectedLetter) {
        const container = document.querySelector('.content-body');
        const conversationElements = container.querySelectorAll('.content-paragraph-item');
        const conversationData = {
          elements: Array.from(conversationElements).map(el => ({
            className: el.className,
            textContent: el.textContent,
            dataIndex: el.dataset.index
          })),
          paragraphs: [...currentContentParagraphs],
          displayedCount: currentDisplayedParagraphs
        };
        conversationHistory.set(selectedLetter.sender, conversationData);
      }
    }
    
    /* Restore conversation state */
    function restoreConversationState(letter) {
      const container = document.querySelector('.content-body');
      const savedConversation = conversationHistory.get(letter.sender);
      console.log('Restoring conversation for:', letter.sender, 'Found saved:', !!savedConversation);
      
      if (savedConversation) {
        // Restore saved conversation
        currentContentParagraphs = savedConversation.paragraphs;
        currentDisplayedParagraphs = savedConversation.displayedCount;
        
        // Clear and rebuild conversation
        const paragraphItems = container.querySelectorAll('.content-paragraph-item');
        paragraphItems.forEach(item => item.remove());
        
        // Restore elements immediately - no animation
        savedConversation.elements.forEach((elementData, index) => {
          const element = document.createElement('div');
          element.className = elementData.className;
          element.textContent = elementData.textContent;
          if (elementData.dataIndex) {
            element.dataset.index = elementData.dataIndex;
          }
          
          // No click handler - selection disabled
          
          container.appendChild(element);
          
          // Scroll to bottom
          container.scrollTop = container.scrollHeight;
        });
      } else {
        // First time viewing this letter
        console.log('First time viewing letter:', letter.sender);
        currentContentParagraphs = splitContentIntoParagraphs(letter.content);
        currentDisplayedParagraphs = 0;
        console.log('Split into paragraphs:', currentContentParagraphs.length);
        
        // Clear any existing content
        const paragraphItems = container.querySelectorAll('.content-paragraph-item');
        paragraphItems.forEach(item => item.remove());
        
        // Display first paragraph immediately - no delay
        console.log('About to display first paragraph immediately');
        displayContentParagraphs(currentContentParagraphs, 0);
      }
    }
    
    /* Initialize content display */
    function initializeContentDisplay(letter) {
      console.log('Initializing content display for:', letter.sender);
      
      // Save current conversation before switching
      saveConversationState();
      
      selectedParagraphIndex = -1;
      
      // Hide old content-text
      document.getElementById('content-text').style.display = 'none';
      
      // Restore or initialize conversation
      restoreConversationState(letter);
    }

    /* Reset content display to default state */
    function resetContentDisplay() {
      const container = document.querySelector('.content-body');
      const contentText = document.getElementById('content-text');
      const contentTitle = document.getElementById('content-title');
      
      // Clear only paragraph items, keep title and text
      const paragraphItems = container.querySelectorAll('.content-paragraph-item');
      paragraphItems.forEach(item => item.remove());
      
      contentText.style.display = 'block';
      
      currentContentParagraphs = [];
      currentDisplayedParagraphs = 0;
      selectedParagraphIndex = -1;
    }

    /* Track currently rendered letters count */
    let currentlyRenderedLetters = 0;

    /* Render letters function */
    function renderLetters(n) {
      console.log('DEBUG: renderLetters called with n =', n);
      console.log('DEBUG: letters.length =', letters.length);
      console.log('DEBUG: currentlyRenderedLetters =', currentlyRenderedLetters);
      
      // n: show first n letters
      const container = document.getElementById('letters-list');
      console.log('DEBUG: container found?', !!container);
      const previousCount = currentlyRenderedLetters;
      
      // Only clear and re-render if we're showing fewer letters than before
      if (n < previousCount) {
        container.innerHTML = '';
        currentlyRenderedLetters = 0;
      }
      
      for (let i = currentlyRenderedLetters; i < Math.min(n, letters.length); i++) {
        const letter = letters[i];
        const item = document.createElement('div');
        item.className = 'letter-item';
        item.dataset.index = i;
        
        // Add staggered animation delay for new letters
        const animationDelay = (i - currentlyRenderedLetters) * 0.2; // 0.2s delay between each
        item.style.animationDelay = `${animationDelay}s`;
        
        // Add fact-checked class if letter has been fact-checked
        if (letter._checked) {
          item.classList.add('fact-checked');
        }
        
        // Add penalized class if letter has been penalized
        if (letter._penalized) {
          item.classList.add('penalized');
        }
        
        item.innerHTML = `
          <div class="letter-sender">${getShortSenderName(letter.sender)}</div>
          <div class="letter-preview">${letter.preview}</div>
        `;
        item.addEventListener('click', (event) => {
          console.log('DEBUG: Letter item click event fired for index:', i);
          console.log('DEBUG: Event target:', event.target);
          console.log('DEBUG: Tutorial active:', tutorialActive);
          selectLetter(i, item);
        });
        console.log('DEBUG: Added click event listener to letter item', i, 'element:', item);
        if (selectedLetterIndex === i) {
          item.classList.add('selected');
        }
        container.appendChild(item);
        
        // DEBUG: Verify the event listener was attached
        setTimeout(() => {
          console.log('DEBUG: Verifying event listener for item', i, 'after DOM append');
          console.log('DEBUG: Item in DOM:', document.contains(item));
          console.log('DEBUG: Item parent:', item.parentElement);
        }, 10);
      }
      
      // Update existing letters' classes if needed
      const existingItems = container.querySelectorAll('.letter-item');
      for (let i = 0; i < Math.min(currentlyRenderedLetters, existingItems.length); i++) {
        const letter = letters[i];
        const item = existingItems[i];
        
        // Update fact-checked status
        if (letter._checked) {
          item.classList.add('fact-checked');
        } else {
          item.classList.remove('fact-checked');
        }
        
        // Update penalized status
        if (letter._penalized) {
          item.classList.add('penalized');
        } else {
          item.classList.remove('penalized');
        }
        
        // Update selected status
        if (selectedLetterIndex === i) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      }
      
      currentlyRenderedLetters = Math.min(n, letters.length);
    }

    /* Global variables */
    const rows = 5, cols = 4, gap = 0;
    let selectedLetter = null;
    let selectedLetterIndex = null;
    let currentContentParagraphs = [];
    let currentDisplayedParagraphs = 0;
    let selectedParagraphIndex = -1;
    
    // Store conversation history for each sender
    let conversationHistory = new Map();
    let dragData = null;

    /* Initialize */
    document.addEventListener('DOMContentLoaded', () => {
      renderLetters(letters.length); // Pass the total number of letters
      initGrid(true); // Force reset on initial load
      setupEventListeners();
      updateStats();
      setupFactCheck();

      // Add event listener for continue button
      document.getElementById('continue-btn').addEventListener('click', showNextParagraph);

      setTimeout(resizeGrid, 100);
    });


    /* Select letter */
    function selectLetter(index, element) {
      console.log('DEBUG: selectLetter called with index:', index, 'element:', element);
      // Check if we need to handle previous letter's internal contradiction
      // if (selectedLetter && selectedLetter.hasInternalContradiction && !selectedLetter._rejected && selectedLetter._opened) {
      //   // Auto-penalize for not rejecting a contradictory letter
      //   selectedLetter._autoPenalized = true;
      //   console.log(`Auto-penalized for not rejecting letter: ${selectedLetter.sender}`);
      //   // Disable all buttons for this letter
      //   disableLetterButtons(selectedLetterIndex);
      // }
      
      document.querySelectorAll('.letter-item').forEach(item => 
        item.classList.remove('selected')
      );
      element.classList.add('selected');
      
      selectedLetter = letters[index];
      selectedLetterIndex = index;
      
      // Mark letter as opened if not already opened
      if (!selectedLetter._opened) {
        selectedLetter._opened = true;
        console.log(`Opened letter: ${selectedLetter.sender}`);
        // Add visual indicator for opened letters
        element.classList.add('opened');
      }
      
      // Don't show sender name - directly show content
      // document.getElementById('content-title').textContent = selectedLetter.sender;
      
      // Direct content display - simplified logic
      console.log('Selected letter:', selectedLetter.sender);
      const container = document.querySelector('.content-body');
      
      // Clear existing paragraph items
      const paragraphItems = container.querySelectorAll('.content-paragraph-item');
      paragraphItems.forEach(item => item.remove());
      
      // Initialize content
      currentContentParagraphs = splitContentIntoParagraphs(selectedLetter.content);
      currentDisplayedParagraphs = 0;
      selectedParagraphIndex = -1;
      
      console.log('Content paragraphs:', currentContentParagraphs.length);
      if (currentContentParagraphs.length > 0) {
        console.log('First paragraph:', currentContentParagraphs[0]);
        displayContentParagraphs(currentContentParagraphs, 0);
      }
      
      updateToolsState();
      updateFactCheckState();
      // 失去小喇叭焦点
      document.getElementById('queue-next-btn').blur();
    }

    /* Disable all buttons for a specific letter */
    function disableLetterButtons(letterIndex) {
      const letter = letters[letterIndex];
      letter._buttonsDisabled = true;
      
      // Disable drag tools if this letter is selected
      if (selectedLetterIndex === letterIndex) {
        document.querySelectorAll('.tool-item:not(.reject)').forEach(tool => {
          tool.classList.add('disabled');
          tool.draggable = false;
        });
      }
      
      // Add visual indicator to letter item
      const letterItems = document.querySelectorAll('.letter-item');
      if (letterItems[letterIndex]) {
        letterItems[letterIndex].classList.add('buttons-disabled');
      }
    }

    /* Handle reject button click */
    function rejectLetter() {
      if (!selectedLetter) return;
      
      selectedLetter._rejected = true;
      console.log(`Rejected letter: ${selectedLetter.sender}`);
      
      // Check if rejecting email without internal contradictions - apply penalty
      if (!selectedLetter.hasInternalContradiction) {
        applyLetterPenalty(selectedLetterIndex);
      }
      
      // Add visual indicator
      const letterItems = document.querySelectorAll('.letter-item');
      if (letterItems[selectedLetterIndex]) {
        letterItems[selectedLetterIndex].classList.add('rejected');
      }
      
      // Disable tools for rejected letter
      disableLetterButtons(selectedLetterIndex);
    }

    /* Update tools state */
    function updateToolsState() {
      const tools = document.querySelectorAll('.tool-item:not(.reject)');
      const hasSelection = !!selectedLetter;
      const buttonsDisabled = selectedLetter && selectedLetter._buttonsDisabled;
      
      tools.forEach(tool => {
        const shouldDisable = !hasSelection || buttonsDisabled;
        tool.classList.toggle('disabled', shouldDisable);
        tool.draggable = !shouldDisable;
      });
      
      // Handle reject button
      const rejectBtn = document.querySelector('.tool-item.reject');
      if (rejectBtn) {
        const shouldDisableReject = !hasSelection || selectedLetter._rejected || buttonsDisabled;
        rejectBtn.classList.toggle('disabled', shouldDisableReject);
      }
    }

    /* Update fact check state */
    function updateFactCheckState() {
      const btn = document.getElementById('fact-check-btn');
      const resultsContainer = document.getElementById('fact-check-results');
      const hasSelection = !!selectedLetter;
      const buttonsDisabled = selectedLetter && selectedLetter._buttonsDisabled;
      
      if (!hasSelection) {
        // No letter selected - disable button and show empty state
        btn.classList.add('disabled');
        resultsContainer.innerHTML = '';
        return;
      }
      
      // Check if the selected letter has already been fact-checked
      const isAlreadyChecked = selectedLetter._checked;
      
      if (isAlreadyChecked) {
        // Letter already fact-checked - disable button and show previous results
        btn.classList.add('disabled');
        const factCheck = selectedLetter.factCheck;
        resultsContainer.innerHTML = `
          <div class="fact-check-results-content show">
            <div class="fact-check-title">📊 Fact Check: ${selectedLetter.sender}</div>
            <div class="fact-section">
              <div class="fact-claim">📩 Claim: ${factCheck.claim}</div>
              <div class="fact-data">
                <ul>
                  ${factCheck.facts.map(fact => `<li>${fact}</li>`).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
      } else if (buttonsDisabled) {
        // Buttons disabled but letter not fact-checked - disable button and show placeholder
        btn.classList.add('disabled');
        resultsContainer.innerHTML = `
          <div id="fact-check-placeholder" class="fact-check-placeholder">
            <div class="fact-check-placeholder-title">Ready for Fact Check</div>
            <div class="fact-check-placeholder-text">Click the "Fact Check" button below to verify the claims in the selected letter.</div>
          </div>
        `;
      } else {
        // Letter not yet fact-checked and buttons enabled - enable button and show placeholder
        btn.classList.remove('disabled');
        resultsContainer.innerHTML = `
          <div id="fact-check-placeholder" class="fact-check-placeholder">
            <div class="fact-check-placeholder-title">Ready for Fact Check</div>
            <div class="fact-check-placeholder-text">Click the "Fact Check" button below to verify the claims in the selected letter.</div>
          </div>
        `;
      }
    }

    /* Setup fact check */
    function setupFactCheck() {
      const btn = document.getElementById('fact-check-btn');
      
      // Remove any existing event listeners to prevent duplicates
      btn.removeEventListener('click', handleFactCheckClick);
      
      // Add the event listener
      btn.addEventListener('click', handleFactCheckClick);
    }
    
    // Separate function to handle fact check clicks
    function handleFactCheckClick() {
      const btn = document.getElementById('fact-check-btn');
      if (!selectedLetter || btn.classList.contains('disabled')) return;
      
      // Disable button during fact checking
      btn.classList.add('disabled');
      
      const resultsContainer = document.getElementById('fact-check-results');
      const placeholderEl = document.getElementById('fact-check-placeholder');
      const factCheck = selectedLetter.factCheck;
      
      // First, fade out the placeholder text with animation
      if (placeholderEl) {
        placeholderEl.classList.add('hide');
        
        // After placeholder disappears, show loading animation
        setTimeout(() => {
          resultsContainer.innerHTML = `
              <div id="fact-check-loading" class="fact-check-loading">
                <div class="main">
                  <div class="up">
                    <div class="loaders">
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                      <div class="loader"></div>
                    </div>
                    <div class="loadersB">
                      <div class="loaderA">
                        <div class="ball0"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball1"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball2"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball3"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball4"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball5"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball6"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball7"></div>
                      </div>
                      <div class="loaderA">
                        <div class="ball8"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
          // Simple fade-in animation
          setTimeout(() => {
            const loadingEl = document.getElementById('fact-check-loading');
            if (loadingEl) {
              loadingEl.classList.add('show');
            }
          }, 50);
          
          // Start accelerated clock animation
          startAcceleratedClock();
        }, 400); // Wait for placeholder to fade out
      } else {
        // If no placeholder, directly show loading (fallback)
        setTimeout(() => {
          const loadingEl = document.getElementById('fact-check-loading');
          if (loadingEl) {
            loadingEl.classList.add('show');
          }
        }, 50);
        
        // Start accelerated clock animation
        startAcceleratedClock();
      }
      
      // After 10 seconds, hide loading and show results
      setTimeout(() => {
        // Simple fade-out
        const loadingEl = document.getElementById('fact-check-loading');
        if (loadingEl) {
          loadingEl.classList.remove('show');
        }
        
        // After loading animation completes, show results
        setTimeout(() => {
          resultsContainer.innerHTML = `
              <div class="fact-check-results-content">
                <div class="fact-check-title">📊 Fact Check: ${selectedLetter.sender}</div>
                <div class="fact-section">
                  <div class="fact-claim">📩 Claim: ${factCheck.claim}</div>
                  <div class="fact-data">
                    <ul>
                      ${factCheck.facts.map(fact => `<li>${fact}</li>`).join('')}
                    </ul>
                  </div>
                </div>
              </div>
          `;
          
          // Trigger results appear animation
          setTimeout(() => {
            const resultsContent = document.querySelector('.fact-check-results-content');
            if (resultsContent) {
              resultsContent.classList.add('show');
            }
          }, 50);
          
          addLogEntry(`fact check ${selectedLetter.sender}'s email`);
          selectedLetter._checked = true;
          
          // Update letter list to show fact-checked status
          if (window.renderLetters) {
            // Get current number of displayed letters
            const currentLetterCount = document.querySelectorAll('.letter-item').length;
            window.renderLetters(currentLetterCount);
          }
          
          // Stop accelerated clock animation
          stopAcceleratedClock();
          
          // Update MVIS scores after fact check
          if (typeof window.calculateAndUpdateMVIS === 'function') {
            window.calculateAndUpdateMVIS();
          }
        }, 400); // Wait for loading disappear animation
      }, 10000); // 10 seconds for fact checking
    }

    /* Initialize grid */
    function initGrid(forceReset = false) {
      const grid = document.getElementById('grid');
      
      // Only clear grid if explicitly forced to reset
      // Don't clear on day transitions to preserve error tiles
      if (forceReset) {
        console.log('initGrid: CLEARING grid (forceReset=' + forceReset + ', currentDay=' + currentDay + ')');
        grid.innerHTML = '';
      } else {
        console.log('initGrid: PRESERVING existing tiles (forceReset=' + forceReset + ', currentDay=' + currentDay + ')');
        // Skip clearing - preserve existing tiles for day transitions
      }

      // Only recreate cells if grid was cleared
      if (forceReset) {
        for (let r = 1; r <= rows; r++) {
          for (let c = 1; c <= cols; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.row = r;
            cell.dataset.col = c;
            cell.addEventListener('dragover', e => e.preventDefault());
            cell.addEventListener('drop', onDrop);
            grid.appendChild(cell);
          }
        }
      } else {
        console.log('initGrid: Skipping cell recreation to preserve existing grid structure');
      }
    }

    /* Setup event listeners */
    function setupEventListeners() {
      console.log('setupEventListeners: Starting event listener setup');
      
      // CRITICAL: Always clean up existing listeners before adding new ones
      // This prevents duplicate event listeners when function is called multiple times
      document.querySelectorAll('.tool-item').forEach(tool => {
        // Create a new clone to remove all existing event listeners
        const newTool = tool.cloneNode(true);
        tool.parentNode.replaceChild(newTool, tool);
      });
      
      document.querySelectorAll('.cell').forEach(cell => {
        // Create a new clone to remove all existing event listeners
        const newCell = cell.cloneNode(true);
        cell.parentNode.replaceChild(newCell, cell);
      });
      
      // Tool drag events
      document.querySelectorAll('.tool-item').forEach(tool => {
        tool.addEventListener('dragstart', e => {
          console.log('Dragstart triggered on:', tool.className);
          
          const isReject = tool.classList.contains('reject');
          if (!isReject && !selectedLetter) {
            e.preventDefault();
            alert('Please select a letter first.');
            return;
          }
          
          let size;
          if (isReject) {
            size = 'reject';
          } else if (tool.classList.contains('size-small')) {
            size = 'small';
          } else if (tool.classList.contains('size-medium')) {
            size = 'medium';
          } else if (tool.classList.contains('size-large')) {
            size = 'large';
          }
          
          console.log('Drag size:', size, 'Selected letter:', selectedLetter);
          
          dragData = { 
            type: 'new', 
            size, 
            sender: selectedLetter ? selectedLetter.sender : null 
          };
          
          tool.style.opacity = '0.5';
        });

        tool.addEventListener('dragend', e => {
          console.log('Dragend triggered');
          e.target.style.opacity = '';
          dragData = null;
          hideGhost();
        });
      });

      // Grid drag events
      const grid = document.getElementById('grid');
      grid.addEventListener('dragover', e => {
        e.preventDefault();
        console.log('Grid dragover, dragData:', dragData);
        
        if (!dragData) return;
        
        let size;
        if (dragData.type === 'move') {
          // Get size from the tile being moved
          size = dragData.tile.dataset.size;
        } else {
          size = dragData.size;
        }
        
        if (size === 'reject') return;
        
        const templateKey = `size-${size}`;
        const span = contentTemplates[templateKey];
        console.log('Template key:', templateKey, 'Span:', span);
        
        if (!span) return;
        
        const cellSize = getCellSize();
        const rect = grid.getBoundingClientRect();
        const gridPadding = 4;
        const cellMargin = 1;
        
        // Adjust mouse position considering grid padding
        const x = e.clientX - rect.left - gridPadding;
        const y = e.clientY - rect.top - gridPadding;
        
        // Calculate cell position considering margins
        const col = Math.floor(x / (cellSize + cellMargin * 2)) + 1;
        const row = Math.floor(y / (cellSize + cellMargin * 2)) + 1;

        const ghost = getOrCreateGhost();
        ghost.dataset.row = row;
        ghost.dataset.col = col;
        ghost.dataset.spanR = span.r;
        ghost.dataset.spanC = span.c;
        
        // Position ghost with same logic as tiles - includes margin extension for seamless contact
        const leftPos = gridPadding + (col - 1) * (cellSize + cellMargin * 2) - cellMargin;
        const topPos = gridPadding + (row - 1) * (cellSize + cellMargin * 2) - cellMargin;
        
        ghost.style.width = (cellSize * span.c + (span.c - 1) * cellMargin * 2 + cellMargin * 2) + 'px';
        ghost.style.height = (cellSize * span.r + (span.r - 1) * cellMargin * 2 + cellMargin * 2) + 'px';
        ghost.style.left = leftPos + 'px';
        ghost.style.top = topPos + 'px';

        // Validate position
        let valid = true;
        if (row < 1 || col < 1 || row + span.r - 1 > rows || col + span.c - 1 > cols) {
          valid = false;
        } else {
          const existingTiles = grid.querySelectorAll('.tile');
          for (const tile of existingTiles) {
            if (dragData.type === 'move' && tile === dragData.tile) continue;
            
            // Skip wounds (tiles that have been transformed to blood)
            if (tile.style.pointerEvents === 'none' && tile.style.background.includes('rgba(128, 0, 0')) continue;
            
            const er = +tile.dataset.row;
            const ec = +tile.dataset.col;
            const sr = +tile.dataset.spanR;
            const sc = +tile.dataset.spanC;
            
            if (row < er + sr && er < row + span.r && col < ec + sc && ec < col + span.c) {
              valid = false;
              break;
            }
          }
        }
        
        ghost.classList.toggle('valid', valid);
        ghost.classList.toggle('invalid', !valid);
        ghost.style.display = 'block';
      });

      // Cell drop events
      document.querySelectorAll('.cell').forEach(cell => {
        cell.addEventListener('drop', onDrop);
        cell.addEventListener('dragover', e => e.preventDefault());
      });

      // Remove zones
      ['letters-panel', 'tools-panel'].forEach(className => {
        const zone = document.querySelector(`.${className}`);
        zone.addEventListener('dragover', e => e.preventDefault());
        zone.addEventListener('drop', () => {
          console.log('Drop on remove zone, dragData:', dragData);
          if (dragData && dragData.type === 'move' && dragData.tile) {
            const tile = dragData.tile;
            const row = +tile.dataset.row;
            const col = +tile.dataset.col;
            const spanR = +tile.dataset.spanR;
            const spanC = +tile.dataset.spanC;
            
            // Clear occupied cells first
            markCellsOccupied(row, col, spanR, spanC, false);
            
            // Check if this is a previous day error tile (should bleed)
            const shouldBleed = tile.dataset.previousDayError === 'true';
            
            if (shouldBleed) {
              // Transform tile into wound with bleeding
              tile.innerHTML = '';
              tile.style.background = 'rgba(128, 0, 0, 0.85)';
              tile.style.borderRadius = '6px 6px 10px 10px';
              tile.style.filter = 'url(#goo) blur(4px)';
              tile.style.cursor = 'default';
              tile.style.pointerEvents = 'none';
              tile.style.zIndex = '4';
              tile.draggable = false;
              
              createBlueDrip(tile);
            } else {
              // Simply remove tile without bleeding (same day tile)
              tile.remove();
            }
            
            updateStats();
            
            // Update MVIS scores
            if (typeof window.calculateAndUpdateMVIS === 'function') {
              window.calculateAndUpdateMVIS();
            }
          }
          dragData = null;
          hideGhost();
        });
      });

      // REJECT button click event
      document.querySelector('.tool-item.reject').addEventListener('click', () => {
        rejectLetter();
      });

      window.addEventListener('resize', () => resizeGrid());
    }

    /* Drop handler */
    function onDrop(e) {
      e.preventDefault();
      console.log('Drop triggered, dragData:', dragData);
      
      if (!dragData) {
        console.log('No dragData, aborting drop');
        return;
      }
      
      const ghost = document.querySelector('.ghost');
      if (!ghost || !ghost.classList.contains('valid')) {
        console.log('Ghost not valid, aborting drop');
        alert('Cannot place here.');
        return;
      }

      console.log('Drop proceeding...');
      const row = +ghost.dataset.row;
      const col = +ghost.dataset.col;
      
      let size;
      if (dragData.type === 'move') {
        size = dragData.tile.dataset.size;
      } else {
        size = dragData.size;
      }
      
      const templateKey = `size-${size}`;
      const span = contentTemplates[templateKey];
      
      console.log('Row:', row, 'Col:', col, 'Size:', size, 'Template:', templateKey, 'Span:', span);
      
      if (!span) {
        console.log('No span found for template:', templateKey);
        return;
      }
      
      let tile;
      if (dragData.type === 'new') {
        console.log('Creating new tile');
        tile = document.createElement('div');
        tile.className = 'tile';
        tile.dataset.size = size;
        tile.dataset.spanR = span.r;
        tile.dataset.spanC = span.c;
        tile.dataset.row = row;
        tile.dataset.col = col;
        tile.draggable = true;
        
        // Get the proposal content
        const letterIndex = Array.from(document.querySelectorAll('.letter-item')).findIndex(item => 
          item.classList.contains('selected')
        );
        const letter = letters[letterIndex];
        
        // Check for internal contradictions - if true, apply penalty for non-reject actions
        if (letter.hasInternalContradiction) {
          applyLetterPenalty(letterIndex);
          return; // Prevent tile creation
        }
        
        const proposal = letter.proposals[size];
        
        // Create content with title and text
        tile.innerHTML = `
          <div class="tile-content">
            <div class="tile-title">${proposal.title}</div>
            <div class="tile-text">${proposal.content}</div>
          </div>
        `;
        
        // Store letter info for potential reuse
        tile.dataset.sender = dragData.sender;
        tile.dataset.letterIndex = letterIndex;
        
        // Add event listeners
        tile.addEventListener('click', () => {
          const row = +tile.dataset.row;
          const col = +tile.dataset.col;
          const spanR = +tile.dataset.spanR;
          const spanC = +tile.dataset.spanC;
          
          // Clear occupied cells first
          markCellsOccupied(row, col, spanR, spanC, false);
          
          // Check if this is a previous day error tile (should bleed)
          const shouldBleed = tile.dataset.previousDayError === 'true';
          console.log('=== Tile removal clicked ===');
          console.log('Tile previousDayError attribute:', tile.dataset.previousDayError);
          console.log('Should bleed:', shouldBleed);
          
          if (shouldBleed) {
            console.log('→ BLEEDING: Transforming tile into wound');
            // Transform tile into wound with bleeding
            tile.innerHTML = '';
            tile.style.background = 'rgba(128, 0, 0, 0.85)';
            tile.style.borderRadius = '6px 6px 10px 10px';
            tile.style.filter = 'url(#goo) blur(4px)';
            tile.style.cursor = 'default';
            tile.style.pointerEvents = 'none';
            tile.style.zIndex = '4';
            tile.draggable = false;
            
            createBlueDrip(tile);
            
            // Play pluck-off sound for tile removal (bleeding)
            const pluckOffSound = document.getElementById('pluck-off-sound');
            if (pluckOffSound) {
              pluckOffSound.currentTime = 0;
              pluckOffSound.play().catch(e => console.log('Pluck-off sound failed:', e));
            }
            
            addLogEntry(`remove (${spanR}×${spanC}) proposal from ${tile.dataset.sender}`);
          } else {
            console.log('→ REGULAR REMOVAL: Same day tile, no bleeding');
            // Simply remove tile without bleeding (same day tile)
            
            // Play pluck-off sound for tile removal (regular)
            const pluckOffSound = document.getElementById('pluck-off-sound');
            if (pluckOffSound) {
              pluckOffSound.currentTime = 0;
              pluckOffSound.play().catch(e => console.log('Pluck-off sound failed:', e));
            }
            
            tile.remove();
            addLogEntry(`remove (${spanR}×${spanC}) proposal from ${tile.dataset.sender}`);
          }
          
          updateStats();
          
          // Update MVIS scores
          if (typeof window.calculateAndUpdateMVIS === 'function') {
            window.calculateAndUpdateMVIS();
          }
        });
        
        tile.addEventListener('dragstart', e => {
          console.log('Tile dragstart');
          dragData = { type: 'move', tile };
          tile.classList.add('dragging');
        });
        
        tile.addEventListener('dragend', () => {
          console.log('Tile dragend');
          if (tile.classList.contains('dragging')) {
            tile.classList.remove('dragging');
          }
          dragData = null;
          hideGhost();
        });
        
        document.getElementById('grid').appendChild(tile);
        addLogEntry(`add (${span.r}×${span.c}) proposal from ${dragData.sender}`);
        console.log('Tile added to grid');
      } else if (dragData.type === 'move') {
        console.log('Moving existing tile');
        tile = dragData.tile;
        tile.dataset.row = row;
        tile.dataset.col = col;
        tile.classList.remove('dragging');
      }

      // Position tile
      const cellSize = getCellSize();
      const gridPadding = 4; // grid padding
      const cellMargin = 1; // cell margin - 但tile要覆盖这个间距
      
      // Calculate position considering grid padding, tile稍微扩展以覆盖cell margins
      const leftPos = gridPadding + (col - 1) * (cellSize + cellMargin * 2) - cellMargin;
      const topPos = gridPadding + (row - 1) * (cellSize + cellMargin * 2) - cellMargin;
      
      // Tile size includes cell margins to achieve seamless contact
      tile.style.width = (cellSize * span.c + (span.c - 1) * cellMargin * 2 + cellMargin * 2) + 'px';
      tile.style.height = (cellSize * span.r + (span.r - 1) * cellMargin * 2 + cellMargin * 2) + 'px';
      tile.style.left = leftPos + 'px';
      tile.style.top = topPos + 'px';

      console.log('Tile positioned');
      
      // Mark occupied cells
      markCellsOccupied(row, col, span.r, span.c, true);
      
      // Play pluck-on sound for successful tile placement
      const pluckOnSound = document.getElementById('pluck-on-sound');
      if (pluckOnSound) {
        pluckOnSound.currentTime = 0;
        pluckOnSound.play().catch(e => console.log('Pluck-on sound failed:', e));
      }
      
      dragData = null;
      hideGhost();
      updateStats();
      
      // Update MVIS scores
      if (typeof window.calculateAndUpdateMVIS === 'function') {
        window.calculateAndUpdateMVIS();
      }
      
      console.log('Drop completed successfully');
    }

    /* Helper functions */
    function markCellsOccupied(row, col, spanR, spanC, occupied) {
      for (let r = row; r < row + spanR; r++) {
        for (let c = col; c < col + spanC; c++) {
          const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
          if (cell) {
            if (occupied) {
              cell.classList.add('occupied');
            } else {
              cell.classList.remove('occupied');
            }
          }
        }
      }
    }
    
    function getCellSize() {
      const grid = document.getElementById('grid');
      // 减去grid的padding (4px * 2 = 8px) 和 cell的margin间距
      const gridPadding = 8; // 4px padding on each side
      const cellMargin = 2; // 1px margin per cell, 2px total gap between cells
      const availableHeight = grid.clientHeight - gridPadding;
      const availableWidth = grid.clientWidth - gridPadding;
      
      // 使用较小的尺寸来保持正方形cells
      const cellSizeByHeight = (availableHeight - (rows - 1) * cellMargin) / rows;
      const cellSizeByWidth = (availableWidth - (cols - 1) * cellMargin) / cols;
      
      return Math.min(cellSizeByHeight, cellSizeByWidth);
    }

    function getOrCreateGhost() {
      let ghost = document.querySelector('.ghost');
      if (!ghost) {
        ghost = document.createElement('div');
        ghost.className = 'ghost';
        document.getElementById('grid').appendChild(ghost);
      }
      return ghost;
    }

    function hideGhost() {
      const ghost = document.querySelector('.ghost');
      if (ghost) ghost.style.display = 'none';
    }

    function resizeGrid() {
      // Let CSS handle grid sizing with aspect-ratio, just reposition tiles
      const cellSize = getCellSize();
      
      // Reposition tiles
      document.querySelectorAll('.tile').forEach(tile => {
        const spanR = +tile.dataset.spanR;
        const spanC = +tile.dataset.spanC;
        const row = +tile.dataset.row;
        const col = +tile.dataset.col;
        const size = tile.dataset.size;
        const letterIndex = tile.dataset.letterIndex;
        
        const gridPadding = 4; // grid padding
        const cellMargin = 1; // cell margin - 但tile要覆盖这个间距
        
        // Calculate position considering grid padding, tile稍微扩展以覆盖cell margins
        const leftPos = gridPadding + (col - 1) * (cellSize + cellMargin * 2) - cellMargin;
        const topPos = gridPadding + (row - 1) * (cellSize + cellMargin * 2) - cellMargin;
        
        // Tile size includes cell margins to achieve seamless contact
        tile.style.width = (cellSize * spanC + (spanC - 1) * cellMargin * 2 + cellMargin * 2) + 'px';
        tile.style.height = (cellSize * spanR + (spanR - 1) * cellMargin * 2 + cellMargin * 2) + 'px';
        tile.style.left = leftPos + 'px';
        tile.style.top = topPos + 'px';
        
        // Update content with proper structure
        if (letterIndex && letters[letterIndex]) {
          const proposal = letters[letterIndex].proposals[size];
          tile.innerHTML = `
            <div class="tile-content">
              <div class="tile-title">${proposal.title}</div>
              <div class="tile-text">${proposal.content}</div>
            </div>
          `;
        }
      });
      // (puddle/water-level features removed)
    }

    function updateStats() {
      const tiles = document.querySelectorAll('.tile');
      const totalCells = rows * cols;
      let usedCells = 0;
      
      tiles.forEach(tile => {
        const spanR = +tile.dataset.spanR;
        const spanC = +tile.dataset.spanC;
        usedCells += spanR * spanC;
      });
      
      const coverage = Math.round((usedCells / totalCells) * 100);
      
      document.getElementById('tile-count').textContent = tiles.length;
      document.getElementById('space-used').textContent = coverage;
    }

    /**
     * Blood drop object pool for performance optimization
     */
    const bloodDropPool = {
      available: [],
      inUse: new Set(),
      maxPoolSize: 50,
      maxActiveDrops: 100,
      
      acquire() {
        if (this.inUse.size >= this.maxActiveDrops) {
          return null; // Prevent excessive drops
        }
        
        let drop;
        if (this.available.length > 0) {
          drop = this.available.pop();
        } else {
          drop = document.createElement('div');
          drop.className = 'drop2';
          drop.style.width = '26px';
          drop.style.height = '30px';
          drop.style.borderRadius = '50%';
          drop.style.position = 'absolute';
          drop.style.bottom = '0';
          drop.style.backgroundColor = 'rgba(178, 18, 18, 0.95)';
          drop.style.filter = 'url(#liquid) blur(1px)';
          drop.style.animation = 'drop var(--anim,1.3s) cubic-bezier(1,.19,.66,.12) forwards';
          drop.style.zIndex = '5';
          drop.style.willChange = 'transform';
        }
        
        this.inUse.add(drop);
        return drop;
      },
      
      release(drop) {
        if (this.inUse.has(drop)) {
          this.inUse.delete(drop);
          drop.style.animation = '';
          drop.style.left = '';
          drop.style.setProperty('--dist', '');
          drop.style.setProperty('--anim', '');
          
          if (drop.parentNode) {
            drop.parentNode.removeChild(drop);
          }
          
          if (this.available.length < this.maxPoolSize) {
            this.available.push(drop);
          }
        }
      }
    };

    /**
     * Blue loader-style drip effect at a given element's bottom center.
     * (Puddle pooling removed; simple falling drops only.)
     */
    function createBlueDrip(elem) {
      const grid      = document.getElementById('grid');
      const gridRect  = grid.getBoundingClientRect();
      const rect      = elem.getBoundingClientRect();

      const container = document.createElement('div');
      container.className = 'blue-drops';
      container.style.left   = `${rect.left - gridRect.left - 2}px`;    /* align with base extension */
      container.style.top    = `${rect.bottom - gridRect.top - 2 - 20}px`;
      container.style.width  = `${rect.width + 4}px`;                   /* match base's +4 px width */
      container.style.height = `24px`;           // base height for drops

      const base = document.createElement('div');
      base.className = 'drop1';
      container.appendChild(base);

      // Pre-calculate values to avoid repeated DOM queries
      const containerWidth = rect.width + 4;
      const dropW = 26;
      const dropDist = gridRect.bottom - rect.bottom + 40;
      const cellSize = getCellSize();
      const spanC = Math.max(1, Math.round(rect.width / cellSize));

      // Helper to spawn a drop at a random X position
      function spawnDrop(){
        const drip = bloodDropPool.acquire();
        if (!drip) {
          return; // Skip if pool limit reached
        }
        
        // random horizontal pixel position inside base
        drip.style.left = Math.random() * (containerWidth - dropW) + 'px';
        // pre-calculated drop distance
        drip.style.setProperty('--dist', dropDist + 'px');
        
        // Auto-cleanup: return to pool after animation completes
        const cleanup = () => {
          bloodDropPool.release(drip);
          drip.removeEventListener('animationend', cleanup);
        };
        drip.addEventListener('animationend', cleanup);
        
        container.appendChild(drip);
      }
      // Spawn one drop initially
      spawnDrop();
      // Simple spawn interval (no acceleration)
      let intervalId = setInterval(spawnDrop, 400 / spanC);

      // stop generating if the wound (and thus container) is removed
      const observer = new MutationObserver(muts => {
        muts.forEach(mu => {
          mu.removedNodes.forEach(node => {
            if (node === container) {
              clearInterval(intervalId);
              observer.disconnect();
              
              // Stop dripping sound when bleeding stops
              const drippingSound = document.getElementById('dripping-sound');
              if (drippingSound) {
                drippingSound.pause();
                drippingSound.currentTime = 0;
              }
              
              // Clean up any remaining drops in this container
              const remainingDrops = container.querySelectorAll('.drop2');
              remainingDrops.forEach(drop => {
                bloodDropPool.release(drop);
              });
            }
          });
        });
      });
      observer.observe(grid, { childList: true });

      grid.appendChild(container);
      
      // Start dripping sound when bleeding begins
      const drippingSound = document.getElementById('dripping-sound');
      if (drippingSound) {
        drippingSound.currentTime = 0;
        drippingSound.play().catch(e => console.log('Dripping sound play failed:', e));
      }
    }

    // —— MVIS Score Calculation —— 
    document.getElementById('submit-btn').addEventListener('click', () => {
      // Stop alarm sound and countdown timer when user manually submits
      const alarmSound = document.getElementById('alarm-sound');
      if (alarmSound) {
        alarmSound.pause();
        alarmSound.currentTime = 0;
      }
      
      // Clear the countdown timer if it exists
      if (window.alarmCountdownTimer) {
        clearInterval(window.alarmCountdownTimer);
        window.alarmCountdownTimer = null;
      }
      
      // Reset submit button text if it was showing countdown
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn && submitBtn.textContent.includes('Auto-Submit')) {
        submitBtn.textContent = 'Submit';
      }
      
      // Skip MVIS calculation and go directly to summary
      setTimeout(async () => {
        await initializeSummary();
        showPage('daily-recap-page');
      }, 100);
    });

    // Debug function to check where jump goes
    function debugJump() {
      console.log('=== DEBUG JUMP START ===');
      
      // Check current active page before jump
      const currentPage = document.querySelector('.page.active');
      console.log('Current active page:', currentPage ? currentPage.id : 'none');
      
      // List all pages and their states
      document.querySelectorAll('.page').forEach((page, index) => {
        const style = window.getComputedStyle(page);
        console.log(`Page ${page.id}:`, {
          hasActiveClass: page.classList.contains('active'),
          hasHiddenClass: page.classList.contains('hidden'),
          display: style.display,
          opacity: style.opacity
        });
      });
      
      // Call showPage and track the result
      console.log('Calling showPage("final-page")...');
      showPage('final-page');
      
      // Check result after a short delay
      setTimeout(() => {
        const newActivePage = document.querySelector('.page.active');
        console.log('After showPage, active page:', newActivePage ? newActivePage.id : 'none');
        
        const finalPage = document.getElementById('final-page');
        if (finalPage) {
          const finalStyle = window.getComputedStyle(finalPage);
          console.log('Final page state:', {
            hasActiveClass: finalPage.classList.contains('active'),
            hasHiddenClass: finalPage.classList.contains('hidden'),
            display: finalStyle.display,
            opacity: finalStyle.opacity,
            visibility: finalStyle.visibility
          });
          
          // Force show final page with story page content
          console.log('Force showing final page with story page structure...');
          
          // Hide all other pages
          document.querySelectorAll('.page').forEach(page => {
            if (page.id !== 'final-page') {
              page.style.display = 'none';
            }
          });
          
          // Force final page to be visible and replace content with story page clone
          finalPage.style.display = 'block';
          finalPage.style.opacity = '1';
          finalPage.style.visibility = 'visible';
          finalPage.style.position = 'fixed';
          finalPage.style.top = '0';
          finalPage.style.left = '0';
          finalPage.style.width = '100%';
          finalPage.style.height = '100%';
          finalPage.style.zIndex = '10000';
          
          // Replace with story page clone
          finalPage.innerHTML = `
            <div class="snow-background"></div>
            <div class="story-wrapper">
              <div class="story-typing">
                <h1 style="text-align: center; margin-bottom: 20px;">Simulation Complete</h1>
                <p>Congratulations! You have completed the 3-day editorial simulation. Your decisions have shaped the narrative and influenced public opinion.</p>
                <br>
                <button class="next-button" onclick="restartGame()">Play Again</button>
              </div>
              <div class="story-prompt visible">Press ENTER to restart...</div>
            </div>
          `;
          
          console.log('Final page content replaced with story page structure');
        }
        
        console.log('=== DEBUG JUMP END ===');
      }, 500);
    }

    // Final page sections - exactly like story page but with new content
    const finalSections = [
      `Thank you for playing.

In this simulation, you served as the Chief History Textbook Editor of Nation A, tasked with portraying a controversial military operation involving Nation B.

This scenario was designed to explore a psychological process called Inverse Victimhood—how people may respond to moral threat by reframing themselves or their group as victims, even when facing accusations of harm.

But what exactly is Inverse Victimhood?
Let's take a closer look.`,

      `When people feel criticized, challenged, or morally questioned, a common psychological response is not simply to deny responsibility. Instead, they subtly flip the narrative, portraying themselves or their group as the "real victim" in the situation—even if they are not genuinely harmed.

This process typically unfolds in three psychological phases:`,

      `Phase One: Identity Defense ("My group is right; we've suffered more.")

In this initial phase, people strongly defend their identity and beliefs when challenged.
They tend to perceive criticism not as constructive feedback, but as personal attacks on themselves or their group.
    They might say:
"Our group has endured greater suffering than others."
"If something went wrong, it's because other groups acted unfairly."
    For example, in the game scenario you played, imagine a military general saying:
"Our soldiers were just protecting our country; it's unfair to call it repression. Other nations have done far worse."

Rather then an intentional deception, this Phase is often an instinctive way to protect self-esteem and group pride.`,

      `Phase Two: Cognitive Reframing ("I had no choice; my actions were justified.")

In the second phase, people create justifications or rationalizations to explain their own aggressive actions. Rather than accepting responsibility directly, they reinterpret their behavior as unavoidable, necessary, or morally justified.
    Common thoughts include:
"I only hurt them because they left me no other option."
"They would have done the same or worse to me."
    In the game, perhaps you found yourself accepting statements like:
"The conflict was complicated, and every side made mistakes. What we did was unavoidable given the circumstances."

Again, this process isn't necessarily dishonest—it's a genuine psychological mechanism that reduces the discomfort of feeling morally wrong.`,

      `Phase Three: Emotional and Relational Expression ("I need others to see how much I've suffered.")

Finally, people might express their perceived victimhood more openly, often strategically seeking empathy, recognition, or support from others.
    They might publicly highlight how deeply they've been hurt or emphasize their moral virtue in facing adversity:
"Look how much I've sacrificed for others, yet no one acknowledges me."
"It's important that people understand how unfairly I've been treated."
    In the textbook scenario, this could manifest as an editor publicly emphasizing how stressful and unfair the criticism of their historical accounts feels:
"I'm constantly attacked for just doing my job; people don't see how much pressure I'm under."

This emotional expression is often genuine, but sometimes people intentionally amplify these emotions to gain strategic sympathy or avoid accountability.`,

      `Why does this matter?

Inverse Victimhood is not a sign of weakness or manipulation in itself; rather, it's a common psychological process we all can engage in, especially when our moral identity or self-image feels threatened.

Understanding this process helps us recognize how easily narratives of victimhood can shift and why conflicts—personal, cultural, or international—become so difficult to resolve.

In your role as a history textbook editor in the simulation, the way you chose which stories to highlight or downplay reflects how easily any of us can slip into these three phases.`,

      `Final Thought

Remember, recognizing Inverse Victimhood isn't about assigning blame—it's about becoming more self-aware and empathetic. By understanding these patterns, we can better navigate disagreements and build healthier, more honest conversations around responsibility, harm, and fairness.

Thank you again for participating.`
    ];

    // NEW SIMPLE FINAL PAGE LOGIC
    let finalSectionIndex = 0;
    let finalPageActive = false;

    function createFinalPage() {
      console.log('Creating final page with new simple logic...');
      
      // Initialize state
      finalSectionIndex = 0;
      finalPageActive = true;
      
      // Show story page
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
        page.classList.add('hidden');
      });
      
      const storyPage = document.getElementById('story-page');
      storyPage.classList.remove('hidden');
      storyPage.classList.add('active');
      
      // Setup story text area
      const storyText = document.getElementById('story-text');
      storyText.style.height = '400px';
      storyText.style.maxHeight = '400px';
      storyText.style.overflowY = 'auto';
      storyText.style.overflowX = 'hidden';
      storyText.style.wordWrap = 'break-word';
      
      // Hide prompt initially
      const storyPrompt = document.getElementById('story-prompt');
      storyPrompt.classList.remove('visible');
      
      // Set up key listener
      document.removeEventListener('keydown', handleStoryKeyPress);
      document.removeEventListener('keydown', handleFinalPageKeyPress);
      document.addEventListener('keydown', handleFinalPageKeyPress);
      
      // Start first section
      displayFinalSection();
    }
    
    function generatePhaseAssessment(phaseNumber, score) {
      let tendency, description;
      
      if (score >= 45) {
        tendency = 'high';
      } else if (score >= -44) {
        tendency = 'moderate';
      } else {
        tendency = 'low';
      }
      
      const descriptions = {
        1: {
          high: 'strongly prioritized group loyalty when editorial decisions challenged your nation\'s narrative',
          moderate: 'balanced group loyalty with critical evaluation of your nation\'s narrative',
          low: 'questioned group narratives even when they supported your nation\'s position'
        },
        2: {
          high: 'frequently justified potentially harmful editorial choices through situational explanations',
          moderate: 'occasionally rationalized difficult editorial decisions while maintaining some accountability',
          low: 'rarely excused harmful editorial choices, accepting responsibility for difficult decisions'
        },
        3: {
          high: 'emphasized your nation\'s suffering and need for recognition in your editorial choices',
          moderate: 'sometimes highlighted your nation\'s hardships while maintaining balanced perspective',
          low: 'rarely focused on victimhood, preferring factual presentation over emotional appeals'
        }
      };
      
      const scoreSign = score >= 0 ? '+' : '';
      return `\n\nYour Phase ${phaseNumber} score: ${scoreSign}${score}\n\nThis indicates a ${tendency} tendency toward ${phaseNumber === 1 ? 'identity defense' : phaseNumber === 2 ? 'cognitive reframing' : 'emotional expression of victimhood'}. Your responses suggest you ${descriptions[phaseNumber][tendency]}.`;
    }

    function displayFinalSection() {
      if (finalSectionIndex >= finalSections.length) {
        showFinalPageComplete();
        return;
      }
      
      const storyText = document.getElementById('story-text');
      const storyPrompt = document.getElementById('story-prompt');
      
      // Hide prompt during typing
      storyPrompt.classList.remove('visible');
      
      // Clear and start typing
      storyText.textContent = '';
      console.log('Displaying final section:', finalSectionIndex);
      
      // Get current section content
      let sectionContent = finalSections[finalSectionIndex];
      
      // Add phase assessment for phase sections (indices 2, 3, 4)
      if (finalSectionIndex >= 2 && finalSectionIndex <= 4) {
        const phaseNumber = finalSectionIndex - 1; // Phase 1, 2, 3
        
        // Get current phase scores
        const phaseScores = getCurrentPhaseScores();
        const phaseScore = phaseScores[phaseNumber - 1];
        
        sectionContent += generatePhaseAssessment(phaseNumber, phaseScore);
      }
      
      typewriterStory(storyText, sectionContent).then(() => {
        // Show prompt after typing
        storyPrompt.classList.add('visible');
        console.log('Final section typed, prompt shown');
      });
    }
    
    function getCurrentPhaseScores() {
      // Get the current phase scores from the display
      const phaseDisplay = document.getElementById('phase-pools-display');
      if (!phaseDisplay) return [0, 0, 0];
      
      const text = phaseDisplay.textContent;
      const matches = text.match(/([+-]?\d+)\/([+-]?\d+)\/([+-]?\d+)/);
      
      if (matches) {
        return [
          parseInt(matches[1]),
          parseInt(matches[2]),
          parseInt(matches[3])
        ];
      }
      
      return [0, 0, 0];
    }
    
    function handleFinalPageKeyPress(event) {
      if (event.key === 'Enter' && finalPageActive) {
        console.log('Enter pressed, moving to next section. Current:', finalSectionIndex);
        event.preventDefault();
        
        // Move to next section
        finalSectionIndex++;
        displayFinalSection();
      }
    }
    
    function showFinalPageComplete() {
      console.log('All final sections completed');
      const storyText = document.getElementById('story-text');
      const storyPrompt = document.getElementById('story-prompt');
      
      storyText.innerHTML = `
        <div style="text-align: center; margin-top: 2rem;">
          <h2>Simulation Complete</h2>
          <p>Thank you for playing the Textbook Editorial Simulator!</p>
          <br>
          <button class="next-button" onclick="restartGame()">Play Again</button>
        </div>
      `;
      
      storyPrompt.textContent = 'Press ENTER to restart...';
      storyPrompt.classList.add('visible');
      
      // Update key listener for restart
      document.removeEventListener('keydown', handleFinalPageKeyPress);
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          finalPageActive = false;
          restartGame();
        }
      });
    }

    async function showFinalSection(sectionIndex) {
      console.log('showFinalSection called with index:', sectionIndex);
      const textElement = document.getElementById('final-text');
      const promptElement = document.getElementById('final-prompt');
      
      console.log('finalText found:', !!textElement);
      console.log('finalPrompt found:', !!promptElement);
      
      if (!textElement || !promptElement) {
        console.error('Final text or prompt not found');
        return;
      }
      
      if (sectionIndex >= finalSections.length) {
        console.log('All sections completed');
        return;
      }
      
      const section = finalSections[sectionIndex];
      
      // Hide prompt and disable key listener immediately - exactly like story page
      promptElement.classList.remove('visible');
      disableFinalKeyListener();
      
      // DEBUG: Force text to be visible with all possible CSS overrides
      textElement.innerHTML = `<span style="color: #000000 !important; font-size: 20px !important; line-height: 1.4 !important; display: block !important; visibility: visible !important; opacity: 1 !important;">${section}</span>`;
      textElement.style.cssText = 'color: #000000 !important; font-size: 20px !important; line-height: 1.4 !important; display: block !important; visibility: visible !important; opacity: 1 !important;';
      console.log('Text set with force styling:', textElement.innerHTML.substring(0, 100) + '...');
      console.log('Element computed style:', window.getComputedStyle(textElement).color);
      console.log('Element computed opacity:', window.getComputedStyle(textElement).opacity);
      console.log('Element computed visibility:', window.getComputedStyle(textElement).visibility);
      
      // Wrap the completed text in lines for later fade out - exactly like story page  
      // wrapTextInLines(textElement);
      
      // Show prompt and enable key listener after typing completes - exactly like story page
      promptElement.classList.add('visible');
      enableFinalKeyListener();
      console.log('Section completed, prompt shown, key listener enabled');
    }

    function typewriterFinal(element, text, speed = 200) {
      return new Promise((resolve) => {
        // Clear any existing content and prevent further Enter key processing
        disableFinalKeyListener();
        element.textContent = '';
        element.classList.add('typing-active');
        
        // Ensure text color is visible
        element.style.color = '#000000';
        element.style.fontSize = '20px';
        element.style.lineHeight = '1.4';
        
        const words = text.split(' ');
        let wordIndex = 0;
        
        function type() {
          if (wordIndex < words.length) {
            // Play typing sound slightly before displaying word
            const typingSound = document.getElementById('typing-sound-other');
            if (typingSound) {
              typingSound.currentTime = 0;
              typingSound.play().catch(e => console.log('Final typing sound play failed:', e));
            }
            
            // Add word after short delay to make sound slightly ahead
            setTimeout(() => {
              const currentWord = words[wordIndex];
              const displayText = element.textContent + (wordIndex > 0 ? ' ' : '') + currentWord;
              element.textContent = displayText;
              // Re-apply color after each word to ensure visibility
              element.style.color = '#000000';
              wordIndex++;
              setTimeout(type, speed - 50);
            }, 50);
          } else {
            element.classList.remove('typing-active');
            // Final color check
            element.style.color = '#000000';
            console.log('Typing completed, element color:', element.style.color);
            console.log('Element content:', element.textContent);
            resolve();
          }
        }
        type();
      });
    }

    function wrapTextInLines(element) {
      const text = element.textContent;
      const lines = text.split('\n');
      element.innerHTML = lines.map(line => `<span>${line}</span>`).join('<br>');
    }

    function nextFinalSection() {
      if (!finalKeyListenerActive) return;
      
      disableFinalKeyListener();
      
      const finalText = document.getElementById('final-text');
      const finalPrompt = document.getElementById('final-prompt');
      
      if (!finalText || !finalPrompt) return;
      
      // Hide prompt - exactly like story page
      finalPrompt.classList.remove('visible');
      
      // Start text fade out animation - exactly like story page
      setTimeout(() => {
        fadeOutFinalText(finalText, () => {
          currentFinalSection++;
          showFinalSection(currentFinalSection);
        });
      }, 150);
    }

    function fadeOutFinalText(element, callback) {
      // Same fade out animation as story page  
      const spans = element.querySelectorAll('span');
      let lineIndex = spans.length - 1;
      
      function fadeLine() {
        if (lineIndex >= 0) {
          if (spans[lineIndex]) {
            spans[lineIndex].style.opacity = '0';
          }
          lineIndex--;
          setTimeout(fadeLine, 100);
        } else {
          setTimeout(() => {
            callback();
          }, 150);
        }
      }
      
      setTimeout(() => {
        fadeLine();
      }, 150);
    }

    function handleFinalKeyPress(event) {
      console.log('handleFinalKeyPress called, key:', event.key, 'active:', finalKeyListenerActive);
      const finalOverlay = document.getElementById('final-overlay');
      if (event.key === 'Enter' && finalKeyListenerActive && finalOverlay) {
        console.log('Enter key pressed, calling nextFinalSection');
        event.preventDefault();
        nextFinalSection();
      }
    }

    function enableFinalKeyListener() {
      console.log('enableFinalKeyListener called');
      finalKeyListenerActive = true;
      document.removeEventListener('keydown', handleFinalKeyPress);
      document.addEventListener('keydown', handleFinalKeyPress);
      console.log('Final key listener enabled, finalKeyListenerActive:', finalKeyListenerActive);
    }

    function disableFinalKeyListener() {
      finalKeyListenerActive = false;
      document.removeEventListener('keydown', handleFinalKeyPress);
    }
  </script>

  <script>
  // Clock initialization and queue animation trigger
  (function(){
    // Initialize clock
    let started = false, current = 0, timer;
    let acceleratedTimer = null, acceleratedStartTime = null, startingMinutes = null;
    
    // Cumulative processed emails counter
    let cumulativeProcessed = 0;
    
    // Phase pools counters
    let Phase1pool = 0;
    let Phase2pool = 0;
    let Phase3pool = 0;
    
    const header = document.querySelector('.header');
    
    // Create phase pools display
    const phasePoolsEl = document.createElement('div');
    phasePoolsEl.id = 'phase-pools-display';
    header.appendChild(phasePoolsEl);
    
    // Create cumulative processed emails display
    const processedEl = document.createElement('div');
    processedEl.id = 'processed-display';
    header.appendChild(processedEl);
    
    // Create date display element
    const dateEl = document.createElement('div');
    dateEl.id = 'date-display';
    header.appendChild(dateEl);
    
    // Create clock element
    const clockEl = document.createElement('div');
    clockEl.id = 'clock';
    header.appendChild(clockEl);
    function renderClock() {
      const h = 9 + Math.floor(current/60);
      const m = current % 60;
      clockEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }
    
    function renderDate() {
      dateEl.textContent = `D${currentDay}`;
    }
    
    function renderProcessed() {
      processedEl.textContent = `${cumulativeProcessed}`;
    }
    
    function renderPhasePools() {
      const phase1Str = (Phase1pool >= 0 ? '+' : '') + Phase1pool.toString().padStart(3, '0');
      const phase2Str = (Phase2pool >= 0 ? '+' : '') + Phase2pool.toString().padStart(3, '0');
      const phase3Str = (Phase3pool >= 0 ? '+' : '') + Phase3pool.toString().padStart(3, '0');
      phasePoolsEl.textContent = `${phase1Str}/${phase2Str}/${phase3Str}`;
    }
    
    // Expose functions globally
    window.renderDate = renderDate;
    window.updateCumulativeProcessed = function(count) {
      cumulativeProcessed += count;
      renderProcessed();
    };
    window.updatePhasePools = function(phase1, phase2, phase3) {
      Phase1pool = phase1;
      Phase2pool = phase2;
      Phase3pool = phase3;
      renderPhasePools();
    };
    
    // Expose timer control functions
    window.resetTimer = function() {
      current = 0;
      started = false;
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      if (acceleratedTimer) {
        clearInterval(acceleratedTimer);
        acceleratedTimer = null;
      }
      renderClock();
      console.log('Timer reset to 9:00 AM');
    };
    
    window.forceSubmit = function() {
      current = 480;
      renderClock();
      disableEverything();
      console.log('Forced submission at 5:00 PM');
    };
    
    window.renderClock = renderClock;
    
    // Expose submit button reset function
    window.resetSubmitButton = function() {
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.classList.remove('disabled');
        submitBtn.disabled = false;
        submitBtn.style.background = '';
        submitBtn.style.color = '';
        submitBtn.textContent = 'Submit';
        console.log('Submit button reset to normal state');
      }
    };
    
    // MVIS Scoring System
    window.calculateAndUpdateMVIS = function() {
      // Reset pools
      let phase1Total = 0;
      let phase2Total = 0;
      let phase3Total = 0;
      
      // Get all tiles in grid
      const tiles = document.querySelectorAll('#grid .tile');
      
      tiles.forEach(tile => {
        // Skip wounded tiles
        if (tile.style.pointerEvents === 'none' && tile.style.background.includes('rgba(128, 0, 0')) {
          return;
        }
        
        const letterIndex = parseInt(tile.dataset.letterIndex);
        if (isNaN(letterIndex) || letterIndex < 0 || letterIndex >= letters.length) {
          return;
        }
        
        const letter = letters[letterIndex];
        const tileSize = tile.dataset.size;
        
        // Calculate MVIS score for this tile
        const mvisScore = calculateMVISScore(letter, tileSize);
        
        // Debug logging
        console.log(`MVIS: Letter "${letter.sender}" (${letter.mvisPhase}): Score=${mvisScore}, TileSize=${tileSize}, Alignment=${letter.alignment}, Verified=${letter._checked}, FactError=${letter.hasFactualError}, InternalContra=${letter.hasInternalContradiction}`);
        
        // Add to appropriate phase pool
        const phase = letter.mvisPhase;
        if (phase && phase !== "N/A") {
          if (phase.startsWith("Phase 1") || phase.startsWith("1.")) {
            phase1Total += mvisScore;
          } else if (phase.startsWith("Phase 2") || phase.startsWith("2.")) {
            phase2Total += mvisScore;
          } else if (phase.startsWith("Phase 3") || phase.startsWith("3.")) {
            phase3Total += mvisScore;
          }
        }
      });
      
      // Update display
      window.updatePhasePools(phase1Total, phase2Total, phase3Total);
    };
    
    function calculateMVISScore(letter, tileSize) {
      // Tile Score (0 for not included/rejected, 1 for small, 2 for medium, 3 for large)
      let tileScore = 0;
      if (tileSize === 'small') tileScore = 1;
      else if (tileSize === 'medium') tileScore = 2;  
      else if (tileSize === 'large') tileScore = 3;
      
      // Fact Check Weight
      let factCheckWeight = 0;
      const isVerified = letter._checked || false;
      const hasFactualError = letter.hasFactualError || false;
      
      if (isVerified && !hasFactualError) {
        factCheckWeight = 1; // Verified + hasFactualError=false + Selected
      } else if (!isVerified) {
        factCheckWeight = 2; // Not Verified + Selected  
      } else if (isVerified && hasFactualError) {
        factCheckWeight = 3; // Verified + hasFactualError=true + Selected
      }
      
      // Alignment Modifier
      let alignmentModifier = 0;
      if (letter.alignment === "Positive") alignmentModifier = 1;
      else if (letter.alignment === "Negative") alignmentModifier = -1;
      else if (letter.alignment === "N/A") alignmentModifier = 0;
      
      // hasInternalContradiction (0 if true, 1 if false)
      const internalContradictionModifier = letter.hasInternalContradiction ? 0 : 1;
      
      // Calculate MVIS score
      const mvisScore = tileScore * factCheckWeight * alignmentModifier * internalContradictionModifier;
      
      return mvisScore;
    }
    function disableEverything() {
      // Disable tools and fact-check, but keep submit button enabled for forced submission
      document.querySelectorAll('.tool-item, .letter-item, #fact-check-btn')
        .forEach(el => { el.classList.add('disabled'); el.disabled = true; });
      
      // Enable submit button and highlight it for forced submission
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.classList.remove('disabled');
        submitBtn.disabled = false;
        submitBtn.style.background = '#b91c1c';
        submitBtn.style.color = 'white';
        submitBtn.textContent = 'SUBMIT (Time Up!)';
      }
      
      clearInterval(timer);
      // Also clear accelerated timer if it's running
      if (acceleratedTimer) {
        clearInterval(acceleratedTimer);
        acceleratedTimer = null;
      }
      
      // Start 10-second countdown for auto-submit
      let countdown = 10;
      const countdownTimer = setInterval(() => {
        countdown--;
        if (submitBtn) {
          submitBtn.textContent = `Auto-Submit in ${countdown}s`;
        }
        
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          
          // Stop alarm sound before auto-submit
          const alarmSound = document.getElementById('alarm-sound');
          if (alarmSound) {
            alarmSound.pause();
            alarmSound.currentTime = 0;
          }
          
          // Trigger auto-submit
          if (submitBtn && !submitBtn.disabled) {
            submitBtn.click();
          }
        }
      }, 1000);
      
      // Store countdown timer globally so it can be cleared if user manually submits
      window.alarmCountdownTimer = countdownTimer;
    }
    function tick() {
      current++;
      if (current >= 480) {
        current = 480;
        renderClock();
        // Stop hourglass when time reaches 17:00 - DISABLED
        // stopHourglassAnimation();
        
        // Play alarm sound when hitting 17:00
        const alarmSound = document.getElementById('alarm-sound');
        if (alarmSound) {
          alarmSound.currentTime = 0;
          alarmSound.play().catch(e => console.log('Alarm sound play failed:', e));
        }
        
        disableEverything();
      } else renderClock();
    }
    
    // Store queue animation start function globally
    window.startQueueAnimation = null;
    
    // Hourglass animation control functions - DISABLED
    /*
    function startHourglassAnimation() {
      const hourglass = document.querySelector('.hourglass');
      if (hourglass) {
        hourglass.style.animationPlayState = 'running';
      }
      // Start all sand animations
      const style = document.createElement('style');
      style.id = 'hourglass-animation-style';
      style.textContent = `
        .hourglass-top::before,
        .hourglass-bottom-sand,
        .hourglass-bottom-sand::before,
        .hourglass-drop {
          animation-play-state: running !important;
        }
      `;
      if (!document.getElementById('hourglass-animation-style')) {
        document.head.appendChild(style);
      }
    }
    
    function stopHourglassAnimation() {
      const hourglass = document.querySelector('.hourglass');
      if (hourglass) {
        hourglass.style.animationPlayState = 'paused';
      }
      // Stop all sand animations
      const style = document.getElementById('hourglass-animation-style');
      if (style) {
        style.textContent = `
          .hourglass-top::before,
          .hourglass-bottom-sand,
          .hourglass-bottom-sand::before,
          .hourglass-drop {
            animation-play-state: paused !important;
          }
        `;
      }
    }
    
    function accelerateHourglassAnimation() {
      const hourglass = document.querySelector('.hourglass');
      if (hourglass) {
        hourglass.style.animationDuration = '3s'; // 20x faster than 60s
      }
      // Accelerate all sand animations
      const style = document.getElementById('hourglass-animation-style');
      if (style) {
        style.textContent = `
          .hourglass {
            animation-duration: 3s !important;
          }
          .hourglass-top::before,
          .hourglass-bottom-sand,
          .hourglass-bottom-sand::before {
            animation-duration: 3s !important;
            animation-play-state: running !important;
          }
          .hourglass-drop {
            animation-duration: 0.03s, 3s !important;
            animation-play-state: running !important;
          }
        `;
      }
    }
    
    function normalizeHourglassAnimation() {
      const hourglass = document.querySelector('.hourglass');
      if (hourglass) {
        hourglass.style.animationDuration = '60s'; // Back to normal
      }
      // Normalize all sand animations
      const style = document.getElementById('hourglass-animation-style');
      if (style) {
        style.textContent = `
          .hourglass {
            animation-duration: 60s !important;
          }
          .hourglass-top::before,
          .hourglass-bottom-sand,
          .hourglass-bottom-sand::before {
            animation-duration: 60s !important;
            animation-play-state: running !important;
          }
          .hourglass-drop {
            animation-duration: 0.6s, 60s !important;
            animation-play-state: running !important;
          }
        `;
      }
    }
    */

    // Store accelerated clock functions globally
    window.startAcceleratedClock = function() {
      // Prevent multiple accelerated timers
      if (acceleratedTimer) {
        return;
      }
      
      // Clear the existing normal timer
      if (timer) {
        clearInterval(timer);
      }
      
      // Accelerate hourglass animation - DISABLED
      // accelerateHourglassAnimation();
      
      // Record start time and current minutes
      acceleratedStartTime = Date.now();
      startingMinutes = current;
      
      // Start accelerated timer - advance 2 hours (120 minutes) over 10 seconds
      acceleratedTimer = setInterval(() => {
        const elapsed = Date.now() - acceleratedStartTime;
        const progress = Math.min(elapsed / 10000, 1); // 10000ms = 10 seconds
        const minutesToAdd = Math.floor(progress * 120); // 120 minutes = 2 hours
        
        current = Math.min(startingMinutes + minutesToAdd, 480);
        renderClock();
        
        if (current >= 480 || progress >= 1) {
          clearInterval(acceleratedTimer);
          acceleratedTimer = null;
          if (current >= 480) disableEverything();
        }
      }, 50); // Update every 50ms for smooth animation
    };
    
    window.stopAcceleratedClock = function() {
      // Clear accelerated timer
      if (acceleratedTimer) {
        clearInterval(acceleratedTimer);
        acceleratedTimer = null;
      }
      
      // Normalize hourglass animation - DISABLED
      // normalizeHourglassAnimation();
      
      // Resume normal timer if clock was already started
      if (started && current < 480) {
        timer = setInterval(tick, 1000);
      }
    };
    
    // Start timing on first letter click
    document.getElementById('letters-list').addEventListener('click', () => {
      if (!started) {
        started = true;
        timer = setInterval(tick, 1000);
        // Start queue animation when clock starts
        if (window.startQueueAnimation) {
          window.startQueueAnimation();
        }
        // Start hourglass animation when clock starts - DISABLED
        // startHourglassAnimation();
      }
    });
    // Fact Check button click handler (time increment now handled by accelerated clock)
    // Initial render
    renderClock();
    renderDate();
    renderProcessed();
    renderPhasePools();
  })();
  </script>

  <script>
  // Background Music Control
  let isMusicEnabled = true; // Global music control
  let backgroundMusic; // Global reference
  
  (function() {
    backgroundMusic = document.getElementById('background-music');
    
    // Function to start background music
    function startBackgroundMusic() {
      if (backgroundMusic && isMusicEnabled) {
        backgroundMusic.volume = 0.05; // 确保音乐很小声
        // DON'T reset currentTime - let music continue from where it was
        if (backgroundMusic.paused) {
          backgroundMusic.play().catch(e => {
            console.log('Audio autoplay blocked by browser:', e);
            // Add user interaction listener for browsers that block autoplay
            document.addEventListener('click', function enableAudio() {
              if (isMusicEnabled) backgroundMusic.play();
              document.removeEventListener('click', enableAudio);
            }, { once: true });
          });
        }
      }
    }
    
    // Function to stop background music  
    function stopBackgroundMusic() {
      if (backgroundMusic) {
        backgroundMusic.pause();
        // DON'T reset currentTime - let music resume from where it paused
      }
    }
    
    // Function to check current page and control music
    function updateMusicBasedOnPage() {
      const activePage = document.querySelector('.page.active');
      const isMainGame = activePage && activePage.id === 'main-game';
      
      if (isMainGame || !isMusicEnabled) {
        stopBackgroundMusic();
      } else if (isMusicEnabled) {
        startBackgroundMusic();
      }
    }
    
    // Monitor page changes
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          updateMusicBasedOnPage();
        }
      });
    });
    
    // Observe all pages for class changes
    document.querySelectorAll('.page').forEach(page => {
      observer.observe(page, { attributes: true });
    });
    
    // Initial music setup
    document.addEventListener('DOMContentLoaded', function() {
      updateMusicBasedOnPage();
    });
    
    // Start music on first user interaction (for browsers that block autoplay)
    document.addEventListener('click', function() {
      updateMusicBasedOnPage();
    }, { once: true });
    
  })();
  
  // Global music and sound control functions
  function toggleBackgroundMusic() {
    isMusicEnabled = !isMusicEnabled;
    const btn = document.getElementById('music-toggle-btn');
    if (btn) {
      btn.textContent = isMusicEnabled ? '🎵 音乐: 开启' : '🎵 音乐: 关闭';
      btn.style.background = isMusicEnabled ? '#4CAF50' : '#f44336';
    }
    
    if (isMusicEnabled) {
      // Check current page and start music if appropriate
      const activePage = document.querySelector('.page.active');
      const isMainGame = activePage && activePage.id === 'main-game';
      if (!isMainGame && backgroundMusic) {
        backgroundMusic.play().catch(e => console.log('Music play failed:', e));
      }
    } else {
      // Stop music immediately
      if (backgroundMusic) {
        backgroundMusic.pause();
      }
    }
  }
  
  function testButtonSound() {
    const buttonClickSound = document.getElementById('button-click-sound');
    if (buttonClickSound) {
      buttonClickSound.volume = 1.0; // 确保最大音量
      buttonClickSound.currentTime = 0;
      buttonClickSound.play().catch(e => {
        console.log('Button sound test failed:', e);
        alert('按钮音效播放失败: ' + e.message);
      });
      
      // Debug info
      const totalButtons = document.querySelectorAll('button').length;
      const soundButtons = document.querySelectorAll('button[data-sound-added]').length;
      console.log(`音效系统状态: 总按钮数${totalButtons}, 已添加音效${soundButtons}`);
      console.log(`音量设置: 背景音乐=${document.getElementById('background-music')?.volume}, 按钮音效=${buttonClickSound.volume}`);
    } else {
      alert('找不到按钮音效元素');
    }
  }
  </script>

  <script>
  // Button Click Sound Control System
  (function() {
    const buttonClickSound = document.getElementById('button-click-sound');
    
    // Function to play button click sound
    function playButtonSound() {
      if (buttonClickSound) {
        buttonClickSound.volume = 1.0; // 确保最大音量
        buttonClickSound.currentTime = 0; // Reset to beginning for rapid clicks
        buttonClickSound.play().catch(e => {
          console.log('Button sound failed to play:', e);
        });
      }
    }
    
    // Add click sound to all buttons
    function addSoundToButtons() {
      // Get all button elements, including those in hidden pages
      const buttons = document.querySelectorAll('button');
      
      console.log(`扫描到 ${buttons.length} 个按钮`);
      
      buttons.forEach(button => {
        // Check if this button already has the sound event listener
        if (!button.hasAttribute('data-sound-added')) {
          button.addEventListener('click', playButtonSound);
          button.setAttribute('data-sound-added', 'true');
          console.log(`为按钮添加音效: ${button.textContent?.substring(0, 20) || button.id || 'unknown'}`);
        }
      });
    }
    
    // Initial setup
    document.addEventListener('DOMContentLoaded', addSoundToButtons);
    
    // Monitor for dynamically added buttons
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === Node.ELEMENT_NODE) {
            // Check if the added node is a button
            if (node.tagName === 'BUTTON') {
              if (!node.hasAttribute('data-sound-added')) {
                node.addEventListener('click', playButtonSound);
                node.setAttribute('data-sound-added', 'true');
              }
            }
            // Check for buttons within the added node
            const buttons = node.querySelectorAll ? node.querySelectorAll('button') : [];
            buttons.forEach(button => {
              if (!button.hasAttribute('data-sound-added')) {
                button.addEventListener('click', playButtonSound);
                button.setAttribute('data-sound-added', 'true');
              }
            });
          }
        });
      });
    });
    
    // Start observing
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // Re-scan for new buttons periodically (backup)
    setInterval(addSoundToButtons, 2000);
    
    // Make addSoundToButtons globally accessible for page transitions
    window.rescanButtonSounds = addSoundToButtons;
    
  })();
  </script>

  <script>
  // Queue Animation Script
  (function() {
    var queueContainer = document.getElementById("queue-character-container");

    // ---- 全局声明处添加 ----
    let maxChars = letters.length; // Allow all letters to be displayed
    // Letter display counter
    let lettersToShow = 0;
    let firstLetterShown = false;
    // Track progress through original letters sequence for queue display
    let originalLetterIndex = 0;

    // Adjusted coordinates for vertical layout in 220x380 container
    const laneX = 128; // shifted slightly left
    const startY = 385; // Near bottom of 380px height (moved down)
    const endY = 40;   // Near top (moved down to match map shift)
    const v = 0.8;     // Increased speed for vertical movement
    const idleF = 60;
    const leftWalkFrames = 24;
    const leftStep = 1.0; // Increased for better visibility
    const safeDist = 20;  // Increased for vertical spacing
    const spawnInterval = 30; // Auto spawn new character interval (frames)

    const chars = [];
    let pendingCalls = 0;   // 存储待叫号次数
    let frameCount = 0;
    // 1. Page load immediate animation: animationStarted = true
    let animationStarted = true;

    // ---- 修改 autoSpawnChar() ----
    function autoSpawnChar() {
      if (chars.length >= maxChars) return;
      const el = document.createElement("div");
      el.className = "character";
      el.setAttribute("facing", "up");
      el.setAttribute("walking", "true");
      el.innerHTML = `
        <div class="shadow pixel-art"></div>
        <div class="character_spritesheet pixel-art"></div>`;
      queueContainer.appendChild(el);
      chars.push({
        y: startY,
        x: laneX,
        state: "up",
        idle: 0,
        leftFrames: 0,
        readyToLeave: false,
        el,
        letterDelivered: false, // 标记该小人是否已传递信
        hasTriggeredAvatar: false // 标记该小人是否已触发头像显示
      });
    }


    // ---- Avatar Display Logic ----
    const avatarDisplay = document.getElementById("avatar-display");
    const avatarImage = document.getElementById("avatar-image");
    const noiseOverlay = document.getElementById("noise-overlay");
    let isShowingAvatar = false;
    let avatarSwitchTimer = null;
    
    // Sender name to avatar path mapping
    const senderAvatars = {
      1: "avatars/avatars:1.png",
      2: "avatars/avatars:2.png",
      3: "avatars/avatars:3.png",
      4: "avatars/avatars:4.png",
      5: "avatars/avatars:5.png",
      6: "avatars/avatars:6.png",
      7: "avatars/avatars:7.png",
      8: "avatars/avatars:8.png",
      9: "avatars/avatars:9.png",
      10: "avatars/avatars:10.png",
      11: "avatars/avatars:11.png",
      12: "avatars/avatars:12.png",
      13: "avatars/avatars:13.png",
      14: "avatars/avatars:14.png",
      15: "avatars/avatars:15.png",
      16: "avatars/avatars:16.png",
      17: "avatars/avatars:17.png",
      18: "avatars/avatars:18.png",
      19: "avatars/avatars:19.png",
      20: "avatars/avatars:20.png",
      21: "avatars/avatars:21.png",
      22: "avatars/avatars:22.png",
      23: "avatars/avatars:23.png",
      24: "avatars/avatars:24.png",
      25: "avatars/avatars:25.png",
      26: "avatars/avatars:26.png",
      27: "avatars/avatars:27.png",
      28: "avatars/avatars:28.png",
      29: "avatars/avatars:29.png",
      30: "avatars/avatars:30.png",
      31: "avatars/avatars:31.png",
      32: "avatars/avatars:32.png",
      33: "avatars/avatars:33.png",
      34: "avatars/avatars:34.png",
      35: "avatars/avatars:35.png",
      36: "avatars/avatars:36.png",
      37: "avatars/avatars:37.png",
      38: "avatars/avatars:38.png",
      39: "avatars/avatars:39.png",
      40: "avatars/avatars:40.png",
      41: "avatars/avatars:41.png",
      42: "avatars/avatars:42.png",
      43: "avatars/avatars:43.png",
      44: "avatars/avatars:44.png",
      45: "avatars/avatars:45.png",
      46: "avatars/avatars:46.png",
      47: "avatars/avatars:47.png",
      48: "avatars/avatars:48.png",
      49: "avatars/avatars:49.png"
    };
    
    function adjustAvatarSize() {
      const displayRect = avatarDisplay.getBoundingClientRect();
      const frameAspectRatio = displayRect.height / displayRect.width;
      const imageAspectRatio = 250 / 128; // height/width = 1.953
      
      if (frameAspectRatio < imageAspectRatio) {
        // Frame is "flatter" than image, fit width and align bottom
        avatarImage.style.width = "100%";
        avatarImage.style.height = "auto";
        avatarImage.style.top = "100%";
        avatarImage.style.left = "50%";
        avatarImage.style.transform = "translate(-50%, -100%)";
      } else {
        // Frame is "taller" than image, fit height and center
        avatarImage.style.height = "100%";
        avatarImage.style.width = "auto";
        avatarImage.style.top = "50%";
        avatarImage.style.left = "50%";
        avatarImage.style.transform = "translate(-50%, -50%)";
      }
    }

    function showAvatar(senderName) {
      console.log('showAvatar called with senderName:', senderName);
      // Find the corresponding letter object by sender name
      const letter = letters.find(l => l.sender === senderName);
      console.log('Found letter:', letter);
      console.log('Available senderAvatars:', Object.keys(senderAvatars));
      if (letter && letter.senderId && senderAvatars[letter.senderId]) {
        console.log('Avatar conditions met, senderId:', letter.senderId, 'avatarPath:', senderAvatars[letter.senderId]);
        // Show noise effect first
        showNoise(800);
        
        // After noise starts, switch to avatar
        setTimeout(() => {
          avatarImage.src = senderAvatars[letter.senderId];
          avatarDisplay.style.display = "block";
          
          // Wait for image to load, then adjust size
          avatarImage.onload = () => {
            adjustAvatarSize();
          };
          
          // If image is already cached, adjust immediately
          if (avatarImage.complete) {
            adjustAvatarSize();
          }
          
          isShowingAvatar = true;
        }, 400); // Switch in the middle of noise effect
      } else {
        console.log('Avatar conditions NOT met:', {
          letterFound: !!letter,
          senderId: letter ? letter.senderId : 'N/A',
          avatarExists: letter ? !!senderAvatars[letter.senderId] : false
        });
      }
    }
    
    function hideAvatar() {
      avatarDisplay.style.display = "none";
      isShowingAvatar = false;
    }
    
    function showNoise(duration = 800) {
      const noiseSound = document.getElementById('noise-sound');
      
      // Start noise visual effect
      noiseOverlay.style.opacity = "0.8";
      noiseOverlay.classList.add("noise-active");
      
      // Start noise sound effect
      if (noiseSound) {
        noiseSound.currentTime = 0;
        noiseSound.play().catch(e => console.log('Noise sound play failed:', e));
      }
      
      setTimeout(() => {
        hideNoise();
      }, duration);
    }
    
    function hideNoise() {
      const noiseSound = document.getElementById('noise-sound');
      
      // Stop noise visual effect
      noiseOverlay.style.opacity = "0";
      noiseOverlay.classList.remove("noise-active");
      
      // Stop noise sound effect
      if (noiseSound) {
        noiseSound.pause();
        noiseSound.currentTime = 0;
      }
    }
    
    function getCurrentSender() {
      // Use original letters sequence for avatar display
      const originalLetters = window.originalLetters || letters;
      console.log('getCurrentSender called:', { 
        originalLetterIndex, 
        totalOriginalLetters: originalLetters.length,
        lettersToShow 
      });
      
      if (originalLetterIndex >= 0 && originalLetterIndex < originalLetters.length) {
        const sender = originalLetters[originalLetterIndex].sender;
        console.log('Current sender (from original sequence):', sender);
        return sender;
      }
      console.log('No current sender found in original sequence');
      return null;
    }
    
    function switchToAvatarAfterDelay(senderName, delay = 3000) {
      console.log('switchToAvatarAfterDelay called:', { senderName, delay });
      if (avatarSwitchTimer) {
        clearTimeout(avatarSwitchTimer);
      }
      
      avatarSwitchTimer = setTimeout(() => {
        console.log('Avatar switch timer triggered, calling showAvatar for:', senderName);
        showAvatar(senderName);
      }, delay);
    }

    // ---- Horn button logic ----
    var queueNextBtn = document.getElementById("queue-next-btn");
    var nextPopup = document.getElementById("next-popup");
    
    queueNextBtn.onclick = nextBtnAction;
    queueNextBtn.onkeydown = (e) => { if (e.key === "Enter" || e.key === " ") nextBtnAction(); };

    function nextBtnAction() {
      // Add click animation class
      queueNextBtn.classList.add('clicked');
      
      // Show popup with animation
      nextPopup.classList.add('show');
      
      // Remove animations after delay
      setTimeout(() => {
        queueNextBtn.classList.remove('clicked');
        nextPopup.classList.remove('show');
      }, 800);
      
      // Avatar switching logic
      if (isShowingAvatar) {
        // If currently showing avatar, switch back to queue view with noise
        showNoise(600);
        setTimeout(() => {
          hideAvatar();
        }, 300);
      }
      
      // Clear any pending avatar switch timer
      if (avatarSwitchTimer) {
        clearTimeout(avatarSwitchTimer);
        avatarSwitchTimer = null;
      }
      
      // Advance the queue as before
      for (const c of chars) {
        if (c.state === "idle" && !c.readyToLeave) {
          c.readyToLeave = true;
          if (firstLetterShown && lettersToShow < letters.length) {
            lettersToShow++;
            originalLetterIndex++;
            console.log('lettersToShow updated to:', lettersToShow);
            renderLetters(lettersToShow);
          }
          break;
        }
      }
      
      // Schedule avatar switch after 3 seconds
      const currentSender = getCurrentSender();
      console.log('Horn button clicked - currentSender:', currentSender);
      if (currentSender) {
        const letter = letters.find(l => l.sender === currentSender);
        if (letter && letter.senderId && senderAvatars[letter.senderId]) {
          console.log('Scheduling avatar switch for:', currentSender);
          switchToAvatarAfterDelay(currentSender, 3000);
        } else {
          console.log('Avatar switch NOT scheduled:', {
            currentSender,
            letterFound: !!letter,
            senderId: letter ? letter.senderId : null,
            avatarExists: letter && letter.senderId ? !!senderAvatars[letter.senderId] : false
          });
        }
      } else {
        console.log('Avatar switch NOT scheduled: no current sender');
      }
      
      // Auto lose focus after each horn button click
      queueNextBtn.blur();
    }

    function canMoveMe(i, nextX, nextY, myState) {
      if (i === 0) return true; // 队头直接走
      const prev = chars[i - 1];
      // 前面是left/down（窗口空），允许补位idle
      if ((prev.state === "left" || prev.state === "down") && myState === "up") {
        return true;
      }
      // 前面idle需保持safeDist
      if (prev.state === "idle" && myState === "up" && Math.abs(nextY - prev.y) < safeDist) {
        return false;
      }
      // 其他状态同阶段保持距离
      if (
        myState === prev.state &&
        Math.abs(nextY - prev.y) < safeDist &&
        Math.abs(nextX - prev.x) < 2
      ) {
        return false;
      }
      return true;
    }


    function loop() {
      if (!animationStarted) {
        requestAnimationFrame(loop);
        return;
      }
      frameCount++;
      // Auto spawn new character
      if (frameCount % spawnInterval === 0) {
        // Only spawn new character when chars.length < maxChars
        if ((chars.length < maxChars) &&
            (chars.length === 0 || (startY - chars[chars.length - 1].y) > safeDist)) {
          autoSpawnChar();
        }
      }

      const px = parseInt(getComputedStyle(document.getElementById('queue-frame')).getPropertyValue('--pixel-size'));
      for (let i = 0; i < chars.length; i++) {
        const c = chars[i];
        let willMove = true;

        if (c.state === "up") {
          const nextY = c.y - v;
          willMove = canMoveMe(i, c.x, nextY, "up");
          if (willMove && c.y > endY) {
            c.y -= v;
            c.el.setAttribute("walking", "true");
          } else {
            c.el.setAttribute("walking", "false");
          }
          c.el.setAttribute("facing", "up");
          if (c.y <= endY) { 
            c.y = endY; 
            c.state = "idle"; 
            c.el.setAttribute("walking", "false");
            
            // Check if this is the first character reaching the top
            if (i === 0 && !c.hasTriggeredAvatar) {
              c.hasTriggeredAvatar = true;
              const currentSender = getCurrentSender();
              if (currentSender) {
                const letter = letters.find(l => l.sender === currentSender);
                if (letter && letter.senderId && senderAvatars[letter.senderId]) {
                  // Wait 3 seconds before showing avatar
                  if (typeof window.autoAvatarTimer !== 'undefined' && window.autoAvatarTimer) {
                    clearTimeout(window.autoAvatarTimer);
                  }
                  window.autoAvatarTimer = setTimeout(() => {
                    showAvatar(currentSender);
                    window.autoAvatarTimer = null;
                  }, 3000);
                }
              }
            }
          }
        } else if (c.state === "idle") {
          c.el.setAttribute("walking", "false");
          c.el.setAttribute("facing", "up");
          if (c.readyToLeave) {
            c.state = "left";
            c.el.setAttribute("walking", "true");
            c.el.setAttribute("facing", "left");
          }
        } else {
          // c.el.style.filter = ""; // Other states auto restore
        }
        if (c.state === "left") {
          const nextX = c.x - leftStep;
          if (c.leftFrames < leftWalkFrames) {
            c.x -= leftStep;
            c.leftFrames++;
            c.el.setAttribute("walking", "true");
          } else {
            c.state = "down";
            c.el.setAttribute("walking", "true");
            c.el.setAttribute("facing", "down");
          }
          c.el.setAttribute("facing", "left");
        } else if (c.state === "down") {
          const nextY = c.y + v;
          if (c.y < startY) {
            c.y += v;
            c.el.setAttribute("walking", "true");
          } else {
            c.el.setAttribute("walking", "false");
          }
          c.el.setAttribute("facing", "down");
          if (c.y >= startY) {
            c.el.remove();
            chars.splice(i, 1);
            i--;
            continue;
          }
        }
        c.el.style.transform = `translate3d(${c.x * px}px,${c.y * px}px,0)`;
        // 根据 y 轴调整图层顺序：y 越大越靠前，避免穿模
        c.el.style.zIndex = 1000 + Math.floor(c.y);
      }
      // First letter auto logic
      if (!firstLetterShown && chars.length > 0 && chars[0].state === "idle") {
        lettersToShow = 1;
        renderLetters(lettersToShow);
        firstLetterShown = true;
      }
      // 队头不是 idle 时，立即让下一个 up 状态且到顶端的人 idle
      if (chars.length >= 2) {
        const head = chars[0];
        const next = chars[1];
        if (
          head.state !== "idle" &&
          next.state === "up" &&
          Math.abs(next.y - endY) < 0.1 // 已到顶
        ) {
          next.y = endY;
          next.state = "idle";
          next.el.setAttribute("walking", "false");
          next.el.setAttribute("facing", "up");
        }
      }
      requestAnimationFrame(loop);
    }
    
    // Set the start function globally so clock can trigger it
    window.startQueueAnimation = function() {
      animationStarted = true;
    };
    
    // Expose reinitialize function to global scope
    window.reinitializeQueue = function() {
      lettersToShow = 0;
      firstLetterShown = false;
      
      // Calculate how many letters from original sequence have been processed
      const originalLetters = window.originalLetters || letters;
      if (originalLetters) {
        // Count how many letters from the original sequence have been opened
        let processedCount = 0;
        for (let i = 0; i < originalLetters.length; i++) {
          if (originalLetters[i]._opened) {
            processedCount++;
          } else {
            break; // Stop at first unprocessed letter
          }
        }
        // Set originalLetterIndex to show the next unprocessed letter
        originalLetterIndex = processedCount;
        console.log('Queue reinitialized - originalLetterIndex set to:', originalLetterIndex);
      }
      
      // Update maxChars to reflect current letters count
      maxChars = letters.length;
      
      renderLetters(lettersToShow);
      
      // Reset all character hasTriggeredAvatar flags before clearing
      chars.forEach(char => {
        if (char) {
          char.hasTriggeredAvatar = false;
        }
      });
      
      // Clear existing characters completely
      chars.length = 0;
      
      // Also remove all character elements from DOM
      const queueFrame = document.getElementById('queue-frame');
      if (queueFrame) {
        const existingChars = queueFrame.querySelectorAll('.character');
        existingChars.forEach(char => char.remove());
      }
      
      // Reset frame count to avoid spawning issues
      frameCount = 0;
      
      // Spawn first character
      if (typeof autoSpawnChar === 'function') {
        autoSpawnChar();
      }
    };

    // Initial page load, queue-related initialization
    window.addEventListener('DOMContentLoaded', () => {
      // Page load immediately spawn first character, clear letter panel content but keep outer frame
      lettersToShow = 0;
      firstLetterShown = false;
      originalLetterIndex = 0; // Initialize original letter sequence index
      
      // FIXED: Only clear letters if we're not already in main-game to avoid conflicts
      const mainGamePage = document.getElementById('main-game');
      if (!mainGamePage || !mainGamePage.classList.contains('active')) {
        renderLetters(lettersToShow); // Letter panel clear content but keep header
      }
      
      if (typeof autoSpawnChar === 'function') autoSpawnChar();
      // loop()主循环不再等待外部触发，animationStarted 已为 true
    });

    // Expose chars array to global scope for reinitialization
    window.queueChars = chars;

    // Start the loop immediately (animationStarted is true so loop runs)
    loop();
  })();
  </script>

  <!-- Chart CSS Styles -->
  <style>
    #wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #wrapper svg {
      background: transparent;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      border-radius: var(--neu-border-radius-small);
    }

    .chart-area {
      fill: var(--neu-bg);
      stroke: none;
    }

    .x-axis path,
    .y-axis path {
      stroke: none;
    }
    
    .x-axis line,
    .y-axis line {
      stroke: var(--border-light);
      stroke-width: 0.5;
      opacity: 0.6;
    }

    .x-axis text,
    .y-axis text {
      fill: var(--ink-light);
      font-family: 'Nunito Sans', sans-serif;
      font-size: 10px;
      font-weight: 500;
    }

    .grid-line {
      stroke: var(--border-light);
      stroke-width: 0.3;
      opacity: 0.3;
      stroke-dasharray: 2,2;
    }

    .freezing {
      fill: var(--neu-shadow-inset-light);
      opacity: 0.3;
    }

    .line {
      fill: none;
      stroke: var(--ink-medium);
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    
    .chart-container {
      background: var(--neu-bg);
      border-radius: var(--neu-border-radius-small);
      box-shadow: 
        inset 2px 2px 4px var(--neu-shadow-inset-dark),
        inset -1px -1px 3px var(--neu-shadow-inset-light);
    }
  </style>

  <!-- D3.js Library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Animated Line Chart Script -->
  <script>
  // Player Activity Tracking System
  let playerActivityTracker = {
    recentActions: [],
    activityHistory: [], // Store activity levels over time
    currentActivityLevel: 0.3, // 0-1 scale, start lower
    smoothedActivity: 0.3, // Heavily smoothed version
    baselineTemp: 65,
    maxTemp: 85, // Reduced range for more subtle changes
    minTemp: 45,
    
    // Record player action
    recordAction: function() {
      const now = Date.now();
      this.recentActions.push(now);
      
      // Keep only actions from last 60 seconds (longer window)
      this.recentActions = this.recentActions.filter(time => now - time < 60000);
      
      // Calculate activity level based on longer periods
      const actionsInLast15s = this.recentActions.filter(time => now - time < 15000).length;
      const actionsInLast60s = this.recentActions.length;
      
      // Much higher thresholds for "high activity"
      const recentActivity = Math.min(actionsInLast15s / 12, 1); // 12+ actions in 15s = max
      const sustainedActivity = Math.min(actionsInLast60s / 30, 1); // 30+ actions in 60s = sustained
      
      // Lower sensitivity - blend more conservatively
      const newLevel = (recentActivity * 0.4 + sustainedActivity * 0.6);
      
      // Smooth the transition - don't jump immediately
      this.currentActivityLevel = this.currentActivityLevel * 0.8 + newLevel * 0.2;
    },
    
    // Get target temperature with momentum and smoothing
    getTargetTemperature: function() {
      // Add to activity history for longer-term trends
      this.activityHistory.push(this.currentActivityLevel);
      if (this.activityHistory.length > 20) {
        this.activityHistory.shift();
      }
      
      // Calculate moving average of activity
      const avgActivity = this.activityHistory.reduce((a, b) => a + b, 0) / this.activityHistory.length;
      
      // Heavy smoothing - very slow response
      this.smoothedActivity = this.smoothedActivity * 0.92 + avgActivity * 0.08;
      
      // Map to temperature with smaller range
      const tempRange = this.maxTemp - this.minTemp;
      const targetTemp = this.minTemp + (tempRange * this.smoothedActivity);
      
      return targetTemp;
    },
    
    // Gradual decay activity over time
    decayActivity: function() {
      const now = Date.now();
      this.recentActions = this.recentActions.filter(time => now - time < 60000);
      
      // Very gradual decay
      if (this.recentActions.length === 0) {
        this.currentActivityLevel *= 0.98; // Much slower decay
      }
    }
  };

  // Track various player interactions
  function setupActivityTracking() {
    const trackedEvents = ['click', 'scroll', 'keydown', 'mousemove'];
    let lastMouseMove = 0;
    
    trackedEvents.forEach(eventType => {
      document.addEventListener(eventType, function(e) {
        // Throttle mousemove to avoid spam
        if (eventType === 'mousemove') {
          const now = Date.now();
          if (now - lastMouseMove < 1000) return; // Max 1 per second
          lastMouseMove = now;
        }
        
        playerActivityTracker.recordAction();
      });
    });
    
    // Track specific simulator interactions
    const interactiveElements = document.querySelectorAll('button, .letter-item, .content-paragraph-item, .tool-item');
    interactiveElements.forEach(element => {
      element.addEventListener('click', () => {
        playerActivityTracker.recordAction();
      });
    });
  }

  async function drawLineChart() {
    // Start with minimal initial data - just a few recent points at baseline
    let dataset = [];
    const startDate = new Date();
    const baselineTemp = playerActivityTracker.baselineTemp;
    
    // Generate only 5 initial points around baseline
    for (let i = 0; i < 5; i++) {
      const date = new Date(startDate);
      date.setDate(date.getDate() - (4 - i)); // 4 days ago to today
      dataset.push({
        date: d3.timeFormat("%Y-%m-%d")(date),
        temperatureMax: baselineTemp + (Math.random() * 6 - 3) // Small variation around baseline
      });
    }

    // 2. Create chart dimensions
    const yAccessor = d => d.temperatureMax;
    const dateParser = d3.timeParse("%Y-%m-%d");
    const xAccessor = d => dateParser(d.date);
    dataset = dataset.sort((a, b) => xAccessor(a) - xAccessor(b));

    let dimensions = {
      width: 280,
      height: 200,
      margin: {
        top: 15,
        right: 15,
        bottom: 15,
        left: 25
      }
    };
    dimensions.boundedWidth =
      dimensions.width - dimensions.margin.left - dimensions.margin.right;
    dimensions.boundedHeight =
      dimensions.height - dimensions.margin.top - dimensions.margin.bottom;

    // 3. Draw canvas
    const wrapper = d3
      .select("#wrapper")
      .append("svg")
      .attr("width", dimensions.width)
      .attr("height", dimensions.height);

    const bounds = wrapper
      .append("g")
      .style(
        "transform",
        `translate(${dimensions.margin.left}px, ${dimensions.margin.top}px)`
      );

    bounds
      .append("defs")
      .append("clipPath")
      .attr("id", "bounds-clip-path")
      .append("rect")
      .attr("width", dimensions.boundedWidth)
      .attr("height", dimensions.boundedHeight);

    // init static elements
    bounds.append("rect").attr("class", "freezing");
    const clip = bounds.append("g").attr("clip-path", "url(#bounds-clip-path)");

    clip.append("path").attr("class", "line");

    bounds
      .append("g")
      .attr("class", "x-axis")
      .style("transform", `translateY(${dimensions.boundedHeight}px)`);
    bounds.append("g").attr("class", "y-axis");

    const drawLine = dataset => {
      // 4. Create scales
      const yScale = d3
        .scaleLinear()
        .domain(d3.extent(dataset, yAccessor))
        .range([dimensions.boundedHeight, 0]);

      const freezingTemperaturePlacement = yScale(32);
      const freezingHeight = Math.max(0, dimensions.boundedHeight - freezingTemperaturePlacement);
      const freezingTemperatures = bounds
        .select(".freezing")
        .attr("x", 0)
        .attr("width", dimensions.boundedWidth)
        .attr("y", freezingTemperaturePlacement)
        .attr("height", freezingHeight);

      const xScale = d3
        .scaleTime()
        .domain(d3.extent(dataset, xAccessor))
        .range([0, dimensions.boundedWidth]);

      // 5. Draw data
      const lineGenerator = d3
        .line()
        .x(d => xScale(xAccessor(d)))
        .y(d => yScale(yAccessor(d)));

      const lastTwoPoints = dataset.slice(-2);
      const pixelsBetweenLastPoints =
        xScale(xAccessor(lastTwoPoints[1])) - xScale(xAccessor(lastTwoPoints[0]));

      const line = bounds
        .select(".line")
        .attr("d", lineGenerator(dataset))
        .style("transform", `translate(${pixelsBetweenLastPoints}px)`)
        .transition()
        .duration(1000)
        .style("transform", "none");

      // 6. Draw peripherals
      const yAxisGenerator = d3.axisLeft().scale(yScale)
        .ticks(Math.min(10, Math.ceil(d3.extent(dataset, yAccessor)[1] - d3.extent(dataset, yAccessor)[0]) / 5));
      const yAxis = bounds.select(".y-axis").call(yAxisGenerator);

      const xAxisGenerator = d3.axisBottom().scale(xScale)
        .ticks(3)
        .tickFormat(d3.timeFormat("%m/%d"));
      const xAxis = bounds
        .select(".x-axis")
        .transition()
        .duration(1000)
        .call(xAxisGenerator);
    };
    drawLine(dataset);

    // update the line every 1.5 seconds
    setInterval(addNewDay, 1500);
    function addNewDay() {
      // Keep a rolling window of recent data points (max 20-30 points for clean display)
      const maxDataPoints = 25;
      const newPoint = generateNewDataPoint(dataset);
      dataset.push(newPoint);
      
      // Remove oldest points if we have too many
      if (dataset.length > maxDataPoints) {
        dataset = dataset.slice(-maxDataPoints);
      }
      
      drawLine(dataset);
    }

    function generateNewDataPoint(dataset) {
      const lastDataPoint = dataset[dataset.length - 1];
      const nextDay = d3.timeDay.offset(xAccessor(lastDataPoint), 1);
      const currentTemp = yAccessor(lastDataPoint);
      
      // Decay activity level
      playerActivityTracker.decayActivity();
      
      // Get target temperature based on player activity
      const targetTemp = playerActivityTracker.getTargetTemperature();
      
      // Much weaker trend force - very gradual shift
      const trendForce = (targetTemp - currentTemp) * 0.05; // Only 5% pull toward target
      
      // Larger natural fluctuations to mask the trend
      const naturalVariation = (Math.random() * 8 - 4); // ±4 degrees natural variation
      
      // Add some momentum/inertia from recent changes
      let momentum = 0;
      if (dataset.length >= 2) {
        const prevTemp = yAccessor(dataset[dataset.length - 2]);
        momentum = (currentTemp - prevTemp) * 0.3; // 30% momentum from last change
      }
      
      // Add subtle cyclical patterns (simulating daily/weekly cycles)
      const timeIndex = dataset.length;
      const dailyCycle = Math.sin(timeIndex * 0.4) * 1.5; // Small daily-like cycle
      const weeklyCycle = Math.sin(timeIndex * 0.1) * 2; // Larger weekly-like cycle
      
      // Combine all forces with natural variation dominating
      let newTemp = currentTemp + 
                   trendForce + 
                   naturalVariation + 
                   momentum + 
                   dailyCycle + 
                   weeklyCycle;
      
      // Soft bounds with some elasticity
      const minTemp = playerActivityTracker.minTemp;
      const maxTemp = playerActivityTracker.maxTemp;
      
      if (newTemp < minTemp) {
        newTemp = minTemp + (newTemp - minTemp) * 0.1; // Bounce back gently
      } else if (newTemp > maxTemp) {
        newTemp = maxTemp + (newTemp - maxTemp) * 0.1; // Bounce back gently
      }

      return {
        date: d3.timeFormat("%Y-%m-%d")(nextDay),
        temperatureMax: newTemp
      };
    }
  }
  
  // Initialize everything
  drawLineChart();
  
  // Setup activity tracking after DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    setupActivityTracking();
  });
  
  // If DOM is already loaded
  if (document.readyState === 'loading') {
    // Still loading
  } else {
    setupActivityTracking();
  }
  </script>


  <!-- Content Glass Positioning Script -->
  <script>
  (function() {
    function positionContentGlass() {
      const contentBody = document.querySelector('.content-body');
      const glassOverlay = document.querySelector('.content-glass-overlay');
      
      if (contentBody && glassOverlay) {
        const rect = contentBody.getBoundingClientRect();
        const panelRect = document.querySelector('.content-panel').getBoundingClientRect();
        
        // Calculate position relative to content-panel
        const top = rect.top - panelRect.top;
        const left = rect.left - panelRect.left;
        const width = rect.width;
        const height = rect.height;
        
        glassOverlay.style.top = top + 'px';
        glassOverlay.style.left = left + 'px';
        glassOverlay.style.width = width + 'px';
        glassOverlay.style.height = height + 'px';
      }
    }
    
    // Position on load and resize
    window.addEventListener('load', positionContentGlass);
    window.addEventListener('resize', positionContentGlass);
    
    // Position when page becomes visible
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(positionContentGlass, 100);
    });
    
    // Re-position when switching to main game page
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const target = mutation.target;
          if (target.id === 'main-game' && !target.classList.contains('hidden')) {
            setTimeout(positionContentGlass, 100);
          }
        }
      });
    });
    
    const mainGame = document.getElementById('main-game');
    if (mainGame) {
      observer.observe(mainGame, { attributes: true });
    }
  })();
  </script>

  <!-- Penalty Notification -->
  <div id="penalty-notification" class="penalty-notification"></div>
</body>
</html>

